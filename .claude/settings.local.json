{
  "permissions": {
    "allow": [
      "Bash(go test:*)",
      "Bash(go version:*)",
      "Bash(go tool cover:*)",
      "Bash(git add:*)",
      "Bash(git commit:*)",
      "Bash(git push:*)",
      "Bash(sort:*)",
      "Bash(grep:*)",
      "Bash(ls:*)",
      "Bash(test:*)",
      "Bash(go clean:*)",
      "Bash(go build:*)",
      "Bash(git checkout:*)",
      "Bash(cut:*)",
      "Bash(mockery:*)",
      "Bash(chmod:*)",
      "Bash(./scripts/setup-mockery.sh:*)",
      "Bash(done)",
      "Bash(wc:*)",
      "Bash(npm test:*)",
      "Bash(npx playwright test --reporter=list)",
      "WebFetch(domain:github.com)",
      "Bash(npm run test:e2e:*)",
      "mcp__plugin_github_github__create_pull_request",
      "mcp__plugin_github_github__merge_pull_request",
      "Bash(git pull:*)",
      "mcp__plugin_github_github__list_releases",
      "Bash(git rev-parse:*)",
      "Bash(gh run list:*)",
      "Bash(gh run view:*)",
      "Bash(gh api:*)",
      "Bash(gh run watch:*)",
      "Bash(xargs gh run watch:*)",
      "Bash(go get:*)",
      "Bash(echo:*)",
      "Bash(make:*)",
      "Bash(npm run build:*)",
      "Bash(npx vite:*)",
      "Bash(curl:*)",
      "Bash(pkill:*)",
      "Bash(go vet:*)",
      "Bash(npm run test:*)",
      "Bash(git restore:*)",
      "Bash(git fetch:*)",
      "Bash(git log:*)",
      "mcp__plugin_github_github__pull_request_read",
      "Bash(gh pr checks:*)",
      "Bash(git worktree:*)",
      "Bash(git rebase:*)",
      "Bash(git:*)",
      "Bash(gh pr diff:*)",
      "Bash(gh pr:*)",
      "Bash(gh pr comment:*)",
      "Bash(gh pr view:*)",
      "Bash(ruff format:*)",
      "Bash(yamllint:*)",
      "Bash(actionlint:*)",
      "Bash(./audiobook-organizer:*)",
      "Bash(pgrep:*)",
      "Bash(openssl req:*)",
      "Bash(lsof:*)",
      "Bash(go mod tidy:*)",
      "Bash(go mod:*)",
      "Bash(go:*)",
      "Bash(./scripts/run-all-tests.sh:*)",
      "Bash(ffmpeg:*)",
      "Bash(./scripts/create-test-audiobooks.sh:*)",
      "Bash(./testdata/scripts/create_test_audiobooks.sh:*)",
      "Bash(while read f)",
      "Bash(do ls -lh \"$f\")",
      "Bash(find:*)",
      "Bash(du -h:*)",
      "Bash(xargs -I {} sh -c 'echo \"\"{}: $\\(du -h \"\"{}\"\" | cut -f1\\)\"\"')",
      "Bash(while read hash file)",
      "Bash(cat:*)",
      "Bash(tree:*)",
      "Bash(# Find duplicate/similar files across the repo - linter configs, editor configs, etc. echo \"\"=== Root dotfiles ===\"\" && ls -la .*rc .*.yml .*.yaml .*.json .*.toml .*.cfg .*.ini .*.conf echo \"\"=== .github dotfiles ===\"\" && ls -la .github/.*rc .github/*.yml .github/*.yaml .github/*.json .github/*.toml echo \"\"=== Linter/format configs ===\"\" && find . -maxdepth 3 \\\\\\( -name \"\".golangci*\"\" -o -name \"\".eslintrc*\"\" -o -name \"\".prettierrc*\"\" -o -name \"\".editorconfig\"\" -o -name \"\".yamllint*\"\" -o -name \"\".markdownlint*\"\" -o -name \"\"*.eslintrc*\"\" -o -name \"\".gitignore\"\" -o -name \"\".golintrc*\"\" \\\\\\) -not -path \"\"./docs/*\"\")",
      "Bash(# Check what CLAUDE.md currently says about build/test commands cat CLAUDE.md echo \"\"===\"\" # Check if there''s a Makefile or common build commands ls Makefile makefile GNUmakefile && echo \"\"Has Makefile\"\" || echo \"\"No Makefile\"\" ls scripts/*.sh)",
      "Bash(xcodebuild:*)",
      "Bash(sudo xcodebuild:*)",
      "Bash(head:*)",
      "mcp__plugin_github_github__search_issues",
      "Bash(staticcheck:*)",
      "Bash(xargs:*)",
      "Bash(bash:*)",
      "Bash(npx playwright:*)",
      "Bash(__NEW_LINE_1710d40a255ef0d4__ cd /Users/jdfalk/repos/github.com/jdfalk/audiobook-organizer)",
      "Bash(__NEW_LINE_d0b2f90efd5606cd__ cd /Users/jdfalk/repos/github.com/jdfalk/audiobook-organizer)",
      "Bash(if [ $? -eq 0 ])",
      "Bash(then)",
      "Bash(else)",
      "Bash(fi)",
      "Bash(__NEW_LINE_85a48a1148945de1__ cd /Users/jdfalk/repos/github.com/jdfalk/audiobook-organizer)",
      "Bash(__NEW_LINE_f433f2c5d65bb151__ cd /Users/jdfalk/repos/github.com/jdfalk/audiobook-organizer)",
      "Bash(__NEW_LINE_91521491ca160c50__ cd /Users/jdfalk/repos/github.com/jdfalk/audiobook-organizer)",
      "Bash(__NEW_LINE_dbc8192fcc233756__ cd /Users/jdfalk/repos/github.com/jdfalk/audiobook-organizer)",
      "Bash(__NEW_LINE_755b12e4efd59737__ pkill -9 audiobook-organizer)",
      "Bash(__NEW_LINE_df99226a1cd35331__ ls -lh /Users/jdfalk/repos/github.com/jdfalk/audiobook-organizer/demo_recordings/audiobook-demo.webm)",
      "Bash(npm run:*)",
      "Bash(npx tsc:*)",
      "Bash(node -e:*)",
      "Bash(node -c:*)",
      "Bash(PLAYWRIGHT_VIDEO=on npm run test:e2e:*)",
      "Bash(npm --version:*)",
      "Bash(ffprobe:*)",
      "Bash(unzip:*)",
      "Bash(npm --prefix web run test:e2e -- web/tests/e2e/app.spec.ts)",
      "Bash(npm --prefix web run test:e2e -- --list)",
      "Bash(npm --prefix web run test:e2e -- --project=chromium-record web/tests/e2e/demo-full-workflow.spec.ts)",
      "Bash(npm --prefix web run test:e2e -- --project=chromium web/tests/e2e/itunes-bidirectional-sync.spec.ts)",
      "Bash(npm --prefix web run test:*)",
      "Bash(tee:*)",
      "Bash(/tmp/failing_tests_summary.txt << 'EOF'\n================================================================================\nFAILING TEST PATTERNS ANALYSIS\n================================================================================\n\nAll 15+ failing tests share ONE common pattern:\n\nPATTERN: setupPhase2Interactive\\(\\) + page.goto\\(\\) to complex page\n========\n\nTEST 1: Backup & Restore\n─────────────────────────\nFile: web/tests/e2e/backup-restore.spec.ts:26-38\n\nconst openBackupSettings = async \\(page: Page, backups = []\\) => {\n  await setupPhase2Interactive\\(page, undefined, { backups }\\);\n  await mockEventSource\\(page\\);\n  await page.goto\\('/settings'\\);  // ← FAILS HERE\n  await page.waitForLoadState\\('domcontentloaded'\\);\n};\n\nFailures:\n  - lists existing backups \\(timeout\\)\n  - downloads backup file \\(timeout\\)\n  - creates manual backup \\(timeout\\)\n  - restores from backup \\(timeout\\)\n  - deletes backup file \\(timeout\\)\n  - validates backup before restore \\(timeout\\)\n\nRoot Issue: After page.goto\\(\\), mock for /api/v1/backup/list doesn't exist\nResult: API call times out after 30 seconds\n\n\nTEST 2: Settings Page Navigation\n────────────────────────────────\nFile: web/tests/e2e/app.spec.ts:35-48\n\ntest\\('navigates to Settings page', async \\({ page }\\) => {\n  // Setup\n  await setupPhase2Interactive\\(page\\);\n  \n  // Navigate to settings\n  const settingsLink = page.getByRole\\('link', { name: /Settings/i }\\);\n  await settingsLink.click\\(\\);\n  \n  // Assert settings page loads\n  await expect\\(page.getByText\\('Settings'\\)\\).toBeVisible\\(\\);  // ← TIMES OUT HERE\n}\\);\n\nRoot Issue: Mock APIs not ready when clicking link to /settings\nResult: Page load timeout\n\n\nTEST 3: Book Detail Page\n───────────────────────\nFile: web/tests/e2e/book-detail.spec.ts\n\ntest\\('renders info, files, and versions tabs', async \\({ page }\\) => {\n  // Setup with mocked books\n  await setupPhase2Interactive\\(page, undefined, { \n    books: [{...}] \n  }\\);\n  \n  // Navigate to book detail\n  await page.goto\\('/books/book-id'\\);  // ← FAILS HERE\n  \n  // Try to interact with page\n  await expect\\(page.getByText\\('Book Info'\\)\\).toBeVisible\\(\\);\n}\\);\n\nRoot Issue: Multiple API calls needed for book detail page not mocked\nResult: Page fails to load properly\n\n\nWHY BATCH OPERATIONS WORK \\(They Don't Have This Pattern\\)\n═════════════════════════════════════════════════════════\n\nFile: web/tests/e2e/batch-operations.spec.ts\n\ntest\\('selects single book with checkbox', async \\({ page }\\) => {\n  // Setup with mocked books\n  await setupPhase1ApiDriven\\(page\\);  // ← Uses Phase1, not Phase2\n  \n  // OR: Uses Phase2 but DOESN'T change page\n  await setupPhase2Interactive\\(page, undefined, { books: [...] }\\);\n  await page.goto\\('/library'\\);  // ← Same page, mocks still active\n  \n  // Interact on /library\n  await page.getByRole\\('checkbox'\\).first\\(\\).click\\(\\);\n  await expect\\(checkbox\\).toBeChecked\\(\\);\n}\\);\n\nSuccess: Never changes pages, so mocks stay active\n\n\nTHE FIX\n═══════\n\nThe issue is in: web/tests/e2e/utils/setup-modes.ts:98-112\n\nexport async function setupPhase2Interactive\\(\n  page: Page,\n  baseURL?: string,\n  mockOptions: MockApiOptions = {}\n\\): Promise<void> {\n  // CURRENT: Mocks set BEFORE first page load\n  await setupMockApi\\(page, mockOptions\\);       // ← addInitScript\n  await skipWelcomeWizard\\(page\\);\n  await resetToFactoryDefaults\\(page, baseURL\\);\n}\n\nPROBLEM: addInitScript\\(\\) only runs before the FIRST page load in this context\nWhen page.goto\\(\\) navigates to a NEW page, the script may not re-run\n\nSOLUTION OPTIONS:\n1. Re-call setupMockApi\\(\\) after each page.goto\\(\\)\n2. Use context-level addInitScript\\(\\) instead of page-level\n3. Modify page.goto\\(\\) wrapper to ensure mocks are reinjected\n4. Wait for window.__apiMock to exist before allowing page interactions\n\n\nPATTERN TO LOOK FOR\n═══════════════════\n\nFAILS:\n  setupPhase2Interactive\\(\\)\n  page.goto\\('/any/page'\\)  ← Different page\n  \nWORKS:\n  setupPhase1ApiDriven\\(\\)  ← Real APIs\n  page.goto\\('/any/page'\\)\n  \nWORKS:\n  setupPhase2Interactive\\(\\)\n  page.goto\\('/library'\\)   ← Same initial page\n  \\(no additional navigations\\)\n  \nWORKS:\n  batch-operations.spec.ts \\(all tests\\)\n  \\(Never call page.goto\\(\\) after setup\\)\n\n================================================================================\nEOF)",
      "Bash(do grep -c \"mockEventSource\" \"$f\")"
    ]
  }
}
