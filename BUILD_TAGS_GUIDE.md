<!-- file: BUILD_TAGS_GUIDE.md -->
<!-- version: 1.0.0 -->
<!-- guid: 1a2b3c4d-5e6f-7a8b-9c0d-1e2f3a4b5c6d -->
<!-- last-edited: 2026-01-22 -->

# Go Build Tags Guide for Mockery Mocks

## Overview

This project uses Go build tags to automatically exclude generated mock files from normal test runs. This improves the developer experience by eliminating the need for manual exclusion flags.

## How It Works

Mock files and their dependent tests are tagged with `//go:build mocks`, which acts as a build constraint. Files with this tag are only included when the `mocks` build tag is explicitly specified.

## Files Tagged with `mocks`

### Generated Mock
- `internal/database/mocks/mock_store.go` - Auto-generated testify mock

### Test Files Using Mocks
- `internal/config/persistence_test.go`
- `internal/metadata/enhanced_test.go`
- `internal/operations/queue_test.go`

## Running Tests

### Normal Test Run (Without Mocks)
```bash
go test ./...
```
- Runs all tests that don't depend on mocks
- Tests 20 packages
- Mock files are excluded automatically
- Most tests use real SQLite/PebbleDB implementations

### Test Run With Mocks
```bash
go test -tags=mocks ./...
```
- Runs ALL tests including mock-dependent tests
- Tests 21 packages
- Includes the mocks directory (shows as "[no test files]")
- Required for testing code that uses testify mocks

### Running Specific Mock Tests
```bash
go test -tags=mocks ./internal/config/...
go test -tags=mocks ./internal/metadata/...
go test -tags=mocks ./internal/operations/...
```

## Regenerating Mocks

When regenerating mocks with mockery, you must manually add the build tag:

1. Run mockery:
   ```bash
   mockery
   ```

2. Add the build tag to the top of the generated file:
   ```go
   //go:build mocks
   
   // Code generated by mockery; DO NOT EDIT.
   ```

3. The build tag must be the first line (before any comments)
4. There must be a blank line after the build tag

## Configuration

The `.mockery.yaml` file contains minimal configuration:
```yaml
all: false
dir: internal/database/mocks
filename: mock_store.go
pkgname: mocks

packages:
  github.com/jdfalk/audiobook-organizer/internal/database:
    interfaces:
      Store:
```

**Note**: Mockery v3 does not support automatic build tag injection via configuration. The build tag must be added manually after generation.

## Best Practices

1. **Default Testing**: Use `go test ./...` for day-to-day development
2. **Mock Testing**: Use `go test -tags=mocks ./...` when working on mock-dependent tests
3. **CI/CD**: Run both commands in CI to ensure all tests pass:
   ```bash
   go test ./...                  # Test without mocks
   go test -tags=mocks ./...      # Test with mocks
   ```
4. **Coverage**: Generate coverage separately for each mode:
   ```bash
   go test -cover ./...
   go test -tags=mocks -cover ./...
   ```

## Why This Approach?

### Benefits
- ✅ No manual `--exclude` flags needed
- ✅ Clear separation between mock and real implementations
- ✅ Faster test runs (mock tests are optional)
- ✅ Explicit about when mocks are used
- ✅ Standard Go mechanism (build constraints)

### Trade-offs
- Manual build tag addition after mockery generation
- Need to remember `-tags=mocks` when working on mock tests
- Slight complexity in understanding which tests run when

## Troubleshooting

### "build constraints exclude all Go files"
This error means you're trying to import the mocks package but didn't specify `-tags=mocks`. Either:
1. Add `-tags=mocks` to your test command, OR
2. Add `//go:build mocks` to the test file that imports mocks

### Tests Not Running
- Without `-tags=mocks`: Only tests that DON'T import mocks will run
- With `-tags=mocks`: ALL tests will run, including those that import mocks

### Mock Not Found During Test
If a test file imports `internal/database/mocks` but you see "package not found":
1. Ensure the test file has `//go:build mocks` at the top
2. Run with `-tags=mocks`

## Related Files
- `.mockery.yaml` - Mockery configuration
- `MOCKERY_IMPLEMENTATION_COMPLETE.md` - Original mockery implementation guide
- `internal/database/mocks/mock_store.go` - Generated mock with build tag
