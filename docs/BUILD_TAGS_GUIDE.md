<!-- file: BUILD_TAGS_GUIDE.md -->
<!-- version: 1.0.0 -->
<!-- guid: 1a2b3c4d-5e6f-7a8b-9c0d-1e2f3a4b5c6d -->
<!-- last-edited: 2026-01-22 -->

# Go Build Tags Guide for Mockery Mocks

## Overview

This project uses Go build tags to automatically exclude generated mock files
from normal test runs. This improves the developer experience by eliminating the
need for manual exclusion flags.

## How It Works

Mock files and their dependent tests are tagged with `//go:build mocks`, which
acts as a build constraint. Files with this tag are only included when the
`mocks` build tag is explicitly specified.

## Files Tagged with `mocks`

### Generated Mock

- `internal/database/mocks/mock_store.go` - Auto-generated testify mock

### Test Files Using Mocks

- `internal/config/persistence_test.go`
- `internal/metadata/enhanced_test.go`
- `internal/operations/queue_test.go`

## Running Tests

### Normal Test Run (Without Mocks)

```bash
go test ./...
```

- Runs all tests that don't depend on mocks
- Tests 20 packages
- Mock files are excluded automatically
- Most tests use real SQLite/PebbleDB implementations

### Test Run With Mocks

```bash
go test -tags=mocks ./...
```

- Runs ALL tests including mock-dependent tests
- Tests 21 packages
- Includes the mocks directory (shows as "[no test files]")
- Required for testing code that uses testify mocks

### Running Specific Mock Tests

```bash
go test -tags=mocks ./internal/config/...
go test -tags=mocks ./internal/metadata/...
go test -tags=mocks ./internal/operations/...
```

## Regenerating Mocks

When regenerating mocks with mockery, you must manually add the build tag:

1. Run mockery:

   ```bash
   mockery
   ```

2. Add the build tag to the top of the generated file:

   ```go
   //go:build mocks

   // Code generated by mockery; DO NOT EDIT.
   ```

3. The build tag must be the first line (before any comments)
4. There must be a blank line after the build tag

## Configuration

The `.mockery.yaml` file contains minimal configuration:

```yaml
all: false
dir: internal/database/mocks
filename: mock_store.go
pkgname: mocks

packages:
  github.com/jdfalk/audiobook-organizer/internal/database:
    interfaces:
      Store:
```

**Note**: Mockery v3 does not support automatic build tag injection via
configuration. The build tag must be added manually after generation.

## Best Practices

1. **Default Testing**: Use `go test ./...` for day-to-day development
   - Mocks are now included by default (no build tags required)
2. **Coverage**: Generate coverage with standard commands:
   ```bash
   go test -cover ./...
   make coverage
   ```

## Why Mocks Are Default

As of 2026-01-25, all `//go:build mocks` tags have been removed from test and
mock files. This means:

- ✅ All tests run by default (no special flags needed)
- ✅ Coverage measurements are always accurate
- ✅ Simpler developer experience
- ✅ No confusion about which tests are running

### Previous Approach (Deprecated)

Previously, mock files and tests used `//go:build mocks` tags to make them
optional. This required using `-tags=mocks` flag to include them. **This is no
longer necessary.**

## Coverage Measurement

### ✅ Standard Coverage Measurement

```bash
# Option 1: Use Makefile (recommended)
make test           # Run all tests
make coverage       # Generate HTML report
make coverage-check # Verify >= 80%

# Option 2: Use go test directly
go test ./... -cover
# Shows: ~86% coverage
```

### Coverage Breakdown

```
Overall: 86.1%
- internal/operations: 90.6% ✅
- internal/metadata:   85.9% ✅
- internal/scanner:    80.7% ✅
- internal/server:     72.1% ⚠️
- cmd:                 78.6% ⚠️
```

### CI/CD Integration

Use standard test commands in CI pipelines:

```yaml
# .github/workflows/ci.yml
- name: Test with coverage
  run: go test ./... -coverprofile=coverage.out

# Or use Makefile
- name: Test with coverage
  run: make coverage-check
```

### Summary

| Command               | Coverage        | Status         |
| --------------------- | --------------- | -------------- |
| `go test ./...`       | 86.1%           | ✅ Accurate    |
| `make test`           | 86.1%           | ✅ Recommended |
| `make coverage-check` | Verifies >= 80% | ✅ Best for CI |

**All mocks are included by default - no special flags needed!**

## Related Files

- `.mockery.yaml` - Mockery configuration
- `MOCKERY_IMPLEMENTATION_COMPLETE.md` - Original mockery implementation guide
- `internal/database/mocks/mock_store.go` - Generated mock with build tag
- `Makefile` - Test targets with proper mocks tags

## References

- [Go Build Tags Documentation](https://pkg.go.dev/cmd/go#hdr-Build_constraints)
- [Mockery v3 Documentation](https://vektra.github.io/mockery/latest/)
- [Testify Mock Documentation](https://pkg.go.dev/github.com/stretchr/testify/mock)
