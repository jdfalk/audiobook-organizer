=== RUN   TestRunSuccess
2026/01/24 13:06:12 Operation queue initialized with 2 workers
2026/01/24 13:06:12 Shutting down operation queue...
2026/01/24 13:06:12 Worker 1 started
2026/01/24 13:06:12 Worker 1 stopped
2026/01/24 13:06:12 Worker 0 started
2026/01/24 13:06:12 Worker 0 stopped
2026/01/24 13:06:12 Operation queue shut down gracefully
--- PASS: TestRunSuccess (0.00s)
=== RUN   TestRunError
2026/01/24 13:06:12 Operation queue initialized with 2 workers
boom
2026/01/24 13:06:12 Shutting down operation queue...
2026/01/24 13:06:12 Worker 1 started
2026/01/24 13:06:12 Worker 1 stopped
2026/01/24 13:06:12 Worker 0 started
2026/01/24 13:06:12 Worker 0 stopped
2026/01/24 13:06:12 Operation queue shut down gracefully
--- PASS: TestRunError (0.00s)
PASS
coverage: 87.5% of statements
ok  	github.com/jdfalk/audiobook-organizer	(cached)	coverage: 87.5% of statements
=== RUN   TestCommandsRunWithStubs
2026/01/24 13:19:01 root.go:498: === Audiobook Organizer Started ===
2026/01/24 13:19:01 root.go:499: Log file: logs/audiobook-organizer-2026-01-24.log
Using database: /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestCommandsRunWithStubs1000430325/001/db.sqlite (sqlite)
Scanning directory: /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestCommandsRunWithStubs1000430325/001
Found 0 audiobooks
Using database: /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestCommandsRunWithStubs1000430325/001/db.sqlite (sqlite)
Generating playlists for audiobook series...
Playlists saved to: /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestCommandsRunWithStubs1000430325/001/playlists
Using database: /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestCommandsRunWithStubs1000430325/001/db.sqlite (sqlite)
Updating audio file tags with series information...
2026/01/24 13:19:01 root.go:498: === Audiobook Organizer Started ===
2026/01/24 13:19:01 root.go:499: Log file: logs/audiobook-organizer-2026-01-24.log
Using database: /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestCommandsRunWithStubs1000430325/001/db.sqlite (sqlite)
Scanning directory: /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestCommandsRunWithStubs1000430325/001
Found 0 audiobooks
Processing audiobooks and identifying series...
Generating playlists...
Updating audio file tags...

Audiobook organization complete!
- Database: /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestCommandsRunWithStubs1000430325/001/db.sqlite
- Playlists: /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestCommandsRunWithStubs1000430325/001/playlists
2026/01/24 13:19:01 root.go:498: === Audiobook Organizer Started ===
2026/01/24 13:19:01 root.go:499: Log file: logs/audiobook-organizer-2026-01-24.log
Using database: /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestCommandsRunWithStubs1000430325/001/db.sqlite (sqlite)
Settings encryption initialized
Configuration loaded from database
  - Root dir (organize output): /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestCommandsRunWithStubs1000430325/001
  - OpenAI API key: (not set)
  - Import paths (scan paths): 0 configured
Starting audiobook organizer web server...
2026/01/24 13:19:01 events.go:302: Event hub initialized
Real-time event hub initialized
Operation queue initialized with 2 workers
Shutting down operation queue...
--- PASS: TestCommandsRunWithStubs (0.00s)
=== RUN   TestScanCommandErrorPaths
2026/01/24 13:19:01 root.go:498: === Audiobook Organizer Started ===
2026/01/24 13:19:01 root.go:499: Log file: logs/audiobook-organizer-2026-01-24.log
Using database: /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestScanCommandErrorPaths3256402824/001/db.sqlite (sqlite)
Scanning directory: /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestScanCommandErrorPaths3256402824/001
2026/01/24 13:19:01 root.go:498: === Audiobook Organizer Started ===
2026/01/24 13:19:01 root.go:499: Log file: logs/audiobook-organizer-2026-01-24.log
Using database: /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestScanCommandErrorPaths3256402824/001/db.sqlite (sqlite)
Scanning directory: /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestScanCommandErrorPaths3256402824/001
Found 1 audiobooks
--- PASS: TestScanCommandErrorPaths (0.00s)
=== RUN   TestServeCommandErrorPaths
2026/01/24 13:19:01 root.go:498: === Audiobook Organizer Started ===
2026/01/24 13:19:01 root.go:499: Log file: logs/audiobook-organizer-2026-01-24.log
Using database: /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestServeCommandErrorPaths3251595937/001/db.sqlite (sqlite)
2026/01/24 13:19:01 root.go:498: === Audiobook Organizer Started ===
2026/01/24 13:19:01 root.go:499: Log file: logs/audiobook-organizer-2026-01-24.log
Using database: /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestServeCommandErrorPaths3251595937/001/db.sqlite (sqlite)
Settings encryption initialized
Configuration loaded from database
  - Root dir (organize output): 
  - OpenAI API key: (not set)
  - Import paths (scan paths): 0 configured
Starting audiobook organizer web server...
2026/01/24 13:19:01 events.go:298: Warning: event hub already initialized
Real-time event hub initialized
Operation queue initialized with 2 workers
Shutting down operation queue...
--- PASS: TestServeCommandErrorPaths (0.00s)
=== RUN   TestPlaylistCommandError
Using database: /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestPlaylistCommandError223498784/001/db.sqlite (sqlite)
Generating playlists for audiobook series...
--- PASS: TestPlaylistCommandError (0.00s)
=== RUN   TestTagCommandError
Using database: /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestTagCommandError2243425543/001/db.sqlite (sqlite)
Updating audio file tags with series information...
--- PASS: TestTagCommandError (0.00s)
=== RUN   TestOrganizeCommandError
2026/01/24 13:19:01 root.go:498: === Audiobook Organizer Started ===
2026/01/24 13:19:01 root.go:499: Log file: logs/audiobook-organizer-2026-01-24.log
--- PASS: TestOrganizeCommandError (0.00s)
=== RUN   TestStoreInitializationError
2026/01/24 13:19:01 root.go:498: === Audiobook Organizer Started ===
2026/01/24 13:19:01 root.go:499: Log file: logs/audiobook-organizer-2026-01-24.log
--- PASS: TestStoreInitializationError (0.00s)
=== RUN   TestTruncateString
--- PASS: TestTruncateString (0.00s)
=== RUN   TestHasPlaceholder
--- PASS: TestHasPlaceholder (0.00s)
=== RUN   TestPromptYesNo
confirm? Type 'yes' to confirm: --- PASS: TestPromptYesNo (0.00s)
=== RUN   TestRunDiagnosticsQueryErrors
--- PASS: TestRunDiagnosticsQueryErrors (0.00s)
=== RUN   TestRunDiagnosticsQuerySuccess
2026/01/24 13:19:01 migrations.go:111: Current database version: 0
2026/01/24 13:19:01 migrations.go:126: Applying 10 migrations...
2026/01/24 13:19:01 migrations.go:130: Applying migration 1: Initial schema with authors, series, books, playlists
2026/01/24 13:19:01 migrations.go:208:   - Validating basic schema (authors, series, books, playlists)
2026/01/24 13:19:01 migrations.go:146: Migration 1 completed successfully
2026/01/24 13:19:01 migrations.go:130: Applying migration 2: Add import paths and operations tables
2026/01/24 13:19:01 migrations.go:215:   - Adding import paths and operations support
2026/01/24 13:19:01 migrations.go:146: Migration 2 completed successfully
2026/01/24 13:19:01 migrations.go:130: Applying migration 3: Add user preferences
2026/01/24 13:19:01 migrations.go:222:   - Adding user preferences support
2026/01/24 13:19:01 migrations.go:146: Migration 3 completed successfully
2026/01/24 13:19:01 migrations.go:130: Applying migration 4: Add extended Pebble keyspace (users, sessions, segments, playback)
2026/01/24 13:19:01 migrations.go:229:   - Adding extended Pebble keyspace (users, sessions, segments, playback)
2026/01/24 13:19:01 migrations.go:146: Migration 4 completed successfully
2026/01/24 13:19:01 migrations.go:130: Applying migration 5: Add media info and version management fields to books
2026/01/24 13:19:01 migrations.go:235:   - Adding media info and version management fields to books table
2026/01/24 13:19:01 migrations.go:260:     - Executing: ALTER TABLE books ADD COLUMN bitrate_kbps INTEGER
2026/01/24 13:19:01 migrations.go:264:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:260:     - Executing: ALTER TABLE books ADD COLUMN codec TEXT
2026/01/24 13:19:01 migrations.go:264:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:260:     - Executing: ALTER TABLE books ADD COLUMN sample_rate_hz INTEGER
2026/01/24 13:19:01 migrations.go:264:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:260:     - Executing: ALTER TABLE books ADD COLUMN channels INTEGER
2026/01/24 13:19:01 migrations.go:264:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:260:     - Executing: ALTER TABLE books ADD COLUMN bit_depth INTEGER
2026/01/24 13:19:01 migrations.go:264:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:260:     - Executing: ALTER TABLE books ADD COLUMN quality TEXT
2026/01/24 13:19:01 migrations.go:264:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:260:     - Executing: ALTER TABLE books ADD COLUMN is_primary_version BOOLEAN DEFAULT 1
2026/01/24 13:19:01 migrations.go:264:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:260:     - Executing: ALTER TABLE books ADD COLUMN version_group_id TEXT
2026/01/24 13:19:01 migrations.go:264:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:260:     - Executing: ALTER TABLE books ADD COLUMN version_notes TEXT
2026/01/24 13:19:01 migrations.go:264:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:278:     - Creating index: CREATE INDEX IF NOT EXISTS idx_books_version_group ON books(version_group_id)
2026/01/24 13:19:01 migrations.go:278:     - Creating index: CREATE INDEX IF NOT EXISTS idx_books_is_primary ON books(is_primary_version)
2026/01/24 13:19:01 migrations.go:284:   - Media info and version management fields added successfully
2026/01/24 13:19:01 migrations.go:146: Migration 5 completed successfully
2026/01/24 13:19:01 migrations.go:130: Applying migration 6: Add original and organized file hash tracking
2026/01/24 13:19:01 migrations.go:290:   - Adding original/organized file hash columns to books table
2026/01/24 13:19:01 migrations.go:304:     - Executing: ALTER TABLE books ADD COLUMN original_file_hash TEXT
2026/01/24 13:19:01 migrations.go:307:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:304:     - Executing: ALTER TABLE books ADD COLUMN organized_file_hash TEXT
2026/01/24 13:19:01 migrations.go:307:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:320:     - Creating index: CREATE INDEX IF NOT EXISTS idx_books_original_hash ON books(original_file_hash)
2026/01/24 13:19:01 migrations.go:320:     - Creating index: CREATE INDEX IF NOT EXISTS idx_books_organized_hash ON books(organized_file_hash)
2026/01/24 13:19:01 migrations.go:146: Migration 6 completed successfully
2026/01/24 13:19:01 migrations.go:130: Applying migration 7: Rename import paths to import paths
2026/01/24 13:19:01 migrations.go:336:   - Renaming import paths to import paths
2026/01/24 13:19:01 migrations.go:146: Migration 7 completed successfully
2026/01/24 13:19:01 migrations.go:130: Applying migration 8: Add do_not_import table for hash blocklist
2026/01/24 13:19:01 migrations.go:373:   - Adding do_not_import table for hash blocklist
2026/01/24 13:19:01 migrations.go:387:     - Executing: CREATE TABLE IF NOT EXISTS do_not_import (
				hash TEXT PRIMARY KEY NOT NULL,
				reason TEXT NOT NULL,
				created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
			)
2026/01/24 13:19:01 migrations.go:387:     - Executing: CREATE INDEX IF NOT EXISTS idx_do_not_import_hash ON do_not_import(hash)
2026/01/24 13:19:01 migrations.go:146: Migration 8 completed successfully
2026/01/24 13:19:01 migrations.go:130: Applying migration 9: Add state machine and lifecycle fields to books
2026/01/24 13:19:01 migrations.go:405:   - Adding state machine and lifecycle fields to books table
2026/01/24 13:19:01 migrations.go:421:     - Executing: ALTER TABLE books ADD COLUMN library_state TEXT DEFAULT 'imported'
2026/01/24 13:19:01 migrations.go:424:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:421:     - Executing: ALTER TABLE books ADD COLUMN quantity INTEGER DEFAULT 1
2026/01/24 13:19:01 migrations.go:424:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:421:     - Executing: ALTER TABLE books ADD COLUMN marked_for_deletion BOOLEAN DEFAULT 0
2026/01/24 13:19:01 migrations.go:424:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:421:     - Executing: ALTER TABLE books ADD COLUMN marked_for_deletion_at DATETIME
2026/01/24 13:19:01 migrations.go:424:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:438:     - Creating index: CREATE INDEX IF NOT EXISTS idx_books_library_state ON books(library_state)
2026/01/24 13:19:01 migrations.go:438:     - Creating index: CREATE INDEX IF NOT EXISTS idx_books_marked_for_deletion ON books(marked_for_deletion)
2026/01/24 13:19:01 migrations.go:444:   - State machine fields added successfully
2026/01/24 13:19:01 migrations.go:146: Migration 9 completed successfully
2026/01/24 13:19:01 migrations.go:130: Applying migration 10: Add metadata_states table for metadata provenance
2026/01/24 13:19:01 migrations.go:450:   - Adding metadata_states table for metadata provenance
2026/01/24 13:19:01 migrations.go:472:     - Executing: CREATE TABLE IF NOT EXISTS metadata_states (
			book_id TEXT NOT NULL,
			field TEXT NOT NULL,
			fetched_value TEXT,
			override_value TEXT,
			override_locked BOOLEAN NOT NULL DEFAULT 0,
			updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
			PRIMARY KEY (book_id, field)
		)
2026/01/24 13:19:01 migrations.go:472:     - Executing: CREATE INDEX IF NOT EXISTS idx_metadata_states_book ON metadata_states(book_id)
2026/01/24 13:19:01 migrations.go:146: Migration 10 completed successfully
2026/01/24 13:19:01 migrations.go:149: All migrations completed. Current version: 10
 1. ID: 01KFRKP6V10DAPP3X53BJQWAST
    Title: Diag Book
    FilePath: /tmp/diag.mp3
---
--- PASS: TestRunDiagnosticsQuerySuccess (0.02s)
=== RUN   TestRunDiagnosticsQueryNoBooks
2026/01/24 13:19:01 migrations.go:111: Current database version: 0
2026/01/24 13:19:01 migrations.go:126: Applying 10 migrations...
2026/01/24 13:19:01 migrations.go:130: Applying migration 1: Initial schema with authors, series, books, playlists
2026/01/24 13:19:01 migrations.go:208:   - Validating basic schema (authors, series, books, playlists)
2026/01/24 13:19:01 migrations.go:146: Migration 1 completed successfully
2026/01/24 13:19:01 migrations.go:130: Applying migration 2: Add import paths and operations tables
2026/01/24 13:19:01 migrations.go:215:   - Adding import paths and operations support
2026/01/24 13:19:01 migrations.go:146: Migration 2 completed successfully
2026/01/24 13:19:01 migrations.go:130: Applying migration 3: Add user preferences
2026/01/24 13:19:01 migrations.go:222:   - Adding user preferences support
2026/01/24 13:19:01 migrations.go:146: Migration 3 completed successfully
2026/01/24 13:19:01 migrations.go:130: Applying migration 4: Add extended Pebble keyspace (users, sessions, segments, playback)
2026/01/24 13:19:01 migrations.go:229:   - Adding extended Pebble keyspace (users, sessions, segments, playback)
2026/01/24 13:19:01 migrations.go:146: Migration 4 completed successfully
2026/01/24 13:19:01 migrations.go:130: Applying migration 5: Add media info and version management fields to books
2026/01/24 13:19:01 migrations.go:235:   - Adding media info and version management fields to books table
2026/01/24 13:19:01 migrations.go:260:     - Executing: ALTER TABLE books ADD COLUMN bitrate_kbps INTEGER
2026/01/24 13:19:01 migrations.go:264:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:260:     - Executing: ALTER TABLE books ADD COLUMN codec TEXT
2026/01/24 13:19:01 migrations.go:264:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:260:     - Executing: ALTER TABLE books ADD COLUMN sample_rate_hz INTEGER
2026/01/24 13:19:01 migrations.go:264:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:260:     - Executing: ALTER TABLE books ADD COLUMN channels INTEGER
2026/01/24 13:19:01 migrations.go:264:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:260:     - Executing: ALTER TABLE books ADD COLUMN bit_depth INTEGER
2026/01/24 13:19:01 migrations.go:264:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:260:     - Executing: ALTER TABLE books ADD COLUMN quality TEXT
2026/01/24 13:19:01 migrations.go:264:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:260:     - Executing: ALTER TABLE books ADD COLUMN is_primary_version BOOLEAN DEFAULT 1
2026/01/24 13:19:01 migrations.go:264:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:260:     - Executing: ALTER TABLE books ADD COLUMN version_group_id TEXT
2026/01/24 13:19:01 migrations.go:264:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:260:     - Executing: ALTER TABLE books ADD COLUMN version_notes TEXT
2026/01/24 13:19:01 migrations.go:264:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:278:     - Creating index: CREATE INDEX IF NOT EXISTS idx_books_version_group ON books(version_group_id)
2026/01/24 13:19:01 migrations.go:278:     - Creating index: CREATE INDEX IF NOT EXISTS idx_books_is_primary ON books(is_primary_version)
2026/01/24 13:19:01 migrations.go:284:   - Media info and version management fields added successfully
2026/01/24 13:19:01 migrations.go:146: Migration 5 completed successfully
2026/01/24 13:19:01 migrations.go:130: Applying migration 6: Add original and organized file hash tracking
2026/01/24 13:19:01 migrations.go:290:   - Adding original/organized file hash columns to books table
2026/01/24 13:19:01 migrations.go:304:     - Executing: ALTER TABLE books ADD COLUMN original_file_hash TEXT
2026/01/24 13:19:01 migrations.go:307:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:304:     - Executing: ALTER TABLE books ADD COLUMN organized_file_hash TEXT
2026/01/24 13:19:01 migrations.go:307:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:320:     - Creating index: CREATE INDEX IF NOT EXISTS idx_books_original_hash ON books(original_file_hash)
2026/01/24 13:19:01 migrations.go:320:     - Creating index: CREATE INDEX IF NOT EXISTS idx_books_organized_hash ON books(organized_file_hash)
2026/01/24 13:19:01 migrations.go:146: Migration 6 completed successfully
2026/01/24 13:19:01 migrations.go:130: Applying migration 7: Rename import paths to import paths
2026/01/24 13:19:01 migrations.go:336:   - Renaming import paths to import paths
2026/01/24 13:19:01 migrations.go:146: Migration 7 completed successfully
2026/01/24 13:19:01 migrations.go:130: Applying migration 8: Add do_not_import table for hash blocklist
2026/01/24 13:19:01 migrations.go:373:   - Adding do_not_import table for hash blocklist
2026/01/24 13:19:01 migrations.go:387:     - Executing: CREATE TABLE IF NOT EXISTS do_not_import (
				hash TEXT PRIMARY KEY NOT NULL,
				reason TEXT NOT NULL,
				created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
			)
2026/01/24 13:19:01 migrations.go:387:     - Executing: CREATE INDEX IF NOT EXISTS idx_do_not_import_hash ON do_not_import(hash)
2026/01/24 13:19:01 migrations.go:146: Migration 8 completed successfully
2026/01/24 13:19:01 migrations.go:130: Applying migration 9: Add state machine and lifecycle fields to books
2026/01/24 13:19:01 migrations.go:405:   - Adding state machine and lifecycle fields to books table
2026/01/24 13:19:01 migrations.go:421:     - Executing: ALTER TABLE books ADD COLUMN library_state TEXT DEFAULT 'imported'
2026/01/24 13:19:01 migrations.go:424:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:421:     - Executing: ALTER TABLE books ADD COLUMN quantity INTEGER DEFAULT 1
2026/01/24 13:19:01 migrations.go:424:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:421:     - Executing: ALTER TABLE books ADD COLUMN marked_for_deletion BOOLEAN DEFAULT 0
2026/01/24 13:19:01 migrations.go:424:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:421:     - Executing: ALTER TABLE books ADD COLUMN marked_for_deletion_at DATETIME
2026/01/24 13:19:01 migrations.go:424:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:438:     - Creating index: CREATE INDEX IF NOT EXISTS idx_books_library_state ON books(library_state)
2026/01/24 13:19:01 migrations.go:438:     - Creating index: CREATE INDEX IF NOT EXISTS idx_books_marked_for_deletion ON books(marked_for_deletion)
2026/01/24 13:19:01 migrations.go:444:   - State machine fields added successfully
2026/01/24 13:19:01 migrations.go:146: Migration 9 completed successfully
2026/01/24 13:19:01 migrations.go:130: Applying migration 10: Add metadata_states table for metadata provenance
2026/01/24 13:19:01 migrations.go:450:   - Adding metadata_states table for metadata provenance
2026/01/24 13:19:01 migrations.go:472:     - Executing: CREATE TABLE IF NOT EXISTS metadata_states (
			book_id TEXT NOT NULL,
			field TEXT NOT NULL,
			fetched_value TEXT,
			override_value TEXT,
			override_locked BOOLEAN NOT NULL DEFAULT 0,
			updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
			PRIMARY KEY (book_id, field)
		)
2026/01/24 13:19:01 migrations.go:472:     - Executing: CREATE INDEX IF NOT EXISTS idx_metadata_states_book ON metadata_states(book_id)
2026/01/24 13:19:01 migrations.go:146: Migration 10 completed successfully
2026/01/24 13:19:01 migrations.go:149: All migrations completed. Current version: 10
No books found.
--- PASS: TestRunDiagnosticsQueryNoBooks (0.02s)
=== RUN   TestRunDiagnosticsQueryPrintsHashes
2026/01/24 13:19:01 migrations.go:111: Current database version: 0
2026/01/24 13:19:01 migrations.go:126: Applying 10 migrations...
2026/01/24 13:19:01 migrations.go:130: Applying migration 1: Initial schema with authors, series, books, playlists
2026/01/24 13:19:01 migrations.go:208:   - Validating basic schema (authors, series, books, playlists)
2026/01/24 13:19:01 migrations.go:146: Migration 1 completed successfully
2026/01/24 13:19:01 migrations.go:130: Applying migration 2: Add import paths and operations tables
2026/01/24 13:19:01 migrations.go:215:   - Adding import paths and operations support
2026/01/24 13:19:01 migrations.go:146: Migration 2 completed successfully
2026/01/24 13:19:01 migrations.go:130: Applying migration 3: Add user preferences
2026/01/24 13:19:01 migrations.go:222:   - Adding user preferences support
2026/01/24 13:19:01 migrations.go:146: Migration 3 completed successfully
2026/01/24 13:19:01 migrations.go:130: Applying migration 4: Add extended Pebble keyspace (users, sessions, segments, playback)
2026/01/24 13:19:01 migrations.go:229:   - Adding extended Pebble keyspace (users, sessions, segments, playback)
2026/01/24 13:19:01 migrations.go:146: Migration 4 completed successfully
2026/01/24 13:19:01 migrations.go:130: Applying migration 5: Add media info and version management fields to books
2026/01/24 13:19:01 migrations.go:235:   - Adding media info and version management fields to books table
2026/01/24 13:19:01 migrations.go:260:     - Executing: ALTER TABLE books ADD COLUMN bitrate_kbps INTEGER
2026/01/24 13:19:01 migrations.go:264:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:260:     - Executing: ALTER TABLE books ADD COLUMN codec TEXT
2026/01/24 13:19:01 migrations.go:264:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:260:     - Executing: ALTER TABLE books ADD COLUMN sample_rate_hz INTEGER
2026/01/24 13:19:01 migrations.go:264:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:260:     - Executing: ALTER TABLE books ADD COLUMN channels INTEGER
2026/01/24 13:19:01 migrations.go:264:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:260:     - Executing: ALTER TABLE books ADD COLUMN bit_depth INTEGER
2026/01/24 13:19:01 migrations.go:264:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:260:     - Executing: ALTER TABLE books ADD COLUMN quality TEXT
2026/01/24 13:19:01 migrations.go:264:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:260:     - Executing: ALTER TABLE books ADD COLUMN is_primary_version BOOLEAN DEFAULT 1
2026/01/24 13:19:01 migrations.go:264:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:260:     - Executing: ALTER TABLE books ADD COLUMN version_group_id TEXT
2026/01/24 13:19:01 migrations.go:264:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:260:     - Executing: ALTER TABLE books ADD COLUMN version_notes TEXT
2026/01/24 13:19:01 migrations.go:264:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:278:     - Creating index: CREATE INDEX IF NOT EXISTS idx_books_version_group ON books(version_group_id)
2026/01/24 13:19:01 migrations.go:278:     - Creating index: CREATE INDEX IF NOT EXISTS idx_books_is_primary ON books(is_primary_version)
2026/01/24 13:19:01 migrations.go:284:   - Media info and version management fields added successfully
2026/01/24 13:19:01 migrations.go:146: Migration 5 completed successfully
2026/01/24 13:19:01 migrations.go:130: Applying migration 6: Add original and organized file hash tracking
2026/01/24 13:19:01 migrations.go:290:   - Adding original/organized file hash columns to books table
2026/01/24 13:19:01 migrations.go:304:     - Executing: ALTER TABLE books ADD COLUMN original_file_hash TEXT
2026/01/24 13:19:01 migrations.go:307:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:304:     - Executing: ALTER TABLE books ADD COLUMN organized_file_hash TEXT
2026/01/24 13:19:01 migrations.go:307:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:320:     - Creating index: CREATE INDEX IF NOT EXISTS idx_books_original_hash ON books(original_file_hash)
2026/01/24 13:19:01 migrations.go:320:     - Creating index: CREATE INDEX IF NOT EXISTS idx_books_organized_hash ON books(organized_file_hash)
2026/01/24 13:19:01 migrations.go:146: Migration 6 completed successfully
2026/01/24 13:19:01 migrations.go:130: Applying migration 7: Rename import paths to import paths
2026/01/24 13:19:01 migrations.go:336:   - Renaming import paths to import paths
2026/01/24 13:19:01 migrations.go:146: Migration 7 completed successfully
2026/01/24 13:19:01 migrations.go:130: Applying migration 8: Add do_not_import table for hash blocklist
2026/01/24 13:19:01 migrations.go:373:   - Adding do_not_import table for hash blocklist
2026/01/24 13:19:01 migrations.go:387:     - Executing: CREATE TABLE IF NOT EXISTS do_not_import (
				hash TEXT PRIMARY KEY NOT NULL,
				reason TEXT NOT NULL,
				created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
			)
2026/01/24 13:19:01 migrations.go:387:     - Executing: CREATE INDEX IF NOT EXISTS idx_do_not_import_hash ON do_not_import(hash)
2026/01/24 13:19:01 migrations.go:146: Migration 8 completed successfully
2026/01/24 13:19:01 migrations.go:130: Applying migration 9: Add state machine and lifecycle fields to books
2026/01/24 13:19:01 migrations.go:405:   - Adding state machine and lifecycle fields to books table
2026/01/24 13:19:01 migrations.go:421:     - Executing: ALTER TABLE books ADD COLUMN library_state TEXT DEFAULT 'imported'
2026/01/24 13:19:01 migrations.go:424:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:421:     - Executing: ALTER TABLE books ADD COLUMN quantity INTEGER DEFAULT 1
2026/01/24 13:19:01 migrations.go:424:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:421:     - Executing: ALTER TABLE books ADD COLUMN marked_for_deletion BOOLEAN DEFAULT 0
2026/01/24 13:19:01 migrations.go:424:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:421:     - Executing: ALTER TABLE books ADD COLUMN marked_for_deletion_at DATETIME
2026/01/24 13:19:01 migrations.go:424:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:438:     - Creating index: CREATE INDEX IF NOT EXISTS idx_books_library_state ON books(library_state)
2026/01/24 13:19:01 migrations.go:438:     - Creating index: CREATE INDEX IF NOT EXISTS idx_books_marked_for_deletion ON books(marked_for_deletion)
2026/01/24 13:19:01 migrations.go:444:   - State machine fields added successfully
2026/01/24 13:19:01 migrations.go:146: Migration 9 completed successfully
2026/01/24 13:19:01 migrations.go:130: Applying migration 10: Add metadata_states table for metadata provenance
2026/01/24 13:19:01 migrations.go:450:   - Adding metadata_states table for metadata provenance
2026/01/24 13:19:01 migrations.go:472:     - Executing: CREATE TABLE IF NOT EXISTS metadata_states (
			book_id TEXT NOT NULL,
			field TEXT NOT NULL,
			fetched_value TEXT,
			override_value TEXT,
			override_locked BOOLEAN NOT NULL DEFAULT 0,
			updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
			PRIMARY KEY (book_id, field)
		)
2026/01/24 13:19:01 migrations.go:472:     - Executing: CREATE INDEX IF NOT EXISTS idx_metadata_states_book ON metadata_states(book_id)
2026/01/24 13:19:01 migrations.go:146: Migration 10 completed successfully
2026/01/24 13:19:01 migrations.go:149: All migrations completed. Current version: 10
 1. ID: 01KFRKP6WC4DR7VGQ6M9TF4BK1
    Title: Diag Book
    FilePath: /tmp/diag.mp3
    FileHash: hash
    OriginalHash: orig
    OrganizedHash: organized
---
--- PASS: TestRunDiagnosticsQueryPrintsHashes (0.02s)
=== RUN   TestRunCleanupInvalidBooksDryRun
2026/01/24 13:19:01 migrations.go:111: Current database version: 0
2026/01/24 13:19:01 migrations.go:126: Applying 10 migrations...
2026/01/24 13:19:01 migrations.go:130: Applying migration 1: Initial schema with authors, series, books, playlists
2026/01/24 13:19:01 migrations.go:208:   - Validating basic schema (authors, series, books, playlists)
2026/01/24 13:19:01 migrations.go:146: Migration 1 completed successfully
2026/01/24 13:19:01 migrations.go:130: Applying migration 2: Add import paths and operations tables
2026/01/24 13:19:01 migrations.go:215:   - Adding import paths and operations support
2026/01/24 13:19:01 migrations.go:146: Migration 2 completed successfully
2026/01/24 13:19:01 migrations.go:130: Applying migration 3: Add user preferences
2026/01/24 13:19:01 migrations.go:222:   - Adding user preferences support
2026/01/24 13:19:01 migrations.go:146: Migration 3 completed successfully
2026/01/24 13:19:01 migrations.go:130: Applying migration 4: Add extended Pebble keyspace (users, sessions, segments, playback)
2026/01/24 13:19:01 migrations.go:229:   - Adding extended Pebble keyspace (users, sessions, segments, playback)
2026/01/24 13:19:01 migrations.go:146: Migration 4 completed successfully
2026/01/24 13:19:01 migrations.go:130: Applying migration 5: Add media info and version management fields to books
2026/01/24 13:19:01 migrations.go:235:   - Adding media info and version management fields to books table
2026/01/24 13:19:01 migrations.go:260:     - Executing: ALTER TABLE books ADD COLUMN bitrate_kbps INTEGER
2026/01/24 13:19:01 migrations.go:264:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:260:     - Executing: ALTER TABLE books ADD COLUMN codec TEXT
2026/01/24 13:19:01 migrations.go:264:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:260:     - Executing: ALTER TABLE books ADD COLUMN sample_rate_hz INTEGER
2026/01/24 13:19:01 migrations.go:264:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:260:     - Executing: ALTER TABLE books ADD COLUMN channels INTEGER
2026/01/24 13:19:01 migrations.go:264:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:260:     - Executing: ALTER TABLE books ADD COLUMN bit_depth INTEGER
2026/01/24 13:19:01 migrations.go:264:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:260:     - Executing: ALTER TABLE books ADD COLUMN quality TEXT
2026/01/24 13:19:01 migrations.go:264:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:260:     - Executing: ALTER TABLE books ADD COLUMN is_primary_version BOOLEAN DEFAULT 1
2026/01/24 13:19:01 migrations.go:264:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:260:     - Executing: ALTER TABLE books ADD COLUMN version_group_id TEXT
2026/01/24 13:19:01 migrations.go:264:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:260:     - Executing: ALTER TABLE books ADD COLUMN version_notes TEXT
2026/01/24 13:19:01 migrations.go:264:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:278:     - Creating index: CREATE INDEX IF NOT EXISTS idx_books_version_group ON books(version_group_id)
2026/01/24 13:19:01 migrations.go:278:     - Creating index: CREATE INDEX IF NOT EXISTS idx_books_is_primary ON books(is_primary_version)
2026/01/24 13:19:01 migrations.go:284:   - Media info and version management fields added successfully
2026/01/24 13:19:01 migrations.go:146: Migration 5 completed successfully
2026/01/24 13:19:01 migrations.go:130: Applying migration 6: Add original and organized file hash tracking
2026/01/24 13:19:01 migrations.go:290:   - Adding original/organized file hash columns to books table
2026/01/24 13:19:01 migrations.go:304:     - Executing: ALTER TABLE books ADD COLUMN original_file_hash TEXT
2026/01/24 13:19:01 migrations.go:307:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:304:     - Executing: ALTER TABLE books ADD COLUMN organized_file_hash TEXT
2026/01/24 13:19:01 migrations.go:307:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:320:     - Creating index: CREATE INDEX IF NOT EXISTS idx_books_original_hash ON books(original_file_hash)
2026/01/24 13:19:01 migrations.go:320:     - Creating index: CREATE INDEX IF NOT EXISTS idx_books_organized_hash ON books(organized_file_hash)
2026/01/24 13:19:01 migrations.go:146: Migration 6 completed successfully
2026/01/24 13:19:01 migrations.go:130: Applying migration 7: Rename import paths to import paths
2026/01/24 13:19:01 migrations.go:336:   - Renaming import paths to import paths
2026/01/24 13:19:01 migrations.go:146: Migration 7 completed successfully
2026/01/24 13:19:01 migrations.go:130: Applying migration 8: Add do_not_import table for hash blocklist
2026/01/24 13:19:01 migrations.go:373:   - Adding do_not_import table for hash blocklist
2026/01/24 13:19:01 migrations.go:387:     - Executing: CREATE TABLE IF NOT EXISTS do_not_import (
				hash TEXT PRIMARY KEY NOT NULL,
				reason TEXT NOT NULL,
				created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
			)
2026/01/24 13:19:01 migrations.go:387:     - Executing: CREATE INDEX IF NOT EXISTS idx_do_not_import_hash ON do_not_import(hash)
2026/01/24 13:19:01 migrations.go:146: Migration 8 completed successfully
2026/01/24 13:19:01 migrations.go:130: Applying migration 9: Add state machine and lifecycle fields to books
2026/01/24 13:19:01 migrations.go:405:   - Adding state machine and lifecycle fields to books table
2026/01/24 13:19:01 migrations.go:421:     - Executing: ALTER TABLE books ADD COLUMN library_state TEXT DEFAULT 'imported'
2026/01/24 13:19:01 migrations.go:424:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:421:     - Executing: ALTER TABLE books ADD COLUMN quantity INTEGER DEFAULT 1
2026/01/24 13:19:01 migrations.go:424:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:421:     - Executing: ALTER TABLE books ADD COLUMN marked_for_deletion BOOLEAN DEFAULT 0
2026/01/24 13:19:01 migrations.go:424:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:421:     - Executing: ALTER TABLE books ADD COLUMN marked_for_deletion_at DATETIME
2026/01/24 13:19:01 migrations.go:424:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:438:     - Creating index: CREATE INDEX IF NOT EXISTS idx_books_library_state ON books(library_state)
2026/01/24 13:19:01 migrations.go:438:     - Creating index: CREATE INDEX IF NOT EXISTS idx_books_marked_for_deletion ON books(marked_for_deletion)
2026/01/24 13:19:01 migrations.go:444:   - State machine fields added successfully
2026/01/24 13:19:01 migrations.go:146: Migration 9 completed successfully
2026/01/24 13:19:01 migrations.go:130: Applying migration 10: Add metadata_states table for metadata provenance
2026/01/24 13:19:01 migrations.go:450:   - Adding metadata_states table for metadata provenance
2026/01/24 13:19:01 migrations.go:472:     - Executing: CREATE TABLE IF NOT EXISTS metadata_states (
			book_id TEXT NOT NULL,
			field TEXT NOT NULL,
			fetched_value TEXT,
			override_value TEXT,
			override_locked BOOLEAN NOT NULL DEFAULT 0,
			updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
			PRIMARY KEY (book_id, field)
		)
2026/01/24 13:19:01 migrations.go:472:     - Executing: CREATE INDEX IF NOT EXISTS idx_metadata_states_book ON metadata_states(book_id)
2026/01/24 13:19:01 migrations.go:146: Migration 10 completed successfully
2026/01/24 13:19:01 migrations.go:149: All migrations completed. Current version: 10
Inspecting books in /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestRunCleanupInvalidBooksDryRun3318329667/001/cleanup.db (sqlite)
Found 1 invalid records:
 1. ID: 01KFRKP6X2KTTZVG0Z8GJV910G
    Title: Bad Book
    Path:  /tmp/{author}/bad.mp3
Dry run enabled; no deletions were performed.
--- PASS: TestRunCleanupInvalidBooksDryRun (0.02s)
=== RUN   TestRunCleanupInvalidBooksPromptAbort
2026/01/24 13:19:01 migrations.go:111: Current database version: 0
2026/01/24 13:19:01 migrations.go:126: Applying 10 migrations...
2026/01/24 13:19:01 migrations.go:130: Applying migration 1: Initial schema with authors, series, books, playlists
2026/01/24 13:19:01 migrations.go:208:   - Validating basic schema (authors, series, books, playlists)
2026/01/24 13:19:01 migrations.go:146: Migration 1 completed successfully
2026/01/24 13:19:01 migrations.go:130: Applying migration 2: Add import paths and operations tables
2026/01/24 13:19:01 migrations.go:215:   - Adding import paths and operations support
2026/01/24 13:19:01 migrations.go:146: Migration 2 completed successfully
2026/01/24 13:19:01 migrations.go:130: Applying migration 3: Add user preferences
2026/01/24 13:19:01 migrations.go:222:   - Adding user preferences support
2026/01/24 13:19:01 migrations.go:146: Migration 3 completed successfully
2026/01/24 13:19:01 migrations.go:130: Applying migration 4: Add extended Pebble keyspace (users, sessions, segments, playback)
2026/01/24 13:19:01 migrations.go:229:   - Adding extended Pebble keyspace (users, sessions, segments, playback)
2026/01/24 13:19:01 migrations.go:146: Migration 4 completed successfully
2026/01/24 13:19:01 migrations.go:130: Applying migration 5: Add media info and version management fields to books
2026/01/24 13:19:01 migrations.go:235:   - Adding media info and version management fields to books table
2026/01/24 13:19:01 migrations.go:260:     - Executing: ALTER TABLE books ADD COLUMN bitrate_kbps INTEGER
2026/01/24 13:19:01 migrations.go:264:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:260:     - Executing: ALTER TABLE books ADD COLUMN codec TEXT
2026/01/24 13:19:01 migrations.go:264:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:260:     - Executing: ALTER TABLE books ADD COLUMN sample_rate_hz INTEGER
2026/01/24 13:19:01 migrations.go:264:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:260:     - Executing: ALTER TABLE books ADD COLUMN channels INTEGER
2026/01/24 13:19:01 migrations.go:264:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:260:     - Executing: ALTER TABLE books ADD COLUMN bit_depth INTEGER
2026/01/24 13:19:01 migrations.go:264:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:260:     - Executing: ALTER TABLE books ADD COLUMN quality TEXT
2026/01/24 13:19:01 migrations.go:264:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:260:     - Executing: ALTER TABLE books ADD COLUMN is_primary_version BOOLEAN DEFAULT 1
2026/01/24 13:19:01 migrations.go:264:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:260:     - Executing: ALTER TABLE books ADD COLUMN version_group_id TEXT
2026/01/24 13:19:01 migrations.go:264:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:260:     - Executing: ALTER TABLE books ADD COLUMN version_notes TEXT
2026/01/24 13:19:01 migrations.go:264:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:278:     - Creating index: CREATE INDEX IF NOT EXISTS idx_books_version_group ON books(version_group_id)
2026/01/24 13:19:01 migrations.go:278:     - Creating index: CREATE INDEX IF NOT EXISTS idx_books_is_primary ON books(is_primary_version)
2026/01/24 13:19:01 migrations.go:284:   - Media info and version management fields added successfully
2026/01/24 13:19:01 migrations.go:146: Migration 5 completed successfully
2026/01/24 13:19:01 migrations.go:130: Applying migration 6: Add original and organized file hash tracking
2026/01/24 13:19:01 migrations.go:290:   - Adding original/organized file hash columns to books table
2026/01/24 13:19:01 migrations.go:304:     - Executing: ALTER TABLE books ADD COLUMN original_file_hash TEXT
2026/01/24 13:19:01 migrations.go:307:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:304:     - Executing: ALTER TABLE books ADD COLUMN organized_file_hash TEXT
2026/01/24 13:19:01 migrations.go:307:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:320:     - Creating index: CREATE INDEX IF NOT EXISTS idx_books_original_hash ON books(original_file_hash)
2026/01/24 13:19:01 migrations.go:320:     - Creating index: CREATE INDEX IF NOT EXISTS idx_books_organized_hash ON books(organized_file_hash)
2026/01/24 13:19:01 migrations.go:146: Migration 6 completed successfully
2026/01/24 13:19:01 migrations.go:130: Applying migration 7: Rename import paths to import paths
2026/01/24 13:19:01 migrations.go:336:   - Renaming import paths to import paths
2026/01/24 13:19:01 migrations.go:146: Migration 7 completed successfully
2026/01/24 13:19:01 migrations.go:130: Applying migration 8: Add do_not_import table for hash blocklist
2026/01/24 13:19:01 migrations.go:373:   - Adding do_not_import table for hash blocklist
2026/01/24 13:19:01 migrations.go:387:     - Executing: CREATE TABLE IF NOT EXISTS do_not_import (
				hash TEXT PRIMARY KEY NOT NULL,
				reason TEXT NOT NULL,
				created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
			)
2026/01/24 13:19:01 migrations.go:387:     - Executing: CREATE INDEX IF NOT EXISTS idx_do_not_import_hash ON do_not_import(hash)
2026/01/24 13:19:01 migrations.go:146: Migration 8 completed successfully
2026/01/24 13:19:01 migrations.go:130: Applying migration 9: Add state machine and lifecycle fields to books
2026/01/24 13:19:01 migrations.go:405:   - Adding state machine and lifecycle fields to books table
2026/01/24 13:19:01 migrations.go:421:     - Executing: ALTER TABLE books ADD COLUMN library_state TEXT DEFAULT 'imported'
2026/01/24 13:19:01 migrations.go:424:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:421:     - Executing: ALTER TABLE books ADD COLUMN quantity INTEGER DEFAULT 1
2026/01/24 13:19:01 migrations.go:424:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:421:     - Executing: ALTER TABLE books ADD COLUMN marked_for_deletion BOOLEAN DEFAULT 0
2026/01/24 13:19:01 migrations.go:424:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:421:     - Executing: ALTER TABLE books ADD COLUMN marked_for_deletion_at DATETIME
2026/01/24 13:19:01 migrations.go:424:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:438:     - Creating index: CREATE INDEX IF NOT EXISTS idx_books_library_state ON books(library_state)
2026/01/24 13:19:01 migrations.go:438:     - Creating index: CREATE INDEX IF NOT EXISTS idx_books_marked_for_deletion ON books(marked_for_deletion)
2026/01/24 13:19:01 migrations.go:444:   - State machine fields added successfully
2026/01/24 13:19:01 migrations.go:146: Migration 9 completed successfully
2026/01/24 13:19:01 migrations.go:130: Applying migration 10: Add metadata_states table for metadata provenance
2026/01/24 13:19:01 migrations.go:450:   - Adding metadata_states table for metadata provenance
2026/01/24 13:19:01 migrations.go:472:     - Executing: CREATE TABLE IF NOT EXISTS metadata_states (
			book_id TEXT NOT NULL,
			field TEXT NOT NULL,
			fetched_value TEXT,
			override_value TEXT,
			override_locked BOOLEAN NOT NULL DEFAULT 0,
			updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
			PRIMARY KEY (book_id, field)
		)
2026/01/24 13:19:01 migrations.go:472:     - Executing: CREATE INDEX IF NOT EXISTS idx_metadata_states_book ON metadata_states(book_id)
2026/01/24 13:19:01 migrations.go:146: Migration 10 completed successfully
2026/01/24 13:19:01 migrations.go:149: All migrations completed. Current version: 10
Inspecting books in /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestRunCleanupInvalidBooksPromptAbort4278903521/001/cleanup-abort.db (sqlite)
Found 1 invalid records:
 1. ID: 01KFRKP6XSNTY2ZVTM6V58CN8Z
    Title: Bad Book
    Path:  /tmp/{author}/bad.mp3
Delete 1 records? Type 'yes' to confirm: Aborted. No records deleted.
--- PASS: TestRunCleanupInvalidBooksPromptAbort (0.02s)
=== RUN   TestRunCleanupInvalidBooksDelete
2026/01/24 13:19:01 migrations.go:111: Current database version: 0
2026/01/24 13:19:01 migrations.go:126: Applying 10 migrations...
2026/01/24 13:19:01 migrations.go:130: Applying migration 1: Initial schema with authors, series, books, playlists
2026/01/24 13:19:01 migrations.go:208:   - Validating basic schema (authors, series, books, playlists)
2026/01/24 13:19:01 migrations.go:146: Migration 1 completed successfully
2026/01/24 13:19:01 migrations.go:130: Applying migration 2: Add import paths and operations tables
2026/01/24 13:19:01 migrations.go:215:   - Adding import paths and operations support
2026/01/24 13:19:01 migrations.go:146: Migration 2 completed successfully
2026/01/24 13:19:01 migrations.go:130: Applying migration 3: Add user preferences
2026/01/24 13:19:01 migrations.go:222:   - Adding user preferences support
2026/01/24 13:19:01 migrations.go:146: Migration 3 completed successfully
2026/01/24 13:19:01 migrations.go:130: Applying migration 4: Add extended Pebble keyspace (users, sessions, segments, playback)
2026/01/24 13:19:01 migrations.go:229:   - Adding extended Pebble keyspace (users, sessions, segments, playback)
2026/01/24 13:19:01 migrations.go:146: Migration 4 completed successfully
2026/01/24 13:19:01 migrations.go:130: Applying migration 5: Add media info and version management fields to books
2026/01/24 13:19:01 migrations.go:235:   - Adding media info and version management fields to books table
2026/01/24 13:19:01 migrations.go:260:     - Executing: ALTER TABLE books ADD COLUMN bitrate_kbps INTEGER
2026/01/24 13:19:01 migrations.go:264:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:260:     - Executing: ALTER TABLE books ADD COLUMN codec TEXT
2026/01/24 13:19:01 migrations.go:264:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:260:     - Executing: ALTER TABLE books ADD COLUMN sample_rate_hz INTEGER
2026/01/24 13:19:01 migrations.go:264:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:260:     - Executing: ALTER TABLE books ADD COLUMN channels INTEGER
2026/01/24 13:19:01 migrations.go:264:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:260:     - Executing: ALTER TABLE books ADD COLUMN bit_depth INTEGER
2026/01/24 13:19:01 migrations.go:264:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:260:     - Executing: ALTER TABLE books ADD COLUMN quality TEXT
2026/01/24 13:19:01 migrations.go:264:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:260:     - Executing: ALTER TABLE books ADD COLUMN is_primary_version BOOLEAN DEFAULT 1
2026/01/24 13:19:01 migrations.go:264:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:260:     - Executing: ALTER TABLE books ADD COLUMN version_group_id TEXT
2026/01/24 13:19:01 migrations.go:264:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:260:     - Executing: ALTER TABLE books ADD COLUMN version_notes TEXT
2026/01/24 13:19:01 migrations.go:264:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:278:     - Creating index: CREATE INDEX IF NOT EXISTS idx_books_version_group ON books(version_group_id)
2026/01/24 13:19:01 migrations.go:278:     - Creating index: CREATE INDEX IF NOT EXISTS idx_books_is_primary ON books(is_primary_version)
2026/01/24 13:19:01 migrations.go:284:   - Media info and version management fields added successfully
2026/01/24 13:19:01 migrations.go:146: Migration 5 completed successfully
2026/01/24 13:19:01 migrations.go:130: Applying migration 6: Add original and organized file hash tracking
2026/01/24 13:19:01 migrations.go:290:   - Adding original/organized file hash columns to books table
2026/01/24 13:19:01 migrations.go:304:     - Executing: ALTER TABLE books ADD COLUMN original_file_hash TEXT
2026/01/24 13:19:01 migrations.go:307:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:304:     - Executing: ALTER TABLE books ADD COLUMN organized_file_hash TEXT
2026/01/24 13:19:01 migrations.go:307:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:320:     - Creating index: CREATE INDEX IF NOT EXISTS idx_books_original_hash ON books(original_file_hash)
2026/01/24 13:19:01 migrations.go:320:     - Creating index: CREATE INDEX IF NOT EXISTS idx_books_organized_hash ON books(organized_file_hash)
2026/01/24 13:19:01 migrations.go:146: Migration 6 completed successfully
2026/01/24 13:19:01 migrations.go:130: Applying migration 7: Rename import paths to import paths
2026/01/24 13:19:01 migrations.go:336:   - Renaming import paths to import paths
2026/01/24 13:19:01 migrations.go:146: Migration 7 completed successfully
2026/01/24 13:19:01 migrations.go:130: Applying migration 8: Add do_not_import table for hash blocklist
2026/01/24 13:19:01 migrations.go:373:   - Adding do_not_import table for hash blocklist
2026/01/24 13:19:01 migrations.go:387:     - Executing: CREATE TABLE IF NOT EXISTS do_not_import (
				hash TEXT PRIMARY KEY NOT NULL,
				reason TEXT NOT NULL,
				created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
			)
2026/01/24 13:19:01 migrations.go:387:     - Executing: CREATE INDEX IF NOT EXISTS idx_do_not_import_hash ON do_not_import(hash)
2026/01/24 13:19:01 migrations.go:146: Migration 8 completed successfully
2026/01/24 13:19:01 migrations.go:130: Applying migration 9: Add state machine and lifecycle fields to books
2026/01/24 13:19:01 migrations.go:405:   - Adding state machine and lifecycle fields to books table
2026/01/24 13:19:01 migrations.go:421:     - Executing: ALTER TABLE books ADD COLUMN library_state TEXT DEFAULT 'imported'
2026/01/24 13:19:01 migrations.go:424:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:421:     - Executing: ALTER TABLE books ADD COLUMN quantity INTEGER DEFAULT 1
2026/01/24 13:19:01 migrations.go:424:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:421:     - Executing: ALTER TABLE books ADD COLUMN marked_for_deletion BOOLEAN DEFAULT 0
2026/01/24 13:19:01 migrations.go:424:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:421:     - Executing: ALTER TABLE books ADD COLUMN marked_for_deletion_at DATETIME
2026/01/24 13:19:01 migrations.go:424:     - Column already exists, skipping
2026/01/24 13:19:01 migrations.go:438:     - Creating index: CREATE INDEX IF NOT EXISTS idx_books_library_state ON books(library_state)
2026/01/24 13:19:01 migrations.go:438:     - Creating index: CREATE INDEX IF NOT EXISTS idx_books_marked_for_deletion ON books(marked_for_deletion)
2026/01/24 13:19:01 migrations.go:444:   - State machine fields added successfully
2026/01/24 13:19:01 migrations.go:146: Migration 9 completed successfully
2026/01/24 13:19:01 migrations.go:130: Applying migration 10: Add metadata_states table for metadata provenance
2026/01/24 13:19:01 migrations.go:450:   - Adding metadata_states table for metadata provenance
2026/01/24 13:19:01 migrations.go:472:     - Executing: CREATE TABLE IF NOT EXISTS metadata_states (
			book_id TEXT NOT NULL,
			field TEXT NOT NULL,
			fetched_value TEXT,
			override_value TEXT,
			override_locked BOOLEAN NOT NULL DEFAULT 0,
			updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
			PRIMARY KEY (book_id, field)
		)
2026/01/24 13:19:01 migrations.go:472:     - Executing: CREATE INDEX IF NOT EXISTS idx_metadata_states_book ON metadata_states(book_id)
2026/01/24 13:19:01 migrations.go:146: Migration 10 completed successfully
2026/01/24 13:19:01 migrations.go:149: All migrations completed. Current version: 10
Inspecting books in /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestRunCleanupInvalidBooksDelete2358255600/001/cleanup-delete.db (sqlite)
Found 1 invalid records:
 1. ID: 01KFRKP6YEV9KWG2DQW6BQ2T0B
    Title: Bad Book
    Path:  /tmp/{author}/bad.mp3
Delete 1 records? Type 'yes' to confirm: Deleted 1 invalid records. Run a rescan to repopulate clean entries.
--- PASS: TestRunCleanupInvalidBooksDelete (0.02s)
=== RUN   TestRunRawPebbleQuery
2026/01/24 13:19:01 open.go:986: [JOB 1] WAL file /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestRunRawPebbleQuery3070889989/001/000002.log with log number 000002 stopped reading at offset: 547; replayed 10 keys in 9 batches
Key: book:01KFRKP71PD92KTQ3WC70RH4PW
Value length: 87 bytes
Value preview: {"id":"01KFRKP71PD92KTQ3WC70RH4PW","title":"Pebble Book","file_path":"/tmp/pebble.mp3"}
---
--- PASS: TestRunRawPebbleQuery (0.14s)
=== RUN   TestExecuteHelp
Audiobook Organizer scans your audiobook files, identifies series
using metadata and filenames, and generates iTunes-compatible playlists.

It also updates metadata tags in the audio files to include series information.

Usage:
  audiobook-organizer [command]

Available Commands:
  completion       Generate the autocompletion script for the specified shell
  diagnostics      Debugging and cleanup helpers
  help             Help about any command
  inspect-metadata Extract metadata for a single audiobook file
  organize         Run the complete organization process
  playlist         Generate playlists for audiobook series
  scan             Scan audiobook directories
  serve            Start the web server
  tag              Update audio file tags with series information

Flags:
      --config string                     config file (default is $HOME/.audiobook-organizer.yaml)
      --db string                         path to database (default: audiobooks.pebble for PebbleDB) (default "audiobooks.pebble")
      --db-type string                    database type: pebble (default) or sqlite (default "pebble")
      --dir string                        root directory containing audiobooks
      --enable-sqlite3-i-know-the-risks   enable SQLite3 database (WARNING: cross-compilation issues, PebbleDB recommended)
  -h, --help                              help for audiobook-organizer
      --playlists string                  directory to store generated playlists (default "playlists")

Use "audiobook-organizer [command] --help" for more information about a command.
--- PASS: TestExecuteHelp (0.00s)
=== RUN   TestPromptYesNoNo
confirm? Type 'yes' to confirm: --- PASS: TestPromptYesNoNo (0.00s)
=== RUN   TestTruncateStringWithBuffer
--- PASS: TestTruncateStringWithBuffer (0.00s)
=== RUN   TestEnsureDiagnosticsStoreError
--- PASS: TestEnsureDiagnosticsStoreError (0.00s)
=== RUN   TestEnsureDiagnosticsStorePebble
2026/01/24 13:19:01 migrations.go:111: Current database version: 0
2026/01/24 13:19:01 migrations.go:126: Applying 10 migrations...
2026/01/24 13:19:01 migrations.go:130: Applying migration 1: Initial schema with authors, series, books, playlists
2026/01/24 13:19:01 migrations.go:208:   - Validating basic schema (authors, series, books, playlists)
2026/01/24 13:19:01 migrations.go:146: Migration 1 completed successfully
2026/01/24 13:19:01 migrations.go:130: Applying migration 2: Add import paths and operations tables
2026/01/24 13:19:01 migrations.go:215:   - Adding import paths and operations support
2026/01/24 13:19:01 migrations.go:146: Migration 2 completed successfully
2026/01/24 13:19:01 migrations.go:130: Applying migration 3: Add user preferences
2026/01/24 13:19:01 migrations.go:222:   - Adding user preferences support
2026/01/24 13:19:01 migrations.go:146: Migration 3 completed successfully
2026/01/24 13:19:01 migrations.go:130: Applying migration 4: Add extended Pebble keyspace (users, sessions, segments, playback)
2026/01/24 13:19:01 migrations.go:229:   - Adding extended Pebble keyspace (users, sessions, segments, playback)
2026/01/24 13:19:01 migrations.go:146: Migration 4 completed successfully
2026/01/24 13:19:01 migrations.go:130: Applying migration 5: Add media info and version management fields to books
2026/01/24 13:19:01 migrations.go:235:   - Adding media info and version management fields to books table
2026/01/24 13:19:01 migrations.go:241:   - Non-SQLite store detected, skipping SQL migration
2026/01/24 13:19:01 migrations.go:146: Migration 5 completed successfully
2026/01/24 13:19:01 migrations.go:130: Applying migration 6: Add original and organized file hash tracking
2026/01/24 13:19:01 migrations.go:290:   - Adding original/organized file hash columns to books table
2026/01/24 13:19:01 migrations.go:294:   - Non-SQLite store detected, skipping SQL migration
2026/01/24 13:19:01 migrations.go:146: Migration 6 completed successfully
2026/01/24 13:19:01 migrations.go:130: Applying migration 7: Rename import paths to import paths
2026/01/24 13:19:01 migrations.go:336:   - Renaming import paths to import paths
2026/01/24 13:19:01 migrations.go:146: Migration 7 completed successfully
2026/01/24 13:19:01 migrations.go:130: Applying migration 8: Add do_not_import table for hash blocklist
2026/01/24 13:19:01 migrations.go:373:   - Adding do_not_import table for hash blocklist
2026/01/24 13:19:01 migrations.go:395:     - Pebble keyspace for do_not_import enabled
2026/01/24 13:19:01 migrations.go:146: Migration 8 completed successfully
2026/01/24 13:19:01 migrations.go:130: Applying migration 9: Add state machine and lifecycle fields to books
2026/01/24 13:19:01 migrations.go:405:   - Adding state machine and lifecycle fields to books table
2026/01/24 13:19:01 migrations.go:409:   - Non-SQLite store detected, skipping SQL migration
2026/01/24 13:19:01 migrations.go:146: Migration 9 completed successfully
2026/01/24 13:19:01 migrations.go:130: Applying migration 10: Add metadata_states table for metadata provenance
2026/01/24 13:19:01 migrations.go:450:   - Adding metadata_states table for metadata provenance
2026/01/24 13:19:01 migrations.go:454:   - Non-SQLite store detected, skipping SQL migration
2026/01/24 13:19:01 migrations.go:146: Migration 10 completed successfully
2026/01/24 13:19:01 migrations.go:149: All migrations completed. Current version: 10
--- PASS: TestEnsureDiagnosticsStorePebble (0.31s)
=== RUN   TestRunCleanupInvalidBooksForceMode
2026/01/24 13:19:02 migrations.go:111: Current database version: 0
2026/01/24 13:19:02 migrations.go:126: Applying 10 migrations...
2026/01/24 13:19:02 migrations.go:130: Applying migration 1: Initial schema with authors, series, books, playlists
2026/01/24 13:19:02 migrations.go:208:   - Validating basic schema (authors, series, books, playlists)
2026/01/24 13:19:02 migrations.go:146: Migration 1 completed successfully
2026/01/24 13:19:02 migrations.go:130: Applying migration 2: Add import paths and operations tables
2026/01/24 13:19:02 migrations.go:215:   - Adding import paths and operations support
2026/01/24 13:19:02 migrations.go:146: Migration 2 completed successfully
2026/01/24 13:19:02 migrations.go:130: Applying migration 3: Add user preferences
2026/01/24 13:19:02 migrations.go:222:   - Adding user preferences support
2026/01/24 13:19:02 migrations.go:146: Migration 3 completed successfully
2026/01/24 13:19:02 migrations.go:130: Applying migration 4: Add extended Pebble keyspace (users, sessions, segments, playback)
2026/01/24 13:19:02 migrations.go:229:   - Adding extended Pebble keyspace (users, sessions, segments, playback)
2026/01/24 13:19:02 migrations.go:146: Migration 4 completed successfully
2026/01/24 13:19:02 migrations.go:130: Applying migration 5: Add media info and version management fields to books
2026/01/24 13:19:02 migrations.go:235:   - Adding media info and version management fields to books table
2026/01/24 13:19:02 migrations.go:260:     - Executing: ALTER TABLE books ADD COLUMN bitrate_kbps INTEGER
2026/01/24 13:19:02 migrations.go:264:     - Column already exists, skipping
2026/01/24 13:19:02 migrations.go:260:     - Executing: ALTER TABLE books ADD COLUMN codec TEXT
2026/01/24 13:19:02 migrations.go:264:     - Column already exists, skipping
2026/01/24 13:19:02 migrations.go:260:     - Executing: ALTER TABLE books ADD COLUMN sample_rate_hz INTEGER
2026/01/24 13:19:02 migrations.go:264:     - Column already exists, skipping
2026/01/24 13:19:02 migrations.go:260:     - Executing: ALTER TABLE books ADD COLUMN channels INTEGER
2026/01/24 13:19:02 migrations.go:264:     - Column already exists, skipping
2026/01/24 13:19:02 migrations.go:260:     - Executing: ALTER TABLE books ADD COLUMN bit_depth INTEGER
2026/01/24 13:19:02 migrations.go:264:     - Column already exists, skipping
2026/01/24 13:19:02 migrations.go:260:     - Executing: ALTER TABLE books ADD COLUMN quality TEXT
2026/01/24 13:19:02 migrations.go:264:     - Column already exists, skipping
2026/01/24 13:19:02 migrations.go:260:     - Executing: ALTER TABLE books ADD COLUMN is_primary_version BOOLEAN DEFAULT 1
2026/01/24 13:19:02 migrations.go:264:     - Column already exists, skipping
2026/01/24 13:19:02 migrations.go:260:     - Executing: ALTER TABLE books ADD COLUMN version_group_id TEXT
2026/01/24 13:19:02 migrations.go:264:     - Column already exists, skipping
2026/01/24 13:19:02 migrations.go:260:     - Executing: ALTER TABLE books ADD COLUMN version_notes TEXT
2026/01/24 13:19:02 migrations.go:264:     - Column already exists, skipping
2026/01/24 13:19:02 migrations.go:278:     - Creating index: CREATE INDEX IF NOT EXISTS idx_books_version_group ON books(version_group_id)
2026/01/24 13:19:02 migrations.go:278:     - Creating index: CREATE INDEX IF NOT EXISTS idx_books_is_primary ON books(is_primary_version)
2026/01/24 13:19:02 migrations.go:284:   - Media info and version management fields added successfully
2026/01/24 13:19:02 migrations.go:146: Migration 5 completed successfully
2026/01/24 13:19:02 migrations.go:130: Applying migration 6: Add original and organized file hash tracking
2026/01/24 13:19:02 migrations.go:290:   - Adding original/organized file hash columns to books table
2026/01/24 13:19:02 migrations.go:304:     - Executing: ALTER TABLE books ADD COLUMN original_file_hash TEXT
2026/01/24 13:19:02 migrations.go:307:     - Column already exists, skipping
2026/01/24 13:19:02 migrations.go:304:     - Executing: ALTER TABLE books ADD COLUMN organized_file_hash TEXT
2026/01/24 13:19:02 migrations.go:307:     - Column already exists, skipping
2026/01/24 13:19:02 migrations.go:320:     - Creating index: CREATE INDEX IF NOT EXISTS idx_books_original_hash ON books(original_file_hash)
2026/01/24 13:19:02 migrations.go:320:     - Creating index: CREATE INDEX IF NOT EXISTS idx_books_organized_hash ON books(organized_file_hash)
2026/01/24 13:19:02 migrations.go:146: Migration 6 completed successfully
2026/01/24 13:19:02 migrations.go:130: Applying migration 7: Rename import paths to import paths
2026/01/24 13:19:02 migrations.go:336:   - Renaming import paths to import paths
2026/01/24 13:19:02 migrations.go:146: Migration 7 completed successfully
2026/01/24 13:19:02 migrations.go:130: Applying migration 8: Add do_not_import table for hash blocklist
2026/01/24 13:19:02 migrations.go:373:   - Adding do_not_import table for hash blocklist
2026/01/24 13:19:02 migrations.go:387:     - Executing: CREATE TABLE IF NOT EXISTS do_not_import (
				hash TEXT PRIMARY KEY NOT NULL,
				reason TEXT NOT NULL,
				created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
			)
2026/01/24 13:19:02 migrations.go:387:     - Executing: CREATE INDEX IF NOT EXISTS idx_do_not_import_hash ON do_not_import(hash)
2026/01/24 13:19:02 migrations.go:146: Migration 8 completed successfully
2026/01/24 13:19:02 migrations.go:130: Applying migration 9: Add state machine and lifecycle fields to books
2026/01/24 13:19:02 migrations.go:405:   - Adding state machine and lifecycle fields to books table
2026/01/24 13:19:02 migrations.go:421:     - Executing: ALTER TABLE books ADD COLUMN library_state TEXT DEFAULT 'imported'
2026/01/24 13:19:02 migrations.go:424:     - Column already exists, skipping
2026/01/24 13:19:02 migrations.go:421:     - Executing: ALTER TABLE books ADD COLUMN quantity INTEGER DEFAULT 1
2026/01/24 13:19:02 migrations.go:424:     - Column already exists, skipping
2026/01/24 13:19:02 migrations.go:421:     - Executing: ALTER TABLE books ADD COLUMN marked_for_deletion BOOLEAN DEFAULT 0
2026/01/24 13:19:02 migrations.go:424:     - Column already exists, skipping
2026/01/24 13:19:02 migrations.go:421:     - Executing: ALTER TABLE books ADD COLUMN marked_for_deletion_at DATETIME
2026/01/24 13:19:02 migrations.go:424:     - Column already exists, skipping
2026/01/24 13:19:02 migrations.go:438:     - Creating index: CREATE INDEX IF NOT EXISTS idx_books_library_state ON books(library_state)
2026/01/24 13:19:02 migrations.go:438:     - Creating index: CREATE INDEX IF NOT EXISTS idx_books_marked_for_deletion ON books(marked_for_deletion)
2026/01/24 13:19:02 migrations.go:444:   - State machine fields added successfully
2026/01/24 13:19:02 migrations.go:146: Migration 9 completed successfully
2026/01/24 13:19:02 migrations.go:130: Applying migration 10: Add metadata_states table for metadata provenance
2026/01/24 13:19:02 migrations.go:450:   - Adding metadata_states table for metadata provenance
2026/01/24 13:19:02 migrations.go:472:     - Executing: CREATE TABLE IF NOT EXISTS metadata_states (
			book_id TEXT NOT NULL,
			field TEXT NOT NULL,
			fetched_value TEXT,
			override_value TEXT,
			override_locked BOOLEAN NOT NULL DEFAULT 0,
			updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
			PRIMARY KEY (book_id, field)
		)
2026/01/24 13:19:02 migrations.go:472:     - Executing: CREATE INDEX IF NOT EXISTS idx_metadata_states_book ON metadata_states(book_id)
2026/01/24 13:19:02 migrations.go:146: Migration 10 completed successfully
2026/01/24 13:19:02 migrations.go:149: All migrations completed. Current version: 10
Inspecting books in /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestRunCleanupInvalidBooksForceMode515166177/001/cleanup-force.db (sqlite)
Found 1 invalid records:
 1. ID: 01KFRKP7GHVMH2GVKA3D5YC81P
    Title: Bad Book
    Path:  /tmp/{author}/bad.mp3
Dry run enabled; no deletions were performed.
--- PASS: TestRunCleanupInvalidBooksForceMode (0.14s)
=== RUN   TestRunDiagnosticsQueryPebble
2026/01/24 13:19:02 open.go:986: [JOB 1] WAL file /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestRunDiagnosticsQueryPebble933365085/001/000002.log with log number 000002 stopped reading at offset: 543; replayed 10 keys in 9 batches
2026/01/24 13:19:02 migrations.go:111: Current database version: 0
2026/01/24 13:19:02 migrations.go:126: Applying 10 migrations...
2026/01/24 13:19:02 migrations.go:130: Applying migration 1: Initial schema with authors, series, books, playlists
2026/01/24 13:19:02 migrations.go:208:   - Validating basic schema (authors, series, books, playlists)
2026/01/24 13:19:02 migrations.go:146: Migration 1 completed successfully
2026/01/24 13:19:02 migrations.go:130: Applying migration 2: Add import paths and operations tables
2026/01/24 13:19:02 migrations.go:215:   - Adding import paths and operations support
2026/01/24 13:19:02 migrations.go:146: Migration 2 completed successfully
2026/01/24 13:19:02 migrations.go:130: Applying migration 3: Add user preferences
2026/01/24 13:19:02 migrations.go:222:   - Adding user preferences support
2026/01/24 13:19:02 migrations.go:146: Migration 3 completed successfully
2026/01/24 13:19:02 migrations.go:130: Applying migration 4: Add extended Pebble keyspace (users, sessions, segments, playback)
2026/01/24 13:19:02 migrations.go:229:   - Adding extended Pebble keyspace (users, sessions, segments, playback)
2026/01/24 13:19:02 migrations.go:146: Migration 4 completed successfully
2026/01/24 13:19:02 migrations.go:130: Applying migration 5: Add media info and version management fields to books
2026/01/24 13:19:02 migrations.go:235:   - Adding media info and version management fields to books table
2026/01/24 13:19:02 migrations.go:241:   - Non-SQLite store detected, skipping SQL migration
2026/01/24 13:19:02 migrations.go:146: Migration 5 completed successfully
2026/01/24 13:19:02 migrations.go:130: Applying migration 6: Add original and organized file hash tracking
2026/01/24 13:19:02 migrations.go:290:   - Adding original/organized file hash columns to books table
2026/01/24 13:19:02 migrations.go:294:   - Non-SQLite store detected, skipping SQL migration
2026/01/24 13:19:02 migrations.go:146: Migration 6 completed successfully
2026/01/24 13:19:02 migrations.go:130: Applying migration 7: Rename import paths to import paths
2026/01/24 13:19:02 migrations.go:336:   - Renaming import paths to import paths
2026/01/24 13:19:02 migrations.go:146: Migration 7 completed successfully
2026/01/24 13:19:02 migrations.go:130: Applying migration 8: Add do_not_import table for hash blocklist
2026/01/24 13:19:02 migrations.go:373:   - Adding do_not_import table for hash blocklist
2026/01/24 13:19:02 migrations.go:395:     - Pebble keyspace for do_not_import enabled
2026/01/24 13:19:02 migrations.go:146: Migration 8 completed successfully
2026/01/24 13:19:02 migrations.go:130: Applying migration 9: Add state machine and lifecycle fields to books
2026/01/24 13:19:02 migrations.go:405:   - Adding state machine and lifecycle fields to books table
2026/01/24 13:19:02 migrations.go:409:   - Non-SQLite store detected, skipping SQL migration
2026/01/24 13:19:02 migrations.go:146: Migration 9 completed successfully
2026/01/24 13:19:02 migrations.go:130: Applying migration 10: Add metadata_states table for metadata provenance
2026/01/24 13:19:02 migrations.go:450:   - Adding metadata_states table for metadata provenance
2026/01/24 13:19:02 migrations.go:454:   - Non-SQLite store detected, skipping SQL migration
2026/01/24 13:19:02 migrations.go:146: Migration 10 completed successfully
2026/01/24 13:19:02 migrations.go:149: All migrations completed. Current version: 10
 1. ID: 01KFRKP7MT25V0A5NVP127B9T4
    Title: Pebble Test
    FilePath: /tmp/test.mp3
---
--- PASS: TestRunDiagnosticsQueryPebble (0.42s)
=== RUN   TestFormatMetadataValue
--- PASS: TestFormatMetadataValue (0.00s)
=== RUN   TestSetupFileLogging
2026/01/24 13:19:02 root.go:498: === Audiobook Organizer Started ===
2026/01/24 13:19:02 root.go:499: Log file: logs/audiobook-organizer-2026-01-24.log
--- PASS: TestSetupFileLogging (0.00s)
=== RUN   TestSetupFileLoggingErrorHandling
--- PASS: TestSetupFileLoggingErrorHandling (0.00s)
=== RUN   TestInitConfigWithViper
Using config file: /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestInitConfigWithViper4017038554/001/config.yaml
--- PASS: TestInitConfigWithViper (0.00s)
=== RUN   TestInitConfigDefaults
--- PASS: TestInitConfigDefaults (0.00s)
=== RUN   TestInitConfigCreatesDirectories
--- PASS: TestInitConfigCreatesDirectories (0.00s)
=== RUN   TestInitConfigUsesHomeConfig
Using config file: /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestInitConfigUsesHomeConfig753202904/001/.audiobook-organizer.yaml
--- PASS: TestInitConfigUsesHomeConfig (0.00s)
=== RUN   TestPrintMetadataField
--- PASS: TestPrintMetadataField (0.00s)
=== RUN   TestScanCommandMissingRootDir
2026/01/24 13:19:02 root.go:498: === Audiobook Organizer Started ===
2026/01/24 13:19:02 root.go:499: Log file: logs/audiobook-organizer-2026-01-24.log
--- PASS: TestScanCommandMissingRootDir (0.00s)
=== RUN   TestMetadataInspectRequiresFile
--- PASS: TestMetadataInspectRequiresFile (0.00s)
PASS
coverage: 78.6% of statements
ok  	github.com/jdfalk/audiobook-organizer/cmd	1.617s	coverage: 78.6% of statements
=== RUN   TestNewOpenAIParser_Disabled
--- PASS: TestNewOpenAIParser_Disabled (0.00s)
=== RUN   TestNewOpenAIParser_Enabled
--- PASS: TestNewOpenAIParser_Enabled (0.00s)
=== RUN   TestIsEnabled
=== RUN   TestIsEnabled/disabled_with_no_key
=== RUN   TestIsEnabled/disabled_explicitly
=== RUN   TestIsEnabled/enabled_with_key
--- PASS: TestIsEnabled (0.00s)
    --- PASS: TestIsEnabled/disabled_with_no_key (0.00s)
    --- PASS: TestIsEnabled/disabled_explicitly (0.00s)
    --- PASS: TestIsEnabled/enabled_with_key (0.00s)
=== RUN   TestParseFilename_Disabled
--- PASS: TestParseFilename_Disabled (0.00s)
=== RUN   TestParseBatch_Disabled
--- PASS: TestParseBatch_Disabled (0.00s)
=== RUN   TestParseBatch_EmptyInput
--- PASS: TestParseBatch_EmptyInput (0.00s)
=== RUN   TestTestConnection_Disabled
--- PASS: TestTestConnection_Disabled (0.00s)
=== RUN   TestParsedMetadata_JSONMarshaling
--- PASS: TestParsedMetadata_JSONMarshaling (0.00s)
=== RUN   TestParsedMetadata_JSONOmitEmpty
--- PASS: TestParsedMetadata_JSONOmitEmpty (0.00s)
=== RUN   TestTestConnection_Timeout
--- PASS: TestTestConnection_Timeout (0.00s)
=== RUN   TestParseBatch_BatchSizeLimit
    openai_parser_test.go:243: Batch size would be limited to 20 in actual execution
--- PASS: TestParseBatch_BatchSizeLimit (0.00s)
=== RUN   TestOpenAIParser_ModelConfiguration
--- PASS: TestOpenAIParser_ModelConfiguration (0.00s)
=== RUN   TestOpenAIParser_RetryConfiguration
--- PASS: TestOpenAIParser_RetryConfiguration (0.00s)
=== RUN   TestParseFilename_APIError
--- PASS: TestParseFilename_APIError (0.21s)
=== RUN   TestParseFilename_InvalidJSON
--- PASS: TestParseFilename_InvalidJSON (0.00s)
=== RUN   TestParseBatch_APIError
--- PASS: TestParseBatch_APIError (0.09s)
=== RUN   TestParseBatch_InvalidJSONResponse
--- PASS: TestParseBatch_InvalidJSONResponse (0.00s)
=== RUN   TestParseBatch_SingleFile
--- PASS: TestParseBatch_SingleFile (0.06s)
=== RUN   TestParseBatch_ExactlyMaxSize
--- PASS: TestParseBatch_ExactlyMaxSize (0.08s)
=== RUN   TestParseBatch_OverMaxSize
--- PASS: TestParseBatch_OverMaxSize (0.07s)
=== RUN   TestParsedMetadata_PartialData
--- PASS: TestParsedMetadata_PartialData (0.00s)
=== RUN   TestParsedMetadata_AllFields
--- PASS: TestParsedMetadata_AllFields (0.00s)
=== RUN   TestParsedMetadata_ZeroValues
    openai_parser_test.go:508: JSON output: {"title":"Standalone Book","author":"Author Name","confidence":"low"}
--- PASS: TestParsedMetadata_ZeroValues (0.00s)
=== RUN   TestParseFilename_ContextCancellation
--- PASS: TestParseFilename_ContextCancellation (0.00s)
=== RUN   TestParseBatch_ContextCancellation
--- PASS: TestParseBatch_ContextCancellation (0.00s)
=== RUN   TestOpenAIParser_ClientNilWhenDisabled
--- PASS: TestOpenAIParser_ClientNilWhenDisabled (0.00s)
=== RUN   TestParsedMetadata_ConfidenceLevels
--- PASS: TestParsedMetadata_ConfidenceLevels (0.00s)
=== RUN   TestOpenAIParser_StructFields
--- PASS: TestOpenAIParser_StructFields (0.00s)
=== RUN   TestNewOpenAIParser_BothDisabledConditions
--- PASS: TestNewOpenAIParser_BothDisabledConditions (0.00s)
=== RUN   TestParseBatch_LargeInputTruncation
--- PASS: TestParseBatch_LargeInputTruncation (0.07s)
=== RUN   TestParsedMetadata_UnmarshalValidJSON
--- PASS: TestParsedMetadata_UnmarshalValidJSON (0.00s)
=== RUN   TestParseBatch_UnmarshalValidBatchJSON
--- PASS: TestParseBatch_UnmarshalValidBatchJSON (0.00s)
=== RUN   TestParsedMetadata_MalformedJSON
=== RUN   TestParsedMetadata_MalformedJSON/incomplete_object
=== RUN   TestParsedMetadata_MalformedJSON/wrong_type_for_number_field
=== RUN   TestParsedMetadata_MalformedJSON/null_json
=== RUN   TestParsedMetadata_MalformedJSON/empty_string
=== RUN   TestParsedMetadata_MalformedJSON/array_instead_of_object
--- PASS: TestParsedMetadata_MalformedJSON (0.00s)
    --- PASS: TestParsedMetadata_MalformedJSON/incomplete_object (0.00s)
    --- PASS: TestParsedMetadata_MalformedJSON/wrong_type_for_number_field (0.00s)
    --- PASS: TestParsedMetadata_MalformedJSON/null_json (0.00s)
    --- PASS: TestParsedMetadata_MalformedJSON/empty_string (0.00s)
    --- PASS: TestParsedMetadata_MalformedJSON/array_instead_of_object (0.00s)
=== RUN   TestParseBatch_MalformedBatchJSON
=== RUN   TestParseBatch_MalformedBatchJSON/incomplete_array
=== RUN   TestParseBatch_MalformedBatchJSON/object_instead_of_array
=== RUN   TestParseBatch_MalformedBatchJSON/mixed_array_types
--- PASS: TestParseBatch_MalformedBatchJSON (0.00s)
    --- PASS: TestParseBatch_MalformedBatchJSON/incomplete_array (0.00s)
    --- PASS: TestParseBatch_MalformedBatchJSON/object_instead_of_array (0.00s)
    --- PASS: TestParseBatch_MalformedBatchJSON/mixed_array_types (0.00s)
=== RUN   TestParsedMetadata_EdgeCaseValues
=== RUN   TestParsedMetadata_EdgeCaseValues/very_long_title
=== RUN   TestParsedMetadata_EdgeCaseValues/special_characters
=== RUN   TestParsedMetadata_EdgeCaseValues/unicode_characters
=== RUN   TestParsedMetadata_EdgeCaseValues/large_series_number
=== RUN   TestParsedMetadata_EdgeCaseValues/negative_numbers
--- PASS: TestParsedMetadata_EdgeCaseValues (0.00s)
    --- PASS: TestParsedMetadata_EdgeCaseValues/very_long_title (0.00s)
    --- PASS: TestParsedMetadata_EdgeCaseValues/special_characters (0.00s)
    --- PASS: TestParsedMetadata_EdgeCaseValues/unicode_characters (0.00s)
    --- PASS: TestParsedMetadata_EdgeCaseValues/large_series_number (0.00s)
    --- PASS: TestParsedMetadata_EdgeCaseValues/negative_numbers (0.00s)
=== RUN   TestOpenAIParser_ErrorMessageFormat
=== RUN   TestOpenAIParser_ErrorMessageFormat/ParseFilename_disabled
=== RUN   TestOpenAIParser_ErrorMessageFormat/ParseBatch_disabled
=== RUN   TestOpenAIParser_ErrorMessageFormat/TestConnection_disabled
--- PASS: TestOpenAIParser_ErrorMessageFormat (0.00s)
    --- PASS: TestOpenAIParser_ErrorMessageFormat/ParseFilename_disabled (0.00s)
    --- PASS: TestOpenAIParser_ErrorMessageFormat/ParseBatch_disabled (0.00s)
    --- PASS: TestOpenAIParser_ErrorMessageFormat/TestConnection_disabled (0.00s)
=== RUN   TestParseBatch_EmptyStringFilenames
--- PASS: TestParseBatch_EmptyStringFilenames (0.09s)
=== RUN   TestParseFilename_EmptyFilename
--- PASS: TestParseFilename_EmptyFilename (0.09s)
=== RUN   TestParseFilename_VeryLongFilename
--- PASS: TestParseFilename_VeryLongFilename (0.09s)
=== RUN   TestParsedMetadata_EmptyConfidence
--- PASS: TestParsedMetadata_EmptyConfidence (0.00s)
=== RUN   TestParseFilename_Integration
    openai_parser_test.go:981: Skipping integration test: OPENAI_API_KEY not set
--- SKIP: TestParseFilename_Integration (0.00s)
=== RUN   TestParseBatch_Integration
    openai_parser_test.go:1037: Skipping integration test: OPENAI_API_KEY not set
--- SKIP: TestParseBatch_Integration (0.00s)
=== RUN   TestTestConnection_Integration
    openai_parser_test.go:1085: Skipping integration test: OPENAI_API_KEY not set
--- SKIP: TestTestConnection_Integration (0.00s)
=== RUN   TestParsedMetadata_JSONTags
--- PASS: TestParsedMetadata_JSONTags (0.00s)
=== RUN   TestParsedMetadata_OmitEmptyBehavior
--- PASS: TestParsedMetadata_OmitEmptyBehavior (0.00s)
=== RUN   TestParsedMetadata_NonPointerUnmarshal
--- PASS: TestParsedMetadata_NonPointerUnmarshal (0.00s)
=== RUN   TestParsedMetadata_PointerInSliceUnmarshal
--- PASS: TestParsedMetadata_PointerInSliceUnmarshal (0.00s)
=== RUN   TestOpenAIParser_DefaultValues
=== RUN   TestOpenAIParser_DefaultValues/enabled_with_key
=== RUN   TestOpenAIParser_DefaultValues/disabled
--- PASS: TestOpenAIParser_DefaultValues (0.00s)
    --- PASS: TestOpenAIParser_DefaultValues/enabled_with_key (0.00s)
    --- PASS: TestOpenAIParser_DefaultValues/disabled (0.00s)
=== RUN   TestParsedMetadata_CompletenessCoverage
--- PASS: TestParsedMetadata_CompletenessCoverage (0.00s)
=== RUN   TestParseBatch_NilFilenames
--- PASS: TestParseBatch_NilFilenames (0.00s)
=== RUN   TestParseMetadataFromJSON
=== RUN   TestParseMetadataFromJSON/valid_complete_metadata
=== RUN   TestParseMetadataFromJSON/valid_minimal_metadata
=== RUN   TestParseMetadataFromJSON/invalid_JSON
=== RUN   TestParseMetadataFromJSON/empty_JSON
=== RUN   TestParseMetadataFromJSON/array_instead_of_object
--- PASS: TestParseMetadataFromJSON (0.00s)
    --- PASS: TestParseMetadataFromJSON/valid_complete_metadata (0.00s)
    --- PASS: TestParseMetadataFromJSON/valid_minimal_metadata (0.00s)
    --- PASS: TestParseMetadataFromJSON/invalid_JSON (0.00s)
    --- PASS: TestParseMetadataFromJSON/empty_JSON (0.00s)
    --- PASS: TestParseMetadataFromJSON/array_instead_of_object (0.00s)
=== RUN   TestParseBatchMetadataFromJSON
=== RUN   TestParseBatchMetadataFromJSON/valid_batch_with_multiple_items
=== RUN   TestParseBatchMetadataFromJSON/valid_batch_with_single_item
=== RUN   TestParseBatchMetadataFromJSON/empty_array
=== RUN   TestParseBatchMetadataFromJSON/invalid_JSON
=== RUN   TestParseBatchMetadataFromJSON/object_instead_of_array
=== RUN   TestParseBatchMetadataFromJSON/null_JSON
--- PASS: TestParseBatchMetadataFromJSON (0.00s)
    --- PASS: TestParseBatchMetadataFromJSON/valid_batch_with_multiple_items (0.00s)
    --- PASS: TestParseBatchMetadataFromJSON/valid_batch_with_single_item (0.00s)
    --- PASS: TestParseBatchMetadataFromJSON/empty_array (0.00s)
    --- PASS: TestParseBatchMetadataFromJSON/invalid_JSON (0.00s)
    --- PASS: TestParseBatchMetadataFromJSON/object_instead_of_array (0.00s)
    --- PASS: TestParseBatchMetadataFromJSON/null_JSON (0.00s)
=== RUN   TestParseMetadataFromJSON_ErrorWrapping
--- PASS: TestParseMetadataFromJSON_ErrorWrapping (0.00s)
=== RUN   TestParseBatchMetadataFromJSON_ErrorWrapping
--- PASS: TestParseBatchMetadataFromJSON_ErrorWrapping (0.00s)
PASS
coverage: 83.0% of statements
ok  	github.com/jdfalk/audiobook-organizer/internal/ai	(cached)	coverage: 83.0% of statements
=== RUN   TestDefaultBackupConfig
--- PASS: TestDefaultBackupConfig (0.00s)
=== RUN   TestBackupInfoStructure
--- PASS: TestBackupInfoStructure (0.00s)
=== RUN   TestBackupConfigStructure
--- PASS: TestBackupConfigStructure (0.00s)
=== RUN   TestCreateBackupDirectoryCreation
--- PASS: TestCreateBackupDirectoryCreation (0.05s)
=== RUN   TestCreateBackupSuccess
--- PASS: TestCreateBackupSuccess (0.05s)
=== RUN   TestCreateBackupInvalidPath
--- PASS: TestCreateBackupInvalidPath (0.01s)
=== RUN   TestRestoreBackupInvalidPath
--- PASS: TestRestoreBackupInvalidPath (0.00s)
=== RUN   TestBackupTimestampFormat
--- PASS: TestBackupTimestampFormat (0.00s)
=== RUN   TestMultipleBackups
--- PASS: TestMultipleBackups (1.02s)
=== RUN   TestBackupChecksum
--- PASS: TestBackupChecksum (1.03s)
=== RUN   TestListBackups
--- PASS: TestListBackups (2.01s)
=== RUN   TestListBackupsEmptyDirectory
--- PASS: TestListBackupsEmptyDirectory (0.00s)
=== RUN   TestDeleteBackup
--- PASS: TestDeleteBackup (0.00s)
=== RUN   TestCleanupOldBackups
--- PASS: TestCleanupOldBackups (4.02s)
=== RUN   TestRestoreBackup
--- PASS: TestRestoreBackup (0.00s)
=== RUN   TestBackupPebbleDirectory
--- PASS: TestBackupPebbleDirectory (0.00s)
=== RUN   TestBackupDifferentCompressionLevels
--- PASS: TestBackupDifferentCompressionLevels (0.00s)
=== RUN   TestScheduleBackupNotImplemented
--- PASS: TestScheduleBackupNotImplemented (0.00s)
=== RUN   TestBackupDatabaseNilStore
--- PASS: TestBackupDatabaseNilStore (0.00s)
=== RUN   TestRestoreBackupWithVerification
Checksum verification not yet implemented
--- PASS: TestRestoreBackupWithVerification (0.00s)
=== RUN   TestDeleteBackupNonexistent
--- PASS: TestDeleteBackupNonexistent (0.00s)
=== RUN   TestCreateBackupPebbleWithSubdirs
--- PASS: TestCreateBackupPebbleWithSubdirs (0.00s)
=== RUN   TestCreateBackupMaxBackupsZero
--- PASS: TestCreateBackupMaxBackupsZero (0.04s)
=== RUN   TestRestoreBackupCorruptedGzip
--- PASS: TestRestoreBackupCorruptedGzip (0.00s)
=== RUN   TestCreateBackupInvalidDatabaseType
--- PASS: TestCreateBackupInvalidDatabaseType (0.00s)
=== RUN   TestListBackupsNonexistentDirectory
--- PASS: TestListBackupsNonexistentDirectory (0.00s)
=== RUN   TestCreateBackupWritePermissionError
--- PASS: TestCreateBackupWritePermissionError (0.00s)
=== RUN   TestBackupInfoTimestampParsing
--- PASS: TestBackupInfoTimestampParsing (0.00s)
=== RUN   TestCreateBackupEmptyPebbleDirectory
--- PASS: TestCreateBackupEmptyPebbleDirectory (0.00s)
=== RUN   TestCalculateChecksumConsistency
--- PASS: TestCalculateChecksumConsistency (0.00s)
=== RUN   TestRestoreBackupPreservesPermissions
--- PASS: TestRestoreBackupPreservesPermissions (0.00s)
=== RUN   TestDeleteBackupSuccess
--- PASS: TestDeleteBackupSuccess (0.00s)
=== RUN   TestCleanupOldBackupsExactlyAtLimit
--- PASS: TestCleanupOldBackupsExactlyAtLimit (0.04s)
=== RUN   TestCreateBackupHighCompression
--- PASS: TestCreateBackupHighCompression (0.00s)
=== RUN   TestCreateBackupLowCompression
--- PASS: TestCreateBackupLowCompression (0.00s)
=== RUN   TestBackupDatabaseNotInitialized
--- PASS: TestBackupDatabaseNotInitialized (0.00s)
=== RUN   TestBackupDatabaseMissingInfo
--- PASS: TestBackupDatabaseMissingInfo (0.00s)
=== RUN   TestRestoreBackupDirectory
--- PASS: TestRestoreBackupDirectory (0.00s)
=== RUN   TestRestoreBackupIOCopyError
--- PASS: TestRestoreBackupIOCopyError (0.00s)
=== RUN   TestRestoreBackupUnsupportedFileType
    backup_test.go:1396: Unsupported file type handling tested indirectly
--- SKIP: TestRestoreBackupUnsupportedFileType (0.00s)
=== RUN   TestAddToArchiveStatError
--- PASS: TestAddToArchiveStatError (0.00s)
=== RUN   TestAddToArchiveWalkError
--- PASS: TestAddToArchiveWalkError (0.00s)
=== RUN   TestCalculateFileChecksumError
--- PASS: TestCalculateFileChecksumError (0.00s)
=== RUN   TestRestoreBackupCreateFileError
--- PASS: TestRestoreBackupCreateFileError (0.00s)
=== RUN   TestCreateBackupMkdirAllError
--- PASS: TestCreateBackupMkdirAllError (0.00s)
PASS
coverage: 80.6% of statements
ok  	github.com/jdfalk/audiobook-organizer/internal/backup	(cached)	coverage: 80.6% of statements
=== RUN   TestInitConfig
--- PASS: TestInitConfig (0.00s)
=== RUN   TestStorageQuotaDefaults
--- PASS: TestStorageQuotaDefaults (0.00s)
=== RUN   TestMetadataDefaults
--- PASS: TestMetadataDefaults (0.00s)
=== RUN   TestAIParsingDefaults
--- PASS: TestAIParsingDefaults (0.00s)
=== RUN   TestPerformanceDefaults
--- PASS: TestPerformanceDefaults (0.00s)
=== RUN   TestMemoryManagementDefaults
--- PASS: TestMemoryManagementDefaults (0.00s)
=== RUN   TestLoggingDefaults
--- PASS: TestLoggingDefaults (0.00s)
=== RUN   TestConfigStructure
--- PASS: TestConfigStructure (0.00s)
=== RUN   TestMetadataSourceStructure
--- PASS: TestMetadataSourceStructure (0.00s)
=== RUN   TestSupportedExtensionsDefaults
--- PASS: TestSupportedExtensionsDefaults (0.00s)
=== RUN   TestDatabaseTypeNormalization
--- PASS: TestDatabaseTypeNormalization (0.00s)
=== RUN   TestDefaultMetadataSources
--- PASS: TestDefaultMetadataSources (0.00s)
=== RUN   TestConfigurationValidation
--- PASS: TestConfigurationValidation (0.00s)
PASS
coverage: 26.6% of statements
ok  	github.com/jdfalk/audiobook-organizer/internal/config	(cached)	coverage: 26.6% of statements
=== RUN   TestGetAudiobooksDefaultsAndFilters
--- PASS: TestGetAudiobooksDefaultsAndFilters (0.06s)
=== RUN   TestAudiobookByIDUpdateAndDelete
--- PASS: TestAudiobookByIDUpdateAndDelete (0.05s)
=== RUN   TestCloseStoreWithDBOnly
--- PASS: TestCloseStoreWithDBOnly (0.00s)
=== RUN   TestInitializeStoreAndClose
2026/01/24 13:06:41 Current database version: 0
2026/01/24 13:06:41 Applying 10 migrations...
2026/01/24 13:06:41 Applying migration 1: Initial schema with authors, series, books, playlists
2026/01/24 13:06:41   - Validating basic schema (authors, series, books, playlists)
2026/01/24 13:06:41 Migration 1 completed successfully
2026/01/24 13:06:41 Applying migration 2: Add import paths and operations tables
2026/01/24 13:06:41   - Adding import paths and operations support
2026/01/24 13:06:41 Migration 2 completed successfully
2026/01/24 13:06:41 Applying migration 3: Add user preferences
2026/01/24 13:06:41   - Adding user preferences support
2026/01/24 13:06:41 Migration 3 completed successfully
2026/01/24 13:06:41 Applying migration 4: Add extended Pebble keyspace (users, sessions, segments, playback)
2026/01/24 13:06:41   - Adding extended Pebble keyspace (users, sessions, segments, playback)
2026/01/24 13:06:41 Migration 4 completed successfully
2026/01/24 13:06:41 Applying migration 5: Add media info and version management fields to books
2026/01/24 13:06:41   - Adding media info and version management fields to books table
2026/01/24 13:06:41     - Executing: ALTER TABLE books ADD COLUMN bitrate_kbps INTEGER
2026/01/24 13:06:41     - Column already exists, skipping
2026/01/24 13:06:41     - Executing: ALTER TABLE books ADD COLUMN codec TEXT
2026/01/24 13:06:41     - Column already exists, skipping
2026/01/24 13:06:41     - Executing: ALTER TABLE books ADD COLUMN sample_rate_hz INTEGER
2026/01/24 13:06:41     - Column already exists, skipping
2026/01/24 13:06:41     - Executing: ALTER TABLE books ADD COLUMN channels INTEGER
2026/01/24 13:06:41     - Column already exists, skipping
2026/01/24 13:06:41     - Executing: ALTER TABLE books ADD COLUMN bit_depth INTEGER
2026/01/24 13:06:41     - Column already exists, skipping
2026/01/24 13:06:41     - Executing: ALTER TABLE books ADD COLUMN quality TEXT
2026/01/24 13:06:41     - Column already exists, skipping
2026/01/24 13:06:41     - Executing: ALTER TABLE books ADD COLUMN is_primary_version BOOLEAN DEFAULT 1
2026/01/24 13:06:41     - Column already exists, skipping
2026/01/24 13:06:41     - Executing: ALTER TABLE books ADD COLUMN version_group_id TEXT
2026/01/24 13:06:41     - Column already exists, skipping
2026/01/24 13:06:41     - Executing: ALTER TABLE books ADD COLUMN version_notes TEXT
2026/01/24 13:06:41     - Column already exists, skipping
2026/01/24 13:06:41     - Creating index: CREATE INDEX IF NOT EXISTS idx_books_version_group ON books(version_group_id)
2026/01/24 13:06:41     - Creating index: CREATE INDEX IF NOT EXISTS idx_books_is_primary ON books(is_primary_version)
2026/01/24 13:06:41   - Media info and version management fields added successfully
2026/01/24 13:06:41 Migration 5 completed successfully
2026/01/24 13:06:41 Applying migration 6: Add original and organized file hash tracking
2026/01/24 13:06:41   - Adding original/organized file hash columns to books table
2026/01/24 13:06:41     - Executing: ALTER TABLE books ADD COLUMN original_file_hash TEXT
2026/01/24 13:06:41     - Column already exists, skipping
2026/01/24 13:06:41     - Executing: ALTER TABLE books ADD COLUMN organized_file_hash TEXT
2026/01/24 13:06:41     - Column already exists, skipping
2026/01/24 13:06:41     - Creating index: CREATE INDEX IF NOT EXISTS idx_books_original_hash ON books(original_file_hash)
2026/01/24 13:06:41     - Creating index: CREATE INDEX IF NOT EXISTS idx_books_organized_hash ON books(organized_file_hash)
2026/01/24 13:06:41 Migration 6 completed successfully
2026/01/24 13:06:41 Applying migration 7: Rename import paths to import paths
2026/01/24 13:06:41   - Renaming import paths to import paths
2026/01/24 13:06:41 Migration 7 completed successfully
2026/01/24 13:06:41 Applying migration 8: Add do_not_import table for hash blocklist
2026/01/24 13:06:41   - Adding do_not_import table for hash blocklist
2026/01/24 13:06:41     - Executing: CREATE TABLE IF NOT EXISTS do_not_import (
				hash TEXT PRIMARY KEY NOT NULL,
				reason TEXT NOT NULL,
				created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
			)
2026/01/24 13:06:41     - Executing: CREATE INDEX IF NOT EXISTS idx_do_not_import_hash ON do_not_import(hash)
2026/01/24 13:06:41 Migration 8 completed successfully
2026/01/24 13:06:41 Applying migration 9: Add state machine and lifecycle fields to books
2026/01/24 13:06:41   - Adding state machine and lifecycle fields to books table
2026/01/24 13:06:41     - Executing: ALTER TABLE books ADD COLUMN library_state TEXT DEFAULT 'imported'
2026/01/24 13:06:41     - Column already exists, skipping
2026/01/24 13:06:41     - Executing: ALTER TABLE books ADD COLUMN quantity INTEGER DEFAULT 1
2026/01/24 13:06:41     - Column already exists, skipping
2026/01/24 13:06:41     - Executing: ALTER TABLE books ADD COLUMN marked_for_deletion BOOLEAN DEFAULT 0
2026/01/24 13:06:41     - Column already exists, skipping
2026/01/24 13:06:41     - Executing: ALTER TABLE books ADD COLUMN marked_for_deletion_at DATETIME
2026/01/24 13:06:41     - Column already exists, skipping
2026/01/24 13:06:41     - Creating index: CREATE INDEX IF NOT EXISTS idx_books_library_state ON books(library_state)
2026/01/24 13:06:41     - Creating index: CREATE INDEX IF NOT EXISTS idx_books_marked_for_deletion ON books(marked_for_deletion)
2026/01/24 13:06:41   - State machine fields added successfully
2026/01/24 13:06:41 Migration 9 completed successfully
2026/01/24 13:06:41 Applying migration 10: Add metadata_states table for metadata provenance
2026/01/24 13:06:41   - Adding metadata_states table for metadata provenance
2026/01/24 13:06:41     - Executing: CREATE TABLE IF NOT EXISTS metadata_states (
			book_id TEXT NOT NULL,
			field TEXT NOT NULL,
			fetched_value TEXT,
			override_value TEXT,
			override_locked BOOLEAN NOT NULL DEFAULT 0,
			updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
			PRIMARY KEY (book_id, field)
		)
2026/01/24 13:06:41     - Executing: CREATE INDEX IF NOT EXISTS idx_metadata_states_book ON metadata_states(book_id)
2026/01/24 13:06:41 Migration 10 completed successfully
2026/01/24 13:06:41 All migrations completed. Current version: 10
2026/01/24 13:06:41 Current database version: 0
2026/01/24 13:06:41 Applying 10 migrations...
2026/01/24 13:06:41 Applying migration 1: Initial schema with authors, series, books, playlists
2026/01/24 13:06:41   - Validating basic schema (authors, series, books, playlists)
2026/01/24 13:06:41 Migration 1 completed successfully
2026/01/24 13:06:41 Applying migration 2: Add import paths and operations tables
2026/01/24 13:06:41   - Adding import paths and operations support
2026/01/24 13:06:41 Migration 2 completed successfully
2026/01/24 13:06:41 Applying migration 3: Add user preferences
2026/01/24 13:06:41   - Adding user preferences support
2026/01/24 13:06:41 Migration 3 completed successfully
2026/01/24 13:06:41 Applying migration 4: Add extended Pebble keyspace (users, sessions, segments, playback)
2026/01/24 13:06:41   - Adding extended Pebble keyspace (users, sessions, segments, playback)
2026/01/24 13:06:41 Migration 4 completed successfully
2026/01/24 13:06:41 Applying migration 5: Add media info and version management fields to books
2026/01/24 13:06:41   - Adding media info and version management fields to books table
2026/01/24 13:06:41   - Non-SQLite store detected, skipping SQL migration
2026/01/24 13:06:41 Migration 5 completed successfully
2026/01/24 13:06:41 Applying migration 6: Add original and organized file hash tracking
2026/01/24 13:06:41   - Adding original/organized file hash columns to books table
2026/01/24 13:06:41   - Non-SQLite store detected, skipping SQL migration
2026/01/24 13:06:41 Migration 6 completed successfully
2026/01/24 13:06:41 Applying migration 7: Rename import paths to import paths
2026/01/24 13:06:41   - Renaming import paths to import paths
2026/01/24 13:06:41 Migration 7 completed successfully
2026/01/24 13:06:41 Applying migration 8: Add do_not_import table for hash blocklist
2026/01/24 13:06:41   - Adding do_not_import table for hash blocklist
2026/01/24 13:06:41     - Pebble keyspace for do_not_import enabled
2026/01/24 13:06:41 Migration 8 completed successfully
2026/01/24 13:06:41 Applying migration 9: Add state machine and lifecycle fields to books
2026/01/24 13:06:41   - Adding state machine and lifecycle fields to books table
2026/01/24 13:06:41   - Non-SQLite store detected, skipping SQL migration
2026/01/24 13:06:41 Migration 9 completed successfully
2026/01/24 13:06:41 Applying migration 10: Add metadata_states table for metadata provenance
2026/01/24 13:06:41   - Adding metadata_states table for metadata provenance
2026/01/24 13:06:41   - Non-SQLite store detected, skipping SQL migration
2026/01/24 13:06:41 Migration 10 completed successfully
2026/01/24 13:06:41 All migrations completed. Current version: 10
--- PASS: TestInitializeStoreAndClose (0.40s)
=== RUN   TestDBInterfaceWrapper
--- PASS: TestDBInterfaceWrapper (0.01s)
=== RUN   TestWebHelpers
--- PASS: TestWebHelpers (0.03s)
=== RUN   TestEncryptionHelpersAndSettings
--- PASS: TestEncryptionHelpersAndSettings (0.12s)
=== RUN   TestDoNotImport_SQLite
2026/01/24 13:06:41 Current database version: 0
2026/01/24 13:06:41 Applying 10 migrations...
2026/01/24 13:06:41 Applying migration 1: Initial schema with authors, series, books, playlists
2026/01/24 13:06:41   - Validating basic schema (authors, series, books, playlists)
2026/01/24 13:06:41 Migration 1 completed successfully
2026/01/24 13:06:41 Applying migration 2: Add import paths and operations tables
2026/01/24 13:06:41   - Adding import paths and operations support
2026/01/24 13:06:41 Migration 2 completed successfully
2026/01/24 13:06:41 Applying migration 3: Add user preferences
2026/01/24 13:06:41   - Adding user preferences support
2026/01/24 13:06:41 Migration 3 completed successfully
2026/01/24 13:06:41 Applying migration 4: Add extended Pebble keyspace (users, sessions, segments, playback)
2026/01/24 13:06:41   - Adding extended Pebble keyspace (users, sessions, segments, playback)
2026/01/24 13:06:41 Migration 4 completed successfully
2026/01/24 13:06:41 Applying migration 5: Add media info and version management fields to books
2026/01/24 13:06:41   - Adding media info and version management fields to books table
2026/01/24 13:06:41     - Executing: ALTER TABLE books ADD COLUMN bitrate_kbps INTEGER
2026/01/24 13:06:41     - Column already exists, skipping
2026/01/24 13:06:41     - Executing: ALTER TABLE books ADD COLUMN codec TEXT
2026/01/24 13:06:41     - Column already exists, skipping
2026/01/24 13:06:41     - Executing: ALTER TABLE books ADD COLUMN sample_rate_hz INTEGER
2026/01/24 13:06:41     - Column already exists, skipping
2026/01/24 13:06:41     - Executing: ALTER TABLE books ADD COLUMN channels INTEGER
2026/01/24 13:06:41     - Column already exists, skipping
2026/01/24 13:06:41     - Executing: ALTER TABLE books ADD COLUMN bit_depth INTEGER
2026/01/24 13:06:41     - Column already exists, skipping
2026/01/24 13:06:41     - Executing: ALTER TABLE books ADD COLUMN quality TEXT
2026/01/24 13:06:41     - Column already exists, skipping
2026/01/24 13:06:41     - Executing: ALTER TABLE books ADD COLUMN is_primary_version BOOLEAN DEFAULT 1
2026/01/24 13:06:41     - Column already exists, skipping
2026/01/24 13:06:41     - Executing: ALTER TABLE books ADD COLUMN version_group_id TEXT
2026/01/24 13:06:41     - Column already exists, skipping
2026/01/24 13:06:41     - Executing: ALTER TABLE books ADD COLUMN version_notes TEXT
2026/01/24 13:06:41     - Column already exists, skipping
2026/01/24 13:06:41     - Creating index: CREATE INDEX IF NOT EXISTS idx_books_version_group ON books(version_group_id)
2026/01/24 13:06:41     - Creating index: CREATE INDEX IF NOT EXISTS idx_books_is_primary ON books(is_primary_version)
2026/01/24 13:06:41   - Media info and version management fields added successfully
2026/01/24 13:06:41 Migration 5 completed successfully
2026/01/24 13:06:41 Applying migration 6: Add original and organized file hash tracking
2026/01/24 13:06:41   - Adding original/organized file hash columns to books table
2026/01/24 13:06:41     - Executing: ALTER TABLE books ADD COLUMN original_file_hash TEXT
2026/01/24 13:06:41     - Column already exists, skipping
2026/01/24 13:06:41     - Executing: ALTER TABLE books ADD COLUMN organized_file_hash TEXT
2026/01/24 13:06:41     - Column already exists, skipping
2026/01/24 13:06:41     - Creating index: CREATE INDEX IF NOT EXISTS idx_books_original_hash ON books(original_file_hash)
2026/01/24 13:06:41     - Creating index: CREATE INDEX IF NOT EXISTS idx_books_organized_hash ON books(organized_file_hash)
2026/01/24 13:06:41 Migration 6 completed successfully
2026/01/24 13:06:41 Applying migration 7: Rename import paths to import paths
2026/01/24 13:06:41   - Renaming import paths to import paths
2026/01/24 13:06:41 Migration 7 completed successfully
2026/01/24 13:06:41 Applying migration 8: Add do_not_import table for hash blocklist
2026/01/24 13:06:41   - Adding do_not_import table for hash blocklist
2026/01/24 13:06:41     - Executing: CREATE TABLE IF NOT EXISTS do_not_import (
				hash TEXT PRIMARY KEY NOT NULL,
				reason TEXT NOT NULL,
				created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
			)
2026/01/24 13:06:41     - Executing: CREATE INDEX IF NOT EXISTS idx_do_not_import_hash ON do_not_import(hash)
2026/01/24 13:06:41 Migration 8 completed successfully
2026/01/24 13:06:41 Applying migration 9: Add state machine and lifecycle fields to books
2026/01/24 13:06:41   - Adding state machine and lifecycle fields to books table
2026/01/24 13:06:41     - Executing: ALTER TABLE books ADD COLUMN library_state TEXT DEFAULT 'imported'
2026/01/24 13:06:41     - Column already exists, skipping
2026/01/24 13:06:41     - Executing: ALTER TABLE books ADD COLUMN quantity INTEGER DEFAULT 1
2026/01/24 13:06:41     - Column already exists, skipping
2026/01/24 13:06:41     - Executing: ALTER TABLE books ADD COLUMN marked_for_deletion BOOLEAN DEFAULT 0
2026/01/24 13:06:41     - Column already exists, skipping
2026/01/24 13:06:41     - Executing: ALTER TABLE books ADD COLUMN marked_for_deletion_at DATETIME
2026/01/24 13:06:41     - Column already exists, skipping
2026/01/24 13:06:41     - Creating index: CREATE INDEX IF NOT EXISTS idx_books_library_state ON books(library_state)
2026/01/24 13:06:41     - Creating index: CREATE INDEX IF NOT EXISTS idx_books_marked_for_deletion ON books(marked_for_deletion)
2026/01/24 13:06:41   - State machine fields added successfully
2026/01/24 13:06:41 Migration 9 completed successfully
2026/01/24 13:06:41 Applying migration 10: Add metadata_states table for metadata provenance
2026/01/24 13:06:41   - Adding metadata_states table for metadata provenance
2026/01/24 13:06:41     - Executing: CREATE TABLE IF NOT EXISTS metadata_states (
			book_id TEXT NOT NULL,
			field TEXT NOT NULL,
			fetched_value TEXT,
			override_value TEXT,
			override_locked BOOLEAN NOT NULL DEFAULT 0,
			updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
			PRIMARY KEY (book_id, field)
		)
2026/01/24 13:06:41     - Executing: CREATE INDEX IF NOT EXISTS idx_metadata_states_book ON metadata_states(book_id)
2026/01/24 13:06:41 Migration 10 completed successfully
2026/01/24 13:06:41 All migrations completed. Current version: 10
--- PASS: TestDoNotImport_SQLite (0.04s)
=== RUN   TestDoNotImport_Pebble
2026/01/24 13:06:41 Current database version: 0
2026/01/24 13:06:41 Applying 10 migrations...
2026/01/24 13:06:41 Applying migration 1: Initial schema with authors, series, books, playlists
2026/01/24 13:06:41   - Validating basic schema (authors, series, books, playlists)
2026/01/24 13:06:41 Migration 1 completed successfully
2026/01/24 13:06:41 Applying migration 2: Add import paths and operations tables
2026/01/24 13:06:41   - Adding import paths and operations support
2026/01/24 13:06:41 Migration 2 completed successfully
2026/01/24 13:06:41 Applying migration 3: Add user preferences
2026/01/24 13:06:41   - Adding user preferences support
2026/01/24 13:06:41 Migration 3 completed successfully
2026/01/24 13:06:41 Applying migration 4: Add extended Pebble keyspace (users, sessions, segments, playback)
2026/01/24 13:06:41   - Adding extended Pebble keyspace (users, sessions, segments, playback)
2026/01/24 13:06:41 Migration 4 completed successfully
2026/01/24 13:06:41 Applying migration 5: Add media info and version management fields to books
2026/01/24 13:06:41   - Adding media info and version management fields to books table
2026/01/24 13:06:41   - Non-SQLite store detected, skipping SQL migration
2026/01/24 13:06:41 Migration 5 completed successfully
2026/01/24 13:06:41 Applying migration 6: Add original and organized file hash tracking
2026/01/24 13:06:41   - Adding original/organized file hash columns to books table
2026/01/24 13:06:41   - Non-SQLite store detected, skipping SQL migration
2026/01/24 13:06:41 Migration 6 completed successfully
2026/01/24 13:06:41 Applying migration 7: Rename import paths to import paths
2026/01/24 13:06:41   - Renaming import paths to import paths
2026/01/24 13:06:41 Migration 7 completed successfully
2026/01/24 13:06:41 Applying migration 8: Add do_not_import table for hash blocklist
2026/01/24 13:06:41   - Adding do_not_import table for hash blocklist
2026/01/24 13:06:41     - Pebble keyspace for do_not_import enabled
2026/01/24 13:06:41 Migration 8 completed successfully
2026/01/24 13:06:41 Applying migration 9: Add state machine and lifecycle fields to books
2026/01/24 13:06:41   - Adding state machine and lifecycle fields to books table
2026/01/24 13:06:41   - Non-SQLite store detected, skipping SQL migration
2026/01/24 13:06:41 Migration 9 completed successfully
2026/01/24 13:06:41 Applying migration 10: Add metadata_states table for metadata provenance
2026/01/24 13:06:41   - Adding metadata_states table for metadata provenance
2026/01/24 13:06:41   - Non-SQLite store detected, skipping SQL migration
2026/01/24 13:06:41 Migration 10 completed successfully
2026/01/24 13:06:41 All migrations completed. Current version: 10
--- PASS: TestDoNotImport_Pebble (0.28s)
=== RUN   TestGetCurrentVersionWithPreference
--- PASS: TestGetCurrentVersionWithPreference (0.02s)
=== RUN   TestGetCurrentVersionInvalidPreference
--- PASS: TestGetCurrentVersionInvalidPreference (0.01s)
=== RUN   TestMigration007UpWithLegacyTable
2026/01/24 13:06:42   - Renaming import paths to import paths
2026/01/24 13:06:42     - Executing: ALTER TABLE library_folders RENAME TO import_paths
2026/01/24 13:06:42     - Executing: DROP INDEX IF EXISTS idx_library_folders_path
2026/01/24 13:06:42     - Executing: CREATE INDEX IF NOT EXISTS idx_import_paths_path ON import_paths(path)
--- PASS: TestMigration007UpWithLegacyTable (0.01s)
=== RUN   TestNewMockDB
--- PASS: TestNewMockDB (0.00s)
=== RUN   TestMockDB_Exec
--- PASS: TestMockDB_Exec (0.00s)
=== RUN   TestMockDB_ExecError
--- PASS: TestMockDB_ExecError (0.00s)
=== RUN   TestMockDB_Query
--- PASS: TestMockDB_Query (0.00s)
=== RUN   TestMockDB_QueryError
--- PASS: TestMockDB_QueryError (0.00s)
=== RUN   TestMockDB_QueryRow
--- PASS: TestMockDB_QueryRow (0.00s)
=== RUN   TestMockDB_Prepare
--- PASS: TestMockDB_Prepare (0.00s)
=== RUN   TestMockDB_PrepareError
--- PASS: TestMockDB_PrepareError (0.00s)
=== RUN   TestMockDB_Begin
--- PASS: TestMockDB_Begin (0.00s)
=== RUN   TestMockDB_BeginError
--- PASS: TestMockDB_BeginError (0.00s)
=== RUN   TestMockDB_Close
--- PASS: TestMockDB_Close (0.00s)
=== RUN   TestMockDB_CloseError
--- PASS: TestMockDB_CloseError (0.00s)
=== RUN   TestMockDB_Reset
--- PASS: TestMockDB_Reset (0.00s)
=== RUN   TestMockDB_GetQueryCallCount
--- PASS: TestMockDB_GetQueryCallCount (0.00s)
=== RUN   TestMockDB_GetExecCallCount
--- PASS: TestMockDB_GetExecCallCount (0.00s)
=== RUN   TestMockDB_GetLastQuery
--- PASS: TestMockDB_GetLastQuery (0.00s)
=== RUN   TestMockDB_GetLastExec
--- PASS: TestMockDB_GetLastExec (0.00s)
=== RUN   TestMockDB_VerifyQuery
--- PASS: TestMockDB_VerifyQuery (0.00s)
=== RUN   TestMockDB_VerifyExec
--- PASS: TestMockDB_VerifyExec (0.00s)
=== RUN   TestMockResult
--- PASS: TestMockResult (0.00s)
=== RUN   TestMockResult_WithError
--- PASS: TestMockResult_WithError (0.00s)
=== RUN   TestMockDB_ConcurrentAccess
--- PASS: TestMockDB_ConcurrentAccess (0.00s)
=== RUN   TestPebbleUpdateBookAndImportPaths
--- PASS: TestPebbleUpdateBookAndImportPaths (0.16s)
=== RUN   TestPebbleDuplicateBooksLegacyKeys
--- PASS: TestPebbleDuplicateBooksLegacyKeys (0.09s)
=== RUN   TestPebbleCreateUserDuplicate
--- PASS: TestPebbleCreateUserDuplicate (0.10s)
=== RUN   TestNewPebbleStoreExistingCounters
2026/01/24 13:06:42 [JOB 1] WAL file /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestNewPebbleStoreExistingCounters106662003/001/000002.log with log number 000002 stopped reading at offset: 349; replayed 8 keys in 8 batches
--- PASS: TestNewPebbleStoreExistingCounters (0.15s)
=== RUN   TestPebbleMigrateImportPathKeysLegacy
--- PASS: TestPebbleMigrateImportPathKeysLegacy (0.11s)
=== RUN   TestNewPebbleStore
--- PASS: TestNewPebbleStore (0.09s)
=== RUN   TestPebbleCreateAndGetBook
--- PASS: TestPebbleCreateAndGetBook (0.14s)
=== RUN   TestPebbleUpdateBook
--- PASS: TestPebbleUpdateBook (0.09s)
=== RUN   TestPebbleDeleteBook
--- PASS: TestPebbleDeleteBook (0.09s)
=== RUN   TestPebbleGetAllBooks
--- PASS: TestPebbleGetAllBooks (0.10s)
=== RUN   TestPebbleGetBooksBySeriesID
--- PASS: TestPebbleGetBooksBySeriesID (0.14s)
=== RUN   TestPebbleGetBooksByAuthorID
--- PASS: TestPebbleGetBooksByAuthorID (0.13s)
=== RUN   TestPebbleVersionManagement
--- PASS: TestPebbleVersionManagement (0.11s)
=== RUN   TestPebbleCreateAndGetAuthor
--- PASS: TestPebbleCreateAndGetAuthor (0.10s)
=== RUN   TestPebbleGetAllAuthors
--- PASS: TestPebbleGetAllAuthors (0.13s)
=== RUN   TestPebbleCreateAndGetSeries
--- PASS: TestPebbleCreateAndGetSeries (0.10s)
=== RUN   TestPebbleGetAllSeries
--- PASS: TestPebbleGetAllSeries (0.13s)
=== RUN   TestPebbleSearchBooks
--- PASS: TestPebbleSearchBooks (0.09s)
=== RUN   TestPebbleCountBooks
--- PASS: TestPebbleCountBooks (0.10s)
=== RUN   TestPebbleImportPaths
--- PASS: TestPebbleImportPaths (0.08s)
=== RUN   TestPebbleMigrateImportPathKeys
--- PASS: TestPebbleMigrateImportPathKeys (0.08s)
=== RUN   TestPebbleOperations
--- PASS: TestPebbleOperations (0.08s)
=== RUN   TestPebbleUserPreferences
--- PASS: TestPebbleUserPreferences (0.07s)
=== RUN   TestInitEncryptionWithExistingKey
--- PASS: TestInitEncryptionWithExistingKey (0.00s)
=== RUN   TestGetDecryptedSettingNonSecret
--- PASS: TestGetDecryptedSettingNonSecret (0.07s)
=== RUN   TestGetDecryptedSettingSecret
--- PASS: TestGetDecryptedSettingSecret (0.07s)
=== RUN   TestNewSQLiteStore
--- PASS: TestNewSQLiteStore (0.01s)
=== RUN   TestCreateAndGetBook
--- PASS: TestCreateAndGetBook (0.01s)
=== RUN   TestUpdateBook
--- PASS: TestUpdateBook (0.01s)
=== RUN   TestDeleteBook
--- PASS: TestDeleteBook (0.02s)
=== RUN   TestListBooks
--- PASS: TestListBooks (0.01s)
=== RUN   TestVersionManagement
--- PASS: TestVersionManagement (0.02s)
=== RUN   TestBookHashLookups
--- PASS: TestBookHashLookups (0.01s)
=== RUN   TestCreateAndGetAuthor
--- PASS: TestCreateAndGetAuthor (0.01s)
=== RUN   TestGetAuthorByName
--- PASS: TestGetAuthorByName (0.01s)
=== RUN   TestCountBooks
--- PASS: TestCountBooks (0.01s)
=== RUN   TestStoreAdditionalCoverageSQLite
2026/01/24 13:06:44 Current database version: 0
2026/01/24 13:06:44 Applying 10 migrations...
2026/01/24 13:06:44 Applying migration 1: Initial schema with authors, series, books, playlists
2026/01/24 13:06:44   - Validating basic schema (authors, series, books, playlists)
2026/01/24 13:06:44 Migration 1 completed successfully
2026/01/24 13:06:44 Applying migration 2: Add import paths and operations tables
2026/01/24 13:06:44   - Adding import paths and operations support
2026/01/24 13:06:44 Migration 2 completed successfully
2026/01/24 13:06:44 Applying migration 3: Add user preferences
2026/01/24 13:06:44   - Adding user preferences support
2026/01/24 13:06:44 Migration 3 completed successfully
2026/01/24 13:06:44 Applying migration 4: Add extended Pebble keyspace (users, sessions, segments, playback)
2026/01/24 13:06:44   - Adding extended Pebble keyspace (users, sessions, segments, playback)
2026/01/24 13:06:44 Migration 4 completed successfully
2026/01/24 13:06:44 Applying migration 5: Add media info and version management fields to books
2026/01/24 13:06:44   - Adding media info and version management fields to books table
2026/01/24 13:06:44     - Executing: ALTER TABLE books ADD COLUMN bitrate_kbps INTEGER
2026/01/24 13:06:44     - Column already exists, skipping
2026/01/24 13:06:44     - Executing: ALTER TABLE books ADD COLUMN codec TEXT
2026/01/24 13:06:44     - Column already exists, skipping
2026/01/24 13:06:44     - Executing: ALTER TABLE books ADD COLUMN sample_rate_hz INTEGER
2026/01/24 13:06:44     - Column already exists, skipping
2026/01/24 13:06:44     - Executing: ALTER TABLE books ADD COLUMN channels INTEGER
2026/01/24 13:06:44     - Column already exists, skipping
2026/01/24 13:06:44     - Executing: ALTER TABLE books ADD COLUMN bit_depth INTEGER
2026/01/24 13:06:44     - Column already exists, skipping
2026/01/24 13:06:44     - Executing: ALTER TABLE books ADD COLUMN quality TEXT
2026/01/24 13:06:44     - Column already exists, skipping
2026/01/24 13:06:44     - Executing: ALTER TABLE books ADD COLUMN is_primary_version BOOLEAN DEFAULT 1
2026/01/24 13:06:44     - Column already exists, skipping
2026/01/24 13:06:44     - Executing: ALTER TABLE books ADD COLUMN version_group_id TEXT
2026/01/24 13:06:44     - Column already exists, skipping
2026/01/24 13:06:44     - Executing: ALTER TABLE books ADD COLUMN version_notes TEXT
2026/01/24 13:06:44     - Column already exists, skipping
2026/01/24 13:06:44     - Creating index: CREATE INDEX IF NOT EXISTS idx_books_version_group ON books(version_group_id)
2026/01/24 13:06:44     - Creating index: CREATE INDEX IF NOT EXISTS idx_books_is_primary ON books(is_primary_version)
2026/01/24 13:06:44   - Media info and version management fields added successfully
2026/01/24 13:06:44 Migration 5 completed successfully
2026/01/24 13:06:44 Applying migration 6: Add original and organized file hash tracking
2026/01/24 13:06:44   - Adding original/organized file hash columns to books table
2026/01/24 13:06:44     - Executing: ALTER TABLE books ADD COLUMN original_file_hash TEXT
2026/01/24 13:06:44     - Column already exists, skipping
2026/01/24 13:06:44     - Executing: ALTER TABLE books ADD COLUMN organized_file_hash TEXT
2026/01/24 13:06:44     - Column already exists, skipping
2026/01/24 13:06:44     - Creating index: CREATE INDEX IF NOT EXISTS idx_books_original_hash ON books(original_file_hash)
2026/01/24 13:06:44     - Creating index: CREATE INDEX IF NOT EXISTS idx_books_organized_hash ON books(organized_file_hash)
2026/01/24 13:06:44 Migration 6 completed successfully
2026/01/24 13:06:44 Applying migration 7: Rename import paths to import paths
2026/01/24 13:06:44   - Renaming import paths to import paths
2026/01/24 13:06:44 Migration 7 completed successfully
2026/01/24 13:06:44 Applying migration 8: Add do_not_import table for hash blocklist
2026/01/24 13:06:44   - Adding do_not_import table for hash blocklist
2026/01/24 13:06:44     - Executing: CREATE TABLE IF NOT EXISTS do_not_import (
				hash TEXT PRIMARY KEY NOT NULL,
				reason TEXT NOT NULL,
				created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
			)
2026/01/24 13:06:44     - Executing: CREATE INDEX IF NOT EXISTS idx_do_not_import_hash ON do_not_import(hash)
2026/01/24 13:06:44 Migration 8 completed successfully
2026/01/24 13:06:44 Applying migration 9: Add state machine and lifecycle fields to books
2026/01/24 13:06:44   - Adding state machine and lifecycle fields to books table
2026/01/24 13:06:44     - Executing: ALTER TABLE books ADD COLUMN library_state TEXT DEFAULT 'imported'
2026/01/24 13:06:44     - Column already exists, skipping
2026/01/24 13:06:44     - Executing: ALTER TABLE books ADD COLUMN quantity INTEGER DEFAULT 1
2026/01/24 13:06:44     - Column already exists, skipping
2026/01/24 13:06:44     - Executing: ALTER TABLE books ADD COLUMN marked_for_deletion BOOLEAN DEFAULT 0
2026/01/24 13:06:44     - Column already exists, skipping
2026/01/24 13:06:44     - Executing: ALTER TABLE books ADD COLUMN marked_for_deletion_at DATETIME
2026/01/24 13:06:44     - Column already exists, skipping
2026/01/24 13:06:44     - Creating index: CREATE INDEX IF NOT EXISTS idx_books_library_state ON books(library_state)
2026/01/24 13:06:44     - Creating index: CREATE INDEX IF NOT EXISTS idx_books_marked_for_deletion ON books(marked_for_deletion)
2026/01/24 13:06:44   - State machine fields added successfully
2026/01/24 13:06:44 Migration 9 completed successfully
2026/01/24 13:06:44 Applying migration 10: Add metadata_states table for metadata provenance
2026/01/24 13:06:44   - Adding metadata_states table for metadata provenance
2026/01/24 13:06:44     - Executing: CREATE TABLE IF NOT EXISTS metadata_states (
			book_id TEXT NOT NULL,
			field TEXT NOT NULL,
			fetched_value TEXT,
			override_value TEXT,
			override_locked BOOLEAN NOT NULL DEFAULT 0,
			updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
			PRIMARY KEY (book_id, field)
		)
2026/01/24 13:06:44     - Executing: CREATE INDEX IF NOT EXISTS idx_metadata_states_book ON metadata_states(book_id)
2026/01/24 13:06:44 Migration 10 completed successfully
2026/01/24 13:06:44 All migrations completed. Current version: 10
--- PASS: TestStoreAdditionalCoverageSQLite (0.04s)
=== RUN   TestStoreAdditionalCoveragePebble
--- PASS: TestStoreAdditionalCoveragePebble (0.27s)
=== RUN   TestSQLiteUnsupportedFeatures
--- PASS: TestSQLiteUnsupportedFeatures (0.01s)
PASS
coverage: 78.0% of statements
ok  	github.com/jdfalk/audiobook-organizer/internal/database	(cached)	coverage: 78.0% of statements
	github.com/jdfalk/audiobook-organizer/internal/database/mocks		coverage: 0.0% of statements
=== RUN   TestComputeFileHash
--- PASS: TestComputeFileHash (0.00s)
=== RUN   TestComputeFileHash_SameContentSameHash
--- PASS: TestComputeFileHash_SameContentSameHash (0.00s)
=== RUN   TestComputeFileHash_DifferentContentDifferentHash
--- PASS: TestComputeFileHash_DifferentContentDifferentHash (0.00s)
=== RUN   TestComputeFileHash_NonExistentFile
--- PASS: TestComputeFileHash_NonExistentFile (0.00s)
=== RUN   TestComputeFileHash_EmptyFile
--- PASS: TestComputeFileHash_EmptyFile (0.00s)
=== RUN   TestComputeFileHash_LargeFile
--- PASS: TestComputeFileHash_LargeFile (0.00s)
=== RUN   TestGetFileSize
--- PASS: TestGetFileSize (0.00s)
=== RUN   TestGetFileSize_EmptyFile
--- PASS: TestGetFileSize_EmptyFile (0.00s)
=== RUN   TestGetFileSize_NonExistentFile
--- PASS: TestGetFileSize_NonExistentFile (0.00s)
=== RUN   TestGetFileSize_Directory
--- PASS: TestGetFileSize_Directory (0.00s)
=== RUN   TestDefaultConfig
--- PASS: TestDefaultConfig (0.00s)
=== RUN   TestNewFileOperation
--- PASS: TestNewFileOperation (0.00s)
=== RUN   TestFileOperation_Execute_NewFile
--- PASS: TestFileOperation_Execute_NewFile (0.02s)
=== RUN   TestFileOperation_Execute_OverwriteExisting
--- PASS: TestFileOperation_Execute_OverwriteExisting (0.05s)
=== RUN   TestFileOperation_Execute_WithoutChecksumVerification
--- PASS: TestFileOperation_Execute_WithoutChecksumVerification (0.01s)
=== RUN   TestFileOperation_Rollback
--- PASS: TestFileOperation_Rollback (0.01s)
=== RUN   TestFileOperation_Commit
--- PASS: TestFileOperation_Commit (0.01s)
=== RUN   TestSafeMove
--- PASS: TestSafeMove (0.00s)
=== RUN   TestSafeCopy
--- PASS: TestSafeCopy (0.01s)
=== RUN   TestVerifyFileIntegrity
--- PASS: TestVerifyFileIntegrity (0.00s)
=== RUN   TestVerifyFileIntegrity_NonExistentFile
--- PASS: TestVerifyFileIntegrity_NonExistentFile (0.00s)
=== RUN   TestCopyFile
--- PASS: TestCopyFile (0.00s)
=== RUN   TestCalculateChecksum
--- PASS: TestCalculateChecksum (0.00s)
=== RUN   TestFileOperation_Rollback_NotCompleted
--- PASS: TestFileOperation_Rollback_NotCompleted (0.00s)
=== RUN   TestFileOperation_Commit_NotCompleted
--- PASS: TestFileOperation_Commit_NotCompleted (0.00s)
=== RUN   TestFileOperation_Execute_MoveWithoutPreserve
--- PASS: TestFileOperation_Execute_MoveWithoutPreserve (0.00s)
=== RUN   TestCleanupOldBackups_NoLimit
--- PASS: TestCleanupOldBackups_NoLimit (0.01s)
=== RUN   TestCleanupOldBackups_ExceedsLimit
--- PASS: TestCleanupOldBackups_ExceedsLimit (0.02s)
=== RUN   TestSafeMove_NewFileOperationError
--- PASS: TestSafeMove_NewFileOperationError (0.00s)
=== RUN   TestSafeCopy_NewFileOperationError
--- PASS: TestSafeCopy_NewFileOperationError (0.00s)
=== RUN   TestCopyFile_NonExistentSource
--- PASS: TestCopyFile_NonExistentSource (0.00s)
=== RUN   TestCalculateChecksum_NonExistentFile
--- PASS: TestCalculateChecksum_NonExistentFile (0.00s)
=== RUN   TestNewFileOperation_NonExistentSource
--- PASS: TestNewFileOperation_NonExistentSource (0.00s)
=== RUN   TestFileOperation_Execute_SameSourceAndTarget
--- PASS: TestFileOperation_Execute_SameSourceAndTarget (0.01s)
=== RUN   TestFileOperation_Execute_CreateDestDirError
--- PASS: TestFileOperation_Execute_CreateDestDirError (0.00s)
=== RUN   TestFileOperation_Rollback_MissingBackup
--- PASS: TestFileOperation_Rollback_MissingBackup (0.01s)
=== RUN   TestFileOperation_Commit_MissingBackup
--- PASS: TestFileOperation_Commit_MissingBackup (0.01s)
=== RUN   TestSafeMove_ExecuteError
--- PASS: TestSafeMove_ExecuteError (0.00s)
=== RUN   TestSafeCopy_ExecuteError
--- PASS: TestSafeCopy_ExecuteError (0.00s)
=== RUN   TestNewFileOperation_RelativeBackupDir
--- PASS: TestNewFileOperation_RelativeBackupDir (0.00s)
PASS
coverage: 84.3% of statements
ok  	github.com/jdfalk/audiobook-organizer/internal/fileops	(cached)	coverage: 84.3% of statements
=== RUN   TestIdentifySeries_PatternMatching
=== RUN   TestIdentifySeries_PatternMatching/Series_dash_Title_format
=== RUN   TestIdentifySeries_PatternMatching/Series_Number:_Title_format
=== RUN   TestIdentifySeries_PatternMatching/Series_Book_Number:_Title_format
=== RUN   TestIdentifySeries_PatternMatching/Series_#Number:_Title_format
=== RUN   TestIdentifySeries_PatternMatching/Series_Vol_Number:_Title_format
=== RUN   TestIdentifySeries_PatternMatching/Series_Volume_Number:_Title_format
=== RUN   TestIdentifySeries_PatternMatching/No_series_pattern
--- PASS: TestIdentifySeries_PatternMatching (0.00s)
    --- PASS: TestIdentifySeries_PatternMatching/Series_dash_Title_format (0.00s)
    --- PASS: TestIdentifySeries_PatternMatching/Series_Number:_Title_format (0.00s)
    --- PASS: TestIdentifySeries_PatternMatching/Series_Book_Number:_Title_format (0.00s)
    --- PASS: TestIdentifySeries_PatternMatching/Series_#Number:_Title_format (0.00s)
    --- PASS: TestIdentifySeries_PatternMatching/Series_Vol_Number:_Title_format (0.00s)
    --- PASS: TestIdentifySeries_PatternMatching/Series_Volume_Number:_Title_format (0.00s)
    --- PASS: TestIdentifySeries_PatternMatching/No_series_pattern (0.00s)
=== RUN   TestIdentifySeries_DirectoryStructure
=== RUN   TestIdentifySeries_DirectoryStructure/Trilogy_in_path
=== RUN   TestIdentifySeries_DirectoryStructure/Series_in_path
=== RUN   TestIdentifySeries_DirectoryStructure/No_series_keywords
--- PASS: TestIdentifySeries_DirectoryStructure (0.00s)
    --- PASS: TestIdentifySeries_DirectoryStructure/Trilogy_in_path (0.00s)
    --- PASS: TestIdentifySeries_DirectoryStructure/Series_in_path (0.00s)
    --- PASS: TestIdentifySeries_DirectoryStructure/No_series_keywords (0.00s)
=== RUN   TestIdentifySeries_ColonAndDashFormats
=== RUN   TestIdentifySeries_ColonAndDashFormats/Colon_separator
=== RUN   TestIdentifySeries_ColonAndDashFormats/Dash_separator
--- PASS: TestIdentifySeries_ColonAndDashFormats (0.00s)
    --- PASS: TestIdentifySeries_ColonAndDashFormats/Colon_separator (0.00s)
    --- PASS: TestIdentifySeries_ColonAndDashFormats/Dash_separator (0.00s)
=== RUN   TestIsSingleWord
=== RUN   TestIsSingleWord/word
=== RUN   TestIsSingleWord/two_words
=== RUN   TestIsSingleWord/#00
=== RUN   TestIsSingleWord/__
=== RUN   TestIsSingleWord/multiple_word_phrase
--- PASS: TestIsSingleWord (0.00s)
    --- PASS: TestIsSingleWord/word (0.00s)
    --- PASS: TestIsSingleWord/two_words (0.00s)
    --- PASS: TestIsSingleWord/#00 (0.00s)
    --- PASS: TestIsSingleWord/__ (0.00s)
    --- PASS: TestIsSingleWord/multiple_word_phrase (0.00s)
=== RUN   TestIdentifySeries_EmptyTitle
--- PASS: TestIdentifySeries_EmptyTitle (0.00s)
=== RUN   TestIdentifySeries_ComplexPaths
=== RUN   TestIdentifySeries_ComplexPaths/Deep_nested_path
=== RUN   TestIdentifySeries_ComplexPaths/Path_with_special_characters
--- PASS: TestIdentifySeries_ComplexPaths (0.00s)
    --- PASS: TestIdentifySeries_ComplexPaths/Deep_nested_path (0.00s)
    --- PASS: TestIdentifySeries_ComplexPaths/Path_with_special_characters (0.00s)
PASS
coverage: 93.5% of statements
ok  	github.com/jdfalk/audiobook-organizer/internal/matcher	(cached)	coverage: 93.5% of statements
=== RUN   TestGenerateQualityString
=== RUN   TestGenerateQualityString/MP3_320kbps
=== RUN   TestGenerateQualityString/AAC_256kbps
=== RUN   TestGenerateQualityString/FLAC_16-bit_44.1kHz
=== RUN   TestGenerateQualityString/FLAC_24-bit_96kHz
=== RUN   TestGenerateQualityString/Vorbis_192kbps
--- PASS: TestGenerateQualityString (0.00s)
    --- PASS: TestGenerateQualityString/MP3_320kbps (0.00s)
    --- PASS: TestGenerateQualityString/AAC_256kbps (0.00s)
    --- PASS: TestGenerateQualityString/FLAC_16-bit_44.1kHz (0.00s)
    --- PASS: TestGenerateQualityString/FLAC_24-bit_96kHz (0.00s)
    --- PASS: TestGenerateQualityString/Vorbis_192kbps (0.00s)
=== RUN   TestGetQualityTier
=== RUN   TestGetQualityTier/FLAC_24-bit_(highest)
=== RUN   TestGetQualityTier/FLAC_16-bit
=== RUN   TestGetQualityTier/MP3_320kbps
=== RUN   TestGetQualityTier/AAC_256kbps
=== RUN   TestGetQualityTier/MP3_192kbps
=== RUN   TestGetQualityTier/AAC_128kbps
=== RUN   TestGetQualityTier/Low_bitrate
--- PASS: TestGetQualityTier (0.00s)
    --- PASS: TestGetQualityTier/FLAC_24-bit_(highest) (0.00s)
    --- PASS: TestGetQualityTier/FLAC_16-bit (0.00s)
    --- PASS: TestGetQualityTier/MP3_320kbps (0.00s)
    --- PASS: TestGetQualityTier/AAC_256kbps (0.00s)
    --- PASS: TestGetQualityTier/MP3_192kbps (0.00s)
    --- PASS: TestGetQualityTier/AAC_128kbps (0.00s)
    --- PASS: TestGetQualityTier/Low_bitrate (0.00s)
=== RUN   TestInferFromFormat
=== RUN   TestInferFromFormat/MP3_file
=== RUN   TestInferFromFormat/M4B_file
=== RUN   TestInferFromFormat/M4A_file
=== RUN   TestInferFromFormat/FLAC_file
=== RUN   TestInferFromFormat/OGG_file
--- PASS: TestInferFromFormat (0.00s)
    --- PASS: TestInferFromFormat/MP3_file (0.00s)
    --- PASS: TestInferFromFormat/M4B_file (0.00s)
    --- PASS: TestInferFromFormat/M4A_file (0.00s)
    --- PASS: TestInferFromFormat/FLAC_file (0.00s)
    --- PASS: TestInferFromFormat/OGG_file (0.00s)
=== RUN   TestInferFromFormat_UnsupportedExtension
--- PASS: TestInferFromFormat_UnsupportedExtension (0.00s)
=== RUN   TestExtract_NonExistentFile
--- PASS: TestExtract_NonExistentFile (0.00s)
=== RUN   TestExtract_EmptyFile
--- PASS: TestExtract_EmptyFile (0.01s)
=== RUN   TestMediaInfo_Struct
--- PASS: TestMediaInfo_Struct (0.00s)
=== RUN   TestExtractMP3Info
--- PASS: TestExtractMP3Info (0.00s)
=== RUN   TestExtractM4AInfo
--- PASS: TestExtractM4AInfo (0.00s)
=== RUN   TestExtractFLACInfo
--- PASS: TestExtractFLACInfo (0.00s)
=== RUN   TestExtractOGGInfo
--- PASS: TestExtractOGGInfo (0.00s)
=== RUN   TestExtract_RealFiles
=== RUN   TestExtract_RealFiles/test.mp3
    mediainfo_test.go:325: Test file /tmp/audiobook_test_files/test.mp3 not found
=== RUN   TestExtract_RealFiles/test.m4a
    mediainfo_test.go:325: Test file /tmp/audiobook_test_files/test.m4a not found
=== RUN   TestExtract_RealFiles/test.flac
    mediainfo_test.go:325: Test file /tmp/audiobook_test_files/test.flac not found
=== RUN   TestExtract_RealFiles/test.ogg
    mediainfo_test.go:325: Test file /tmp/audiobook_test_files/test.ogg not found
--- PASS: TestExtract_RealFiles (0.00s)
    --- SKIP: TestExtract_RealFiles/test.mp3 (0.00s)
    --- SKIP: TestExtract_RealFiles/test.m4a (0.00s)
    --- SKIP: TestExtract_RealFiles/test.flac (0.00s)
    --- SKIP: TestExtract_RealFiles/test.ogg (0.00s)
=== RUN   TestExtract_FallbackBehavior
=== RUN   TestExtract_FallbackBehavior/test.mp3
=== RUN   TestExtract_FallbackBehavior/test.m4a
=== RUN   TestExtract_FallbackBehavior/test.flac
=== RUN   TestExtract_FallbackBehavior/test.ogg
--- PASS: TestExtract_FallbackBehavior (0.01s)
    --- PASS: TestExtract_FallbackBehavior/test.mp3 (0.00s)
    --- PASS: TestExtract_FallbackBehavior/test.m4a (0.00s)
    --- PASS: TestExtract_FallbackBehavior/test.flac (0.00s)
    --- PASS: TestExtract_FallbackBehavior/test.ogg (0.00s)
=== RUN   TestGenerateQualityString_EdgeCases
=== RUN   TestGenerateQualityString_EdgeCases/Zero_bitrate
=== RUN   TestGenerateQualityString_EdgeCases/FLAC_zero_bit_depth
=== RUN   TestGenerateQualityString_EdgeCases/High_sample_rate
--- PASS: TestGenerateQualityString_EdgeCases (0.00s)
    --- PASS: TestGenerateQualityString_EdgeCases/Zero_bitrate (0.00s)
    --- PASS: TestGenerateQualityString_EdgeCases/FLAC_zero_bit_depth (0.00s)
    --- PASS: TestGenerateQualityString_EdgeCases/High_sample_rate (0.00s)
=== RUN   TestGetQualityTier_Boundaries
=== RUN   TestGetQualityTier_Boundaries/320kbps_boundary
=== RUN   TestGetQualityTier_Boundaries/256kbps_boundary
=== RUN   TestGetQualityTier_Boundaries/192kbps_boundary
=== RUN   TestGetQualityTier_Boundaries/128kbps_boundary
=== RUN   TestGetQualityTier_Boundaries/64kbps_low
=== RUN   TestGetQualityTier_Boundaries/0kbps_minimum
--- PASS: TestGetQualityTier_Boundaries (0.00s)
    --- PASS: TestGetQualityTier_Boundaries/320kbps_boundary (0.00s)
    --- PASS: TestGetQualityTier_Boundaries/256kbps_boundary (0.00s)
    --- PASS: TestGetQualityTier_Boundaries/192kbps_boundary (0.00s)
    --- PASS: TestGetQualityTier_Boundaries/128kbps_boundary (0.00s)
    --- PASS: TestGetQualityTier_Boundaries/64kbps_low (0.00s)
    --- PASS: TestGetQualityTier_Boundaries/0kbps_minimum (0.00s)
=== RUN   TestExtract_MP3WithTags
--- PASS: TestExtract_MP3WithTags (0.01s)
=== RUN   TestExtract_M4AWithTags
--- PASS: TestExtract_M4AWithTags (0.00s)
=== RUN   TestExtract_FLACWithTags
--- PASS: TestExtract_FLACWithTags (0.00s)
=== RUN   TestExtract_OGGWithTags
--- PASS: TestExtract_OGGWithTags (0.00s)
=== RUN   TestExtract_M4BFormat
--- PASS: TestExtract_M4BFormat (0.01s)
=== RUN   TestExtract_OGAFormat
--- PASS: TestExtract_OGAFormat (0.00s)
=== RUN   TestInferFromFormat_CaseInsensitivity
=== RUN   TestInferFromFormat_CaseInsensitivity/test.MP3
=== RUN   TestInferFromFormat_CaseInsensitivity/test.Mp3
=== RUN   TestInferFromFormat_CaseInsensitivity/test.FLAC
=== RUN   TestInferFromFormat_CaseInsensitivity/test.M4A
=== RUN   TestInferFromFormat_CaseInsensitivity/test.OGG
--- PASS: TestInferFromFormat_CaseInsensitivity (0.00s)
    --- PASS: TestInferFromFormat_CaseInsensitivity/test.MP3 (0.00s)
    --- PASS: TestInferFromFormat_CaseInsensitivity/test.Mp3 (0.00s)
    --- PASS: TestInferFromFormat_CaseInsensitivity/test.FLAC (0.00s)
    --- PASS: TestInferFromFormat_CaseInsensitivity/test.M4A (0.00s)
    --- PASS: TestInferFromFormat_CaseInsensitivity/test.OGG (0.00s)
=== RUN   TestExtract_FormatExtraction
=== RUN   TestExtract_FormatExtraction/.mp3
=== RUN   TestExtract_FormatExtraction/.m4a
=== RUN   TestExtract_FormatExtraction/.m4b
=== RUN   TestExtract_FormatExtraction/.flac
=== RUN   TestExtract_FormatExtraction/.ogg
=== RUN   TestExtract_FormatExtraction/.oga
--- PASS: TestExtract_FormatExtraction (0.01s)
    --- PASS: TestExtract_FormatExtraction/.mp3 (0.00s)
    --- PASS: TestExtract_FormatExtraction/.m4a (0.00s)
    --- PASS: TestExtract_FormatExtraction/.m4b (0.00s)
    --- PASS: TestExtract_FormatExtraction/.flac (0.00s)
    --- PASS: TestExtract_FormatExtraction/.ogg (0.00s)
    --- PASS: TestExtract_FormatExtraction/.oga (0.00s)
=== RUN   TestGetQualityTier_AboveBoundaries
=== RUN   TestGetQualityTier_AboveBoundaries/400kbps_(above_320)
=== RUN   TestGetQualityTier_AboveBoundaries/350kbps_(above_320)
=== RUN   TestGetQualityTier_AboveBoundaries/260kbps_(above_256)
=== RUN   TestGetQualityTier_AboveBoundaries/200kbps_(above_192)
=== RUN   TestGetQualityTier_AboveBoundaries/150kbps_(above_128)
=== RUN   TestGetQualityTier_AboveBoundaries/FLAC_32-bit
=== RUN   TestGetQualityTier_AboveBoundaries/FLAC_24-bit
--- PASS: TestGetQualityTier_AboveBoundaries (0.00s)
    --- PASS: TestGetQualityTier_AboveBoundaries/400kbps_(above_320) (0.00s)
    --- PASS: TestGetQualityTier_AboveBoundaries/350kbps_(above_320) (0.00s)
    --- PASS: TestGetQualityTier_AboveBoundaries/260kbps_(above_256) (0.00s)
    --- PASS: TestGetQualityTier_AboveBoundaries/200kbps_(above_192) (0.00s)
    --- PASS: TestGetQualityTier_AboveBoundaries/150kbps_(above_128) (0.00s)
    --- PASS: TestGetQualityTier_AboveBoundaries/FLAC_32-bit (0.00s)
    --- PASS: TestGetQualityTier_AboveBoundaries/FLAC_24-bit (0.00s)
=== RUN   TestExtract_RealMP3File
    mediainfo_test.go:921: Extracted info: Codec=MP3, Bitrate=192, SampleRate=44100, Quality=192kbps MP3
--- PASS: TestExtract_RealMP3File (0.00s)
=== RUN   TestExtractMP3Info_WithMetadata
=== RUN   TestExtractMP3Info_WithMetadata/With_bitrate_and_sample_rate
=== RUN   TestExtractMP3Info_WithMetadata/With_only_bitrate
=== RUN   TestExtractMP3Info_WithMetadata/No_metadata_(defaults)
=== RUN   TestExtractMP3Info_WithMetadata/Wrong_type_in_metadata
--- PASS: TestExtractMP3Info_WithMetadata (0.00s)
    --- PASS: TestExtractMP3Info_WithMetadata/With_bitrate_and_sample_rate (0.00s)
    --- PASS: TestExtractMP3Info_WithMetadata/With_only_bitrate (0.00s)
    --- PASS: TestExtractMP3Info_WithMetadata/No_metadata_(defaults) (0.00s)
    --- PASS: TestExtractMP3Info_WithMetadata/Wrong_type_in_metadata (0.00s)
=== RUN   TestExtractM4AInfo_WithMetadata
=== RUN   TestExtractM4AInfo_WithMetadata/With_bitrate_and_sample_rate
=== RUN   TestExtractM4AInfo_WithMetadata/With_only_sample_rate
=== RUN   TestExtractM4AInfo_WithMetadata/No_metadata_(defaults)
=== RUN   TestExtractM4AInfo_WithMetadata/Wrong_type_in_metadata
--- PASS: TestExtractM4AInfo_WithMetadata (0.00s)
    --- PASS: TestExtractM4AInfo_WithMetadata/With_bitrate_and_sample_rate (0.00s)
    --- PASS: TestExtractM4AInfo_WithMetadata/With_only_sample_rate (0.00s)
    --- PASS: TestExtractM4AInfo_WithMetadata/No_metadata_(defaults) (0.00s)
    --- PASS: TestExtractM4AInfo_WithMetadata/Wrong_type_in_metadata (0.00s)
=== RUN   TestExtractFLACInfo_WithMetadata
=== RUN   TestExtractFLACInfo_WithMetadata/With_sample_rate_and_bit_depth
=== RUN   TestExtractFLACInfo_WithMetadata/With_only_sample_rate
=== RUN   TestExtractFLACInfo_WithMetadata/No_metadata_(defaults)
=== RUN   TestExtractFLACInfo_WithMetadata/Wrong_types
--- PASS: TestExtractFLACInfo_WithMetadata (0.00s)
    --- PASS: TestExtractFLACInfo_WithMetadata/With_sample_rate_and_bit_depth (0.00s)
    --- PASS: TestExtractFLACInfo_WithMetadata/With_only_sample_rate (0.00s)
    --- PASS: TestExtractFLACInfo_WithMetadata/No_metadata_(defaults) (0.00s)
    --- PASS: TestExtractFLACInfo_WithMetadata/Wrong_types (0.00s)
=== RUN   TestExtractOGGInfo_WithMetadata
=== RUN   TestExtractOGGInfo_WithMetadata/With_bitrate_and_sample_rate
=== RUN   TestExtractOGGInfo_WithMetadata/With_only_bitrate
=== RUN   TestExtractOGGInfo_WithMetadata/No_metadata_(defaults)
=== RUN   TestExtractOGGInfo_WithMetadata/Wrong_types
--- PASS: TestExtractOGGInfo_WithMetadata (0.00s)
    --- PASS: TestExtractOGGInfo_WithMetadata/With_bitrate_and_sample_rate (0.00s)
    --- PASS: TestExtractOGGInfo_WithMetadata/With_only_bitrate (0.00s)
    --- PASS: TestExtractOGGInfo_WithMetadata/No_metadata_(defaults) (0.00s)
    --- PASS: TestExtractOGGInfo_WithMetadata/Wrong_types (0.00s)
PASS
coverage: 98.2% of statements
ok  	github.com/jdfalk/audiobook-organizer/internal/mediainfo	(cached)	coverage: 98.2% of statements
=== RUN   TestExtractMetadata_UsesAlbumArtistForAuthor
2026/01/24 13:06:40 [DEBUG] metadata: extracting tags for /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestExtractMetadata_UsesAlbumArtistForAuthor4048494938/001/test_sample.mp3
2026/01/24 13:06:40 [TRACE] metadata: raw tag keys for /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestExtractMetadata_UsesAlbumArtistForAuthor4048494938/001/test_sample.mp3: [TALB TIT2 TPE1 TPE2 TSSE]
2026/01/24 13:06:40 [TRACE] metadata: sources for /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestExtractMetadata_UsesAlbumArtistForAuthor4048494938/001/test_sample.mp3 | title=tag.Title | author=tag.AlbumArtist (album_artist) | series=album fallback | series_index= | narrator=tag.Artist | album=tag.Album | publisher=unset | language=unset
2026/01/24 13:06:40 [DEBUG] metadata: extracted for /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestExtractMetadata_UsesAlbumArtistForAuthor4048494938/001/test_sample.mp3 (title="The Title" author="Author Example" series="The Album" position=0)
--- PASS: TestExtractMetadata_UsesAlbumArtistForAuthor (0.02s)
=== RUN   TestExtractMetadata_ComposerOverridesAlbumArtist
2026/01/24 13:06:40 [DEBUG] metadata: extracting tags for /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestExtractMetadata_ComposerOverridesAlbumArtist2166245410/001/test_sample.mp3
2026/01/24 13:06:40 [TRACE] metadata: raw tag keys for /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestExtractMetadata_ComposerOverridesAlbumArtist2166245410/001/test_sample.mp3: [TCOM TIT2 TPE1 TPE2 TSSE TXXX]
2026/01/24 13:06:40 [TRACE] metadata: sources for /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestExtractMetadata_ComposerOverridesAlbumArtist2166245410/001/test_sample.mp3 | title=tag.Title | author=tag.Composer (composer) | series=title fallback | series_index= | narrator=raw.narrator | album=unset | publisher=unset | language=unset
2026/01/24 13:06:40 [DEBUG] metadata: extracted for /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestExtractMetadata_ComposerOverridesAlbumArtist2166245410/001/test_sample.mp3 (title="Composer Title" author="Composer Author" series="Composer Title" position=0)
--- PASS: TestExtractMetadata_ComposerOverridesAlbumArtist (0.01s)
=== RUN   TestExtractMetadata_FallbackFlagOnReadError
2026/01/24 13:06:40 [DEBUG] metadata: extracting tags for /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestExtractMetadata_FallbackFlagOnReadError4274578042/001/Author Name - Book Title.mp3
2026/01/24 13:06:40 [WARN] metadata: failed to read tags for /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestExtractMetadata_FallbackFlagOnReadError4274578042/001/Author Name - Book Title.mp3: unexpected EOF; falling back to filename parsing
--- PASS: TestExtractMetadata_FallbackFlagOnReadError (0.01s)
=== RUN   TestFirstNonEmpty
=== RUN   TestFirstNonEmpty/FirstNonEmpty
=== RUN   TestFirstNonEmpty/AllEmpty
=== RUN   TestFirstNonEmpty/WithWhitespace
=== RUN   TestFirstNonEmpty/NoValues
=== RUN   TestFirstNonEmpty/FirstIsValue
--- PASS: TestFirstNonEmpty (0.00s)
    --- PASS: TestFirstNonEmpty/FirstNonEmpty (0.00s)
    --- PASS: TestFirstNonEmpty/AllEmpty (0.00s)
    --- PASS: TestFirstNonEmpty/WithWhitespace (0.00s)
    --- PASS: TestFirstNonEmpty/NoValues (0.00s)
    --- PASS: TestFirstNonEmpty/FirstIsValue (0.00s)
=== RUN   TestExtractSeriesFromComments
=== RUN   TestExtractSeriesFromComments/SeriesColon
=== RUN   TestExtractSeriesFromComments/SeriesColonWithSpace
=== RUN   TestExtractSeriesFromComments/PartOf
=== RUN   TestExtractSeriesFromComments/WithNewline
=== RUN   TestExtractSeriesFromComments/WithComma
=== RUN   TestExtractSeriesFromComments/WithPeriod
=== RUN   TestExtractSeriesFromComments/NoMatch
=== RUN   TestExtractSeriesFromComments/EmptyComment
--- PASS: TestExtractSeriesFromComments (0.00s)
    --- PASS: TestExtractSeriesFromComments/SeriesColon (0.00s)
    --- PASS: TestExtractSeriesFromComments/SeriesColonWithSpace (0.00s)
    --- PASS: TestExtractSeriesFromComments/PartOf (0.00s)
    --- PASS: TestExtractSeriesFromComments/WithNewline (0.00s)
    --- PASS: TestExtractSeriesFromComments/WithComma (0.00s)
    --- PASS: TestExtractSeriesFromComments/WithPeriod (0.00s)
    --- PASS: TestExtractSeriesFromComments/NoMatch (0.00s)
    --- PASS: TestExtractSeriesFromComments/EmptyComment (0.00s)
=== RUN   TestExtractYearDigits
=== RUN   TestExtractYearDigits/YearOnly
=== RUN   TestExtractYearDigits/YearWithText
=== RUN   TestExtractYearDigits/DateFormat
=== RUN   TestExtractYearDigits/NoYear
=== RUN   TestExtractYearDigits/ThreeDigits
=== RUN   TestExtractYearDigits/MultipleYears
--- PASS: TestExtractYearDigits (0.00s)
    --- PASS: TestExtractYearDigits/YearOnly (0.00s)
    --- PASS: TestExtractYearDigits/YearWithText (0.00s)
    --- PASS: TestExtractYearDigits/DateFormat (0.00s)
    --- PASS: TestExtractYearDigits/NoYear (0.00s)
    --- PASS: TestExtractYearDigits/ThreeDigits (0.00s)
    --- PASS: TestExtractYearDigits/MultipleYears (0.00s)
=== RUN   TestExtractAuthorFromDirectory
=== RUN   TestExtractAuthorFromDirectory/AuthorTitlePattern
=== RUN   TestExtractAuthorFromDirectory/SimpleAuthorName
=== RUN   TestExtractAuthorFromDirectory/SkipBooksDirectory
=== RUN   TestExtractAuthorFromDirectory/SkipAudiobooksDirectory
=== RUN   TestExtractAuthorFromDirectory/SkipDownloadsDirectory
=== RUN   TestExtractAuthorFromDirectory/TranslatorPattern
=== RUN   TestExtractAuthorFromDirectory/NarratedByPattern
=== RUN   TestExtractAuthorFromDirectory/InvalidAuthorBook
=== RUN   TestExtractAuthorFromDirectory/InvalidAuthorChapter
=== RUN   TestExtractAuthorFromDirectory/CaseInsensitiveSkip
--- PASS: TestExtractAuthorFromDirectory (0.00s)
    --- PASS: TestExtractAuthorFromDirectory/AuthorTitlePattern (0.00s)
    --- PASS: TestExtractAuthorFromDirectory/SimpleAuthorName (0.00s)
    --- PASS: TestExtractAuthorFromDirectory/SkipBooksDirectory (0.00s)
    --- PASS: TestExtractAuthorFromDirectory/SkipAudiobooksDirectory (0.00s)
    --- PASS: TestExtractAuthorFromDirectory/SkipDownloadsDirectory (0.00s)
    --- PASS: TestExtractAuthorFromDirectory/TranslatorPattern (0.00s)
    --- PASS: TestExtractAuthorFromDirectory/NarratedByPattern (0.00s)
    --- PASS: TestExtractAuthorFromDirectory/InvalidAuthorBook (0.00s)
    --- PASS: TestExtractAuthorFromDirectory/InvalidAuthorChapter (0.00s)
    --- PASS: TestExtractAuthorFromDirectory/CaseInsensitiveSkip (0.00s)
=== RUN   TestIsValidAuthor
=== RUN   TestIsValidAuthor/ValidName
=== RUN   TestIsValidAuthor/EmptyString
=== RUN   TestIsValidAuthor/StartsWithBook
=== RUN   TestIsValidAuthor/StartsWithChapter
=== RUN   TestIsValidAuthor/StartsWithPart
=== RUN   TestIsValidAuthor/StartsWithVol
=== RUN   TestIsValidAuthor/StartsWithVolume
=== RUN   TestIsValidAuthor/StartsWithDisc
=== RUN   TestIsValidAuthor/PurelyNumeric
=== RUN   TestIsValidAuthor/ChapterPattern
=== RUN   TestIsValidAuthor/ValidWithNumber
=== RUN   TestIsValidAuthor/CaseInsensitive
--- PASS: TestIsValidAuthor (0.00s)
    --- PASS: TestIsValidAuthor/ValidName (0.00s)
    --- PASS: TestIsValidAuthor/EmptyString (0.00s)
    --- PASS: TestIsValidAuthor/StartsWithBook (0.00s)
    --- PASS: TestIsValidAuthor/StartsWithChapter (0.00s)
    --- PASS: TestIsValidAuthor/StartsWithPart (0.00s)
    --- PASS: TestIsValidAuthor/StartsWithVol (0.00s)
    --- PASS: TestIsValidAuthor/StartsWithVolume (0.00s)
    --- PASS: TestIsValidAuthor/StartsWithDisc (0.00s)
    --- PASS: TestIsValidAuthor/PurelyNumeric (0.00s)
    --- PASS: TestIsValidAuthor/ChapterPattern (0.00s)
    --- PASS: TestIsValidAuthor/ValidWithNumber (0.00s)
    --- PASS: TestIsValidAuthor/CaseInsensitive (0.00s)
=== RUN   TestParseFilenameForAuthor
=== RUN   TestParseFilenameForAuthor/TitleDashAuthor
=== RUN   TestParseFilenameForAuthor/AuthorDashTitle
=== RUN   TestParseFilenameForAuthor/NotTwoParts
=== RUN   TestParseFilenameForAuthor/NoDash
=== RUN   TestParseFilenameForAuthor/BothLookLikeNames
=== RUN   TestParseFilenameForAuthor/NeitherLooksLikeName
--- PASS: TestParseFilenameForAuthor (0.00s)
    --- PASS: TestParseFilenameForAuthor/TitleDashAuthor (0.00s)
    --- PASS: TestParseFilenameForAuthor/AuthorDashTitle (0.00s)
    --- PASS: TestParseFilenameForAuthor/NotTwoParts (0.00s)
    --- PASS: TestParseFilenameForAuthor/NoDash (0.00s)
    --- PASS: TestParseFilenameForAuthor/BothLookLikeNames (0.00s)
    --- PASS: TestParseFilenameForAuthor/NeitherLooksLikeName (0.00s)
=== RUN   TestLooksLikePersonName
=== RUN   TestLooksLikePersonName/InitialsWithPeriods
=== RUN   TestLooksLikePersonName/InitialsNoPeriods
=== RUN   TestLooksLikePersonName/ProperCase
=== RUN   TestLooksLikePersonName/ThreeWords
=== RUN   TestLooksLikePersonName/LowerCase
=== RUN   TestLooksLikePersonName/SingleWord
=== RUN   TestLooksLikePersonName/TooManyWords
=== RUN   TestLooksLikePersonName/StartsWithLowercase
=== RUN   TestLooksLikePersonName/SecondWordLowercase
=== RUN   TestLooksLikePersonName/InvalidAuthor
=== RUN   TestLooksLikePersonName/EmptyString
=== RUN   TestLooksLikePersonName/SingleInitial
=== RUN   TestLooksLikePersonName/MixedCase
--- PASS: TestLooksLikePersonName (0.00s)
    --- PASS: TestLooksLikePersonName/InitialsWithPeriods (0.00s)
    --- PASS: TestLooksLikePersonName/InitialsNoPeriods (0.00s)
    --- PASS: TestLooksLikePersonName/ProperCase (0.00s)
    --- PASS: TestLooksLikePersonName/ThreeWords (0.00s)
    --- PASS: TestLooksLikePersonName/LowerCase (0.00s)
    --- PASS: TestLooksLikePersonName/SingleWord (0.00s)
    --- PASS: TestLooksLikePersonName/TooManyWords (0.00s)
    --- PASS: TestLooksLikePersonName/StartsWithLowercase (0.00s)
    --- PASS: TestLooksLikePersonName/SecondWordLowercase (0.00s)
    --- PASS: TestLooksLikePersonName/InvalidAuthor (0.00s)
    --- PASS: TestLooksLikePersonName/EmptyString (0.00s)
    --- PASS: TestLooksLikePersonName/SingleInitial (0.00s)
    --- PASS: TestLooksLikePersonName/MixedCase (0.00s)
=== RUN   TestIsTitleCaseCandidate
=== RUN   TestIsTitleCaseCandidate/TitleCase
=== RUN   TestIsTitleCaseCandidate/Lowercase
=== RUN   TestIsTitleCaseCandidate/Whitespace
--- PASS: TestIsTitleCaseCandidate (0.00s)
    --- PASS: TestIsTitleCaseCandidate/TitleCase (0.00s)
    --- PASS: TestIsTitleCaseCandidate/Lowercase (0.00s)
    --- PASS: TestIsTitleCaseCandidate/Whitespace (0.00s)
=== RUN   TestExtractFromFilename
=== RUN   TestExtractFromFilename/UnderscoreSeparator
=== RUN   TestExtractFromFilename/UnderscoreAuthorFirst
=== RUN   TestExtractFromFilename/DashSeparator
=== RUN   TestExtractFromFilename/LeadingTrackNumber
=== RUN   TestExtractFromFilename/ChapterSuffix
=== RUN   TestExtractFromFilename/NoSeparator
--- PASS: TestExtractFromFilename (0.00s)
    --- PASS: TestExtractFromFilename/UnderscoreSeparator (0.00s)
    --- PASS: TestExtractFromFilename/UnderscoreAuthorFirst (0.00s)
    --- PASS: TestExtractFromFilename/DashSeparator (0.00s)
    --- PASS: TestExtractFromFilename/LeadingTrackNumber (0.00s)
    --- PASS: TestExtractFromFilename/ChapterSuffix (0.00s)
    --- PASS: TestExtractFromFilename/NoSeparator (0.00s)
=== RUN   TestExtractFromFilename_WithDirectory
--- PASS: TestExtractFromFilename_WithDirectory (0.01s)
=== RUN   TestNormalizeRawTagValue
=== RUN   TestNormalizeRawTagValue/String
=== RUN   TestNormalizeRawTagValue/StringArray
=== RUN   TestNormalizeRawTagValue/StringArrayWithReleaseGroup
=== RUN   TestNormalizeRawTagValue/ByteArray
=== RUN   TestNormalizeRawTagValue/CommPointer
=== RUN   TestNormalizeRawTagValue/CommValue
=== RUN   TestNormalizeRawTagValue/Integer
=== RUN   TestNormalizeRawTagValue/Nil
=== RUN   TestNormalizeRawTagValue/EmptyString
=== RUN   TestNormalizeRawTagValue/Whitespace
--- PASS: TestNormalizeRawTagValue (0.00s)
    --- PASS: TestNormalizeRawTagValue/String (0.00s)
    --- PASS: TestNormalizeRawTagValue/StringArray (0.00s)
    --- PASS: TestNormalizeRawTagValue/StringArrayWithReleaseGroup (0.00s)
    --- PASS: TestNormalizeRawTagValue/ByteArray (0.00s)
    --- PASS: TestNormalizeRawTagValue/CommPointer (0.00s)
    --- PASS: TestNormalizeRawTagValue/CommValue (0.00s)
    --- PASS: TestNormalizeRawTagValue/Integer (0.00s)
    --- PASS: TestNormalizeRawTagValue/Nil (0.00s)
    --- PASS: TestNormalizeRawTagValue/EmptyString (0.00s)
    --- PASS: TestNormalizeRawTagValue/Whitespace (0.00s)
=== RUN   TestLooksLikeReleaseGroupTag
=== RUN   TestLooksLikeReleaseGroupTag/ReleaseGroup
=== RUN   TestLooksLikeReleaseGroupTag/ReleaseGroupWithText
=== RUN   TestLooksLikeReleaseGroupTag/NotReleaseGroup
=== RUN   TestLooksLikeReleaseGroupTag/EmptyBrackets
=== RUN   TestLooksLikeReleaseGroupTag/EmptyString
=== RUN   TestLooksLikeReleaseGroupTag/OnlyOpenBracket
=== RUN   TestLooksLikeReleaseGroupTag/OnlyCloseBracket
=== RUN   TestLooksLikeReleaseGroupTag/WithWhitespace
--- PASS: TestLooksLikeReleaseGroupTag (0.00s)
    --- PASS: TestLooksLikeReleaseGroupTag/ReleaseGroup (0.00s)
    --- PASS: TestLooksLikeReleaseGroupTag/ReleaseGroupWithText (0.00s)
    --- PASS: TestLooksLikeReleaseGroupTag/NotReleaseGroup (0.00s)
    --- PASS: TestLooksLikeReleaseGroupTag/EmptyBrackets (0.00s)
    --- PASS: TestLooksLikeReleaseGroupTag/EmptyString (0.00s)
    --- PASS: TestLooksLikeReleaseGroupTag/OnlyOpenBracket (0.00s)
    --- PASS: TestLooksLikeReleaseGroupTag/OnlyCloseBracket (0.00s)
    --- PASS: TestLooksLikeReleaseGroupTag/WithWhitespace (0.00s)
=== RUN   TestGetRawString_NilMap
--- PASS: TestGetRawString_NilMap (0.00s)
=== RUN   TestGetRawString_CaseInsensitiveComm
--- PASS: TestGetRawString_CaseInsensitiveComm (0.00s)
=== RUN   TestGetRawString_CommValueType
--- PASS: TestGetRawString_CommValueType (0.00s)
=== RUN   TestSetFieldSource_NilMap
--- PASS: TestSetFieldSource_NilMap (0.00s)
=== RUN   TestSetFieldSource_EmptySource
--- PASS: TestSetFieldSource_EmptySource (0.00s)
=== RUN   TestSourceOrUnknown_NilMap
--- PASS: TestSourceOrUnknown_NilMap (0.00s)
=== RUN   TestSourceOrUnknown_MissingField
--- PASS: TestSourceOrUnknown_MissingField (0.00s)
=== RUN   TestSourceOrUnknown_EmptyValue
--- PASS: TestSourceOrUnknown_EmptyValue (0.00s)
=== RUN   TestSourceOrUnknown_ValidValue
--- PASS: TestSourceOrUnknown_ValidValue (0.00s)
=== RUN   TestExtractMetadata_FileNotFound
2026/01/24 13:06:40 [DEBUG] metadata: extracting tags for /nonexistent/file.m4b
--- PASS: TestExtractMetadata_FileNotFound (0.00s)
=== RUN   TestGetRawStringCaseInsensitive
--- PASS: TestGetRawStringCaseInsensitive (0.00s)
=== RUN   TestGetRawStringSkipsReleaseGroupTag
--- PASS: TestGetRawStringSkipsReleaseGroupTag (0.00s)
=== RUN   TestGetRawStringFromTXXXComm
--- PASS: TestGetRawStringFromTXXXComm (0.00s)
=== RUN   TestNewOpenLibraryClient
--- PASS: TestNewOpenLibraryClient (0.00s)
=== RUN   TestNewOpenLibraryClientUsesEnvBaseURL
--- PASS: TestNewOpenLibraryClientUsesEnvBaseURL (0.00s)
=== RUN   TestSearchByTitle
--- PASS: TestSearchByTitle (0.00s)
=== RUN   TestSearchByTitleAndAuthor
--- PASS: TestSearchByTitleAndAuthor (0.00s)
=== RUN   TestSearchByTitleNoResults
--- PASS: TestSearchByTitleNoResults (0.00s)
=== RUN   TestGetBookByISBN
--- PASS: TestGetBookByISBN (0.00s)
=== RUN   TestGetBookByISBNInvalid
--- PASS: TestGetBookByISBNInvalid (0.00s)
=== RUN   TestSearchByTitle_NetworkError
--- PASS: TestSearchByTitle_NetworkError (0.00s)
=== RUN   TestSearchByTitle_NonOKStatus
--- PASS: TestSearchByTitle_NonOKStatus (0.00s)
=== RUN   TestSearchByTitle_InvalidJSON
--- PASS: TestSearchByTitle_InvalidJSON (0.00s)
=== RUN   TestSearchByTitle_CompleteMetadata
--- PASS: TestSearchByTitle_CompleteMetadata (0.00s)
=== RUN   TestSearchByTitleAndAuthor_NetworkError
--- PASS: TestSearchByTitleAndAuthor_NetworkError (0.00s)
=== RUN   TestSearchByTitleAndAuthor_NonOKStatus
--- PASS: TestSearchByTitleAndAuthor_NonOKStatus (0.00s)
=== RUN   TestSearchByTitleAndAuthor_InvalidJSON
--- PASS: TestSearchByTitleAndAuthor_InvalidJSON (0.00s)
=== RUN   TestSearchByTitleAndAuthor_MultipleAuthors
--- PASS: TestSearchByTitleAndAuthor_MultipleAuthors (0.00s)
=== RUN   TestGetBookByISBN_NetworkError
--- PASS: TestGetBookByISBN_NetworkError (0.00s)
=== RUN   TestGetBookByISBN_NonOKNonNotFound
--- PASS: TestGetBookByISBN_NonOKNonNotFound (0.00s)
=== RUN   TestGetBookByISBN_InvalidJSON
--- PASS: TestGetBookByISBN_InvalidJSON (0.00s)
=== RUN   TestGetBookByISBN_EmptyResponse
--- PASS: TestGetBookByISBN_EmptyResponse (0.00s)
=== RUN   TestGetBookByISBN_ShortPublishDate
--- PASS: TestGetBookByISBN_ShortPublishDate (0.00s)
=== RUN   TestNewOpenLibraryClientWithBaseURL_TrailingSlash
--- PASS: TestNewOpenLibraryClientWithBaseURL_TrailingSlash (0.00s)
=== RUN   TestDetectVolumeNumberRomanNumerals
--- PASS: TestDetectVolumeNumberRomanNumerals (0.00s)
=== RUN   TestExtractSeriesFromVolumeString
=== RUN   TestExtractSeriesFromVolumeString/CommaVolSuffix
=== RUN   TestExtractSeriesFromVolumeString/HyphenVolume
=== RUN   TestExtractSeriesFromVolumeString/HashNumber
=== RUN   TestExtractSeriesFromVolumeString/NoMatch
--- PASS: TestExtractSeriesFromVolumeString (0.00s)
    --- PASS: TestExtractSeriesFromVolumeString/CommaVolSuffix (0.00s)
    --- PASS: TestExtractSeriesFromVolumeString/HyphenVolume (0.00s)
    --- PASS: TestExtractSeriesFromVolumeString/HashNumber (0.00s)
    --- PASS: TestExtractSeriesFromVolumeString/NoMatch (0.00s)
=== RUN   TestDetectVolumeNumberArabic
=== RUN   TestDetectVolumeNumberArabic/VolWithLeadingZero
=== RUN   TestDetectVolumeNumberArabic/VolumeNoDot
=== RUN   TestDetectVolumeNumberArabic/BookPrefix
=== RUN   TestDetectVolumeNumberArabic/BkPrefix
=== RUN   TestDetectVolumeNumberArabic/PartPrefix
=== RUN   TestDetectVolumeNumberArabic/HashPrefix
--- PASS: TestDetectVolumeNumberArabic (0.00s)
    --- PASS: TestDetectVolumeNumberArabic/VolWithLeadingZero (0.00s)
    --- PASS: TestDetectVolumeNumberArabic/VolumeNoDot (0.00s)
    --- PASS: TestDetectVolumeNumberArabic/BookPrefix (0.00s)
    --- PASS: TestDetectVolumeNumberArabic/BkPrefix (0.00s)
    --- PASS: TestDetectVolumeNumberArabic/PartPrefix (0.00s)
    --- PASS: TestDetectVolumeNumberArabic/HashPrefix (0.00s)
=== RUN   TestWriteMetadataToFile_UnsupportedFormat
--- PASS: TestWriteMetadataToFile_UnsupportedFormat (0.00s)
=== RUN   TestWriteM4BMetadata_ToolNotFound
--- PASS: TestWriteM4BMetadata_ToolNotFound (0.00s)
=== RUN   TestWriteMP3Metadata_ToolNotFound
--- PASS: TestWriteMP3Metadata_ToolNotFound (0.00s)
=== RUN   TestWriteFLACMetadata_ToolNotFound
--- PASS: TestWriteFLACMetadata_ToolNotFound (0.00s)
=== RUN   TestWriteMP3Metadata_FakeToolSuccess
--- PASS: TestWriteMP3Metadata_FakeToolSuccess (1.01s)
=== RUN   TestWriteFLACMetadata_FakeToolSuccess
--- PASS: TestWriteFLACMetadata_FakeToolSuccess (0.64s)
=== RUN   TestWriteMetadata_IntegrationM4B
    write_test.go:223: AtomicParsley unavailable for integration test: tag write failed (restored from backup): signal: segmentation fault, output: 
--- SKIP: TestWriteMetadata_IntegrationM4B (0.23s)
=== RUN   TestWriteMetadata_BackupRestore
--- PASS: TestWriteMetadata_BackupRestore (0.10s)
PASS
coverage: 71.2% of statements
ok  	github.com/jdfalk/audiobook-organizer/internal/metadata	(cached)	coverage: 71.2% of statements
	github.com/jdfalk/audiobook-organizer/internal/metadata/mocks		coverage: 0.0% of statements
=== RUN   TestRegister
    metrics_test.go:19: Register called multiple times successfully
--- PASS: TestRegister (0.00s)
=== RUN   TestIncOperationStarted
    metrics_test.go:31: Incremented operation started for: scan
    metrics_test.go:31: Incremented operation started for: organize
    metrics_test.go:31: Incremented operation started for: metadata_fetch
--- PASS: TestIncOperationStarted (0.00s)
=== RUN   TestIncOperationCompleted
    metrics_test.go:42: Incremented operation completed for: scan
    metrics_test.go:42: Incremented operation completed for: organize
    metrics_test.go:42: Incremented operation completed for: metadata_fetch
--- PASS: TestIncOperationCompleted (0.00s)
=== RUN   TestIncOperationFailed
    metrics_test.go:53: Incremented operation failed for: scan
    metrics_test.go:53: Incremented operation failed for: organize
    metrics_test.go:53: Incremented operation failed for: metadata_fetch
--- PASS: TestIncOperationFailed (0.00s)
=== RUN   TestIncOperationCanceled
    metrics_test.go:64: Incremented operation canceled for: scan
    metrics_test.go:64: Incremented operation canceled for: organize
    metrics_test.go:64: Incremented operation canceled for: metadata_fetch
--- PASS: TestIncOperationCanceled (0.00s)
=== RUN   TestObserveOperationDuration
=== RUN   TestObserveOperationDuration/Short_duration
    metrics_test.go:96: Observed duration 100ms for operation scan
=== RUN   TestObserveOperationDuration/Medium_duration
    metrics_test.go:96: Observed duration 2s for operation organize
=== RUN   TestObserveOperationDuration/Long_duration
    metrics_test.go:96: Observed duration 10s for operation metadata_fetch
--- PASS: TestObserveOperationDuration (0.00s)
    --- PASS: TestObserveOperationDuration/Short_duration (0.00s)
    --- PASS: TestObserveOperationDuration/Medium_duration (0.00s)
    --- PASS: TestObserveOperationDuration/Long_duration (0.00s)
=== RUN   TestSetBooks
    metrics_test.go:108: Set books gauge to: 0
    metrics_test.go:108: Set books gauge to: 1
    metrics_test.go:108: Set books gauge to: 100
    metrics_test.go:108: Set books gauge to: 1000
    metrics_test.go:108: Set books gauge to: 10000
--- PASS: TestSetBooks (0.00s)
=== RUN   TestSetFolders
    metrics_test.go:119: Set folders gauge to: 0
    metrics_test.go:119: Set folders gauge to: 1
    metrics_test.go:119: Set folders gauge to: 5
    metrics_test.go:119: Set folders gauge to: 10
    metrics_test.go:119: Set folders gauge to: 50
--- PASS: TestSetFolders (0.00s)
=== RUN   TestSetMemoryAlloc
    metrics_test.go:135: Set memory alloc gauge to: 0 bytes
    metrics_test.go:135: Set memory alloc gauge to: 1024 bytes
    metrics_test.go:135: Set memory alloc gauge to: 1048576 bytes
    metrics_test.go:135: Set memory alloc gauge to: 104857600 bytes
--- PASS: TestSetMemoryAlloc (0.00s)
=== RUN   TestSetGoroutines
    metrics_test.go:146: Set goroutines gauge to: 1
    metrics_test.go:146: Set goroutines gauge to: 10
    metrics_test.go:146: Set goroutines gauge to: 100
    metrics_test.go:146: Set goroutines gauge to: 1000
--- PASS: TestSetGoroutines (0.00s)
=== RUN   TestMetricsIntegration
    metrics_test.go:174: Successfully completed full metrics lifecycle test
--- PASS: TestMetricsIntegration (0.01s)
=== RUN   TestMetricsWithMultipleOperationTypes
    metrics_test.go:194: Successfully recorded 4 different operation types
--- PASS: TestMetricsWithMultipleOperationTypes (0.00s)
=== RUN   TestOperationLifecycle_Success
    metrics_test.go:208: Successfully completed operation lifecycle
--- PASS: TestOperationLifecycle_Success (0.01s)
=== RUN   TestOperationLifecycle_Failure
    metrics_test.go:222: Successfully recorded failed operation
--- PASS: TestOperationLifecycle_Failure (0.01s)
=== RUN   TestOperationLifecycle_Canceled
    metrics_test.go:236: Successfully recorded canceled operation
--- PASS: TestOperationLifecycle_Canceled (0.01s)
PASS
coverage: 100.0% of statements
ok  	github.com/jdfalk/audiobook-organizer/internal/metrics	(cached)	coverage: 100.0% of statements
=== RUN   TestAuthorStruct
--- PASS: TestAuthorStruct (0.00s)
=== RUN   TestAuthorJSON
--- PASS: TestAuthorJSON (0.00s)
=== RUN   TestSeriesStruct
--- PASS: TestSeriesStruct (0.00s)
=== RUN   TestSeriesJSON
--- PASS: TestSeriesJSON (0.00s)
=== RUN   TestAudiobookStruct
--- PASS: TestAudiobookStruct (0.00s)
=== RUN   TestAudiobookJSON
--- PASS: TestAudiobookJSON (0.00s)
=== RUN   TestAudiobookVersionManagement
--- PASS: TestAudiobookVersionManagement (0.00s)
=== RUN   TestAudiobookListRequest
--- PASS: TestAudiobookListRequest (0.00s)
=== RUN   TestAudiobookListResponse
--- PASS: TestAudiobookListResponse (0.00s)
=== RUN   TestAudiobookUpdateRequest
--- PASS: TestAudiobookUpdateRequest (0.00s)
=== RUN   TestBatchUpdateRequest
--- PASS: TestBatchUpdateRequest (0.00s)
=== RUN   TestFileSystemItem
--- PASS: TestFileSystemItem (0.00s)
=== RUN   TestBrowseRequest
--- PASS: TestBrowseRequest (0.00s)
=== RUN   TestExclusionRequest
--- PASS: TestExclusionRequest (0.00s)
=== RUN   TestSystemStatus
--- PASS: TestSystemStatus (0.00s)
=== RUN   TestLogEntry
--- PASS: TestLogEntry (0.00s)
=== RUN   TestAudiobookMediaInfo
--- PASS: TestAudiobookMediaInfo (0.00s)
PASS
coverage: [no statements]
ok  	github.com/jdfalk/audiobook-organizer/internal/models	(cached)	coverage: [no statements]
=== RUN   TestUpdateProgressNotifiesListeners
--- PASS: TestUpdateProgressNotifiesListeners (0.00s)
PASS
coverage: 8.0% of statements
ok  	github.com/jdfalk/audiobook-organizer/internal/operations	(cached)	coverage: 8.0% of statements
	github.com/jdfalk/audiobook-organizer/internal/operations/mocks		coverage: 0.0% of statements
=== RUN   TestSanitizeFilename
=== RUN   TestSanitizeFilename/valid_filename
=== RUN   TestSanitizeFilename/invalid_chars
=== RUN   TestSanitizeFilename/multiple_spaces
=== RUN   TestSanitizeFilename/long_filename
--- PASS: TestSanitizeFilename (0.00s)
    --- PASS: TestSanitizeFilename/valid_filename (0.00s)
    --- PASS: TestSanitizeFilename/invalid_chars (0.00s)
    --- PASS: TestSanitizeFilename/multiple_spaces (0.00s)
    --- PASS: TestSanitizeFilename/long_filename (0.00s)
=== RUN   TestExpandPattern
--- PASS: TestExpandPattern (0.00s)
=== RUN   TestRemoveEmptySegment
=== RUN   TestRemoveEmptySegment/remove_dash_segment
=== RUN   TestRemoveEmptySegment/remove_parentheses
=== RUN   TestRemoveEmptySegment/keep_filled_segment
--- PASS: TestRemoveEmptySegment (0.00s)
    --- PASS: TestRemoveEmptySegment/remove_dash_segment (0.00s)
    --- PASS: TestRemoveEmptySegment/remove_parentheses (0.00s)
    --- PASS: TestRemoveEmptySegment/keep_filled_segment (0.00s)
=== RUN   TestGenerateTargetPath
--- PASS: TestGenerateTargetPath (0.00s)
=== RUN   TestCopyFile
--- PASS: TestCopyFile (0.01s)
=== RUN   TestHardlinkFile
--- PASS: TestHardlinkFile (0.01s)
=== RUN   TestSymlinkFile
--- PASS: TestSymlinkFile (0.00s)
=== RUN   TestNewOrganizer
--- PASS: TestNewOrganizer (0.00s)
=== RUN   TestOrganizeBook_NilBook
--- PASS: TestOrganizeBook_NilBook (0.00s)
=== RUN   TestOrganizeBook_EmptyFilePath
--- PASS: TestOrganizeBook_EmptyFilePath (0.00s)
=== RUN   TestOrganizeBook_Copy
--- PASS: TestOrganizeBook_Copy (0.02s)
=== RUN   TestOrganizeBook_Hardlink
--- PASS: TestOrganizeBook_Hardlink (0.01s)
=== RUN   TestOrganizeBook_Symlink
--- PASS: TestOrganizeBook_Symlink (0.01s)
=== RUN   TestOrganizeBook_Auto
--- PASS: TestOrganizeBook_Auto (0.02s)
=== RUN   TestOrganizeBook_UnknownStrategy
--- PASS: TestOrganizeBook_UnknownStrategy (0.01s)
=== RUN   TestOrganizeBook_MkdirError
--- PASS: TestOrganizeBook_MkdirError (0.00s)
=== RUN   TestExpandPattern_WithSeries
--- PASS: TestExpandPattern_WithSeries (0.00s)
=== RUN   TestExpandPattern_WithAllFields
--- PASS: TestExpandPattern_WithAllFields (0.00s)
=== RUN   TestExpandPattern_EmptyFields
--- PASS: TestExpandPattern_EmptyFields (0.00s)
=== RUN   TestExpandPattern_UnresolvedPlaceholder
--- PASS: TestExpandPattern_UnresolvedPlaceholder (0.00s)
=== RUN   TestExpandPattern_EmptyTitle
--- PASS: TestExpandPattern_EmptyTitle (0.00s)
=== RUN   TestExpandPattern_EmptyNarrator
--- PASS: TestExpandPattern_EmptyNarrator (0.00s)
=== RUN   TestCleanupPattern
=== RUN   TestCleanupPattern/multiple_spaces
=== RUN   TestCleanupPattern/empty_parens
=== RUN   TestCleanupPattern/leading_dash
=== RUN   TestCleanupPattern/trailing_dash
=== RUN   TestCleanupPattern/multiple_slashes
=== RUN   TestCleanupPattern/combined
--- PASS: TestCleanupPattern (0.00s)
    --- PASS: TestCleanupPattern/multiple_spaces (0.00s)
    --- PASS: TestCleanupPattern/empty_parens (0.00s)
    --- PASS: TestCleanupPattern/leading_dash (0.00s)
    --- PASS: TestCleanupPattern/trailing_dash (0.00s)
    --- PASS: TestCleanupPattern/multiple_slashes (0.00s)
    --- PASS: TestCleanupPattern/combined (0.00s)
=== RUN   TestSanitizePath
=== RUN   TestSanitizePath/simple_path
=== RUN   TestSanitizePath/invalid_chars_in_parts
=== RUN   TestSanitizePath/multiple_parts
--- PASS: TestSanitizePath (0.00s)
    --- PASS: TestSanitizePath/simple_path (0.00s)
    --- PASS: TestSanitizePath/invalid_chars_in_parts (0.00s)
    --- PASS: TestSanitizePath/multiple_parts (0.00s)
=== RUN   TestStringOrEmpty
=== RUN   TestStringOrEmpty/nil_pointer
=== RUN   TestStringOrEmpty/empty_string
=== RUN   TestStringOrEmpty/non-empty
--- PASS: TestStringOrEmpty (0.00s)
    --- PASS: TestStringOrEmpty/nil_pointer (0.00s)
    --- PASS: TestStringOrEmpty/empty_string (0.00s)
    --- PASS: TestStringOrEmpty/non-empty (0.00s)
=== RUN   TestCopyFile_ErrorCases
=== RUN   TestCopyFile_ErrorCases/source_does_not_exist
=== RUN   TestCopyFile_ErrorCases/destination_path_invalid
--- PASS: TestCopyFile_ErrorCases (0.01s)
    --- PASS: TestCopyFile_ErrorCases/source_does_not_exist (0.00s)
    --- PASS: TestCopyFile_ErrorCases/destination_path_invalid (0.00s)
=== RUN   TestSymlinkFile_ErrorPath
--- PASS: TestSymlinkFile_ErrorPath (0.00s)
=== RUN   TestGenerateTargetPath_PatternError
--- PASS: TestGenerateTargetPath_PatternError (0.00s)
=== RUN   TestGenerateTargetPath_FilePatternError
--- PASS: TestGenerateTargetPath_FilePatternError (0.00s)
=== RUN   TestOrganizeBook_Reflink
    organizer_test.go:780: reflink not supported: reflink not supported on this filesystem (errno: inappropriate ioctl for device)
--- SKIP: TestOrganizeBook_Reflink (0.01s)
=== RUN   TestCopyFile_IOCopyError
--- PASS: TestCopyFile_IOCopyError (0.02s)
=== RUN   TestPatternExpansionWithRealData
=== RUN   TestPatternExpansionWithRealData/simple_author_and_title
=== RUN   TestPatternExpansionWithRealData/series_with_position_-_Book_N_format
=== RUN   TestPatternExpansionWithRealData/series_with_zero-padded_position
=== RUN   TestPatternExpansionWithRealData/series_without_explicit_position
=== RUN   TestPatternExpansionWithRealData/book_with_narrator_info
=== RUN   TestPatternExpansionWithRealData/book_with_edition
=== RUN   TestPatternExpansionWithRealData/complex_pattern_with_multiple_fields
=== RUN   TestPatternExpansionWithRealData/book_without_series_(pattern_should_handle_empty)
=== RUN   TestPatternExpansionWithRealData/book_with_publisher_and_year
=== RUN   TestPatternExpansionWithRealData/book_with_quality_info
=== RUN   TestPatternExpansionWithRealData/book_with_ISBN
=== RUN   TestPatternExpansionWithRealData/book_with_language
=== RUN   TestPatternExpansionWithRealData/missing_metadata_uses_defaults
--- PASS: TestPatternExpansionWithRealData (0.00s)
    --- PASS: TestPatternExpansionWithRealData/simple_author_and_title (0.00s)
    --- PASS: TestPatternExpansionWithRealData/series_with_position_-_Book_N_format (0.00s)
    --- PASS: TestPatternExpansionWithRealData/series_with_zero-padded_position (0.00s)
    --- PASS: TestPatternExpansionWithRealData/series_without_explicit_position (0.00s)
    --- PASS: TestPatternExpansionWithRealData/book_with_narrator_info (0.00s)
    --- PASS: TestPatternExpansionWithRealData/book_with_edition (0.00s)
    --- PASS: TestPatternExpansionWithRealData/complex_pattern_with_multiple_fields (0.00s)
    --- PASS: TestPatternExpansionWithRealData/book_without_series_(pattern_should_handle_empty) (0.00s)
    --- PASS: TestPatternExpansionWithRealData/book_with_publisher_and_year (0.00s)
    --- PASS: TestPatternExpansionWithRealData/book_with_quality_info (0.00s)
    --- PASS: TestPatternExpansionWithRealData/book_with_ISBN (0.00s)
    --- PASS: TestPatternExpansionWithRealData/book_with_language (0.00s)
    --- PASS: TestPatternExpansionWithRealData/missing_metadata_uses_defaults (0.00s)
=== RUN   TestEmptyFieldRemoval
=== RUN   TestEmptyFieldRemoval/remove_empty_series_in_parentheses
=== RUN   TestEmptyFieldRemoval/remove_empty_narrator_with_dash
=== RUN   TestEmptyFieldRemoval/keep_filled_narrator
=== RUN   TestEmptyFieldRemoval/series_with_empty_number
=== RUN   TestEmptyFieldRemoval/series_with_actual_number
--- PASS: TestEmptyFieldRemoval (0.00s)
    --- PASS: TestEmptyFieldRemoval/remove_empty_series_in_parentheses (0.00s)
    --- PASS: TestEmptyFieldRemoval/remove_empty_narrator_with_dash (0.00s)
    --- PASS: TestEmptyFieldRemoval/keep_filled_narrator (0.00s)
    --- PASS: TestEmptyFieldRemoval/series_with_empty_number (0.00s)
    --- PASS: TestEmptyFieldRemoval/series_with_actual_number (0.00s)
=== RUN   TestComplexRealWorldPaths
=== RUN   TestComplexRealWorldPaths/series_with_book_number_in_directory
=== RUN   TestComplexRealWorldPaths/author-only_organization
=== RUN   TestComplexRealWorldPaths/multi-book_series_with_position
=== RUN   TestComplexRealWorldPaths/collection_series
--- PASS: TestComplexRealWorldPaths (0.01s)
    --- PASS: TestComplexRealWorldPaths/series_with_book_number_in_directory (0.00s)
    --- PASS: TestComplexRealWorldPaths/author-only_organization (0.00s)
    --- PASS: TestComplexRealWorldPaths/multi-book_series_with_position (0.00s)
    --- PASS: TestComplexRealWorldPaths/collection_series (0.00s)
=== RUN   TestSanitizationWithRealWorldData
=== RUN   TestSanitizationWithRealWorldData/colon_in_title
=== RUN   TestSanitizationWithRealWorldData/multiple_special_chars_-_slash_not_replaced
=== RUN   TestSanitizationWithRealWorldData/question_mark_and_asterisk
=== RUN   TestSanitizationWithRealWorldData/series_with_hashtag
=== RUN   TestSanitizationWithRealWorldData/parentheses_and_brackets
=== RUN   TestSanitizationWithRealWorldData/em_dash_and_en_dash
=== RUN   TestSanitizationWithRealWorldData/quotes_replaced
=== RUN   TestSanitizationWithRealWorldData/multiple_spaces_collapsed
--- PASS: TestSanitizationWithRealWorldData (0.00s)
    --- PASS: TestSanitizationWithRealWorldData/colon_in_title (0.00s)
    --- PASS: TestSanitizationWithRealWorldData/multiple_special_chars_-_slash_not_replaced (0.00s)
    --- PASS: TestSanitizationWithRealWorldData/question_mark_and_asterisk (0.00s)
    --- PASS: TestSanitizationWithRealWorldData/series_with_hashtag (0.00s)
    --- PASS: TestSanitizationWithRealWorldData/parentheses_and_brackets (0.00s)
    --- PASS: TestSanitizationWithRealWorldData/em_dash_and_en_dash (0.00s)
    --- PASS: TestSanitizationWithRealWorldData/quotes_replaced (0.00s)
    --- PASS: TestSanitizationWithRealWorldData/multiple_spaces_collapsed (0.00s)
=== RUN   TestPatternPlaceholderNormalization
--- PASS: TestPatternPlaceholderNormalization (0.00s)
=== RUN   TestPatternRejectsUnknownPlaceholder
--- PASS: TestPatternRejectsUnknownPlaceholder (0.00s)
=== RUN   TestRealWorldFileParsing
    realworld_test.go:31: Testing with 1000 real-world file paths
    realworld_test.go:104: Success 1:
          Source: /mnt/bigdata/books/abooks/1964-1984 - John Grimes series (22)/JG-04 - The Broken Cycle (Abano) 48k 04.11.54 {89mb} by chap/JG-04 - The Broken Cycle - chap-10.mp3
          Target: /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestRealWorldFileParsing2467609515/001/JG-04/The Broken Cycle.mp3
    realworld_test.go:104: Success 2:
          Source: /mnt/bigdata/books/abooks/1964-1984 - John Grimes series (22)/JG-12 - Star Loot (Abano) 48k 09.16.40 {196mb} by chap/JG-12 - Star Loot - chap-13.mp3
          Target: /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestRealWorldFileParsing2467609515/001/JG-12/Star Loot.mp3
    realworld_test.go:104: Success 3:
          Source: /mnt/bigdata/books/abooks/1964-1984 - John Grimes series (22)/JG-13 - The Anarch Lords (Abano) 48k 07.40.59 {161mb} by chap/JG-13 - The Anarchy Lords - chap-26.mp3
          Target: /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestRealWorldFileParsing2467609515/001/JG-13/The Anarchy Lords.mp3
    realworld_test.go:104: Success 4:
          Source: /mnt/bigdata/books/abooks/Arkady Martine - A Memory Called Empire Teixcalaan, Book 1/15 - Interlude.mp3
          Target: /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestRealWorldFileParsing2467609515/001/15/Interlude.mp3
    realworld_test.go:104: Success 5:
          Source: /mnt/bigdata/books/abooks/Books of Shannara/09 First King of Shannara/Terry_Brooks_-_First_King_of_Shannara_-_02_of_57.mp3
          Target: /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestRealWorldFileParsing2467609515/001/09 First King of Shannara/Terry_Brooks_-_First_King_of_Shannara_-_02_of_57.mp3
    realworld_test.go:104: Success 6:
          Source: /mnt/bigdata/books/abooks/Brent Weeks - The Burning White Book Five of Lightbringer (Unabridged, M4B, Chapterized)/The Burning White Book Five of Lightbringer - 084.m4b
          Target: /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestRealWorldFileParsing2467609515/001/The Burning White Book Five of Lightbringer/The Burning White/084.m4b
    realworld_test.go:104: Success 7:
          Source: /mnt/bigdata/books/abooks/Brent Weeks - The Burning White Book Five of Lightbringer (Unabridged, M4B, Chapterized)/The Burning White Book Five of Lightbringer - 132.m4b
          Target: /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestRealWorldFileParsing2467609515/001/The Burning White Book Five of Lightbringer/The Burning White/132.m4b
    realworld_test.go:104: Success 8:
          Source: /mnt/bigdata/books/abooks/Brent Weeks - The Burning White Book Five of Lightbringer (Unabridged, M4B, Chapterized)/The Burning White Book Five of Lightbringer - 151.m4b
          Target: /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestRealWorldFileParsing2467609515/001/The Burning White Book Five of Lightbringer/The Burning White/151.m4b
    realworld_test.go:104: Success 9:
          Source: /mnt/bigdata/books/abooks/C. T. Phipps - Esoterrorism From the Secret Files of the Red Room, Book 1 (Unabridged)/Esoterrorism From the Secret Files of the Red Room, Book 1 (Unabridged) - 021.mp3
          Target: /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestRealWorldFileParsing2467609515/001/Esoterrorism From the Secret Files of the Red Room, Book 1/Esoterrorism From the Secret Files of the Red Room,/021.mp3
    realworld_test.go:104: Success 10:
          Source: /mnt/bigdata/books/abooks/Christopher G Nuttall - Ark Royal Series - Books 1 - 6/Christopher G. Nuttall - Ark Royal 3 - The Trafalgar Gambit (Unabridged)/The Trafalgar Gambit part1.mp3
          Target: /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestRealWorldFileParsing2467609515/001/Christopher G. Nuttall - Ark Royal 3 - The Trafalgar Gambit/The Trafalgar Gambit part1.mp3
    realworld_test.go:109: 
        === PARSING STATISTICS ===
    realworld_test.go:110: Total files: 1000
    realworld_test.go:111: Audio files: 839
    realworld_test.go:112: Successfully organized: 839
    realworld_test.go:113: Success rate: 100.0%
    realworld_test.go:115: 
        === FILE EXTENSIONS ===
    realworld_test.go:118:   .cbz: 7
    realworld_test.go:118:   .txt: 12
    realworld_test.go:118:   .nfo: 8
    realworld_test.go:118:   .mobi: 8
    realworld_test.go:118:   .epub: 14
    realworld_test.go:118:   .m4b: 119
    realworld_test.go:118:   .jpg: 62
    realworld_test.go:118:   .pdf: 10
    realworld_test.go:118:   .cbr: 6
    realworld_test.go:118:   .mp3: 716
    realworld_test.go:118:   .cue: 20
    realworld_test.go:122: 
        === METADATA EXTRACTION ===
    realworld_test.go:123: Files with author: 839 (100.0%)
    realworld_test.go:125: Files with series: 93 (11.1%)
--- PASS: TestRealWorldFileParsing (0.16s)
=== RUN   TestRealWorldPatternVariations
    realworld_test.go:188: Testing 839 audio files with 4 pattern variations
=== RUN   TestRealWorldPatternVariations/Author_only
    realworld_test.go:223: Pattern: {author} -> {title}
    realworld_test.go:224: Success: 839/839 (100.0%)
=== RUN   TestRealWorldPatternVariations/Author_and_Series
    realworld_test.go:223: Pattern: {author}/{series} -> {title}
    realworld_test.go:224: Success: 839/839 (100.0%)
=== RUN   TestRealWorldPatternVariations/Series_with_number
    realworld_test.go:223: Pattern: {author}/{series} -> {series_number} - {title}
    realworld_test.go:224: Success: 839/839 (100.0%)
=== RUN   TestRealWorldPatternVariations/With_narrator
    realworld_test.go:223: Pattern: {author} -> {title} - {narrator}
    realworld_test.go:224: Success: 839/839 (100.0%)
--- PASS: TestRealWorldPatternVariations (0.69s)
    --- PASS: TestRealWorldPatternVariations/Author_only (0.16s)
    --- PASS: TestRealWorldPatternVariations/Author_and_Series (0.19s)
    --- PASS: TestRealWorldPatternVariations/Series_with_number (0.17s)
    --- PASS: TestRealWorldPatternVariations/With_narrator (0.18s)
PASS
coverage: 89.5% of statements
ok  	github.com/jdfalk/audiobook-organizer/internal/organizer	(cached)	coverage: 89.5% of statements
=== RUN   TestGetBooksInSeries
--- PASS: TestGetBooksInSeries (0.04s)
=== RUN   TestGetBooksInSeriesEmpty
--- PASS: TestGetBooksInSeriesEmpty (0.03s)
=== RUN   TestGetBooksInSeriesNullSequence
--- PASS: TestGetBooksInSeriesNullSequence (0.04s)
=== RUN   TestCreateiTunesPlaylist
--- PASS: TestCreateiTunesPlaylist (0.00s)
=== RUN   TestCreateiTunesPlaylistSpecialChars
--- PASS: TestCreateiTunesPlaylistSpecialChars (0.01s)
=== RUN   TestCreateiTunesPlaylistCreateError
--- PASS: TestCreateiTunesPlaylistCreateError (0.01s)
=== RUN   TestCreateiTunesPlaylistEmpty
--- PASS: TestCreateiTunesPlaylistEmpty (0.01s)
=== RUN   TestSavePlaylistToDatabase
--- PASS: TestSavePlaylistToDatabase (0.05s)
=== RUN   TestSavePlaylistToDatabaseUpdate
--- PASS: TestSavePlaylistToDatabaseUpdate (0.08s)
=== RUN   TestSavePlaylistToDatabaseQueryError
--- PASS: TestSavePlaylistToDatabaseQueryError (0.04s)
=== RUN   TestGeneratePlaylistsForSeries
Generated playlist: Test Series - Test Author
--- PASS: TestGeneratePlaylistsForSeries (0.07s)
=== RUN   TestGeneratePlaylistsForSeriesQueryError
--- PASS: TestGeneratePlaylistsForSeriesQueryError (0.06s)
=== RUN   TestGeneratePlaylistsForSeriesNoBooks
--- PASS: TestGeneratePlaylistsForSeriesNoBooks (0.03s)
=== RUN   TestGeneratePlaylistsForSeriesNoSeries
--- PASS: TestGeneratePlaylistsForSeriesNoSeries (0.03s)
=== RUN   TestGeneratePlaylistsForSeriesMultiple
Generated playlist: Series A - Author One
Generated playlist: Series B - Author Two
--- PASS: TestGeneratePlaylistsForSeriesMultiple (0.07s)
PASS
coverage: 81.4% of statements
ok  	github.com/jdfalk/audiobook-organizer/internal/playlist	(cached)	coverage: 81.4% of statements
=== RUN   TestNewClient
--- PASS: TestNewClient (0.00s)
=== RUN   TestClient_Subscribe
2026/01/24 13:06:42 Client test-client subscribed to operation op-123
--- PASS: TestClient_Subscribe (0.00s)
=== RUN   TestClient_Unsubscribe
2026/01/24 13:06:42 Client test-client subscribed to operation op-123
2026/01/24 13:06:42 Client test-client unsubscribed from operation op-123
--- PASS: TestClient_Unsubscribe (0.00s)
=== RUN   TestClient_IsSubscribed
2026/01/24 13:06:42 Client test-client subscribed to operation op-1
--- PASS: TestClient_IsSubscribed (0.00s)
=== RUN   TestNewEventHub
--- PASS: TestNewEventHub (0.00s)
=== RUN   TestEventHub_RegisterClient
2026/01/24 13:06:42 Client client-1 registered, total clients: 1
--- PASS: TestEventHub_RegisterClient (0.00s)
=== RUN   TestEventHub_UnregisterClient
2026/01/24 13:06:42 Client client-1 registered, total clients: 1
2026/01/24 13:06:42 Client client-1 unregistered, remaining clients: 0
--- PASS: TestEventHub_UnregisterClient (0.00s)
=== RUN   TestEventHub_GetClientCount
2026/01/24 13:06:42 Client client-0 registered, total clients: 1
2026/01/24 13:06:42 Client client-1 registered, total clients: 2
2026/01/24 13:06:42 Client client-2 registered, total clients: 3
2026/01/24 13:06:42 Client client-3 registered, total clients: 4
2026/01/24 13:06:42 Client client-4 registered, total clients: 5
--- PASS: TestEventHub_GetClientCount (0.00s)
=== RUN   TestEventHub_Broadcast_SystemWideEvent
2026/01/24 13:06:42 Client client-1 registered, total clients: 1
2026/01/24 13:06:42 Client client-2 registered, total clients: 2
2026/01/24 13:06:42 Broadcasted event system.status to 2 clients
--- PASS: TestEventHub_Broadcast_SystemWideEvent (0.00s)
=== RUN   TestEventHub_Broadcast_OperationSpecificEvent
2026/01/24 13:06:42 Client client-1 subscribed to operation op-1
2026/01/24 13:06:42 Client client-2 subscribed to operation op-2
2026/01/24 13:06:42 Client client-1 registered, total clients: 1
2026/01/24 13:06:42 Client client-2 registered, total clients: 2
2026/01/24 13:06:42 Broadcasted event operation.progress to 1 clients
--- PASS: TestEventHub_Broadcast_OperationSpecificEvent (0.05s)
=== RUN   TestEventHub_SendOperationProgress
2026/01/24 13:06:42 Client client-1 subscribed to operation op-123
2026/01/24 13:06:42 Client client-1 registered, total clients: 1
2026/01/24 13:06:42 Broadcasted event operation.progress to 1 clients
--- PASS: TestEventHub_SendOperationProgress (0.00s)
=== RUN   TestEventHub_SendOperationStatus
2026/01/24 13:06:42 Client client-1 subscribed to operation op-123
2026/01/24 13:06:42 Client client-1 registered, total clients: 1
2026/01/24 13:06:42 Broadcasted event operation.status to 1 clients
--- PASS: TestEventHub_SendOperationStatus (0.00s)
=== RUN   TestEventHub_SendOperationLog
2026/01/24 13:06:42 Client client-1 subscribed to operation op-123
2026/01/24 13:06:42 Client client-1 registered, total clients: 1
2026/01/24 13:06:42 Broadcasted event operation.log to 1 clients
--- PASS: TestEventHub_SendOperationLog (0.00s)
=== RUN   TestEventHub_SendSystemStatus
2026/01/24 13:06:42 Client client-1 registered, total clients: 1
2026/01/24 13:06:42 Broadcasted event system.status to 1 clients
--- PASS: TestEventHub_SendSystemStatus (0.00s)
=== RUN   TestCalculatePercentage
--- PASS: TestCalculatePercentage (0.00s)
=== RUN   TestInitializeEventHub
2026/01/24 13:06:42 Event hub initialized
2026/01/24 13:06:42 Warning: event hub already initialized
--- PASS: TestInitializeEventHub (0.00s)
=== RUN   TestEventHub_Broadcast_ChannelFull
2026/01/24 13:06:42 Client client-1 registered, total clients: 1
2026/01/24 13:06:42 Warning: Client client-1 channel full, dropping event
2026/01/24 13:06:42 Client client-1 unregistered, remaining clients: 0
--- PASS: TestEventHub_Broadcast_ChannelFull (0.05s)
=== RUN   TestEventHub_UnregisterClient_NonExistent
--- PASS: TestEventHub_UnregisterClient_NonExistent (0.00s)
=== RUN   TestEventHub_Broadcast_NoClients
--- PASS: TestEventHub_Broadcast_NoClients (0.00s)
=== RUN   TestEventHub_Broadcast_ClientWithNoSubscriptions
2026/01/24 13:06:42 Client client-1 registered, total clients: 1
2026/01/24 13:06:42 Broadcasted event operation.progress to 1 clients
--- PASS: TestEventHub_Broadcast_ClientWithNoSubscriptions (0.00s)
=== RUN   TestEventHub_SendOperationLog_WithoutDetails
2026/01/24 13:06:42 Client client-1 subscribed to operation op-123
2026/01/24 13:06:42 Client client-1 registered, total clients: 1
2026/01/24 13:06:42 Broadcasted event operation.log to 1 clients
--- PASS: TestEventHub_SendOperationLog_WithoutDetails (0.00s)
=== RUN   TestClient_ConcurrentSubscribe
2026/01/24 13:06:42 Client test-client subscribed to operation op-9
2026/01/24 13:06:42 Client test-client unsubscribed from operation op-9
2026/01/24 13:06:42 Client test-client subscribed to operation op-3
2026/01/24 13:06:42 Client test-client unsubscribed from operation op-3
2026/01/24 13:06:42 Client test-client subscribed to operation op-1
2026/01/24 13:06:42 Client test-client unsubscribed from operation op-1
2026/01/24 13:06:42 Client test-client subscribed to operation op-2
2026/01/24 13:06:42 Client test-client unsubscribed from operation op-2
2026/01/24 13:06:42 Client test-client subscribed to operation op-4
2026/01/24 13:06:42 Client test-client unsubscribed from operation op-4
2026/01/24 13:06:42 Client test-client subscribed to operation op-5
2026/01/24 13:06:42 Client test-client unsubscribed from operation op-5
2026/01/24 13:06:42 Client test-client subscribed to operation op-6
2026/01/24 13:06:42 Client test-client unsubscribed from operation op-6
2026/01/24 13:06:42 Client test-client subscribed to operation op-7
2026/01/24 13:06:42 Client test-client unsubscribed from operation op-7
2026/01/24 13:06:42 Client test-client subscribed to operation op-8
2026/01/24 13:06:42 Client test-client unsubscribed from operation op-8
2026/01/24 13:06:42 Client test-client subscribed to operation op-0
2026/01/24 13:06:42 Client test-client unsubscribed from operation op-0
--- PASS: TestClient_ConcurrentSubscribe (0.00s)
=== RUN   TestHandleSSE_BasicConnection
2026/01/24 13:06:42 Client client-1769278002866735000 registered, total clients: 1
2026/01/24 13:06:43 Client client-1769278002866735000 connection closed
2026/01/24 13:06:43 Client client-1769278002866735000 unregistered, remaining clients: 0
--- PASS: TestHandleSSE_BasicConnection (0.20s)
=== RUN   TestHandleSSE_WithOperationSubscription
2026/01/24 13:06:43 Client client-1769278003067853000 subscribed to operation op-123
2026/01/24 13:06:43 Client client-1769278003067853000 registered, total clients: 1
2026/01/24 13:06:43 Client client-1769278003067853000 connection closed
2026/01/24 13:06:43 Client client-1769278003067853000 unregistered, remaining clients: 0
--- PASS: TestHandleSSE_WithOperationSubscription (0.15s)
=== RUN   TestHandleSSE_EventDelivery
2026/01/24 13:06:43 Client client-1769278003219028000 registered, total clients: 1
2026/01/24 13:06:43 Broadcasted event system.status to 1 clients
2026/01/24 13:06:43 Client client-1769278003219028000 connection closed
2026/01/24 13:06:43 Client client-1769278003219028000 unregistered, remaining clients: 0
--- PASS: TestHandleSSE_EventDelivery (0.30s)
=== RUN   TestHandleSSE_Heartbeat
2026/01/24 13:06:43 Client client-1769278003519282000 registered, total clients: 1
2026/01/24 13:07:14 Client client-1769278003519282000 connection closed
2026/01/24 13:07:14 Client client-1769278003519282000 unregistered, remaining clients: 0
--- PASS: TestHandleSSE_Heartbeat (31.00s)
=== RUN   TestHandleSSE_JSONMarshalError
2026/01/24 13:07:14 Client client-1769278034520506000 registered, total clients: 1
2026/01/24 13:07:14 Broadcasted event system.status to 1 clients
2026/01/24 13:07:14 Client client-1769278034520506000 connection closed
2026/01/24 13:07:14 Client client-1769278034520506000 unregistered, remaining clients: 0
--- PASS: TestHandleSSE_JSONMarshalError (0.20s)
=== RUN   TestCalculatePercentage_NegativeTotal
--- PASS: TestCalculatePercentage_NegativeTotal (0.00s)
=== RUN   TestEventHub_MultipleSubscriptions
2026/01/24 13:07:14 Client client-1 subscribed to operation op-1
2026/01/24 13:07:14 Client client-1 subscribed to operation op-2
2026/01/24 13:07:14 Client client-1 subscribed to operation op-3
2026/01/24 13:07:14 Client client-1 registered, total clients: 1
2026/01/24 13:07:14 Broadcasted event operation.progress to 1 clients
--- PASS: TestEventHub_MultipleSubscriptions (0.05s)
=== RUN   TestEventType_Constants
--- PASS: TestEventType_Constants (0.00s)
=== RUN   TestEvent_JSONMarshaling
--- PASS: TestEvent_JSONMarshaling (0.00s)
=== RUN   TestEventHub_RegisterClient_MultipleClients
2026/01/24 13:07:14 Client client-0 registered, total clients: 1
2026/01/24 13:07:14 Client client-1 registered, total clients: 2
2026/01/24 13:07:14 Client client-2 registered, total clients: 3
2026/01/24 13:07:14 Client client-3 registered, total clients: 4
2026/01/24 13:07:14 Client client-4 registered, total clients: 5
2026/01/24 13:07:14 Client client-5 registered, total clients: 6
2026/01/24 13:07:14 Client client-6 registered, total clients: 7
2026/01/24 13:07:14 Client client-7 registered, total clients: 8
2026/01/24 13:07:14 Client client-8 registered, total clients: 9
2026/01/24 13:07:14 Client client-9 registered, total clients: 10
2026/01/24 13:07:14 Client client-0 unregistered, remaining clients: 9
2026/01/24 13:07:14 Client client-1 unregistered, remaining clients: 8
2026/01/24 13:07:14 Client client-2 unregistered, remaining clients: 7
2026/01/24 13:07:14 Client client-3 unregistered, remaining clients: 6
2026/01/24 13:07:14 Client client-4 unregistered, remaining clients: 5
--- PASS: TestEventHub_RegisterClient_MultipleClients (0.00s)
=== RUN   TestEventHub_SendOperationProgress_EdgeCases
2026/01/24 13:07:14 Client client-1 subscribed to operation op-123
2026/01/24 13:07:14 Client client-1 registered, total clients: 1
2026/01/24 13:07:14 Broadcasted event operation.progress to 1 clients
2026/01/24 13:07:14 Broadcasted event operation.progress to 1 clients
--- PASS: TestEventHub_SendOperationProgress_EdgeCases (0.00s)
=== RUN   TestHandleSSE_ClientDisconnect
2026/01/24 13:07:14 Client client-1769278034773048000 registered, total clients: 1
2026/01/24 13:07:14 Client client-1769278034773048000 connection closed
2026/01/24 13:07:14 Client client-1769278034773048000 unregistered, remaining clients: 0
--- PASS: TestHandleSSE_ClientDisconnect (0.01s)
=== RUN   TestEventHub_ConcurrentBroadcast
2026/01/24 13:07:14 Client client-0 registered, total clients: 1
2026/01/24 13:07:14 Client client-1 registered, total clients: 2
2026/01/24 13:07:14 Client client-2 registered, total clients: 3
2026/01/24 13:07:14 Client client-3 registered, total clients: 4
2026/01/24 13:07:14 Client client-4 registered, total clients: 5
2026/01/24 13:07:14 Broadcasted event system.status to 5 clients
2026/01/24 13:07:14 Broadcasted event system.status to 5 clients
2026/01/24 13:07:14 Broadcasted event system.status to 5 clients
2026/01/24 13:07:14 Broadcasted event system.status to 5 clients
2026/01/24 13:07:14 Broadcasted event system.status to 5 clients
2026/01/24 13:07:14 Broadcasted event system.status to 5 clients
2026/01/24 13:07:14 Broadcasted event system.status to 5 clients
2026/01/24 13:07:14 Broadcasted event system.status to 5 clients
2026/01/24 13:07:14 Broadcasted event system.status to 5 clients
2026/01/24 13:07:14 Broadcasted event system.status to 5 clients
--- PASS: TestEventHub_ConcurrentBroadcast (0.51s)
=== RUN   TestClient_ChannelCapacity
--- PASS: TestClient_ChannelCapacity (0.00s)
PASS
coverage: 95.6% of statements
ok  	github.com/jdfalk/audiobook-organizer/internal/realtime	(cached)	coverage: 95.6% of statements
=== RUN   TestIntegrationRealWorldMixedFormats
Scanning for audiobook files (using 4 workers)...
--- PASS: TestIntegrationRealWorldMixedFormats (0.08s)
=== RUN   TestIntegrationProcessingMixedFormats
Scanning for audiobook files (using 1 workers)...
Processing audiobook metadata (using 2 workers)...
   0% |                                                | (0/4, 0 it/hr) [0s:0s]2026/01/24 13:06:43 [DEBUG] metadata: extracting tags for /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/processing-test-1968311890/Stephen King/The Shining.m4a
2026/01/24 13:06:43 [DEBUG] metadata: extracting tags for /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/processing-test-1968311890/Tolkien/The Hobbit - Chapter 02.mp3
2026/01/24 13:06:43 [WARN] metadata: failed to read tags for /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/processing-test-1968311890/Stephen King/The Shining.m4a: unexpected EOF; falling back to filename parsing
2026/01/24 13:06:43 [WARN] metadata: failed to read tags for /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/processing-test-1968311890/Tolkien/The Hobbit - Chapter 02.mp3: unexpected EOF; falling back to filename parsing
2026/01/24 13:06:43 [DEBUG] metadata: extracting tags for /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/processing-test-1968311890/Harry Potter/Harry Potter and the Philosopher's Stone.m4b
2026/01/24 13:06:43 [DEBUG] metadata: extracting tags for /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/processing-test-1968311890/Tolkien/The Hobbit - Chapter 01.mp3
2026/01/24 13:06:43 [WARN] metadata: failed to read tags for /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/processing-test-1968311890/Harry Potter/Harry Potter and the Philosopher's Stone.m4b: unexpected EOF; falling back to filename parsing
2026/01/24 13:06:43 [WARN] metadata: failed to read tags for /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/processing-test-1968311890/Tolkien/The Hobbit - Chapter 01.mp3: unexpected EOF; falling back to filename parsing
                                                                                100% || (4/4, 5902 it/s)
Warning: 4 books failed to save
--- PASS: TestIntegrationProcessingMixedFormats (0.02s)
=== RUN   TestIntegrationLargeScaleMixedFormats
=== RUN   TestIntegrationLargeScaleMixedFormats/workers_1
Scanning for audiobook files (using 1 workers)...
=== RUN   TestIntegrationLargeScaleMixedFormats/workers_2
Scanning for audiobook files (using 2 workers)...
=== RUN   TestIntegrationLargeScaleMixedFormats/workers_4
Scanning for audiobook files (using 4 workers)...
=== RUN   TestIntegrationLargeScaleMixedFormats/workers_8
Scanning for audiobook files (using 8 workers)...
--- PASS: TestIntegrationLargeScaleMixedFormats (1.24s)
    --- PASS: TestIntegrationLargeScaleMixedFormats/workers_1 (0.13s)
    --- PASS: TestIntegrationLargeScaleMixedFormats/workers_2 (0.09s)
    --- PASS: TestIntegrationLargeScaleMixedFormats/workers_4 (0.08s)
    --- PASS: TestIntegrationLargeScaleMixedFormats/workers_8 (0.10s)
=== RUN   TestMultiFormatSupport
=== RUN   TestMultiFormatSupport/M4B_files_only
Scanning for audiobook files (using 1 workers)...
=== RUN   TestMultiFormatSupport/MP3_files_only
Scanning for audiobook files (using 1 workers)...
=== RUN   TestMultiFormatSupport/M4A_files_only
Scanning for audiobook files (using 1 workers)...
=== RUN   TestMultiFormatSupport/FLAC_files_only
Scanning for audiobook files (using 1 workers)...
=== RUN   TestMultiFormatSupport/Mixed_formats
Scanning for audiobook files (using 1 workers)...
=== RUN   TestMultiFormatSupport/Unsupported_formats_excluded
Scanning for audiobook files (using 1 workers)...
=== RUN   TestMultiFormatSupport/Case_insensitive_extensions
Scanning for audiobook files (using 1 workers)...
--- PASS: TestMultiFormatSupport (0.01s)
    --- PASS: TestMultiFormatSupport/M4B_files_only (0.00s)
    --- PASS: TestMultiFormatSupport/MP3_files_only (0.00s)
    --- PASS: TestMultiFormatSupport/M4A_files_only (0.00s)
    --- PASS: TestMultiFormatSupport/FLAC_files_only (0.00s)
    --- PASS: TestMultiFormatSupport/Mixed_formats (0.00s)
    --- PASS: TestMultiFormatSupport/Unsupported_formats_excluded (0.00s)
    --- PASS: TestMultiFormatSupport/Case_insensitive_extensions (0.00s)
=== RUN   TestFormatConfiguration
--- PASS: TestFormatConfiguration (0.00s)
=== RUN   TestParallelScanWithMixedFormats
=== RUN   TestParallelScanWithMixedFormats/workers_1
Scanning for audiobook files (using 1 workers)...
=== RUN   TestParallelScanWithMixedFormats/workers_2
Scanning for audiobook files (using 2 workers)...
=== RUN   TestParallelScanWithMixedFormats/workers_3
Scanning for audiobook files (using 3 workers)...
=== RUN   TestParallelScanWithMixedFormats/workers_4
Scanning for audiobook files (using 4 workers)...
--- PASS: TestParallelScanWithMixedFormats (0.00s)
    --- PASS: TestParallelScanWithMixedFormats/workers_1 (0.00s)
    --- PASS: TestParallelScanWithMixedFormats/workers_2 (0.00s)
    --- PASS: TestParallelScanWithMixedFormats/workers_3 (0.00s)
    --- PASS: TestParallelScanWithMixedFormats/workers_4 (0.00s)
=== RUN   TestFormatPreservation
Scanning for audiobook files (using 1 workers)...
--- PASS: TestFormatPreservation (0.00s)
=== RUN   TestSaveBookToDatabase_GlobalStoreCreateAndUpdate
2026/01/24 13:06:44 Current database version: 0
2026/01/24 13:06:44 Applying 10 migrations...
2026/01/24 13:06:44 Applying migration 1: Initial schema with authors, series, books, playlists
2026/01/24 13:06:44   - Validating basic schema (authors, series, books, playlists)
2026/01/24 13:06:44 Migration 1 completed successfully
2026/01/24 13:06:44 Applying migration 2: Add import paths and operations tables
2026/01/24 13:06:44   - Adding import paths and operations support
2026/01/24 13:06:44 Migration 2 completed successfully
2026/01/24 13:06:44 Applying migration 3: Add user preferences
2026/01/24 13:06:44   - Adding user preferences support
2026/01/24 13:06:44 Migration 3 completed successfully
2026/01/24 13:06:44 Applying migration 4: Add extended Pebble keyspace (users, sessions, segments, playback)
2026/01/24 13:06:44   - Adding extended Pebble keyspace (users, sessions, segments, playback)
2026/01/24 13:06:44 Migration 4 completed successfully
2026/01/24 13:06:44 Applying migration 5: Add media info and version management fields to books
2026/01/24 13:06:44   - Adding media info and version management fields to books table
2026/01/24 13:06:44     - Executing: ALTER TABLE books ADD COLUMN bitrate_kbps INTEGER
2026/01/24 13:06:44     - Column already exists, skipping
2026/01/24 13:06:44     - Executing: ALTER TABLE books ADD COLUMN codec TEXT
2026/01/24 13:06:44     - Column already exists, skipping
2026/01/24 13:06:44     - Executing: ALTER TABLE books ADD COLUMN sample_rate_hz INTEGER
2026/01/24 13:06:44     - Column already exists, skipping
2026/01/24 13:06:44     - Executing: ALTER TABLE books ADD COLUMN channels INTEGER
2026/01/24 13:06:44     - Column already exists, skipping
2026/01/24 13:06:44     - Executing: ALTER TABLE books ADD COLUMN bit_depth INTEGER
2026/01/24 13:06:44     - Column already exists, skipping
2026/01/24 13:06:44     - Executing: ALTER TABLE books ADD COLUMN quality TEXT
2026/01/24 13:06:44     - Column already exists, skipping
2026/01/24 13:06:44     - Executing: ALTER TABLE books ADD COLUMN is_primary_version BOOLEAN DEFAULT 1
2026/01/24 13:06:44     - Column already exists, skipping
2026/01/24 13:06:44     - Executing: ALTER TABLE books ADD COLUMN version_group_id TEXT
2026/01/24 13:06:44     - Column already exists, skipping
2026/01/24 13:06:44     - Executing: ALTER TABLE books ADD COLUMN version_notes TEXT
2026/01/24 13:06:44     - Column already exists, skipping
2026/01/24 13:06:44     - Creating index: CREATE INDEX IF NOT EXISTS idx_books_version_group ON books(version_group_id)
2026/01/24 13:06:44     - Creating index: CREATE INDEX IF NOT EXISTS idx_books_is_primary ON books(is_primary_version)
2026/01/24 13:06:44   - Media info and version management fields added successfully
2026/01/24 13:06:44 Migration 5 completed successfully
2026/01/24 13:06:44 Applying migration 6: Add original and organized file hash tracking
2026/01/24 13:06:44   - Adding original/organized file hash columns to books table
2026/01/24 13:06:44     - Executing: ALTER TABLE books ADD COLUMN original_file_hash TEXT
2026/01/24 13:06:44     - Column already exists, skipping
2026/01/24 13:06:44     - Executing: ALTER TABLE books ADD COLUMN organized_file_hash TEXT
2026/01/24 13:06:44     - Column already exists, skipping
2026/01/24 13:06:44     - Creating index: CREATE INDEX IF NOT EXISTS idx_books_original_hash ON books(original_file_hash)
2026/01/24 13:06:44     - Creating index: CREATE INDEX IF NOT EXISTS idx_books_organized_hash ON books(organized_file_hash)
2026/01/24 13:06:44 Migration 6 completed successfully
2026/01/24 13:06:44 Applying migration 7: Rename import paths to import paths
2026/01/24 13:06:44   - Renaming import paths to import paths
2026/01/24 13:06:44 Migration 7 completed successfully
2026/01/24 13:06:44 Applying migration 8: Add do_not_import table for hash blocklist
2026/01/24 13:06:44   - Adding do_not_import table for hash blocklist
2026/01/24 13:06:44     - Executing: CREATE TABLE IF NOT EXISTS do_not_import (
				hash TEXT PRIMARY KEY NOT NULL,
				reason TEXT NOT NULL,
				created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
			)
2026/01/24 13:06:44     - Executing: CREATE INDEX IF NOT EXISTS idx_do_not_import_hash ON do_not_import(hash)
2026/01/24 13:06:44 Migration 8 completed successfully
2026/01/24 13:06:44 Applying migration 9: Add state machine and lifecycle fields to books
2026/01/24 13:06:44   - Adding state machine and lifecycle fields to books table
2026/01/24 13:06:44     - Executing: ALTER TABLE books ADD COLUMN library_state TEXT DEFAULT 'imported'
2026/01/24 13:06:44     - Column already exists, skipping
2026/01/24 13:06:44     - Executing: ALTER TABLE books ADD COLUMN quantity INTEGER DEFAULT 1
2026/01/24 13:06:44     - Column already exists, skipping
2026/01/24 13:06:44     - Executing: ALTER TABLE books ADD COLUMN marked_for_deletion BOOLEAN DEFAULT 0
2026/01/24 13:06:44     - Column already exists, skipping
2026/01/24 13:06:44     - Executing: ALTER TABLE books ADD COLUMN marked_for_deletion_at DATETIME
2026/01/24 13:06:44     - Column already exists, skipping
2026/01/24 13:06:44     - Creating index: CREATE INDEX IF NOT EXISTS idx_books_library_state ON books(library_state)
2026/01/24 13:06:44     - Creating index: CREATE INDEX IF NOT EXISTS idx_books_marked_for_deletion ON books(marked_for_deletion)
2026/01/24 13:06:44   - State machine fields added successfully
2026/01/24 13:06:44 Migration 9 completed successfully
2026/01/24 13:06:44 Applying migration 10: Add metadata_states table for metadata provenance
2026/01/24 13:06:44   - Adding metadata_states table for metadata provenance
2026/01/24 13:06:44     - Executing: CREATE TABLE IF NOT EXISTS metadata_states (
			book_id TEXT NOT NULL,
			field TEXT NOT NULL,
			fetched_value TEXT,
			override_value TEXT,
			override_locked BOOLEAN NOT NULL DEFAULT 0,
			updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
			PRIMARY KEY (book_id, field)
		)
2026/01/24 13:06:44     - Executing: CREATE INDEX IF NOT EXISTS idx_metadata_states_book ON metadata_states(book_id)
2026/01/24 13:06:44 Migration 10 completed successfully
2026/01/24 13:06:44 All migrations completed. Current version: 10
--- PASS: TestSaveBookToDatabase_GlobalStoreCreateAndUpdate (0.03s)
=== RUN   TestSaveBookToDatabase_BlocklistSkips
2026/01/24 13:06:44 Current database version: 0
2026/01/24 13:06:44 Applying 10 migrations...
2026/01/24 13:06:44 Applying migration 1: Initial schema with authors, series, books, playlists
2026/01/24 13:06:44   - Validating basic schema (authors, series, books, playlists)
2026/01/24 13:06:44 Migration 1 completed successfully
2026/01/24 13:06:44 Applying migration 2: Add import paths and operations tables
2026/01/24 13:06:44   - Adding import paths and operations support
2026/01/24 13:06:44 Migration 2 completed successfully
2026/01/24 13:06:44 Applying migration 3: Add user preferences
2026/01/24 13:06:44   - Adding user preferences support
2026/01/24 13:06:44 Migration 3 completed successfully
2026/01/24 13:06:44 Applying migration 4: Add extended Pebble keyspace (users, sessions, segments, playback)
2026/01/24 13:06:44   - Adding extended Pebble keyspace (users, sessions, segments, playback)
2026/01/24 13:06:44 Migration 4 completed successfully
2026/01/24 13:06:44 Applying migration 5: Add media info and version management fields to books
2026/01/24 13:06:44   - Adding media info and version management fields to books table
2026/01/24 13:06:44     - Executing: ALTER TABLE books ADD COLUMN bitrate_kbps INTEGER
2026/01/24 13:06:44     - Column already exists, skipping
2026/01/24 13:06:44     - Executing: ALTER TABLE books ADD COLUMN codec TEXT
2026/01/24 13:06:44     - Column already exists, skipping
2026/01/24 13:06:44     - Executing: ALTER TABLE books ADD COLUMN sample_rate_hz INTEGER
2026/01/24 13:06:44     - Column already exists, skipping
2026/01/24 13:06:44     - Executing: ALTER TABLE books ADD COLUMN channels INTEGER
2026/01/24 13:06:44     - Column already exists, skipping
2026/01/24 13:06:44     - Executing: ALTER TABLE books ADD COLUMN bit_depth INTEGER
2026/01/24 13:06:44     - Column already exists, skipping
2026/01/24 13:06:44     - Executing: ALTER TABLE books ADD COLUMN quality TEXT
2026/01/24 13:06:44     - Column already exists, skipping
2026/01/24 13:06:44     - Executing: ALTER TABLE books ADD COLUMN is_primary_version BOOLEAN DEFAULT 1
2026/01/24 13:06:44     - Column already exists, skipping
2026/01/24 13:06:44     - Executing: ALTER TABLE books ADD COLUMN version_group_id TEXT
2026/01/24 13:06:44     - Column already exists, skipping
2026/01/24 13:06:44     - Executing: ALTER TABLE books ADD COLUMN version_notes TEXT
2026/01/24 13:06:44     - Column already exists, skipping
2026/01/24 13:06:44     - Creating index: CREATE INDEX IF NOT EXISTS idx_books_version_group ON books(version_group_id)
2026/01/24 13:06:44     - Creating index: CREATE INDEX IF NOT EXISTS idx_books_is_primary ON books(is_primary_version)
2026/01/24 13:06:44   - Media info and version management fields added successfully
2026/01/24 13:06:44 Migration 5 completed successfully
2026/01/24 13:06:44 Applying migration 6: Add original and organized file hash tracking
2026/01/24 13:06:44   - Adding original/organized file hash columns to books table
2026/01/24 13:06:44     - Executing: ALTER TABLE books ADD COLUMN original_file_hash TEXT
2026/01/24 13:06:44     - Column already exists, skipping
2026/01/24 13:06:44     - Executing: ALTER TABLE books ADD COLUMN organized_file_hash TEXT
2026/01/24 13:06:44     - Column already exists, skipping
2026/01/24 13:06:44     - Creating index: CREATE INDEX IF NOT EXISTS idx_books_original_hash ON books(original_file_hash)
2026/01/24 13:06:44     - Creating index: CREATE INDEX IF NOT EXISTS idx_books_organized_hash ON books(organized_file_hash)
2026/01/24 13:06:44 Migration 6 completed successfully
2026/01/24 13:06:44 Applying migration 7: Rename import paths to import paths
2026/01/24 13:06:44   - Renaming import paths to import paths
2026/01/24 13:06:44 Migration 7 completed successfully
2026/01/24 13:06:44 Applying migration 8: Add do_not_import table for hash blocklist
2026/01/24 13:06:44   - Adding do_not_import table for hash blocklist
2026/01/24 13:06:44     - Executing: CREATE TABLE IF NOT EXISTS do_not_import (
				hash TEXT PRIMARY KEY NOT NULL,
				reason TEXT NOT NULL,
				created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
			)
2026/01/24 13:06:44     - Executing: CREATE INDEX IF NOT EXISTS idx_do_not_import_hash ON do_not_import(hash)
2026/01/24 13:06:44 Migration 8 completed successfully
2026/01/24 13:06:44 Applying migration 9: Add state machine and lifecycle fields to books
2026/01/24 13:06:44   - Adding state machine and lifecycle fields to books table
2026/01/24 13:06:44     - Executing: ALTER TABLE books ADD COLUMN library_state TEXT DEFAULT 'imported'
2026/01/24 13:06:44     - Column already exists, skipping
2026/01/24 13:06:44     - Executing: ALTER TABLE books ADD COLUMN quantity INTEGER DEFAULT 1
2026/01/24 13:06:44     - Column already exists, skipping
2026/01/24 13:06:44     - Executing: ALTER TABLE books ADD COLUMN marked_for_deletion BOOLEAN DEFAULT 0
2026/01/24 13:06:44     - Column already exists, skipping
2026/01/24 13:06:44     - Executing: ALTER TABLE books ADD COLUMN marked_for_deletion_at DATETIME
2026/01/24 13:06:44     - Column already exists, skipping
2026/01/24 13:06:44     - Creating index: CREATE INDEX IF NOT EXISTS idx_books_library_state ON books(library_state)
2026/01/24 13:06:44     - Creating index: CREATE INDEX IF NOT EXISTS idx_books_marked_for_deletion ON books(marked_for_deletion)
2026/01/24 13:06:44   - State machine fields added successfully
2026/01/24 13:06:44 Migration 9 completed successfully
2026/01/24 13:06:44 Applying migration 10: Add metadata_states table for metadata provenance
2026/01/24 13:06:44   - Adding metadata_states table for metadata provenance
2026/01/24 13:06:44     - Executing: CREATE TABLE IF NOT EXISTS metadata_states (
			book_id TEXT NOT NULL,
			field TEXT NOT NULL,
			fetched_value TEXT,
			override_value TEXT,
			override_locked BOOLEAN NOT NULL DEFAULT 0,
			updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
			PRIMARY KEY (book_id, field)
		)
2026/01/24 13:06:44     - Executing: CREATE INDEX IF NOT EXISTS idx_metadata_states_book ON metadata_states(book_id)
2026/01/24 13:06:44 Migration 10 completed successfully
2026/01/24 13:06:44 All migrations completed. Current version: 10
2026/01/24 13:06:44 Skipping file /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestSaveBookToDatabase_BlocklistSkips576866191/002/blocked.m4b: hash 6973dddd3ef9cb6a2932702f31777faad9c9bf3124d147a84f31aadb6d139546 is blocked
--- PASS: TestSaveBookToDatabase_BlocklistSkips (0.03s)
=== RUN   TestGetFileSize
=== RUN   TestGetFileSize/valid_file
=== RUN   TestGetFileSize/nonexistent_file
=== RUN   TestGetFileSize/directory_instead_of_file
--- PASS: TestGetFileSize (0.00s)
    --- PASS: TestGetFileSize/valid_file (0.00s)
    --- PASS: TestGetFileSize/nonexistent_file (0.00s)
    --- PASS: TestGetFileSize/directory_instead_of_file (0.00s)
=== RUN   TestComputeFullFileHash
=== RUN   TestComputeFullFileHash/valid_file
=== RUN   TestComputeFullFileHash/nonexistent_file
=== RUN   TestComputeFullFileHash/empty_file
--- PASS: TestComputeFullFileHash (0.00s)
    --- PASS: TestComputeFullFileHash/valid_file (0.00s)
    --- PASS: TestComputeFullFileHash/nonexistent_file (0.00s)
    --- PASS: TestComputeFullFileHash/empty_file (0.00s)
=== RUN   TestComputeFileHashLargeFile
--- PASS: TestComputeFileHashLargeFile (0.13s)
=== RUN   TestComputeFileHashReadError
=== RUN   TestComputeFileHashReadError/directory_instead_of_file
--- PASS: TestComputeFileHashReadError (0.00s)
    --- PASS: TestComputeFileHashReadError/directory_instead_of_file (0.00s)
=== RUN   TestLooksLikePersonNameEdgeCases
=== RUN   TestLooksLikePersonNameEdgeCases/empty_string
=== RUN   TestLooksLikePersonNameEdgeCases/single_uppercase_word
=== RUN   TestLooksLikePersonNameEdgeCases/lowercase_name
=== RUN   TestLooksLikePersonNameEdgeCases/three_word_name
=== RUN   TestLooksLikePersonNameEdgeCases/four_word_name
=== RUN   TestLooksLikePersonNameEdgeCases/five_word_name
=== RUN   TestLooksLikePersonNameEdgeCases/single_initial
=== RUN   TestLooksLikePersonNameEdgeCases/double_initial_with_space
=== RUN   TestLooksLikePersonNameEdgeCases/double_initial_no_space
=== RUN   TestLooksLikePersonNameEdgeCases/triple_initial
=== RUN   TestLooksLikePersonNameEdgeCases/name_with_initial
=== RUN   TestLooksLikePersonNameEdgeCases/mixed_case_nonsense
=== RUN   TestLooksLikePersonNameEdgeCases/valid_book_prefix
=== RUN   TestLooksLikePersonNameEdgeCases/chapter_prefix
=== RUN   TestLooksLikePersonNameEdgeCases/volume_prefix
=== RUN   TestLooksLikePersonNameEdgeCases/part_prefix
=== RUN   TestLooksLikePersonNameEdgeCases/disc_prefix
=== RUN   TestLooksLikePersonNameEdgeCases/numeric_string
=== RUN   TestLooksLikePersonNameEdgeCases/single_word_capital
=== RUN   TestLooksLikePersonNameEdgeCases/hyphenated_name
=== RUN   TestLooksLikePersonNameEdgeCases/name_with_apostrophe
--- PASS: TestLooksLikePersonNameEdgeCases (0.00s)
    --- PASS: TestLooksLikePersonNameEdgeCases/empty_string (0.00s)
    --- PASS: TestLooksLikePersonNameEdgeCases/single_uppercase_word (0.00s)
    --- PASS: TestLooksLikePersonNameEdgeCases/lowercase_name (0.00s)
    --- PASS: TestLooksLikePersonNameEdgeCases/three_word_name (0.00s)
    --- PASS: TestLooksLikePersonNameEdgeCases/four_word_name (0.00s)
    --- PASS: TestLooksLikePersonNameEdgeCases/five_word_name (0.00s)
    --- PASS: TestLooksLikePersonNameEdgeCases/single_initial (0.00s)
    --- PASS: TestLooksLikePersonNameEdgeCases/double_initial_with_space (0.00s)
    --- PASS: TestLooksLikePersonNameEdgeCases/double_initial_no_space (0.00s)
    --- PASS: TestLooksLikePersonNameEdgeCases/triple_initial (0.00s)
    --- PASS: TestLooksLikePersonNameEdgeCases/name_with_initial (0.00s)
    --- PASS: TestLooksLikePersonNameEdgeCases/mixed_case_nonsense (0.00s)
    --- PASS: TestLooksLikePersonNameEdgeCases/valid_book_prefix (0.00s)
    --- PASS: TestLooksLikePersonNameEdgeCases/chapter_prefix (0.00s)
    --- PASS: TestLooksLikePersonNameEdgeCases/volume_prefix (0.00s)
    --- PASS: TestLooksLikePersonNameEdgeCases/part_prefix (0.00s)
    --- PASS: TestLooksLikePersonNameEdgeCases/disc_prefix (0.00s)
    --- PASS: TestLooksLikePersonNameEdgeCases/numeric_string (0.00s)
    --- PASS: TestLooksLikePersonNameEdgeCases/single_word_capital (0.00s)
    --- PASS: TestLooksLikePersonNameEdgeCases/hyphenated_name (0.00s)
    --- PASS: TestLooksLikePersonNameEdgeCases/name_with_apostrophe (0.00s)
=== RUN   TestExtractInfoFromPathUnderscoreSeparator
=== RUN   TestExtractInfoFromPathUnderscoreSeparator/title_author_pattern
=== RUN   TestExtractInfoFromPathUnderscoreSeparator/author_title_pattern
=== RUN   TestExtractInfoFromPathUnderscoreSeparator/underscore_without_name
=== RUN   TestExtractInfoFromPathUnderscoreSeparator/complex_title_with_series
--- PASS: TestExtractInfoFromPathUnderscoreSeparator (0.00s)
    --- PASS: TestExtractInfoFromPathUnderscoreSeparator/title_author_pattern (0.00s)
    --- PASS: TestExtractInfoFromPathUnderscoreSeparator/author_title_pattern (0.00s)
    --- PASS: TestExtractInfoFromPathUnderscoreSeparator/underscore_without_name (0.00s)
    --- PASS: TestExtractInfoFromPathUnderscoreSeparator/complex_title_with_series (0.00s)
=== RUN   TestExtractAuthorFromDirectoryEdgeCases
=== RUN   TestExtractAuthorFromDirectoryEdgeCases/narrated_by_pattern
=== RUN   TestExtractAuthorFromDirectoryEdgeCases/bt_directory_skip
=== RUN   TestExtractAuthorFromDirectoryEdgeCases/incomplete_directory_skip
=== RUN   TestExtractAuthorFromDirectoryEdgeCases/data_directory_skip
=== RUN   TestExtractAuthorFromDirectoryEdgeCases/library_directory_skip
=== RUN   TestExtractAuthorFromDirectoryEdgeCases/collection_directory_skip
=== RUN   TestExtractAuthorFromDirectoryEdgeCases/newbooks_directory_skip
--- PASS: TestExtractAuthorFromDirectoryEdgeCases (0.00s)
    --- PASS: TestExtractAuthorFromDirectoryEdgeCases/narrated_by_pattern (0.00s)
    --- PASS: TestExtractAuthorFromDirectoryEdgeCases/bt_directory_skip (0.00s)
    --- PASS: TestExtractAuthorFromDirectoryEdgeCases/incomplete_directory_skip (0.00s)
    --- PASS: TestExtractAuthorFromDirectoryEdgeCases/data_directory_skip (0.00s)
    --- PASS: TestExtractAuthorFromDirectoryEdgeCases/library_directory_skip (0.00s)
    --- PASS: TestExtractAuthorFromDirectoryEdgeCases/collection_directory_skip (0.00s)
    --- PASS: TestExtractAuthorFromDirectoryEdgeCases/newbooks_directory_skip (0.00s)
=== RUN   TestParseFilenameForAuthorEdgeCases
=== RUN   TestParseFilenameForAuthorEdgeCases/author_-_title_(swapped_due_to_name_detection)
=== RUN   TestParseFilenameForAuthorEdgeCases/title_-_author
=== RUN   TestParseFilenameForAuthorEdgeCases/both_sides_look_like_names
=== RUN   TestParseFilenameForAuthorEdgeCases/neither_side_looks_like_name
=== RUN   TestParseFilenameForAuthorEdgeCases/three_parts
=== RUN   TestParseFilenameForAuthorEdgeCases/no_separator
--- PASS: TestParseFilenameForAuthorEdgeCases (0.00s)
    --- PASS: TestParseFilenameForAuthorEdgeCases/author_-_title_(swapped_due_to_name_detection) (0.00s)
    --- PASS: TestParseFilenameForAuthorEdgeCases/title_-_author (0.00s)
    --- PASS: TestParseFilenameForAuthorEdgeCases/both_sides_look_like_names (0.00s)
    --- PASS: TestParseFilenameForAuthorEdgeCases/neither_side_looks_like_name (0.00s)
    --- PASS: TestParseFilenameForAuthorEdgeCases/three_parts (0.00s)
    --- PASS: TestParseFilenameForAuthorEdgeCases/no_separator (0.00s)
=== RUN   TestScanDirectoryParallelReadDirError
Scanning for audiobook files (using 2 workers)...
--- PASS: TestScanDirectoryParallelReadDirError (0.01s)
=== RUN   TestScanDirectoryParallelWalkError
Scanning for audiobook files (using 2 workers)...
--- PASS: TestScanDirectoryParallelWalkError (0.00s)
=== RUN   TestProcessBooksParallelWithSaveError
Processing audiobook metadata (using 1 workers)...
   0% |                                                | (0/1, 0 it/hr) [0s:0s]2026/01/24 13:06:44 [DEBUG] metadata: extracting tags for /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestProcessBooksParallelWithSaveError2357572087/001/book1.m4b
2026/01/24 13:06:44 [WARN] metadata: failed to read tags for /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestProcessBooksParallelWithSaveError2357572087/001/book1.m4b: unexpected EOF; falling back to filename parsing
                                                                                100% || (1/1, 4391 it/s)
Warning: 1 books failed to save
--- PASS: TestProcessBooksParallelWithSaveError (0.01s)
=== RUN   TestProcessBooksParallelNoProgressCallback
Processing audiobook metadata (using 2 workers)...
   0% |                                                | (0/2, 0 it/hr) [0s:0s]2026/01/24 13:06:44 [DEBUG] metadata: extracting tags for /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestProcessBooksParallelNoProgressCallback2739099936/001/book2.m4b
2026/01/24 13:06:44 [DEBUG] metadata: extracting tags for /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestProcessBooksParallelNoProgressCallback2739099936/001/book1.m4b
2026/01/24 13:06:44 [WARN] metadata: failed to read tags for /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestProcessBooksParallelNoProgressCallback2739099936/001/book2.m4b: unexpected EOF; falling back to filename parsing
2026/01/24 13:06:44 [WARN] metadata: failed to read tags for /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestProcessBooksParallelNoProgressCallback2739099936/001/book1.m4b: unexpected EOF; falling back to filename parsing
                                                                                100% || (2/2, 3379 it/s)
--- PASS: TestProcessBooksParallelNoProgressCallback (0.02s)
=== RUN   TestSaveBookToDatabaseCodePaths
=== RUN   TestSaveBookToDatabaseCodePaths/no_database_available
=== RUN   TestSaveBookToDatabaseCodePaths/with_GlobalStore_path_exercised
    scanner_coverage_test.go:479: cannot initialize store for this test
--- PASS: TestSaveBookToDatabaseCodePaths (0.16s)
    --- PASS: TestSaveBookToDatabaseCodePaths/no_database_available (0.00s)
    --- SKIP: TestSaveBookToDatabaseCodePaths/with_GlobalStore_path_exercised (0.16s)
=== RUN   TestSaveBookToDatabaseWithoutStore
--- PASS: TestSaveBookToDatabaseWithoutStore (0.04s)
=== RUN   TestSaveBookToDatabaseNoDatabase
--- PASS: TestSaveBookToDatabaseNoDatabase (0.00s)
=== RUN   TestProcessBooksParallelWithAIParsing
Processing audiobook metadata (using 1 workers)...
   0% |                                                | (0/1, 0 it/hr) [0s:0s]2026/01/24 13:06:45 [WARN] scanner: AI parsing enabled but OpenAI API key is not configured
2026/01/24 13:06:45 [DEBUG] metadata: extracting tags for /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestProcessBooksParallelWithAIParsing155133356/001/book1.m4b
2026/01/24 13:06:45 [WARN] metadata: failed to read tags for /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestProcessBooksParallelWithAIParsing155133356/001/book1.m4b: unexpected EOF; falling back to filename parsing
                                                                                100% || (1/1, 7084 it/s)
--- PASS: TestProcessBooksParallelWithAIParsing (0.00s)
=== RUN   TestProcessBooksParallelContextTimeout
Processing audiobook metadata (using 1 workers)...
   0% |                                                | (0/1, 0 it/hr) [0s:0s]2026/01/24 13:06:45 [DEBUG] metadata: extracting tags for /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestProcessBooksParallelContextTimeout852727932/001/book1.m4b
2026/01/24 13:06:45 [WARN] metadata: failed to read tags for /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestProcessBooksParallelContextTimeout852727932/001/book1.m4b: unexpected EOF; falling back to filename parsing
                                                                                100% || (1/1, 10 it/s)
    scanner_coverage_test.go:621: expected context error, got: <nil>
--- PASS: TestProcessBooksParallelContextTimeout (0.10s)
=== RUN   TestIsValidAuthorNumericString
--- PASS: TestIsValidAuthorNumericString (0.00s)
=== RUN   TestExtractInfoFromPathLeadingNumber
--- PASS: TestExtractInfoFromPathLeadingNumber (0.00s)
=== RUN   TestExtractInfoFromPathSeriesPattern
=== RUN   TestExtractInfoFromPathSeriesPattern/series_-_title_without_author_detection
--- PASS: TestExtractInfoFromPathSeriesPattern (0.00s)
    --- PASS: TestExtractInfoFromPathSeriesPattern/series_-_title_without_author_detection (0.00s)
=== RUN   TestScanDirectoryParallelMultipleWorkers
=== RUN   TestScanDirectoryParallelMultipleWorkers/workers_0
Scanning for audiobook files (using 1 workers)...
=== RUN   TestScanDirectoryParallelMultipleWorkers/workers_1
Scanning for audiobook files (using 1 workers)...
=== RUN   TestScanDirectoryParallelMultipleWorkers/workers_2
Scanning for audiobook files (using 2 workers)...
=== RUN   TestScanDirectoryParallelMultipleWorkers/workers_4
Scanning for audiobook files (using 4 workers)...
=== RUN   TestScanDirectoryParallelMultipleWorkers/workers_8
Scanning for audiobook files (using 8 workers)...
--- PASS: TestScanDirectoryParallelMultipleWorkers (0.01s)
    --- PASS: TestScanDirectoryParallelMultipleWorkers/workers_0 (0.00s)
    --- PASS: TestScanDirectoryParallelMultipleWorkers/workers_1 (0.00s)
    --- PASS: TestScanDirectoryParallelMultipleWorkers/workers_2 (0.00s)
    --- PASS: TestScanDirectoryParallelMultipleWorkers/workers_4 (0.00s)
    --- PASS: TestScanDirectoryParallelMultipleWorkers/workers_8 (0.00s)
=== RUN   TestScanDirectoryParallelFiltersExtensions
Scanning for audiobook files (using 2 workers)...
--- PASS: TestScanDirectoryParallelFiltersExtensions (0.00s)
=== RUN   TestProcessBooksParallelInvokesProgress
Processing audiobook metadata (using 2 workers)...
   0% |                                                | (0/3, 0 it/hr) [0s:0s]2026/01/24 13:06:45 [DEBUG] metadata: extracting tags for /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestProcessBooksParallelInvokesProgress539518422/001/book3.m4b
2026/01/24 13:06:45 [DEBUG] metadata: extracting tags for /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestProcessBooksParallelInvokesProgress539518422/001/book1.m4b
2026/01/24 13:06:45 [WARN] metadata: failed to read tags for /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestProcessBooksParallelInvokesProgress539518422/001/book1.m4b: unexpected EOF; falling back to filename parsing
2026/01/24 13:06:45 [WARN] metadata: failed to read tags for /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestProcessBooksParallelInvokesProgress539518422/001/book3.m4b: unexpected EOF; falling back to filename parsing
2026/01/24 13:06:45 [DEBUG] metadata: extracting tags for /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestProcessBooksParallelInvokesProgress539518422/001/book2.m4b
2026/01/24 13:06:45 [WARN] metadata: failed to read tags for /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestProcessBooksParallelInvokesProgress539518422/001/book2.m4b: unexpected EOF; falling back to filename parsing
                                                                                100% || (3/3, 17053 it/s)
--- PASS: TestProcessBooksParallelInvokesProgress (0.00s)
=== RUN   TestExtractInfoFromPathParsesTitleAndAuthor
--- PASS: TestExtractInfoFromPathParsesTitleAndAuthor (0.00s)
=== RUN   TestParseFilenameForAuthor
--- PASS: TestParseFilenameForAuthor (0.00s)
=== RUN   TestLooksLikePersonName
--- PASS: TestLooksLikePersonName (0.00s)
=== RUN   TestComputeFileHash
--- PASS: TestComputeFileHash (0.00s)
=== RUN   TestScanDirectory
Scanning for audiobook files (using 1 workers)...
--- PASS: TestScanDirectory (0.00s)
=== RUN   TestExtractAuthorFromDirectory
=== RUN   TestExtractAuthorFromDirectory/author_in_directory
=== RUN   TestExtractAuthorFromDirectory/author-title_pattern
=== RUN   TestExtractAuthorFromDirectory/skip_common_directories
=== RUN   TestExtractAuthorFromDirectory/skip_downloads_directory
=== RUN   TestExtractAuthorFromDirectory/translator_pattern
--- PASS: TestExtractAuthorFromDirectory (0.00s)
    --- PASS: TestExtractAuthorFromDirectory/author_in_directory (0.00s)
    --- PASS: TestExtractAuthorFromDirectory/author-title_pattern (0.00s)
    --- PASS: TestExtractAuthorFromDirectory/skip_common_directories (0.00s)
    --- PASS: TestExtractAuthorFromDirectory/skip_downloads_directory (0.00s)
    --- PASS: TestExtractAuthorFromDirectory/translator_pattern (0.00s)
=== RUN   TestIsValidAuthor
=== RUN   TestIsValidAuthor/Stephen_King
=== RUN   TestIsValidAuthor/J.K._Rowling
=== RUN   TestIsValidAuthor/#00
=== RUN   TestIsValidAuthor/book1
=== RUN   TestIsValidAuthor/chapter_5
=== RUN   TestIsValidAuthor/Part_One
=== RUN   TestIsValidAuthor/Volume_2
=== RUN   TestIsValidAuthor/123
=== RUN   TestIsValidAuthor/Disc_1
--- PASS: TestIsValidAuthor (0.00s)
    --- PASS: TestIsValidAuthor/Stephen_King (0.00s)
    --- PASS: TestIsValidAuthor/J.K._Rowling (0.00s)
    --- PASS: TestIsValidAuthor/#00 (0.00s)
    --- PASS: TestIsValidAuthor/book1 (0.00s)
    --- PASS: TestIsValidAuthor/chapter_5 (0.00s)
    --- PASS: TestIsValidAuthor/Part_One (0.00s)
    --- PASS: TestIsValidAuthor/Volume_2 (0.00s)
    --- PASS: TestIsValidAuthor/123 (0.00s)
    --- PASS: TestIsValidAuthor/Disc_1 (0.00s)
=== RUN   TestExtractInfoFromPathVariants
=== RUN   TestExtractInfoFromPathVariants/numbered_chapter_stripped
=== RUN   TestExtractInfoFromPathVariants/track_number_prefix
=== RUN   TestExtractInfoFromPathVariants/simple_filename
=== RUN   TestExtractInfoFromPathVariants/author-title_pattern_with_author_name
--- PASS: TestExtractInfoFromPathVariants (0.00s)
    --- PASS: TestExtractInfoFromPathVariants/numbered_chapter_stripped (0.00s)
    --- PASS: TestExtractInfoFromPathVariants/track_number_prefix (0.00s)
    --- PASS: TestExtractInfoFromPathVariants/simple_filename (0.00s)
    --- PASS: TestExtractInfoFromPathVariants/author-title_pattern_with_author_name (0.00s)
=== RUN   TestProcessBooksParallelCancellation
Processing audiobook metadata (using 2 workers)...
   0% |                                                | (0/3, 0 it/hr) [0s:0s]--- PASS: TestProcessBooksParallelCancellation (0.00s)
=== RUN   TestScanDirectoryParallelNegativeWorkers
Scanning for audiobook files (using 1 workers)...
--- PASS: TestScanDirectoryParallelNegativeWorkers (0.00s)
=== RUN   TestProcessBooksParallelNegativeWorkers
Processing audiobook metadata (using 1 workers)...
   0% |                                                | (0/1, 0 it/hr) [0s:0s]2026/01/24 13:06:45 [DEBUG] metadata: extracting tags for /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestProcessBooksParallelNegativeWorkers1006452031/001/book1.m4b
2026/01/24 13:06:45 [WARN] metadata: failed to read tags for /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestProcessBooksParallelNegativeWorkers1006452031/001/book1.m4b: unexpected EOF; falling back to filename parsing
                                                                                100% || (1/1, 6920 it/s)
--- PASS: TestProcessBooksParallelNegativeWorkers (0.00s)
=== RUN   TestComputeFileHashError
--- PASS: TestComputeFileHashError (0.00s)
=== RUN   TestHelperFunctions
=== RUN   TestHelperFunctions/stringPtrValue
=== RUN   TestHelperFunctions/stringPtr
=== RUN   TestHelperFunctions/intPtr
=== RUN   TestHelperFunctions/nullablePtr_empty
=== RUN   TestHelperFunctions/nullablePtr_whitespace
=== RUN   TestHelperFunctions/nullablePtr_value
--- PASS: TestHelperFunctions (0.00s)
    --- PASS: TestHelperFunctions/stringPtrValue (0.00s)
    --- PASS: TestHelperFunctions/stringPtr (0.00s)
    --- PASS: TestHelperFunctions/intPtr (0.00s)
    --- PASS: TestHelperFunctions/nullablePtr_empty (0.00s)
    --- PASS: TestHelperFunctions/nullablePtr_whitespace (0.00s)
    --- PASS: TestHelperFunctions/nullablePtr_value (0.00s)
=== RUN   TestIdentifySeriesUsingExternalAPIs
--- PASS: TestIdentifySeriesUsingExternalAPIs (0.00s)
=== RUN   TestProcessBooks
Processing audiobook metadata (using 1 workers)...
   0% |                                                | (0/1, 0 it/hr) [0s:0s]2026/01/24 13:06:45 [DEBUG] metadata: extracting tags for /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestProcessBooks4045492117/001/book1.m4b
2026/01/24 13:06:45 [WARN] metadata: failed to read tags for /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestProcessBooks4045492117/001/book1.m4b: unexpected EOF; falling back to filename parsing
                                                                                100% || (1/1, 9975 it/s)
--- PASS: TestProcessBooks (0.00s)
PASS
coverage: 80.7% of statements
ok  	github.com/jdfalk/audiobook-organizer/internal/scanner	(cached)	coverage: 80.7% of statements
	github.com/jdfalk/audiobook-organizer/internal/scanner/mocks		coverage: 0.0% of statements
=== RUN   TestAIEndpoints_WithStubbedOpenAI
2026/01/24 13:19:03 Worker 0 started
2026/01/24 13:19:03 Worker 1 started
[GIN] 2026/01/24 - 13:19:03 | 200 |    2.224541ms |       192.0.2.1 | POST     "/api/v1/ai/parse-filename"
[GIN] 2026/01/24 - 13:19:03 | 200 |    2.238084ms |       192.0.2.1 | POST     "/api/v1/ai/parse-filename"
[GIN] 2026/01/24 - 13:19:03 | 200 |     235.208s |       192.0.2.1 | POST     "/api/v1/ai/test-connection"
[GIN] 2026/01/24 - 13:19:03 | 200 |     241.542s |       192.0.2.1 | POST     "/api/v1/ai/test-connection"
[GIN] 2026/01/24 - 13:19:03 | 200 |    1.724959ms |       192.0.2.1 | POST     "/api/v1/audiobooks/01KFRKP8GZKY8BARWS3CA8PK5Y/parse-with-ai"
[GIN] 2026/01/24 - 13:19:03 | 200 |    1.738459ms |       192.0.2.1 | POST     "/api/v1/audiobooks/01KFRKP8GZKY8BARWS3CA8PK5Y/parse-with-ai"
2026/01/24 13:19:03 Shutting down operation queue...
2026/01/24 13:19:03 Worker 1 stopped
2026/01/24 13:19:03 Worker 0 stopped
2026/01/24 13:19:03 Operation queue shut down gracefully
--- PASS: TestAIEndpoints_WithStubbedOpenAI (0.02s)
=== RUN   TestRestoreBackup_Success
2026/01/24 13:19:03 Worker 0 started
2026/01/24 13:19:03 Worker 1 started
[GIN] 2026/01/24 - 13:19:03 | 200 |      3.7725ms |       192.0.2.1 | POST     "/api/v1/backup/create"
[GIN] 2026/01/24 - 13:19:03 | 200 |    3.789542ms |       192.0.2.1 | POST     "/api/v1/backup/create"
[GIN] 2026/01/24 - 13:19:03 | 200 |     457.084s |       192.0.2.1 | POST     "/api/v1/backup/restore"
[GIN] 2026/01/24 - 13:19:03 | 200 |     463.541s |       192.0.2.1 | POST     "/api/v1/backup/restore"
2026/01/24 13:19:03 Shutting down operation queue...
2026/01/24 13:19:03 Worker 1 stopped
2026/01/24 13:19:03 Worker 0 stopped
2026/01/24 13:19:03 Operation queue shut down gracefully
--- PASS: TestRestoreBackup_Success (0.02s)
=== RUN   TestDeleteBackup_Success
2026/01/24 13:19:03 Worker 0 started
2026/01/24 13:19:03 Worker 1 started
[GIN] 2026/01/24 - 13:19:03 | 200 |    1.796541ms |       192.0.2.1 | POST     "/api/v1/backup/create"
[GIN] 2026/01/24 - 13:19:03 | 200 |    1.806541ms |       192.0.2.1 | POST     "/api/v1/backup/create"
[GIN] 2026/01/24 - 13:19:03 | 200 |      70.084s |       192.0.2.1 | DELETE   "/api/v1/backup/audiobooks_sqlite_20260124_131903.tar.gz"
[GIN] 2026/01/24 - 13:19:03 | 200 |      74.709s |       192.0.2.1 | DELETE   "/api/v1/backup/audiobooks_sqlite_20260124_131903.tar.gz"
2026/01/24 13:19:03 Shutting down operation queue...
2026/01/24 13:19:03 Worker 1 stopped
2026/01/24 13:19:03 Worker 0 stopped
2026/01/24 13:19:03 Operation queue shut down gracefully
--- PASS: TestDeleteBackup_Success (0.02s)
=== RUN   TestBulkFetchMetadata_MixedResults
2026/01/24 13:19:03 Worker 0 started
2026/01/24 13:19:03 Worker 1 started
[GIN] 2026/01/24 - 13:19:03 | 200 |    5.108042ms |       192.0.2.1 | POST     "/api/v1/metadata/bulk-fetch"
[GIN] 2026/01/24 - 13:19:03 | 200 |     5.12225ms |       192.0.2.1 | POST     "/api/v1/metadata/bulk-fetch"
2026/01/24 13:19:03 Shutting down operation queue...
2026/01/24 13:19:03 Worker 1 stopped
2026/01/24 13:19:03 Worker 0 stopped
2026/01/24 13:19:03 Operation queue shut down gracefully
--- PASS: TestBulkFetchMetadata_MixedResults (0.02s)
=== RUN   TestBulkFetchMetadata_OnlyMissingFalse_AllowsOverwrite
2026/01/24 13:19:03 Worker 0 started
2026/01/24 13:19:03 Worker 1 started
[GIN] 2026/01/24 - 13:19:03 | 200 |      4.1305ms |       192.0.2.1 | POST     "/api/v1/metadata/bulk-fetch"
[GIN] 2026/01/24 - 13:19:03 | 200 |    4.144333ms |       192.0.2.1 | POST     "/api/v1/metadata/bulk-fetch"
2026/01/24 13:19:03 Shutting down operation queue...
2026/01/24 13:19:03 Worker 0 stopped
2026/01/24 13:19:03 Worker 1 stopped
2026/01/24 13:19:03 Operation queue shut down gracefully
--- PASS: TestBulkFetchMetadata_OnlyMissingFalse_AllowsOverwrite (0.02s)
=== RUN   TestGetDefaultServerConfig_DisablesWriteTimeout
--- PASS: TestGetDefaultServerConfig_DisablesWriteTimeout (0.00s)
=== RUN   TestCountAudiobooksEndpoint
2026/01/24 13:19:03 Worker 0 started
2026/01/24 13:19:03 Worker 1 started
=== RUN   TestCountAudiobooksEndpoint/count_all_audiobooks
2026/01/24 13:19:03 [DEBUG] countAudiobooks: Returning count: 3
[GIN] 2026/01/24 - 13:19:03 | 200 |     119.041s |       192.0.2.1 | GET      "/api/v1/audiobooks/count"
[GIN] 2026/01/24 - 13:19:03 | 200 |     130.708s |       192.0.2.1 | GET      "/api/v1/audiobooks/count"
=== RUN   TestCountAudiobooksEndpoint/count_with_search_query
2026/01/24 13:19:03 [DEBUG] countAudiobooks: Returning count: 3
[GIN] 2026/01/24 - 13:19:03 | 200 |      26.083s |       192.0.2.1 | GET      "/api/v1/audiobooks/count?search=Test"
[GIN] 2026/01/24 - 13:19:03 | 200 |        29.5s |       192.0.2.1 | GET      "/api/v1/audiobooks/count?search=Test"
2026/01/24 13:19:03 Shutting down operation queue...
2026/01/24 13:19:03 Worker 1 stopped
2026/01/24 13:19:03 Worker 0 stopped
2026/01/24 13:19:03 Operation queue shut down gracefully
--- PASS: TestCountAudiobooksEndpoint (0.01s)
    --- PASS: TestCountAudiobooksEndpoint/count_all_audiobooks (0.00s)
    --- PASS: TestCountAudiobooksEndpoint/count_with_search_query (0.00s)
=== RUN   TestSystemLogsEndpoint
2026/01/24 13:19:03 Worker 0 started
2026/01/24 13:19:03 Worker 1 started
=== RUN   TestSystemLogsEndpoint/default_logs
[GIN] 2026/01/24 - 13:19:03 | 200 |     139.583s |       192.0.2.1 | GET      "/api/v1/system/logs"
[GIN] 2026/01/24 - 13:19:03 | 200 |     154.416s |       192.0.2.1 | GET      "/api/v1/system/logs"
=== RUN   TestSystemLogsEndpoint/logs_with_limit
[GIN] 2026/01/24 - 13:19:03 | 200 |      29.916s |       192.0.2.1 | GET      "/api/v1/system/logs?limit=50"
[GIN] 2026/01/24 - 13:19:03 | 200 |      36.667s |       192.0.2.1 | GET      "/api/v1/system/logs?limit=50"
=== RUN   TestSystemLogsEndpoint/logs_with_level_filter
[GIN] 2026/01/24 - 13:19:03 | 200 |      25.625s |       192.0.2.1 | GET      "/api/v1/system/logs?level=error"
[GIN] 2026/01/24 - 13:19:03 | 200 |      31.459s |       192.0.2.1 | GET      "/api/v1/system/logs?level=error"
2026/01/24 13:19:03 Shutting down operation queue...
2026/01/24 13:19:03 Worker 1 stopped
2026/01/24 13:19:03 Worker 0 stopped
2026/01/24 13:19:03 Operation queue shut down gracefully
--- PASS: TestSystemLogsEndpoint (0.02s)
    --- PASS: TestSystemLogsEndpoint/default_logs (0.00s)
    --- PASS: TestSystemLogsEndpoint/logs_with_limit (0.00s)
    --- PASS: TestSystemLogsEndpoint/logs_with_level_filter (0.00s)
=== RUN   TestUpdateConfigEndpointComplete
2026/01/24 13:19:03 Worker 0 started
2026/01/24 13:19:03 Worker 1 started
=== RUN   TestUpdateConfigEndpointComplete/valid_config_update
2026/01/24 13:19:03 [DEBUG] updateConfig: No openai_api_key in updates (present: false, type: <nil>)
2026/01/24 13:19:03 Saving configuration to database...
2026/01/24 13:19:03 [DEBUG] SaveConfigToDatabase: OpenAI key length: 0, EnableAIParsing: false
2026/01/24 13:19:03 [DEBUG] SaveConfigToDatabase: Skipping empty secret: openai_api_key
2026/01/24 13:19:03 [DEBUG] SaveConfigToDatabase: Skipping empty secret: goodreads_api_key
2026/01/24 13:19:03 Saved 24 settings to database
2026/01/24 13:19:03 Configuration saved successfully. Updated fields: []
[GIN] 2026/01/24 - 13:19:03 | 200 |     10.8985ms |       192.0.2.1 | PUT      "/api/v1/config"
[GIN] 2026/01/24 - 13:19:03 | 200 |   10.917833ms |       192.0.2.1 | PUT      "/api/v1/config"
=== RUN   TestUpdateConfigEndpointComplete/empty_config
2026/01/24 13:19:03 [DEBUG] updateConfig: No openai_api_key in updates (present: false, type: <nil>)
2026/01/24 13:19:03 Saving configuration to database...
2026/01/24 13:19:03 [DEBUG] SaveConfigToDatabase: OpenAI key length: 0, EnableAIParsing: false
2026/01/24 13:19:03 [DEBUG] SaveConfigToDatabase: Skipping empty secret: openai_api_key
2026/01/24 13:19:03 [DEBUG] SaveConfigToDatabase: Skipping empty secret: goodreads_api_key
2026/01/24 13:19:03 Saved 24 settings to database
2026/01/24 13:19:03 Configuration saved successfully. Updated fields: []
[GIN] 2026/01/24 - 13:19:03 | 200 |     514.667s |       192.0.2.1 | PUT      "/api/v1/config"
[GIN] 2026/01/24 - 13:19:03 | 200 |     529.792s |       192.0.2.1 | PUT      "/api/v1/config"
2026/01/24 13:19:03 Shutting down operation queue...
2026/01/24 13:19:03 Worker 1 stopped
2026/01/24 13:19:03 Worker 0 stopped
2026/01/24 13:19:03 Operation queue shut down gracefully
--- PASS: TestUpdateConfigEndpointComplete (0.02s)
    --- PASS: TestUpdateConfigEndpointComplete/valid_config_update (0.01s)
    --- PASS: TestUpdateConfigEndpointComplete/empty_config (0.00s)
=== RUN   TestBackupEndpoints
2026/01/24 13:19:03 Worker 0 started
2026/01/24 13:19:03 Worker 1 started
=== RUN   TestBackupEndpoints/create_backup
[GIN] 2026/01/24 - 13:19:03 | 200 |    4.511708ms |       192.0.2.1 | POST     "/api/v1/backup/create"
[GIN] 2026/01/24 - 13:19:03 | 200 |    4.530375ms |       192.0.2.1 | POST     "/api/v1/backup/create"
=== RUN   TestBackupEndpoints/list_backups
[GIN] 2026/01/24 - 13:19:03 | 200 |      271.25s |       192.0.2.1 | GET      "/api/v1/backup/list"
[GIN] 2026/01/24 - 13:19:03 | 200 |         276s |       192.0.2.1 | GET      "/api/v1/backup/list"
2026/01/24 13:19:03 Shutting down operation queue...
2026/01/24 13:19:03 Worker 0 stopped
2026/01/24 13:19:03 Worker 1 stopped
2026/01/24 13:19:03 Operation queue shut down gracefully
--- PASS: TestBackupEndpoints (0.02s)
    --- PASS: TestBackupEndpoints/create_backup (0.00s)
    --- PASS: TestBackupEndpoints/list_backups (0.00s)
=== RUN   TestImportFileEndpointComplete
2026/01/24 13:19:03 Worker 0 started
2026/01/24 13:19:03 Worker 1 started
[GIN] 2026/01/24 - 13:19:03 | 404 |       5.875s |       192.0.2.1 | POST     "/api/v1/import"
[GIN] 2026/01/24 - 13:19:03 | 404 |      17.833s |       192.0.2.1 | POST     "/api/v1/import"
2026/01/24 13:19:03 Shutting down operation queue...
2026/01/24 13:19:03 Worker 0 stopped
2026/01/24 13:19:03 Worker 1 stopped
2026/01/24 13:19:03 Operation queue shut down gracefully
--- PASS: TestImportFileEndpointComplete (0.01s)
=== RUN   TestDashboardEndpoint
2026/01/24 13:19:03 Worker 0 started
2026/01/24 13:19:03 Worker 1 started
[GIN] 2026/01/24 - 13:19:03 | 200 |     175.958s |       192.0.2.1 | GET      "/api/v1/dashboard"
[GIN] 2026/01/24 - 13:19:03 | 200 |     183.167s |       192.0.2.1 | GET      "/api/v1/dashboard"
2026/01/24 13:19:03 Shutting down operation queue...
2026/01/24 13:19:03 Worker 1 stopped
2026/01/24 13:19:03 Worker 0 stopped
2026/01/24 13:19:03 Operation queue shut down gracefully
--- PASS: TestDashboardEndpoint (0.01s)
=== RUN   TestServerHelpers
2026/01/24 13:19:03 [DEBUG] Recalculating library sizes (cache expired)
2026/01/24 13:19:03 [DEBUG] Calculated new sizes: library=4, import=5
2026/01/24 13:19:03 [DEBUG] Using cached sizes: library=4, import=5
--- PASS: TestServerHelpers (0.00s)
=== RUN   TestDuplicateAndSoftDeleteEndpoints
2026/01/24 13:19:03 Worker 0 started
2026/01/24 13:19:03 Worker 1 started
[GIN] 2026/01/24 - 13:19:03 | 200 |         297s |       192.0.2.1 | GET      "/api/v1/audiobooks/duplicates"
[GIN] 2026/01/24 - 13:19:03 | 200 |     305.333s |       192.0.2.1 | GET      "/api/v1/audiobooks/duplicates"
[GIN] 2026/01/24 - 13:19:03 | 200 |      99.958s |       192.0.2.1 | GET      "/api/v1/audiobooks/soft-deleted?limit=10"
[GIN] 2026/01/24 - 13:19:03 | 200 |     104.834s |       192.0.2.1 | GET      "/api/v1/audiobooks/soft-deleted?limit=10"
[GIN] 2026/01/24 - 13:19:03 | 200 |     517.709s |       192.0.2.1 | DELETE   "/api/v1/audiobooks/purge-soft-deleted?delete_files=true"
[GIN] 2026/01/24 - 13:19:03 | 200 |     521.916s |       192.0.2.1 | DELETE   "/api/v1/audiobooks/purge-soft-deleted?delete_files=true"
[GIN] 2026/01/24 - 13:19:03 | 200 |     498.459s |       192.0.2.1 | POST     "/api/v1/audiobooks/01KFRKP8PMYQQWYFD9JM25JWWE/restore"
[GIN] 2026/01/24 - 13:19:03 | 200 |     502.417s |       192.0.2.1 | POST     "/api/v1/audiobooks/01KFRKP8PMYQQWYFD9JM25JWWE/restore"
2026/01/24 13:19:03 [DEBUG] countAudiobooks: Returning count: 3
[GIN] 2026/01/24 - 13:19:03 | 200 |      23.708s |       192.0.2.1 | GET      "/api/v1/audiobooks/count"
[GIN] 2026/01/24 - 13:19:03 | 200 |       26.75s |       192.0.2.1 | GET      "/api/v1/audiobooks/count"
2026/01/24 13:19:03 Shutting down operation queue...
2026/01/24 13:19:03 Worker 1 stopped
2026/01/24 13:19:03 Worker 0 stopped
2026/01/24 13:19:03 Operation queue shut down gracefully
--- PASS: TestDuplicateAndSoftDeleteEndpoints (0.02s)
=== RUN   TestWorkEndpoints
2026/01/24 13:19:03 Worker 0 started
2026/01/24 13:19:03 Worker 1 started
[GIN] 2026/01/24 - 13:19:03 | 201 |     430.084s |       192.0.2.1 | POST     "/api/v1/works"
[GIN] 2026/01/24 - 13:19:03 | 201 |     437.042s |       192.0.2.1 | POST     "/api/v1/works"
[GIN] 2026/01/24 - 13:19:03 | 200 |      30.208s |       192.0.2.1 | GET      "/api/v1/works"
[GIN] 2026/01/24 - 13:19:03 | 200 |          34s |       192.0.2.1 | GET      "/api/v1/works"
[GIN] 2026/01/24 - 13:19:03 | 200 |      18.875s |       192.0.2.1 | GET      "/api/v1/works/01KFRKP8Q1N0CTGFGW1T80Q5QZ"
[GIN] 2026/01/24 - 13:19:03 | 200 |      22.334s |       192.0.2.1 | GET      "/api/v1/works/01KFRKP8Q1N0CTGFGW1T80Q5QZ"
[GIN] 2026/01/24 - 13:19:03 | 200 |      314.25s |       192.0.2.1 | PUT      "/api/v1/works/01KFRKP8Q1N0CTGFGW1T80Q5QZ"
[GIN] 2026/01/24 - 13:19:03 | 200 |     317.541s |       192.0.2.1 | PUT      "/api/v1/works/01KFRKP8Q1N0CTGFGW1T80Q5QZ"
[GIN] 2026/01/24 - 13:19:03 | 200 |      62.292s |       192.0.2.1 | GET      "/api/v1/works/01KFRKP8Q1N0CTGFGW1T80Q5QZ/books"
[GIN] 2026/01/24 - 13:19:03 | 200 |      65.959s |       192.0.2.1 | GET      "/api/v1/works/01KFRKP8Q1N0CTGFGW1T80Q5QZ/books"
[GIN] 2026/01/24 - 13:19:03 | 204 |     379.542s |       192.0.2.1 | DELETE   "/api/v1/works/01KFRKP8Q1N0CTGFGW1T80Q5QZ"
[GIN] 2026/01/24 - 13:19:03 | 204 |     383.041s |       192.0.2.1 | DELETE   "/api/v1/works/01KFRKP8Q1N0CTGFGW1T80Q5QZ"
2026/01/24 13:19:03 Shutting down operation queue...
2026/01/24 13:19:03 Worker 1 stopped
2026/01/24 13:19:03 Worker 0 stopped
2026/01/24 13:19:03 Operation queue shut down gracefully
--- PASS: TestWorkEndpoints (0.01s)
=== RUN   TestExclusionEndpoints
2026/01/24 13:19:03 Worker 0 started
2026/01/24 13:19:03 Worker 1 started
[GIN] 2026/01/24 - 13:19:03 | 201 |     119.208s |       192.0.2.1 | POST     "/api/v1/filesystem/exclude"
[GIN] 2026/01/24 - 13:19:03 | 201 |     125.875s |       192.0.2.1 | POST     "/api/v1/filesystem/exclude"
[GIN] 2026/01/24 - 13:19:03 | 204 |      48.291s |       192.0.2.1 | DELETE   "/api/v1/filesystem/exclude"
[GIN] 2026/01/24 - 13:19:03 | 204 |      52.292s |       192.0.2.1 | DELETE   "/api/v1/filesystem/exclude"
2026/01/24 13:19:03 Shutting down operation queue...
2026/01/24 13:19:03 Worker 1 stopped
2026/01/24 13:19:03 Worker 0 stopped
2026/01/24 13:19:03 Operation queue shut down gracefully
--- PASS: TestExclusionEndpoints (0.01s)
=== RUN   TestImportPathEndpoints
2026/01/24 13:19:03 Worker 0 started
2026/01/24 13:19:03 Worker 1 started
[GIN] 2026/01/24 - 13:19:03 | 201 |     765.917s |       192.0.2.1 | POST     "/api/v1/import-paths"
[GIN] 2026/01/24 - 13:19:03 | 201 |     773.833s |       192.0.2.1 | POST     "/api/v1/import-paths"
[GIN] 2026/01/24 - 13:19:03 | 200 |      45.917s |       192.0.2.1 | GET      "/api/v1/import-paths"
[GIN] 2026/01/24 - 13:19:03 | 200 |      49.916s |       192.0.2.1 | GET      "/api/v1/import-paths"
[GIN] 2026/01/24 - 13:19:03 | 204 |         421s |       192.0.2.1 | DELETE   "/api/v1/import-paths/1"
[GIN] 2026/01/24 - 13:19:03 | 204 |     425.375s |       192.0.2.1 | DELETE   "/api/v1/import-paths/1"
2026/01/24 13:19:03 Shutting down operation queue...
2026/01/24 13:19:03 Worker 1 stopped
2026/01/24 13:19:03 Worker 0 stopped
2026/01/24 13:19:03 Operation queue shut down gracefully
--- PASS: TestImportPathEndpoints (0.01s)
=== RUN   TestOperationEndpointsErrors
2026/01/24 13:19:03 Worker 0 started
2026/01/24 13:19:03 Worker 1 started
[GIN] 2026/01/24 - 13:19:03 | 500 |         7.5s |       192.0.2.1 | POST     "/api/v1/operations/scan"
[GIN] 2026/01/24 - 13:19:03 | 500 |      16.917s |       192.0.2.1 | POST     "/api/v1/operations/scan"
[GIN] 2026/01/24 - 13:19:03 | 500 |       22.25s |       192.0.2.1 | POST     "/api/v1/operations/organize"
[GIN] 2026/01/24 - 13:19:03 | 500 |      25.584s |       192.0.2.1 | POST     "/api/v1/operations/organize"
[GIN] 2026/01/24 - 13:19:03 | 200 |       6.917s |       192.0.2.1 | GET      "/api/v1/operations/active"
[GIN] 2026/01/24 - 13:19:03 | 200 |        9.75s |       192.0.2.1 | GET      "/api/v1/operations/active"
[GIN] 2026/01/24 - 13:19:03 | 500 |       2.334s |       192.0.2.1 | DELETE   "/api/v1/operations/bad-id"
[GIN] 2026/01/24 - 13:19:03 | 500 |       4.917s |       192.0.2.1 | DELETE   "/api/v1/operations/bad-id"
2026/01/24 13:19:03 Shutting down operation queue...
2026/01/24 13:19:03 Worker 1 stopped
2026/01/24 13:19:03 Worker 0 stopped
2026/01/24 13:19:03 Operation queue shut down gracefully
--- PASS: TestOperationEndpointsErrors (0.01s)
=== RUN   TestImportFileErrors
2026/01/24 13:19:03 Worker 0 started
2026/01/24 13:19:03 Worker 1 started
[GIN] 2026/01/24 - 13:19:03 | 400 |     161.834s |       192.0.2.1 | POST     "/api/v1/import/file"
[GIN] 2026/01/24 - 13:19:03 | 400 |     171.792s |       192.0.2.1 | POST     "/api/v1/import/file"
[GIN] 2026/01/24 - 13:19:03 | 400 |      13.125s |       192.0.2.1 | POST     "/api/v1/import/file"
[GIN] 2026/01/24 - 13:19:03 | 400 |      18.833s |       192.0.2.1 | POST     "/api/v1/import/file"
[GIN] 2026/01/24 - 13:19:03 | 400 |       9.167s |       192.0.2.1 | POST     "/api/v1/import/file"
[GIN] 2026/01/24 - 13:19:03 | 400 |      13.167s |       192.0.2.1 | POST     "/api/v1/import/file"
2026/01/24 13:19:03 Shutting down operation queue...
2026/01/24 13:19:03 Worker 1 stopped
2026/01/24 13:19:03 Worker 0 stopped
2026/01/24 13:19:03 Operation queue shut down gracefully
--- PASS: TestImportFileErrors (0.01s)
=== RUN   TestSystemLogsEndpoints
2026/01/24 13:19:03 Worker 0 started
2026/01/24 13:19:03 Worker 1 started
[GIN] 2026/01/24 - 13:19:03 | 200 |      87.625s |       192.0.2.1 | GET      "/api/v1/system/logs?level=info"
[GIN] 2026/01/24 - 13:19:03 | 200 |      97.375s |       192.0.2.1 | GET      "/api/v1/system/logs?level=info"
[GIN] 2026/01/24 - 13:19:03 | 200 |      55.916s |       192.0.2.1 | GET      "/api/v1/system/logs?operation_id=log-op"
[GIN] 2026/01/24 - 13:19:03 | 200 |      59.875s |       192.0.2.1 | GET      "/api/v1/system/logs?operation_id=log-op"
2026/01/24 13:19:03 Shutting down operation queue...
2026/01/24 13:19:03 Worker 0 stopped
2026/01/24 13:19:03 Worker 1 stopped
2026/01/24 13:19:03 Operation queue shut down gracefully
--- PASS: TestSystemLogsEndpoints (0.01s)
=== RUN   TestAIEndpoints
2026/01/24 13:19:03 Worker 0 started
2026/01/24 13:19:03 Worker 1 started
[GIN] 2026/01/24 - 13:19:03 | 400 |      15.583s |       192.0.2.1 | POST     "/api/v1/ai/parse-filename"
[GIN] 2026/01/24 - 13:19:03 | 400 |          24s |       192.0.2.1 | POST     "/api/v1/ai/parse-filename"
[GIN] 2026/01/24 - 13:19:03 | 400 |       5.291s |       192.0.2.1 | POST     "/api/v1/ai/parse-filename"
[GIN] 2026/01/24 - 13:19:03 | 400 |       8.417s |       192.0.2.1 | POST     "/api/v1/ai/parse-filename"
[GIN] 2026/01/24 - 13:19:03 | 400 |       3.416s |       192.0.2.1 | POST     "/api/v1/ai/test-connection"
[GIN] 2026/01/24 - 13:19:03 | 400 |       6.458s |       192.0.2.1 | POST     "/api/v1/ai/test-connection"
[GIN] 2026/01/24 - 13:19:03 | 400 |      40.083s |       192.0.2.1 | POST     "/api/v1/audiobooks/missing/parse-with-ai"
[GIN] 2026/01/24 - 13:19:03 | 400 |      44.167s |       192.0.2.1 | POST     "/api/v1/audiobooks/missing/parse-with-ai"
[GIN] 2026/01/24 - 13:19:03 | 400 |          52s |       192.0.2.1 | POST     "/api/v1/audiobooks/01KFRKP8S5JKVGT7DCE0FBQYRF/parse-with-ai"
[GIN] 2026/01/24 - 13:19:03 | 400 |      57.875s |       192.0.2.1 | POST     "/api/v1/audiobooks/01KFRKP8S5JKVGT7DCE0FBQYRF/parse-with-ai"
2026/01/24 13:19:03 Shutting down operation queue...
2026/01/24 13:19:03 Worker 1 stopped
2026/01/24 13:19:03 Worker 0 stopped
2026/01/24 13:19:03 Operation queue shut down gracefully
--- PASS: TestAIEndpoints (0.01s)
=== RUN   TestVersionEndpoints
2026/01/24 13:19:03 Worker 0 started
2026/01/24 13:19:03 Worker 1 started
[GIN] 2026/01/24 - 13:19:03 | 200 |       55.25s |       192.0.2.1 | GET      "/api/v1/audiobooks/01KFRKP8SHCASYSTCVANJ4KWWK/versions"
[GIN] 2026/01/24 - 13:19:03 | 200 |        61.5s |       192.0.2.1 | GET      "/api/v1/audiobooks/01KFRKP8SHCASYSTCVANJ4KWWK/versions"
[GIN] 2026/01/24 - 13:19:03 | 200 |     845.375s |       192.0.2.1 | POST     "/api/v1/audiobooks/01KFRKP8SHCASYSTCVANJ4KWWK/versions"
[GIN] 2026/01/24 - 13:19:03 | 200 |     849.791s |       192.0.2.1 | POST     "/api/v1/audiobooks/01KFRKP8SHCASYSTCVANJ4KWWK/versions"
[GIN] 2026/01/24 - 13:19:03 | 200 |      62.166s |       192.0.2.1 | GET      "/api/v1/version-groups/01KFRKP8SJRXP6RMX936WRJZ5Q"
[GIN] 2026/01/24 - 13:19:03 | 200 |      66.334s |       192.0.2.1 | GET      "/api/v1/version-groups/01KFRKP8SJRXP6RMX936WRJZ5Q"
[GIN] 2026/01/24 - 13:19:03 | 200 |     777.458s |       192.0.2.1 | PUT      "/api/v1/audiobooks/01KFRKP8SHCASYSTCVANJ4KWWK/set-primary"
[GIN] 2026/01/24 - 13:19:03 | 200 |     783.417s |       192.0.2.1 | PUT      "/api/v1/audiobooks/01KFRKP8SHCASYSTCVANJ4KWWK/set-primary"
[GIN] 2026/01/24 - 13:19:03 | 200 |     489.292s |       192.0.2.1 | PUT      "/api/v1/audiobooks/01KFRKP8SMV6CV1AR3PQT35JNV/set-primary"
[GIN] 2026/01/24 - 13:19:03 | 200 |     495.583s |       192.0.2.1 | PUT      "/api/v1/audiobooks/01KFRKP8SMV6CV1AR3PQT35JNV/set-primary"
2026/01/24 13:19:03 Shutting down operation queue...
2026/01/24 13:19:03 Worker 1 stopped
2026/01/24 13:19:03 Worker 0 stopped
2026/01/24 13:19:03 Operation queue shut down gracefully
--- PASS: TestVersionEndpoints (0.02s)
=== RUN   TestBlockedHashEndpoints
2026/01/24 13:19:03 Worker 0 started
2026/01/24 13:19:03 Worker 1 started
2026/01/24 13:19:03 Current database version: 0
2026/01/24 13:19:03 Applying 10 migrations...
2026/01/24 13:19:03 Applying migration 1: Initial schema with authors, series, books, playlists
2026/01/24 13:19:03   - Validating basic schema (authors, series, books, playlists)
2026/01/24 13:19:03 Migration 1 completed successfully
2026/01/24 13:19:03 Applying migration 2: Add import paths and operations tables
2026/01/24 13:19:03   - Adding import paths and operations support
2026/01/24 13:19:03 Migration 2 completed successfully
2026/01/24 13:19:03 Applying migration 3: Add user preferences
2026/01/24 13:19:03   - Adding user preferences support
2026/01/24 13:19:03 Migration 3 completed successfully
2026/01/24 13:19:03 Applying migration 4: Add extended Pebble keyspace (users, sessions, segments, playback)
2026/01/24 13:19:03   - Adding extended Pebble keyspace (users, sessions, segments, playback)
2026/01/24 13:19:03 Migration 4 completed successfully
2026/01/24 13:19:03 Applying migration 5: Add media info and version management fields to books
2026/01/24 13:19:03   - Adding media info and version management fields to books table
2026/01/24 13:19:03     - Executing: ALTER TABLE books ADD COLUMN bitrate_kbps INTEGER
2026/01/24 13:19:03     - Column already exists, skipping
2026/01/24 13:19:03     - Executing: ALTER TABLE books ADD COLUMN codec TEXT
2026/01/24 13:19:03     - Column already exists, skipping
2026/01/24 13:19:03     - Executing: ALTER TABLE books ADD COLUMN sample_rate_hz INTEGER
2026/01/24 13:19:03     - Column already exists, skipping
2026/01/24 13:19:03     - Executing: ALTER TABLE books ADD COLUMN channels INTEGER
2026/01/24 13:19:03     - Column already exists, skipping
2026/01/24 13:19:03     - Executing: ALTER TABLE books ADD COLUMN bit_depth INTEGER
2026/01/24 13:19:03     - Column already exists, skipping
2026/01/24 13:19:03     - Executing: ALTER TABLE books ADD COLUMN quality TEXT
2026/01/24 13:19:03     - Column already exists, skipping
2026/01/24 13:19:03     - Executing: ALTER TABLE books ADD COLUMN is_primary_version BOOLEAN DEFAULT 1
2026/01/24 13:19:03     - Column already exists, skipping
2026/01/24 13:19:03     - Executing: ALTER TABLE books ADD COLUMN version_group_id TEXT
2026/01/24 13:19:03     - Column already exists, skipping
2026/01/24 13:19:03     - Executing: ALTER TABLE books ADD COLUMN version_notes TEXT
2026/01/24 13:19:03     - Column already exists, skipping
2026/01/24 13:19:03     - Creating index: CREATE INDEX IF NOT EXISTS idx_books_version_group ON books(version_group_id)
2026/01/24 13:19:03     - Creating index: CREATE INDEX IF NOT EXISTS idx_books_is_primary ON books(is_primary_version)
2026/01/24 13:19:03   - Media info and version management fields added successfully
2026/01/24 13:19:03 Migration 5 completed successfully
2026/01/24 13:19:03 Applying migration 6: Add original and organized file hash tracking
2026/01/24 13:19:03   - Adding original/organized file hash columns to books table
2026/01/24 13:19:03     - Executing: ALTER TABLE books ADD COLUMN original_file_hash TEXT
2026/01/24 13:19:03     - Column already exists, skipping
2026/01/24 13:19:03     - Executing: ALTER TABLE books ADD COLUMN organized_file_hash TEXT
2026/01/24 13:19:03     - Column already exists, skipping
2026/01/24 13:19:03     - Creating index: CREATE INDEX IF NOT EXISTS idx_books_original_hash ON books(original_file_hash)
2026/01/24 13:19:03     - Creating index: CREATE INDEX IF NOT EXISTS idx_books_organized_hash ON books(organized_file_hash)
2026/01/24 13:19:03 Migration 6 completed successfully
2026/01/24 13:19:03 Applying migration 7: Rename import paths to import paths
2026/01/24 13:19:03   - Renaming import paths to import paths
2026/01/24 13:19:03 Migration 7 completed successfully
2026/01/24 13:19:03 Applying migration 8: Add do_not_import table for hash blocklist
2026/01/24 13:19:03   - Adding do_not_import table for hash blocklist
2026/01/24 13:19:03     - Executing: CREATE TABLE IF NOT EXISTS do_not_import (
				hash TEXT PRIMARY KEY NOT NULL,
				reason TEXT NOT NULL,
				created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
			)
2026/01/24 13:19:03     - Executing: CREATE INDEX IF NOT EXISTS idx_do_not_import_hash ON do_not_import(hash)
2026/01/24 13:19:03 Migration 8 completed successfully
2026/01/24 13:19:03 Applying migration 9: Add state machine and lifecycle fields to books
2026/01/24 13:19:03   - Adding state machine and lifecycle fields to books table
2026/01/24 13:19:03     - Executing: ALTER TABLE books ADD COLUMN library_state TEXT DEFAULT 'imported'
2026/01/24 13:19:03     - Column already exists, skipping
2026/01/24 13:19:03     - Executing: ALTER TABLE books ADD COLUMN quantity INTEGER DEFAULT 1
2026/01/24 13:19:03     - Column already exists, skipping
2026/01/24 13:19:03     - Executing: ALTER TABLE books ADD COLUMN marked_for_deletion BOOLEAN DEFAULT 0
2026/01/24 13:19:03     - Column already exists, skipping
2026/01/24 13:19:03     - Executing: ALTER TABLE books ADD COLUMN marked_for_deletion_at DATETIME
2026/01/24 13:19:03     - Column already exists, skipping
2026/01/24 13:19:03     - Creating index: CREATE INDEX IF NOT EXISTS idx_books_library_state ON books(library_state)
2026/01/24 13:19:03     - Creating index: CREATE INDEX IF NOT EXISTS idx_books_marked_for_deletion ON books(marked_for_deletion)
2026/01/24 13:19:03   - State machine fields added successfully
2026/01/24 13:19:03 Migration 9 completed successfully
2026/01/24 13:19:03 Applying migration 10: Add metadata_states table for metadata provenance
2026/01/24 13:19:03   - Adding metadata_states table for metadata provenance
2026/01/24 13:19:03     - Executing: CREATE TABLE IF NOT EXISTS metadata_states (
			book_id TEXT NOT NULL,
			field TEXT NOT NULL,
			fetched_value TEXT,
			override_value TEXT,
			override_locked BOOLEAN NOT NULL DEFAULT 0,
			updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
			PRIMARY KEY (book_id, field)
		)
2026/01/24 13:19:03     - Executing: CREATE INDEX IF NOT EXISTS idx_metadata_states_book ON metadata_states(book_id)
2026/01/24 13:19:03 Migration 10 completed successfully
2026/01/24 13:19:03 All migrations completed. Current version: 10
[GIN] 2026/01/24 - 13:19:03 | 200 |      59.333s |       192.0.2.1 | GET      "/api/v1/blocked-hashes"
[GIN] 2026/01/24 - 13:19:03 | 200 |      66.917s |       192.0.2.1 | GET      "/api/v1/blocked-hashes"
[GIN] 2026/01/24 - 13:19:03 | 400 |      16.083s |       192.0.2.1 | POST     "/api/v1/blocked-hashes"
[GIN] 2026/01/24 - 13:19:03 | 400 |       19.25s |       192.0.2.1 | POST     "/api/v1/blocked-hashes"
[GIN] 2026/01/24 - 13:19:03 | 201 |     379.834s |       192.0.2.1 | POST     "/api/v1/blocked-hashes"
[GIN] 2026/01/24 - 13:19:03 | 201 |     383.583s |       192.0.2.1 | POST     "/api/v1/blocked-hashes"
[GIN] 2026/01/24 - 13:19:03 | 200 |      399.25s |       192.0.2.1 | DELETE   "/api/v1/blocked-hashes/aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"
[GIN] 2026/01/24 - 13:19:03 | 200 |     404.041s |       192.0.2.1 | DELETE   "/api/v1/blocked-hashes/aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"
2026/01/24 13:19:03 Shutting down operation queue...
2026/01/24 13:19:03 Worker 1 stopped
2026/01/24 13:19:03 Worker 0 stopped
2026/01/24 13:19:03 Operation queue shut down gracefully
--- PASS: TestBlockedHashEndpoints (0.02s)
=== RUN   TestHandleEventsUnavailable
2026/01/24 13:19:03 Worker 0 started
2026/01/24 13:19:03 Worker 1 started
[GIN] 2026/01/24 - 13:19:03 | 503 |       7.083s |       192.0.2.1 | GET      "/api/events"
[GIN] 2026/01/24 - 13:19:03 | 503 |      15.667s |       192.0.2.1 | GET      "/api/events"
2026/01/24 13:19:03 Shutting down operation queue...
2026/01/24 13:19:03 Worker 0 stopped
2026/01/24 13:19:03 Worker 1 stopped
2026/01/24 13:19:03 Operation queue shut down gracefully
--- PASS: TestHandleEventsUnavailable (0.01s)
=== RUN   TestBackupEndpointsErrors
2026/01/24 13:19:03 Worker 0 started
2026/01/24 13:19:03 Worker 1 started
[GIN] 2026/01/24 - 13:19:03 | 500 |     717.042s |       192.0.2.1 | POST     "/api/v1/backup/create"
[GIN] 2026/01/24 - 13:19:03 | 500 |     725.875s |       192.0.2.1 | POST     "/api/v1/backup/create"
[GIN] 2026/01/24 - 13:19:03 | 400 |       7.667s |       192.0.2.1 | POST     "/api/v1/backup/restore"
[GIN] 2026/01/24 - 13:19:03 | 400 |      10.666s |       192.0.2.1 | POST     "/api/v1/backup/restore"
[GIN] 2026/01/24 - 13:19:03 | 500 |      10.667s |       192.0.2.1 | DELETE   "/api/v1/backup/missing.tar.gz"
[GIN] 2026/01/24 - 13:19:03 | 500 |      13.167s |       192.0.2.1 | DELETE   "/api/v1/backup/missing.tar.gz"
2026/01/24 13:19:03 Shutting down operation queue...
2026/01/24 13:19:03 Worker 1 stopped
2026/01/24 13:19:03 Worker 0 stopped
2026/01/24 13:19:03 Operation queue shut down gracefully
--- PASS: TestBackupEndpointsErrors (0.01s)
=== RUN   TestListAuthorsAndSeries_ReturnsEmptyArrayWhenNil
2026/01/24 13:19:03 Worker 0 started
2026/01/24 13:19:03 Worker 1 started
[GIN] 2026/01/24 - 13:19:03 | 200 |         150s |       192.0.2.1 | GET      "/api/v1/authors"
[GIN] 2026/01/24 - 13:19:03 | 200 |     159.209s |       192.0.2.1 | GET      "/api/v1/authors"
[GIN] 2026/01/24 - 13:19:03 | 200 |      25.875s |       192.0.2.1 | GET      "/api/v1/series"
[GIN] 2026/01/24 - 13:19:03 | 200 |          29s |       192.0.2.1 | GET      "/api/v1/series"
2026/01/24 13:19:03 Shutting down operation queue...
2026/01/24 13:19:03 Worker 0 stopped
2026/01/24 13:19:03 Worker 1 stopped
2026/01/24 13:19:03 Operation queue shut down gracefully
--- PASS: TestListAuthorsAndSeries_ReturnsEmptyArrayWhenNil (0.01s)
=== RUN   TestImportPaths_ListNilAndRemoveInvalidID
2026/01/24 13:19:03 Worker 0 started
2026/01/24 13:19:03 Worker 1 started
[GIN] 2026/01/24 - 13:19:03 | 200 |      44.667s |       192.0.2.1 | GET      "/api/v1/import-paths"
[GIN] 2026/01/24 - 13:19:03 | 200 |      53.709s |       192.0.2.1 | GET      "/api/v1/import-paths"
[GIN] 2026/01/24 - 13:19:03 | 400 |       2.625s |       192.0.2.1 | DELETE   "/api/v1/import-paths/not-an-int"
[GIN] 2026/01/24 - 13:19:03 | 400 |       5.667s |       192.0.2.1 | DELETE   "/api/v1/import-paths/not-an-int"
2026/01/24 13:19:03 Shutting down operation queue...
2026/01/24 13:19:03 Worker 1 stopped
2026/01/24 13:19:03 Worker 0 stopped
2026/01/24 13:19:03 Operation queue shut down gracefully
--- PASS: TestImportPaths_ListNilAndRemoveInvalidID (0.01s)
=== RUN   TestAddImportPath_EnqueuesAndExecutesOperationFunc
2026/01/24 13:19:03 Worker 0 started
2026/01/24 13:19:03 Worker 1 started
[GIN] 2026/01/24 - 13:19:03 | 201 |       310.5s |       192.0.2.1 | POST     "/api/v1/import-paths"
[GIN] 2026/01/24 - 13:19:03 | 201 |     318.083s |       192.0.2.1 | POST     "/api/v1/import-paths"
2026/01/24 13:19:03 Shutting down operation queue...
2026/01/24 13:19:03 Worker 1 stopped
2026/01/24 13:19:03 Worker 0 stopped
2026/01/24 13:19:03 Operation queue shut down gracefully
--- PASS: TestAddImportPath_EnqueuesAndExecutesOperationFunc (0.01s)
=== RUN   TestBlockedHashes_CRUD
2026/01/24 13:19:03 Worker 0 started
2026/01/24 13:19:03 Worker 1 started
[GIN] 2026/01/24 - 13:19:03 | 400 |       9.708s |       192.0.2.1 | POST     "/api/v1/blocked-hashes"
[GIN] 2026/01/24 - 13:19:03 | 400 |      16.542s |       192.0.2.1 | POST     "/api/v1/blocked-hashes"
[GIN] 2026/01/24 - 13:19:03 | 200 |      35.625s |       192.0.2.1 | GET      "/api/v1/blocked-hashes"
[GIN] 2026/01/24 - 13:19:03 | 200 |      39.666s |       192.0.2.1 | GET      "/api/v1/blocked-hashes"
[GIN] 2026/01/24 - 13:19:03 | 200 |       48.75s |       192.0.2.1 | DELETE   "/api/v1/blocked-hashes/0123456789abcdef0123456789abcdef0123456789abcdef0123456789abcdef"
[GIN] 2026/01/24 - 13:19:03 | 200 |      52.625s |       192.0.2.1 | DELETE   "/api/v1/blocked-hashes/0123456789abcdef0123456789abcdef0123456789abcdef0123456789abcdef"
2026/01/24 13:19:03 Shutting down operation queue...
2026/01/24 13:19:03 Worker 1 stopped
2026/01/24 13:19:03 Worker 0 stopped
2026/01/24 13:19:03 Operation queue shut down gracefully
--- PASS: TestBlockedHashes_CRUD (0.01s)
=== RUN   TestUpdateConfigEndpoint
2026/01/24 13:19:03 Worker 0 started
2026/01/24 13:19:03 Worker 1 started
2026/01/24 13:19:03 [DEBUG] updateConfig: Updating OpenAI API key (length: 10, last 4: ***-key)
2026/01/24 13:19:03 [DEBUG] updateConfig: Updating enable_ai_parsing to: true
2026/01/24 13:19:03 Saving configuration to database...
2026/01/24 13:19:03 [DEBUG] SaveConfigToDatabase: OpenAI key length: 10, EnableAIParsing: true
2026/01/24 13:19:03 [DEBUG] SaveConfigToDatabase: Saving OpenAI key (length: 10, secret: true)
2026/01/24 13:19:03 Warning: Failed to save setting openai_api_key: encryption failed: encryption key not initialized
2026/01/24 13:19:03 [DEBUG] SaveConfigToDatabase: Skipping empty secret: goodreads_api_key
2026/01/24 13:19:03 Saved 24 settings to database
2026/01/24 13:19:03 Configuration saved successfully. Updated fields: [root_dir playlist_dir openai_api_key enable_ai_parsing concurrent_scans language log_level]
[GIN] 2026/01/24 - 13:19:03 | 200 |   11.166916ms |       192.0.2.1 | PUT      "/api/v1/config"
[GIN] 2026/01/24 - 13:19:03 | 200 |   11.173542ms |       192.0.2.1 | PUT      "/api/v1/config"
[GIN] 2026/01/24 - 13:19:03 | 400 |       5.125s |       192.0.2.1 | PUT      "/api/v1/config"
[GIN] 2026/01/24 - 13:19:03 | 400 |       8.041s |       192.0.2.1 | PUT      "/api/v1/config"
2026/01/24 13:19:03 Shutting down operation queue...
2026/01/24 13:19:03 Worker 1 stopped
2026/01/24 13:19:03 Worker 0 stopped
2026/01/24 13:19:03 Operation queue shut down gracefully
--- PASS: TestUpdateConfigEndpoint (0.02s)
=== RUN   TestImportMetadataEndpoint
2026/01/24 13:19:03 Worker 0 started
2026/01/24 13:19:03 Worker 1 started
[GIN] 2026/01/24 - 13:19:03 | 400 |      12.584s |       192.0.2.1 | POST     "/api/v1/metadata/import"
[GIN] 2026/01/24 - 13:19:03 | 400 |      25.375s |       192.0.2.1 | POST     "/api/v1/metadata/import"
[GIN] 2026/01/24 - 13:19:03 | 206 |      24.958s |       192.0.2.1 | POST     "/api/v1/metadata/import"
[GIN] 2026/01/24 - 13:19:03 | 206 |        30.5s |       192.0.2.1 | POST     "/api/v1/metadata/import"
[GIN] 2026/01/24 - 13:19:03 | 200 |     614.708s |       192.0.2.1 | POST     "/api/v1/metadata/import"
[GIN] 2026/01/24 - 13:19:03 | 200 |     626.375s |       192.0.2.1 | POST     "/api/v1/metadata/import"
2026/01/24 13:19:03 Shutting down operation queue...
2026/01/24 13:19:03 Worker 1 stopped
2026/01/24 13:19:03 Worker 0 stopped
2026/01/24 13:19:03 Operation queue shut down gracefully
--- PASS: TestImportMetadataEndpoint (0.01s)
=== RUN   TestSearchAndFetchMetadata
2026/01/24 13:19:03 Worker 0 started
2026/01/24 13:19:03 Worker 1 started
[GIN] 2026/01/24 - 13:19:03 | 400 |       12.25s |       192.0.2.1 | GET      "/api/v1/metadata/search"
[GIN] 2026/01/24 - 13:19:03 | 400 |      22.541s |       192.0.2.1 | GET      "/api/v1/metadata/search"
[GIN] 2026/01/24 - 13:19:03 | 200 |     456.833s |       192.0.2.1 | GET      "/api/v1/metadata/search?title=Test"
[GIN] 2026/01/24 - 13:19:03 | 200 |     463.167s |       192.0.2.1 | GET      "/api/v1/metadata/search?title=Test"
[GIN] 2026/01/24 - 13:19:03 | 200 |    3.343166ms |       192.0.2.1 | POST     "/api/v1/audiobooks/01KFRKP8XSRG2GQDVYGPQ5K7Q5/fetch-metadata"
[GIN] 2026/01/24 - 13:19:03 | 200 |    3.354625ms |       192.0.2.1 | POST     "/api/v1/audiobooks/01KFRKP8XSRG2GQDVYGPQ5K7Q5/fetch-metadata"
2026/01/24 13:19:03 Shutting down operation queue...
2026/01/24 13:19:03 Worker 1 stopped
2026/01/24 13:19:03 Worker 0 stopped
2026/01/24 13:19:03 Operation queue shut down gracefully
--- PASS: TestSearchAndFetchMetadata (0.02s)
=== RUN   TestImportFileEndpoint
2026/01/24 13:19:03 Worker 0 started
2026/01/24 13:19:03 Worker 1 started
2026/01/24 13:19:03 [DEBUG] metadata: extracting tags for /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestImportFileEndpoint2396093331/001/test_sample.m4b
2026/01/24 13:19:03 [TRACE] metadata: raw tag keys for /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestImportFileEndpoint2396093331/001/test_sample.m4b: [too]
2026/01/24 13:19:03 [TRACE] metadata: filename fallback filled gaps for /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestImportFileEndpoint2396093331/001/test_sample.m4b
2026/01/24 13:19:03 [TRACE] metadata: sources for /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestImportFileEndpoint2396093331/001/test_sample.m4b | title=filename default (basename) | author=unset | series=title fallback | series_index= | narrator=unset | album=unset | publisher=unset | language=unset
2026/01/24 13:19:03 [DEBUG] metadata: extracted for /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestImportFileEndpoint2396093331/001/test_sample.m4b (title="test_sample" author="" series="test_sample" position=0)
2026/01/24 13:19:03 Operation 01KFRKP8YA47FA82X5QWWS1E4M enqueued with priority 1
2026/01/24 13:19:03 Worker 0 processing operation 01KFRKP8YA47FA82X5QWWS1E4M
[GIN] 2026/01/24 - 13:19:03 | 201 |    1.263083ms |       192.0.2.1 | POST     "/api/v1/import/file"
[GIN] 2026/01/24 - 13:19:03 | 201 |    1.272334ms |       192.0.2.1 | POST     "/api/v1/import/file"
2026/01/24 13:19:03 Operation 01KFRKP8YA47FA82X5QWWS1E4M completed successfully
2026/01/24 13:19:03 Shutting down operation queue...
2026/01/24 13:19:03 Worker 0 stopped
2026/01/24 13:19:03 Worker 1 stopped
2026/01/24 13:19:03 Operation queue shut down gracefully
--- PASS: TestImportFileEndpoint (0.02s)
=== RUN   TestAddImportPathAutoScan
2026/01/24 13:19:03 Worker 0 started
2026/01/24 13:19:03 Worker 1 started
2026/01/24 13:19:03 Operation 01KFRKP8YT98MXM725P5ZZ3JDB enqueued with priority 1
2026/01/24 13:19:03 Worker 0 processing operation 01KFRKP8YT98MXM725P5ZZ3JDB
[GIN] 2026/01/24 - 13:19:03 | 201 |    1.019334ms |       192.0.2.1 | POST     "/api/v1/import-paths"
[GIN] 2026/01/24 - 13:19:03 | 201 |    1.028667ms |       192.0.2.1 | POST     "/api/v1/import-paths"
Scanning for audiobook files (using 1 workers)...
Processing audiobook metadata (using 1 workers)...
   0% |                                                | (0/1, 0 it/hr) [0s:0s]2026/01/24 13:19:03 [DEBUG] metadata: extracting tags for /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestAddImportPathAutoScan1223566281/001/test_sample.m4b
2026/01/24 13:19:03 [TRACE] metadata: raw tag keys for /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestAddImportPathAutoScan1223566281/001/test_sample.m4b: [too]
2026/01/24 13:19:03 [TRACE] metadata: filename fallback filled gaps for /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestAddImportPathAutoScan1223566281/001/test_sample.m4b
2026/01/24 13:19:03 [TRACE] metadata: sources for /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestAddImportPathAutoScan1223566281/001/test_sample.m4b | title=filename default (basename) | author=unset | series=title fallback | series_index= | narrator=unset | album=unset | publisher=unset | language=unset
2026/01/24 13:19:03 [DEBUG] metadata: extracted for /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestAddImportPathAutoScan1223566281/001/test_sample.m4b (title="test_sample" author="" series="test_sample" position=0)
2026/01/24 13:19:03 Warning: failed to check hash blocklist: no such table: do_not_import
                                                                                100% || (1/1, 510 it/s)
2026/01/24 13:19:03 Operation 01KFRKP8YT98MXM725P5ZZ3JDB completed successfully
[GIN] 2026/01/24 - 13:19:03 | 201 |    1.210791ms |       192.0.2.1 | POST     "/api/v1/import-paths"
[GIN] 2026/01/24 - 13:19:03 | 201 |    1.229417ms |       192.0.2.1 | POST     "/api/v1/import-paths"
2026/01/24 13:19:03 Shutting down operation queue...
2026/01/24 13:19:03 Worker 0 stopped
2026/01/24 13:19:03 Worker 1 stopped
2026/01/24 13:19:03 Operation queue shut down gracefully
--- PASS: TestAddImportPathAutoScan (0.07s)
=== RUN   TestAddImportPathFallbackScan
2026/01/24 13:19:03 Worker 0 started
2026/01/24 13:19:03 Worker 1 started
Scanning for audiobook files (using 1 workers)...
Processing audiobook metadata (using 1 workers)...
   0% |                                                | (0/1, 0 it/hr) [0s:0s]2026/01/24 13:19:03 [DEBUG] metadata: extracting tags for /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestAddImportPathFallbackScan1540116230/001/test_sample.m4b
2026/01/24 13:19:03 [TRACE] metadata: raw tag keys for /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestAddImportPathFallbackScan1540116230/001/test_sample.m4b: [too]
2026/01/24 13:19:03 [TRACE] metadata: filename fallback filled gaps for /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestAddImportPathFallbackScan1540116230/001/test_sample.m4b
2026/01/24 13:19:03 [TRACE] metadata: sources for /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestAddImportPathFallbackScan1540116230/001/test_sample.m4b | title=filename default (basename) | author=unset | series=title fallback | series_index= | narrator=unset | album=unset | publisher=unset | language=unset
2026/01/24 13:19:03 [DEBUG] metadata: extracted for /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestAddImportPathFallbackScan1540116230/001/test_sample.m4b (title="test_sample" author="" series="test_sample" position=0)
2026/01/24 13:19:03 Warning: failed to check hash blocklist: no such table: do_not_import
                                                                                100% || (1/1, 624 it/s)
2026/01/24 13:19:03 auto-organize enabled but root_dir not set
[GIN] 2026/01/24 - 13:19:03 | 201 |    2.536333ms |       192.0.2.1 | POST     "/api/v1/import-paths"
[GIN] 2026/01/24 - 13:19:03 | 201 |       2.545ms |       192.0.2.1 | POST     "/api/v1/import-paths"
2026/01/24 13:19:03 Shutting down operation queue...
2026/01/24 13:19:03 Worker 1 stopped
2026/01/24 13:19:03 Worker 0 stopped
2026/01/24 13:19:03 Operation queue shut down gracefully
--- PASS: TestAddImportPathFallbackScan (0.02s)
=== RUN   TestServerStartGracefulShutdown
2026/01/24 13:19:03 Worker 0 started
2026/01/24 13:19:03 Worker 1 started
2026/01/24 13:19:03 Starting server on 127.0.0.1:0
2026/01/24 13:19:08 [DEBUG] Heartbeat: Got 1 import paths
2026/01/24 13:19:09 Shutting down server...
2026/01/24 13:19:10 Server exited
2026/01/24 13:19:10 Shutting down operation queue...
2026/01/24 13:19:10 Worker 0 stopped
2026/01/24 13:19:10 Worker 1 stopped
2026/01/24 13:19:10 Operation queue shut down gracefully
--- PASS: TestServerStartGracefulShutdown (6.52s)
=== RUN   TestWorkEndpointErrors
2026/01/24 13:19:10 Worker 0 started
2026/01/24 13:19:10 Worker 1 started
[GIN] 2026/01/24 - 13:19:10 | 400 |       43.75s |       192.0.2.1 | POST     "/api/v1/works"
[GIN] 2026/01/24 - 13:19:10 | 400 |      68.375s |       192.0.2.1 | POST     "/api/v1/works"
[GIN] 2026/01/24 - 13:19:10 | 400 |       6.583s |       192.0.2.1 | PUT      "/api/v1/works/missing"
[GIN] 2026/01/24 - 13:19:10 | 400 |      11.208s |       192.0.2.1 | PUT      "/api/v1/works/missing"
[GIN] 2026/01/24 - 13:19:10 | 404 |      38.916s |       192.0.2.1 | GET      "/api/v1/works/missing"
[GIN] 2026/01/24 - 13:19:10 | 404 |        45.5s |       192.0.2.1 | GET      "/api/v1/works/missing"
[GIN] 2026/01/24 - 13:19:10 | 404 |      29.708s |       192.0.2.1 | DELETE   "/api/v1/works/missing"
[GIN] 2026/01/24 - 13:19:10 | 404 |      35.708s |       192.0.2.1 | DELETE   "/api/v1/works/missing"
2026/01/24 13:19:10 Shutting down operation queue...
2026/01/24 13:19:10 Worker 1 stopped
2026/01/24 13:19:10 Worker 0 stopped
2026/01/24 13:19:10 Operation queue shut down gracefully
--- PASS: TestWorkEndpointErrors (0.02s)
=== RUN   TestGetOperationLogsEndpoint
2026/01/24 13:19:10 Worker 0 started
2026/01/24 13:19:10 Worker 1 started
[GIN] 2026/01/24 - 13:19:10 | 200 |        70.5s |       192.0.2.1 | GET      "/api/v1/operations/op-logs/logs?tail=1"
[GIN] 2026/01/24 - 13:19:10 | 200 |      83.375s |       192.0.2.1 | GET      "/api/v1/operations/op-logs/logs?tail=1"
2026/01/24 13:19:10 Shutting down operation queue...
2026/01/24 13:19:10 Worker 1 stopped
2026/01/24 13:19:10 Worker 0 stopped
2026/01/24 13:19:10 Operation queue shut down gracefully
--- PASS: TestGetOperationLogsEndpoint (0.02s)
=== RUN   TestGetAudiobookAndDashboard
2026/01/24 13:19:10 Worker 0 started
2026/01/24 13:19:10 Worker 1 started
2026/01/24 13:19:10 [DEBUG] metadata: extracting tags for /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestGetAudiobookAndDashboard4160455490/001/test_sample.m4b
2026/01/24 13:19:10 [TRACE] metadata: raw tag keys for /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestGetAudiobookAndDashboard4160455490/001/test_sample.m4b: [too]
2026/01/24 13:19:10 [TRACE] metadata: filename fallback filled gaps for /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestGetAudiobookAndDashboard4160455490/001/test_sample.m4b
2026/01/24 13:19:10 [TRACE] metadata: sources for /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestGetAudiobookAndDashboard4160455490/001/test_sample.m4b | title=filename default (basename) | author=unset | series=title fallback | series_index= | narrator=unset | album=unset | publisher=unset | language=unset
2026/01/24 13:19:10 [DEBUG] metadata: extracted for /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestGetAudiobookAndDashboard4160455490/001/test_sample.m4b (title="test_sample" author="" series="test_sample" position=0)
[GIN] 2026/01/24 - 13:19:10 | 200 |     300.208s |       192.0.2.1 | GET      "/api/v1/audiobooks/01KFRKPFED9V2MWGVRJ297V2Q7"
[GIN] 2026/01/24 - 13:19:10 | 200 |     310.917s |       192.0.2.1 | GET      "/api/v1/audiobooks/01KFRKPFED9V2MWGVRJ297V2Q7"
[GIN] 2026/01/24 - 13:19:10 | 200 |     128.958s |       192.0.2.1 | GET      "/api/v1/dashboard"
[GIN] 2026/01/24 - 13:19:10 | 200 |     134.083s |       192.0.2.1 | GET      "/api/v1/dashboard"
2026/01/24 13:19:10 Shutting down operation queue...
2026/01/24 13:19:10 Worker 1 stopped
2026/01/24 13:19:10 Worker 0 stopped
2026/01/24 13:19:10 Operation queue shut down gracefully
--- PASS: TestGetAudiobookAndDashboard (0.02s)
=== RUN   TestExportMetadataEndpoint
2026/01/24 13:19:10 Worker 0 started
2026/01/24 13:19:10 Worker 1 started
[GIN] 2026/01/24 - 13:19:10 | 200 |     106.375s |       192.0.2.1 | GET      "/api/v1/metadata/export"
[GIN] 2026/01/24 - 13:19:10 | 200 |     118.459s |       192.0.2.1 | GET      "/api/v1/metadata/export"
2026/01/24 13:19:10 Shutting down operation queue...
2026/01/24 13:19:10 Worker 0 stopped
2026/01/24 13:19:10 Worker 1 stopped
2026/01/24 13:19:10 Operation queue shut down gracefully
--- PASS: TestExportMetadataEndpoint (0.01s)
=== RUN   TestParseAudiobookWithAIEndpoint
2026/01/24 13:19:10 Worker 1 started
2026/01/24 13:19:10 Worker 0 started
[GIN] 2026/01/24 - 13:19:10 | 400 |      63.833s |       192.0.2.1 | POST     "/api/v1/audiobooks/01KFRKPFF810EYTRDF1QT7KAJD/parse-with-ai"
[GIN] 2026/01/24 - 13:19:10 | 400 |      76.208s |       192.0.2.1 | POST     "/api/v1/audiobooks/01KFRKPFF810EYTRDF1QT7KAJD/parse-with-ai"
2026/01/24 13:19:10 Shutting down operation queue...
2026/01/24 13:19:10 Worker 0 stopped
2026/01/24 13:19:10 Worker 1 stopped
2026/01/24 13:19:10 Operation queue shut down gracefully
--- PASS: TestParseAudiobookWithAIEndpoint (0.01s)
=== RUN   TestUpdateDeleteBatchAudiobook
2026/01/24 13:19:10 Worker 0 started
2026/01/24 13:19:10 Worker 1 started
[GIN] 2026/01/24 - 13:19:10 | 200 |    3.411208ms |       192.0.2.1 | PUT      "/api/v1/audiobooks/01KFRKPFFMHRVWKQK9AS5KKV8Z"
[GIN] 2026/01/24 - 13:19:10 | 200 |    3.422333ms |       192.0.2.1 | PUT      "/api/v1/audiobooks/01KFRKPFFMHRVWKQK9AS5KKV8Z"
[GIN] 2026/01/24 - 13:19:10 | 200 |     426.583s |       192.0.2.1 | POST     "/api/v1/audiobooks/batch"
[GIN] 2026/01/24 - 13:19:10 | 200 |     430.833s |       192.0.2.1 | POST     "/api/v1/audiobooks/batch"
2026/01/24 13:19:10 Warning: failed to block hash during soft delete: no such table: do_not_import
[GIN] 2026/01/24 - 13:19:10 | 200 |     447.792s |       192.0.2.1 | DELETE   "/api/v1/audiobooks/01KFRKPFFMHRVWKQK9AS5KKV8Z?soft_delete=true&block_hash=true"
[GIN] 2026/01/24 - 13:19:10 | 200 |       452.5s |       192.0.2.1 | DELETE   "/api/v1/audiobooks/01KFRKPFFMHRVWKQK9AS5KKV8Z?soft_delete=true&block_hash=true"
2026/01/24 13:19:10 Warning: failed to block hash before delete: no such table: do_not_import
[GIN] 2026/01/24 - 13:19:10 | 200 |     455.208s |       192.0.2.1 | DELETE   "/api/v1/audiobooks/01KFRKPFFSATTNSPEMT0AX8AQ7?block_hash=true"
[GIN] 2026/01/24 - 13:19:10 | 200 |     459.125s |       192.0.2.1 | DELETE   "/api/v1/audiobooks/01KFRKPFFSATTNSPEMT0AX8AQ7?block_hash=true"
2026/01/24 13:19:10 Shutting down operation queue...
2026/01/24 13:19:10 Worker 1 stopped
2026/01/24 13:19:10 Worker 0 stopped
2026/01/24 13:19:10 Operation queue shut down gracefully
--- PASS: TestUpdateDeleteBatchAudiobook (0.02s)
=== RUN   TestStartScanOperation
2026/01/24 13:19:10 Worker 0 started
2026/01/24 13:19:10 Worker 1 started
2026/01/24 13:19:10 [DEBUG] startScan: Force update enabled - will update all book file paths in database
2026/01/24 13:19:10 Operation 01KFRKPFG5EC2N09QZZS0NXQB7 enqueued with priority 1
2026/01/24 13:19:10 Worker 0 processing operation 01KFRKPFG5EC2N09QZZS0NXQB7
[GIN] 2026/01/24 - 13:19:10 | 202 |     675.625s |       192.0.2.1 | POST     "/api/v1/operations/scan"
[GIN] 2026/01/24 - 13:19:10 | 202 |      682.75s |       192.0.2.1 | POST     "/api/v1/operations/scan"
Scanning for audiobook files (using 1 workers)...
Processing audiobook metadata (using 1 workers)...
   0% |                                                | (0/1, 0 it/hr) [0s:0s]2026/01/24 13:19:10 [DEBUG] metadata: extracting tags for /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestStartScanOperation4292572524/001/test_sample.m4b
2026/01/24 13:19:10 [TRACE] metadata: raw tag keys for /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestStartScanOperation4292572524/001/test_sample.m4b: [too]
2026/01/24 13:19:10 [TRACE] metadata: filename fallback filled gaps for /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestStartScanOperation4292572524/001/test_sample.m4b
2026/01/24 13:19:10 [TRACE] metadata: sources for /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestStartScanOperation4292572524/001/test_sample.m4b | title=filename default (basename) | author=unset | series=title fallback | series_index= | narrator=unset | album=unset | publisher=unset | language=unset
2026/01/24 13:19:10 [DEBUG] metadata: extracted for /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestStartScanOperation4292572524/001/test_sample.m4b (title="test_sample" author="" series="test_sample" position=0)
2026/01/24 13:19:10 Warning: failed to check hash blocklist: no such table: do_not_import
                                                                                100% || (1/1, 624 it/s)
Scanning for audiobook files (using 1 workers)...
Processing audiobook metadata (using 1 workers)...
   0% |                                                | (0/1, 0 it/hr) [0s:0s]2026/01/24 13:19:10 [DEBUG] metadata: extracting tags for /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestStartScanOperation4292572524/002/test_sample.m4b
2026/01/24 13:19:10 [TRACE] metadata: raw tag keys for /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestStartScanOperation4292572524/002/test_sample.m4b: [too]
2026/01/24 13:19:10 [TRACE] metadata: filename fallback filled gaps for /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestStartScanOperation4292572524/002/test_sample.m4b
2026/01/24 13:19:10 [TRACE] metadata: sources for /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestStartScanOperation4292572524/002/test_sample.m4b | title=filename default (basename) | author=unset | series=title fallback | series_index= | narrator=unset | album=unset | publisher=unset | language=unset
2026/01/24 13:19:10 [DEBUG] metadata: extracted for /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestStartScanOperation4292572524/002/test_sample.m4b (title="test_sample" author="" series="test_sample" position=0)
2026/01/24 13:19:10 Warning: failed to check hash blocklist: no such table: do_not_import
2026/01/24 13:19:10 [DEBUG] Found duplicate book by hash: test_sample (existing: /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestStartScanOperation4292572524/001/test_sample.m4b, new: /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestStartScanOperation4292572524/002/test_sample.m4b)
2026/01/24 13:19:10 [DEBUG] Skipping duplicate: keeping existing path /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestStartScanOperation4292572524/001/test_sample.m4b
                                                                                100% || (1/1, 3452 it/s)
2026/01/24 13:19:10 Operation 01KFRKPFG5EC2N09QZZS0NXQB7 completed successfully
2026/01/24 13:19:10 Shutting down operation queue...
2026/01/24 13:19:10 Worker 1 stopped
2026/01/24 13:19:10 Worker 0 stopped
2026/01/24 13:19:10 Operation queue shut down gracefully
--- PASS: TestStartScanOperation (0.07s)
=== RUN   TestStartOrganizeOperation
2026/01/24 13:19:10 Worker 0 started
2026/01/24 13:19:10 Worker 1 started
2026/01/24 13:19:10 Operation 01KFRKPFJAHR7MMBVAWKVF7CEF enqueued with priority 1
2026/01/24 13:19:10 Worker 0 processing operation 01KFRKPFJAHR7MMBVAWKVF7CEF
[GIN] 2026/01/24 - 13:19:10 | 202 |     626.583s |       192.0.2.1 | POST     "/api/v1/operations/organize"
[GIN] 2026/01/24 - 13:19:10 | 202 |     634.958s |       192.0.2.1 | POST     "/api/v1/operations/organize"
2026/01/24 13:19:10 [DEBUG] Organize: Fetched 1 total books from database
2026/01/24 13:19:10 [DEBUG] Organize: Found 1 books that need organizing (out of 1 total)
2026/01/24 13:19:10 Operation 01KFRKPFJQN9N1M39KK8AS9CKX enqueued with priority 0
2026/01/24 13:19:10 Worker 1 processing operation 01KFRKPFJQN9N1M39KK8AS9CKX
2026/01/24 13:19:10 Operation 01KFRKPFJAHR7MMBVAWKVF7CEF completed successfully
Scanning for audiobook files (using 1 workers)...
Processing audiobook metadata (using 1 workers)...
   0% |                                                | (0/1, 0 it/hr) [0s:0s]2026/01/24 13:19:10 [DEBUG] metadata: extracting tags for /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestStartOrganizeOperation60891882/001/Organize Me/Organize Me.m4b
2026/01/24 13:19:10 [TRACE] metadata: raw tag keys for /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestStartOrganizeOperation60891882/001/Organize Me/Organize Me.m4b: [too]
2026/01/24 13:19:10 [TRACE] metadata: filename fallback filled gaps for /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestStartOrganizeOperation60891882/001/Organize Me/Organize Me.m4b
2026/01/24 13:19:10 [TRACE] metadata: sources for /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestStartOrganizeOperation60891882/001/Organize Me/Organize Me.m4b | title=filename default (basename) | author=filename pattern | series=title fallback | series_index= | narrator=unset | album=unset | publisher=unset | language=unset
2026/01/24 13:19:10 [DEBUG] metadata: extracted for /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestStartOrganizeOperation60891882/001/Organize Me/Organize Me.m4b (title="Organize Me" author="Organize Me" series="Organize Me" position=0)
2026/01/24 13:19:10 Warning: failed to check hash blocklist: no such table: do_not_import
                                                                                100% || (1/1, 608 it/s)
2026/01/24 13:19:10 Operation 01KFRKPFJQN9N1M39KK8AS9CKX completed successfully
2026/01/24 13:19:10 Shutting down operation queue...
2026/01/24 13:19:10 Worker 1 stopped
2026/01/24 13:19:10 Worker 0 stopped
2026/01/24 13:19:10 Operation queue shut down gracefully
--- PASS: TestStartOrganizeOperation (0.07s)
=== RUN   TestListActiveOperations
2026/01/24 13:19:10 Worker 0 started
2026/01/24 13:19:10 Worker 1 started
2026/01/24 13:19:10 Operation op-block enqueued with priority 1
2026/01/24 13:19:10 Worker 0 processing operation op-block
[GIN] 2026/01/24 - 13:19:10 | 200 |     175.333s |       192.0.2.1 | GET      "/api/v1/operations/active"
[GIN] 2026/01/24 - 13:19:10 | 200 |     199.917s |       192.0.2.1 | GET      "/api/v1/operations/active"
2026/01/24 13:19:10 Operation op-block completed successfully
2026/01/24 13:19:10 Shutting down operation queue...
2026/01/24 13:19:10 Worker 0 stopped
2026/01/24 13:19:10 Worker 1 stopped
2026/01/24 13:19:10 Operation queue shut down gracefully
--- PASS: TestListActiveOperations (0.17s)
=== RUN   TestRunAutoPurgeSoftDeleted
2026/01/24 13:19:10 Worker 0 started
2026/01/24 13:19:10 Worker 1 started
2026/01/24 13:19:10 [INFO] Auto-purge soft-deleted books: attempted=1 purged=1 files_deleted=1 errors=0
2026/01/24 13:19:10 Shutting down operation queue...
2026/01/24 13:19:10 Worker 1 stopped
2026/01/24 13:19:10 Worker 0 stopped
2026/01/24 13:19:10 Operation queue shut down gracefully
--- PASS: TestRunAutoPurgeSoftDeleted (0.02s)
=== RUN   TestSoftDeleteAndPurge_WithFileDeletion
2026/01/24 13:19:10 Worker 0 started
2026/01/24 13:19:10 Worker 1 started
[GIN] 2026/01/24 - 13:19:10 | 200 |     512.166s |       192.0.2.1 | DELETE   "/api/v1/audiobooks/01KFRKPFT87PG4GP84C5KK2NMF?soft_delete=true"
[GIN] 2026/01/24 - 13:19:10 | 200 |       524.5s |       192.0.2.1 | DELETE   "/api/v1/audiobooks/01KFRKPFT87PG4GP84C5KK2NMF?soft_delete=true"
[GIN] 2026/01/24 - 13:19:10 | 200 |     636.709s |       192.0.2.1 | DELETE   "/api/v1/audiobooks/purge-soft-deleted?delete_files=true"
[GIN] 2026/01/24 - 13:19:10 | 200 |     645.292s |       192.0.2.1 | DELETE   "/api/v1/audiobooks/purge-soft-deleted?delete_files=true"
2026/01/24 13:19:10 Shutting down operation queue...
2026/01/24 13:19:10 Worker 1 stopped
2026/01/24 13:19:10 Worker 0 stopped
2026/01/24 13:19:10 Operation queue shut down gracefully
--- PASS: TestSoftDeleteAndPurge_WithFileDeletion (0.02s)
=== RUN   TestRunAutoPurgeSoftDeleted_DeletesOldEntries
2026/01/24 13:19:10 Worker 0 started
2026/01/24 13:19:10 Worker 1 started
2026/01/24 13:19:10 [INFO] Auto-purge soft-deleted books: attempted=1 purged=1 files_deleted=1 errors=0
2026/01/24 13:19:10 Shutting down operation queue...
2026/01/24 13:19:10 Worker 0 stopped
2026/01/24 13:19:10 Worker 1 stopped
2026/01/24 13:19:10 Operation queue shut down gracefully
--- PASS: TestRunAutoPurgeSoftDeleted_DeletesOldEntries (0.02s)
=== RUN   TestHealthCheck
2026/01/24 13:19:10 Worker 0 started
2026/01/24 13:19:10 Worker 1 started
[GIN] 2026/01/24 - 13:19:10 | 200 |      82.833s |       192.0.2.1 | GET      "/api/health"
[GIN] 2026/01/24 - 13:19:10 | 200 |      95.625s |       192.0.2.1 | GET      "/api/health"
[GIN] 2026/01/24 - 13:19:10 | 200 |      49.334s |       192.0.2.1 | GET      "/api/v1/health"
[GIN] 2026/01/24 - 13:19:10 | 200 |      54.292s |       192.0.2.1 | GET      "/api/v1/health"
2026/01/24 13:19:10 Shutting down operation queue...
2026/01/24 13:19:10 Worker 1 stopped
2026/01/24 13:19:10 Worker 0 stopped
2026/01/24 13:19:10 Operation queue shut down gracefully
--- PASS: TestHealthCheck (0.02s)
=== RUN   TestListAudiobooks
2026/01/24 13:19:10 Worker 0 started
2026/01/24 13:19:10 Worker 1 started
=== RUN   TestListAudiobooks/list_all_audiobooks_without_params
[GIN] 2026/01/24 - 13:19:10 | 200 |      102.25s |       192.0.2.1 | GET      "/api/v1/audiobooks"
[GIN] 2026/01/24 - 13:19:10 | 200 |     113.625s |       192.0.2.1 | GET      "/api/v1/audiobooks"
=== RUN   TestListAudiobooks/list_with_limit_and_offset
[GIN] 2026/01/24 - 13:19:10 | 200 |      56.834s |       192.0.2.1 | GET      "/api/v1/audiobooks?limit=10&offset=0"
[GIN] 2026/01/24 - 13:19:10 | 200 |          61s |       192.0.2.1 | GET      "/api/v1/audiobooks?limit=10&offset=0"
=== RUN   TestListAudiobooks/list_with_search_query
[GIN] 2026/01/24 - 13:19:10 | 200 |      97.083s |       192.0.2.1 | GET      "/api/v1/audiobooks?search=test"
[GIN] 2026/01/24 - 13:19:10 | 200 |     101.167s |       192.0.2.1 | GET      "/api/v1/audiobooks?search=test"
2026/01/24 13:19:10 Shutting down operation queue...
2026/01/24 13:19:10 Worker 1 stopped
2026/01/24 13:19:10 Worker 0 stopped
2026/01/24 13:19:10 Operation queue shut down gracefully
--- PASS: TestListAudiobooks (0.01s)
    --- PASS: TestListAudiobooks/list_all_audiobooks_without_params (0.00s)
    --- PASS: TestListAudiobooks/list_with_limit_and_offset (0.00s)
    --- PASS: TestListAudiobooks/list_with_search_query (0.00s)
=== RUN   TestGetAudiobook
2026/01/24 13:19:10 Worker 0 started
2026/01/24 13:19:10 Worker 1 started
[GIN] 2026/01/24 - 13:19:10 | 404 |      51.625s |       192.0.2.1 | GET      "/api/v1/audiobooks/01HXZ123456789ABCDEFGHJ"
[GIN] 2026/01/24 - 13:19:10 | 404 |      63.333s |       192.0.2.1 | GET      "/api/v1/audiobooks/01HXZ123456789ABCDEFGHJ"
2026/01/24 13:19:10 Shutting down operation queue...
2026/01/24 13:19:10 Worker 1 stopped
2026/01/24 13:19:10 Worker 0 stopped
2026/01/24 13:19:10 Operation queue shut down gracefully
--- PASS: TestGetAudiobook (0.01s)
=== RUN   TestUpdateAudiobook
2026/01/24 13:19:10 Worker 0 started
2026/01/24 13:19:10 Worker 1 started
[GIN] 2026/01/24 - 13:19:10 | 404 |       42.75s |       192.0.2.1 | PUT      "/api/v1/audiobooks/01HXZ123456789ABCDEFGHJ"
[GIN] 2026/01/24 - 13:19:10 | 404 |        53.5s |       192.0.2.1 | PUT      "/api/v1/audiobooks/01HXZ123456789ABCDEFGHJ"
2026/01/24 13:19:10 Shutting down operation queue...
2026/01/24 13:19:10 Worker 1 stopped
2026/01/24 13:19:10 Worker 0 stopped
2026/01/24 13:19:10 Operation queue shut down gracefully
--- PASS: TestUpdateAudiobook (0.01s)
=== RUN   TestGetAudiobookTagsReportsEffectiveSourceSimple
2026/01/24 13:19:10 Worker 0 started
2026/01/24 13:19:10 Worker 1 started
2026/01/24 13:19:10 [DEBUG] metadata: extracting tags for /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestGetAudiobookTagsReportsEffectiveSourceSimple365869759/001/book.m4b
2026/01/24 13:19:10 [WARN] metadata: failed to read tags for /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestGetAudiobookTagsReportsEffectiveSourceSimple365869759/001/book.m4b: unexpected EOF; falling back to filename parsing
[GIN] 2026/01/24 - 13:19:10 | 200 |     179.625s |       192.0.2.1 | GET      "/api/v1/audiobooks/01KFRKPFX2STMNRK2EEWD8VF2C/tags"
[GIN] 2026/01/24 - 13:19:10 | 200 |         185s |       192.0.2.1 | GET      "/api/v1/audiobooks/01KFRKPFX2STMNRK2EEWD8VF2C/tags"
2026/01/24 13:19:10 Shutting down operation queue...
2026/01/24 13:19:10 Worker 1 stopped
2026/01/24 13:19:10 Worker 0 stopped
2026/01/24 13:19:10 Operation queue shut down gracefully
--- PASS: TestGetAudiobookTagsReportsEffectiveSourceSimple (0.01s)
=== RUN   TestUpdateAudiobookOverridesPersist
2026/01/24 13:19:10 Worker 0 started
2026/01/24 13:19:10 Worker 1 started
[GIN] 2026/01/24 - 13:19:10 | 200 |    1.097792ms |       192.0.2.1 | PUT      "/api/v1/audiobooks/01KFRKPFXE4040BC5TVZ9NEQ43"
[GIN] 2026/01/24 - 13:19:10 | 200 |    1.107208ms |       192.0.2.1 | PUT      "/api/v1/audiobooks/01KFRKPFXE4040BC5TVZ9NEQ43"
2026/01/24 13:19:10 Shutting down operation queue...
2026/01/24 13:19:10 Worker 1 stopped
2026/01/24 13:19:10 Worker 0 stopped
2026/01/24 13:19:10 Operation queue shut down gracefully
--- PASS: TestUpdateAudiobookOverridesPersist (0.01s)
=== RUN   TestDeleteAudiobook
2026/01/24 13:19:10 Worker 0 started
2026/01/24 13:19:10 Worker 1 started
[GIN] 2026/01/24 - 13:19:10 | 404 |          53s |       192.0.2.1 | DELETE   "/api/v1/audiobooks/01HXZ123456789ABCDEFGHJ"
[GIN] 2026/01/24 - 13:19:10 | 404 |      59.042s |       192.0.2.1 | DELETE   "/api/v1/audiobooks/01HXZ123456789ABCDEFGHJ"
2026/01/24 13:19:10 Shutting down operation queue...
2026/01/24 13:19:10 Worker 1 stopped
2026/01/24 13:19:10 Worker 0 stopped
2026/01/24 13:19:10 Operation queue shut down gracefully
--- PASS: TestDeleteAudiobook (0.01s)
=== RUN   TestBatchUpdateAudiobooks
2026/01/24 13:19:10 Worker 0 started
2026/01/24 13:19:10 Worker 1 started
[GIN] 2026/01/24 - 13:19:10 | 200 |      10.333s |       192.0.2.1 | POST     "/api/v1/audiobooks/batch"
[GIN] 2026/01/24 - 13:19:10 | 200 |      16.042s |       192.0.2.1 | POST     "/api/v1/audiobooks/batch"
2026/01/24 13:19:10 Shutting down operation queue...
2026/01/24 13:19:10 Worker 1 stopped
2026/01/24 13:19:10 Worker 0 stopped
2026/01/24 13:19:10 Operation queue shut down gracefully
--- PASS: TestBatchUpdateAudiobooks (0.01s)
=== RUN   TestListAuthors
2026/01/24 13:19:10 Worker 0 started
2026/01/24 13:19:10 Worker 1 started
[GIN] 2026/01/24 - 13:19:10 | 200 |      19.792s |       192.0.2.1 | GET      "/api/v1/authors"
[GIN] 2026/01/24 - 13:19:10 | 200 |        25.5s |       192.0.2.1 | GET      "/api/v1/authors"
2026/01/24 13:19:10 Shutting down operation queue...
2026/01/24 13:19:10 Worker 0 stopped
2026/01/24 13:19:10 Worker 1 stopped
2026/01/24 13:19:10 Operation queue shut down gracefully
--- PASS: TestListAuthors (0.01s)
=== RUN   TestListSeries
2026/01/24 13:19:10 Worker 0 started
2026/01/24 13:19:10 Worker 1 started
[GIN] 2026/01/24 - 13:19:10 | 200 |      18.583s |       192.0.2.1 | GET      "/api/v1/series"
[GIN] 2026/01/24 - 13:19:10 | 200 |      23.416s |       192.0.2.1 | GET      "/api/v1/series"
2026/01/24 13:19:10 Shutting down operation queue...
2026/01/24 13:19:10 Worker 1 stopped
2026/01/24 13:19:10 Worker 0 stopped
2026/01/24 13:19:10 Operation queue shut down gracefully
--- PASS: TestListSeries (0.01s)
=== RUN   TestBrowseFilesystem
2026/01/24 13:19:10 Worker 0 started
2026/01/24 13:19:10 Worker 1 started
=== RUN   TestBrowseFilesystem/browse_root
[GIN] 2026/01/24 - 13:19:10 | 200 |     218.959s |       192.0.2.1 | GET      "/api/v1/filesystem/browse?path=/"
[GIN] 2026/01/24 - 13:19:10 | 200 |     223.917s |       192.0.2.1 | GET      "/api/v1/filesystem/browse?path=/"
=== RUN   TestBrowseFilesystem/browse_without_path
[GIN] 2026/01/24 - 13:19:10 | 400 |       6.042s |       192.0.2.1 | GET      "/api/v1/filesystem/browse"
[GIN] 2026/01/24 - 13:19:10 | 400 |       8.666s |       192.0.2.1 | GET      "/api/v1/filesystem/browse"
2026/01/24 13:19:10 Shutting down operation queue...
2026/01/24 13:19:10 Worker 1 stopped
2026/01/24 13:19:10 Worker 0 stopped
2026/01/24 13:19:10 Operation queue shut down gracefully
--- PASS: TestBrowseFilesystem (0.01s)
    --- PASS: TestBrowseFilesystem/browse_root (0.00s)
    --- PASS: TestBrowseFilesystem/browse_without_path (0.00s)
=== RUN   TestListImportPaths
2026/01/24 13:19:10 Worker 0 started
2026/01/24 13:19:10 Worker 1 started
[GIN] 2026/01/24 - 13:19:10 | 200 |       23.75s |       192.0.2.1 | GET      "/api/v1/import-paths"
[GIN] 2026/01/24 - 13:19:10 | 200 |      30.125s |       192.0.2.1 | GET      "/api/v1/import-paths"
2026/01/24 13:19:10 Shutting down operation queue...
2026/01/24 13:19:10 Worker 1 stopped
2026/01/24 13:19:10 Worker 0 stopped
2026/01/24 13:19:10 Operation queue shut down gracefully
--- PASS: TestListImportPaths (0.01s)
=== RUN   TestGetOperationStatus
2026/01/24 13:19:10 Worker 0 started
2026/01/24 13:19:10 Worker 1 started
[GIN] 2026/01/24 - 13:19:10 | 404 |      25.917s |       192.0.2.1 | GET      "/api/v1/operations/01HXZ123456789ABCDEFGHJ/status"
[GIN] 2026/01/24 - 13:19:10 | 404 |      31.583s |       192.0.2.1 | GET      "/api/v1/operations/01HXZ123456789ABCDEFGHJ/status"
2026/01/24 13:19:10 Shutting down operation queue...
2026/01/24 13:19:10 Worker 1 stopped
2026/01/24 13:19:10 Worker 0 stopped
2026/01/24 13:19:10 Operation queue shut down gracefully
--- PASS: TestGetOperationStatus (0.01s)
=== RUN   TestGetSystemStatus
2026/01/24 13:19:10 Worker 0 started
2026/01/24 13:19:10 Worker 1 started
2026/01/24 13:19:10 [DEBUG] getSystemStatus: Got 0 import paths
2026/01/24 13:19:10 [DEBUG] getSystemStatus: Library books: 0, Import path books: 0
2026/01/24 13:19:10 [DEBUG] Using cached sizes: library=4, import=5
[GIN] 2026/01/24 - 13:19:10 | 200 |     166.084s |       192.0.2.1 | GET      "/api/v1/system/status"
[GIN] 2026/01/24 - 13:19:10 | 200 |     171.708s |       192.0.2.1 | GET      "/api/v1/system/status"
2026/01/24 13:19:10 Shutting down operation queue...
2026/01/24 13:19:10 Worker 1 stopped
2026/01/24 13:19:10 Worker 0 stopped
2026/01/24 13:19:10 Operation queue shut down gracefully
--- PASS: TestGetSystemStatus (0.01s)
=== RUN   TestGetConfig
2026/01/24 13:19:10 Worker 0 started
2026/01/24 13:19:10 Worker 1 started
[GIN] 2026/01/24 - 13:19:10 | 200 |       7.583s |       192.0.2.1 | GET      "/api/v1/config"
[GIN] 2026/01/24 - 13:19:10 | 200 |      12.375s |       192.0.2.1 | GET      "/api/v1/config"
2026/01/24 13:19:10 Shutting down operation queue...
2026/01/24 13:19:10 Worker 1 stopped
2026/01/24 13:19:10 Worker 0 stopped
2026/01/24 13:19:10 Operation queue shut down gracefully
--- PASS: TestGetConfig (0.01s)
=== RUN   TestListBackups
2026/01/24 13:19:10 Worker 0 started
2026/01/24 13:19:10 Worker 1 started
[GIN] 2026/01/24 - 13:19:10 | 200 |     357.917s |       192.0.2.1 | GET      "/api/v1/backup/list"
[GIN] 2026/01/24 - 13:19:10 | 200 |     363.583s |       192.0.2.1 | GET      "/api/v1/backup/list"
2026/01/24 13:19:10 Shutting down operation queue...
2026/01/24 13:19:10 Worker 0 stopped
2026/01/24 13:19:10 Worker 1 stopped
2026/01/24 13:19:10 Operation queue shut down gracefully
--- PASS: TestListBackups (0.01s)
=== RUN   TestBatchUpdateMetadata
2026/01/24 13:19:10 Worker 0 started
2026/01/24 13:19:10 Worker 1 started
=== RUN   TestBatchUpdateMetadata/empty_batch
[GIN] 2026/01/24 - 13:19:10 | 200 |      51.917s |       192.0.2.1 | POST     "/api/v1/metadata/batch-update"
[GIN] 2026/01/24 - 13:19:10 | 200 |      56.875s |       192.0.2.1 | POST     "/api/v1/metadata/batch-update"
=== RUN   TestBatchUpdateMetadata/invalid_request_-_missing_updates
[GIN] 2026/01/24 - 13:19:10 | 400 |      10.166s |       192.0.2.1 | POST     "/api/v1/metadata/batch-update"
[GIN] 2026/01/24 - 13:19:10 | 400 |      13.417s |       192.0.2.1 | POST     "/api/v1/metadata/batch-update"
2026/01/24 13:19:10 Shutting down operation queue...
2026/01/24 13:19:10 Worker 1 stopped
2026/01/24 13:19:10 Worker 0 stopped
2026/01/24 13:19:10 Operation queue shut down gracefully
--- PASS: TestBatchUpdateMetadata (0.01s)
    --- PASS: TestBatchUpdateMetadata/empty_batch (0.00s)
    --- PASS: TestBatchUpdateMetadata/invalid_request_-_missing_updates (0.00s)
=== RUN   TestValidateMetadata
2026/01/24 13:19:10 Worker 0 started
2026/01/24 13:19:10 Worker 1 started
=== RUN   TestValidateMetadata/valid_metadata
[GIN] 2026/01/24 - 13:19:10 | 200 |      17.958s |       192.0.2.1 | POST     "/api/v1/metadata/validate"
[GIN] 2026/01/24 - 13:19:10 | 200 |      22.583s |       192.0.2.1 | POST     "/api/v1/metadata/validate"
=== RUN   TestValidateMetadata/invalid_metadata_-_missing_required_field
[GIN] 2026/01/24 - 13:19:10 | 400 |       9.667s |       192.0.2.1 | POST     "/api/v1/metadata/validate"
[GIN] 2026/01/24 - 13:19:10 | 400 |      12.958s |       192.0.2.1 | POST     "/api/v1/metadata/validate"
2026/01/24 13:19:10 Shutting down operation queue...
2026/01/24 13:19:10 Worker 0 stopped
2026/01/24 13:19:10 Worker 1 stopped
2026/01/24 13:19:10 Operation queue shut down gracefully
--- PASS: TestValidateMetadata (0.01s)
    --- PASS: TestValidateMetadata/valid_metadata (0.00s)
    --- PASS: TestValidateMetadata/invalid_metadata_-_missing_required_field (0.00s)
=== RUN   TestExportMetadata
2026/01/24 13:19:10 Worker 0 started
2026/01/24 13:19:10 Worker 1 started
[GIN] 2026/01/24 - 13:19:10 | 200 |      67.417s |       192.0.2.1 | GET      "/api/v1/metadata/export"
[GIN] 2026/01/24 - 13:19:10 | 200 |      73.542s |       192.0.2.1 | GET      "/api/v1/metadata/export"
2026/01/24 13:19:10 Shutting down operation queue...
2026/01/24 13:19:10 Worker 1 stopped
2026/01/24 13:19:10 Worker 0 stopped
2026/01/24 13:19:10 Operation queue shut down gracefully
--- PASS: TestExportMetadata (0.01s)
=== RUN   TestBulkFetchMetadataRespectsOverridesAndMissingFields
2026/01/24 13:19:10 Worker 0 started
2026/01/24 13:19:10 Worker 1 started
[GIN] 2026/01/24 - 13:19:10 | 200 |    3.416917ms |       192.0.2.1 | POST     "/api/v1/metadata/bulk-fetch"
[GIN] 2026/01/24 - 13:19:10 | 200 |    3.424292ms |       192.0.2.1 | POST     "/api/v1/metadata/bulk-fetch"
2026/01/24 13:19:10 Shutting down operation queue...
2026/01/24 13:19:10 Worker 1 stopped
2026/01/24 13:19:10 Worker 0 stopped
2026/01/24 13:19:10 Operation queue shut down gracefully
--- PASS: TestBulkFetchMetadataRespectsOverridesAndMissingFields (0.02s)
=== RUN   TestCORSMiddleware
2026/01/24 13:19:10 Worker 0 started
2026/01/24 13:19:10 Worker 1 started
[GIN] 2026/01/24 - 13:19:10 | 204 |           2s |       192.0.2.1 | OPTIONS  "/api/health"
[GIN] 2026/01/24 - 13:19:10 | 204 |      10.334s |       192.0.2.1 | OPTIONS  "/api/health"
2026/01/24 13:19:10 Shutting down operation queue...
2026/01/24 13:19:10 Worker 0 stopped
2026/01/24 13:19:10 Worker 1 stopped
2026/01/24 13:19:10 Operation queue shut down gracefully
--- PASS: TestCORSMiddleware (0.01s)
=== RUN   TestRouteNotFound
2026/01/24 13:19:10 Worker 0 started
2026/01/24 13:19:10 Worker 1 started
=== RUN   TestRouteNotFound/api_endpoint_not_found
[GIN] 2026/01/24 - 13:19:10 | 404 |      35.875s |       192.0.2.1 | GET      "/api/v1/nonexistent"
[GIN] 2026/01/24 - 13:19:10 | 404 |      44.417s |       192.0.2.1 | GET      "/api/v1/nonexistent"
=== RUN   TestRouteNotFound/root_path
[GIN] 2026/01/24 - 13:19:10 | 200 |      29.417s |       192.0.2.1 | GET      "/"
[GIN] 2026/01/24 - 13:19:10 | 200 |      32.625s |       192.0.2.1 | GET      "/"
2026/01/24 13:19:10 Shutting down operation queue...
2026/01/24 13:19:10 Worker 1 stopped
2026/01/24 13:19:10 Worker 0 stopped
2026/01/24 13:19:10 Operation queue shut down gracefully
--- PASS: TestRouteNotFound (0.01s)
    --- PASS: TestRouteNotFound/api_endpoint_not_found (0.00s)
    --- PASS: TestRouteNotFound/root_path (0.00s)
=== RUN   TestEndToEndWorkflow
2026/01/24 13:19:10 Worker 0 started
2026/01/24 13:19:10 Worker 1 started
=== RUN   TestEndToEndWorkflow/check_health
[GIN] 2026/01/24 - 13:19:10 | 200 |       71.75s |       192.0.2.1 | GET      "/api/health"
[GIN] 2026/01/24 - 13:19:10 | 200 |      77.125s |       192.0.2.1 | GET      "/api/health"
=== RUN   TestEndToEndWorkflow/list_empty_audiobooks
[GIN] 2026/01/24 - 13:19:10 | 200 |      71.708s |       192.0.2.1 | GET      "/api/v1/audiobooks"
[GIN] 2026/01/24 - 13:19:10 | 200 |      75.708s |       192.0.2.1 | GET      "/api/v1/audiobooks"
=== RUN   TestEndToEndWorkflow/get_configuration
[GIN] 2026/01/24 - 13:19:10 | 200 |      12.458s |       192.0.2.1 | GET      "/api/v1/config"
[GIN] 2026/01/24 - 13:19:10 | 200 |      15.458s |       192.0.2.1 | GET      "/api/v1/config"
=== RUN   TestEndToEndWorkflow/list_import_paths
[GIN] 2026/01/24 - 13:19:10 | 200 |      23.542s |       192.0.2.1 | GET      "/api/v1/import-paths"
[GIN] 2026/01/24 - 13:19:10 | 200 |      26.834s |       192.0.2.1 | GET      "/api/v1/import-paths"
=== RUN   TestEndToEndWorkflow/list_backups
[GIN] 2026/01/24 - 13:19:10 | 200 |     665.375s |       192.0.2.1 | GET      "/api/v1/backup/list"
[GIN] 2026/01/24 - 13:19:10 | 200 |       671.5s |       192.0.2.1 | GET      "/api/v1/backup/list"
2026/01/24 13:19:10 Shutting down operation queue...
2026/01/24 13:19:10 Worker 1 stopped
2026/01/24 13:19:10 Worker 0 stopped
2026/01/24 13:19:10 Operation queue shut down gracefully
--- PASS: TestEndToEndWorkflow (0.01s)
    --- PASS: TestEndToEndWorkflow/check_health (0.00s)
    --- PASS: TestEndToEndWorkflow/list_empty_audiobooks (0.00s)
    --- PASS: TestEndToEndWorkflow/get_configuration (0.00s)
    --- PASS: TestEndToEndWorkflow/list_import_paths (0.00s)
    --- PASS: TestEndToEndWorkflow/list_backups (0.00s)
=== RUN   TestResponseTimes
2026/01/24 13:19:10 Worker 0 started
2026/01/24 13:19:10 Worker 1 started
=== RUN   TestResponseTimes/GET_/api/health
[GIN] 2026/01/24 - 13:19:10 | 200 |      67.875s |       192.0.2.1 | GET      "/api/health"
[GIN] 2026/01/24 - 13:19:10 | 200 |      74.083s |       192.0.2.1 | GET      "/api/health"
=== RUN   TestResponseTimes/GET_/api/v1/audiobooks
[GIN] 2026/01/24 - 13:19:10 | 200 |      67.208s |       192.0.2.1 | GET      "/api/v1/audiobooks"
[GIN] 2026/01/24 - 13:19:10 | 200 |      71.084s |       192.0.2.1 | GET      "/api/v1/audiobooks"
=== RUN   TestResponseTimes/GET_/api/v1/authors
[GIN] 2026/01/24 - 13:19:10 | 200 |       23.75s |       192.0.2.1 | GET      "/api/v1/authors"
[GIN] 2026/01/24 - 13:19:10 | 200 |      27.125s |       192.0.2.1 | GET      "/api/v1/authors"
=== RUN   TestResponseTimes/GET_/api/v1/series
[GIN] 2026/01/24 - 13:19:10 | 200 |      21.125s |       192.0.2.1 | GET      "/api/v1/series"
[GIN] 2026/01/24 - 13:19:10 | 200 |      23.916s |       192.0.2.1 | GET      "/api/v1/series"
=== RUN   TestResponseTimes/GET_/api/v1/config
[GIN] 2026/01/24 - 13:19:10 | 200 |       8.958s |       192.0.2.1 | GET      "/api/v1/config"
[GIN] 2026/01/24 - 13:19:10 | 200 |      11.167s |       192.0.2.1 | GET      "/api/v1/config"
2026/01/24 13:19:10 Shutting down operation queue...
2026/01/24 13:19:10 Worker 1 stopped
2026/01/24 13:19:10 Worker 0 stopped
2026/01/24 13:19:10 Operation queue shut down gracefully
--- PASS: TestResponseTimes (0.01s)
    --- PASS: TestResponseTimes/GET_/api/health (0.00s)
    --- PASS: TestResponseTimes/GET_/api/v1/audiobooks (0.00s)
    --- PASS: TestResponseTimes/GET_/api/v1/authors (0.00s)
    --- PASS: TestResponseTimes/GET_/api/v1/series (0.00s)
    --- PASS: TestResponseTimes/GET_/api/v1/config (0.00s)
=== RUN   TestDashboardSizeFormat
2026/01/24 13:19:10 Worker 0 started
2026/01/24 13:19:10 Worker 1 started
[GIN] 2026/01/24 - 13:19:10 | 200 |      83.792s |       192.0.2.1 | GET      "/api/v1/dashboard"
[GIN] 2026/01/24 - 13:19:10 | 200 |      89.417s |       192.0.2.1 | GET      "/api/v1/dashboard"
=== RUN   TestDashboardSizeFormat/size_distribution_structure
=== RUN   TestDashboardSizeFormat/format_distribution_structure
2026/01/24 13:19:10 Shutting down operation queue...
2026/01/24 13:19:10 Worker 1 stopped
2026/01/24 13:19:10 Worker 0 stopped
2026/01/24 13:19:10 Operation queue shut down gracefully
--- PASS: TestDashboardSizeFormat (0.01s)
    --- PASS: TestDashboardSizeFormat/size_distribution_structure (0.00s)
    --- PASS: TestDashboardSizeFormat/format_distribution_structure (0.00s)
=== RUN   TestSizeCalculationAccuracy
2026/01/24 13:19:10 Worker 0 started
2026/01/24 13:19:10 Worker 1 started
[GIN] 2026/01/24 - 13:19:10 | 200 |      87.542s |       192.0.2.1 | GET      "/api/v1/dashboard"
[GIN] 2026/01/24 - 13:19:10 | 200 |      95.708s |       192.0.2.1 | GET      "/api/v1/dashboard"
2026/01/24 13:19:10 Shutting down operation queue...
2026/01/24 13:19:10 Worker 1 stopped
2026/01/24 13:19:10 Worker 0 stopped
2026/01/24 13:19:10 Operation queue shut down gracefully
--- PASS: TestSizeCalculationAccuracy (0.01s)
=== RUN   TestFormatDetection
2026/01/24 13:19:10 Worker 0 started
2026/01/24 13:19:10 Worker 1 started
=== RUN   TestFormatDetection/m4b_detection
[GIN] 2026/01/24 - 13:19:10 | 200 |      92.583s |       192.0.2.1 | GET      "/api/v1/dashboard"
[GIN] 2026/01/24 - 13:19:10 | 200 |       98.25s |       192.0.2.1 | GET      "/api/v1/dashboard"
=== RUN   TestFormatDetection/mp3_detection
[GIN] 2026/01/24 - 13:19:10 | 200 |          71s |       192.0.2.1 | GET      "/api/v1/dashboard"
[GIN] 2026/01/24 - 13:19:10 | 200 |      74.875s |       192.0.2.1 | GET      "/api/v1/dashboard"
=== RUN   TestFormatDetection/opus_detection
[GIN] 2026/01/24 - 13:19:10 | 200 |       66.25s |       192.0.2.1 | GET      "/api/v1/dashboard"
[GIN] 2026/01/24 - 13:19:10 | 200 |      71.125s |       192.0.2.1 | GET      "/api/v1/dashboard"
=== RUN   TestFormatDetection/flac_detection
[GIN] 2026/01/24 - 13:19:10 | 200 |      62.041s |       192.0.2.1 | GET      "/api/v1/dashboard"
[GIN] 2026/01/24 - 13:19:10 | 200 |      65.334s |       192.0.2.1 | GET      "/api/v1/dashboard"
2026/01/24 13:19:10 Shutting down operation queue...
2026/01/24 13:19:10 Worker 1 stopped
2026/01/24 13:19:10 Worker 0 stopped
2026/01/24 13:19:10 Operation queue shut down gracefully
--- PASS: TestFormatDetection (0.01s)
    --- PASS: TestFormatDetection/m4b_detection (0.00s)
    --- PASS: TestFormatDetection/mp3_detection (0.00s)
    --- PASS: TestFormatDetection/opus_detection (0.00s)
    --- PASS: TestFormatDetection/flac_detection (0.00s)
=== RUN   TestSizeBucketDistribution
2026/01/24 13:19:10 Worker 0 started
2026/01/24 13:19:10 Worker 1 started
[GIN] 2026/01/24 - 13:19:10 | 200 |        81.5s |       192.0.2.1 | GET      "/api/v1/dashboard"
[GIN] 2026/01/24 - 13:19:10 | 200 |      87.833s |       192.0.2.1 | GET      "/api/v1/dashboard"
2026/01/24 13:19:10 Shutting down operation queue...
2026/01/24 13:19:10 Worker 1 stopped
2026/01/24 13:19:10 Worker 0 stopped
2026/01/24 13:19:10 Operation queue shut down gracefully
--- PASS: TestSizeBucketDistribution (0.01s)
=== RUN   TestEmptyDashboardSizeFormat
2026/01/24 13:19:10 Worker 0 started
2026/01/24 13:19:10 Worker 1 started
[GIN] 2026/01/24 - 13:19:10 | 200 |      92.833s |       192.0.2.1 | GET      "/api/v1/dashboard"
[GIN] 2026/01/24 - 13:19:10 | 200 |     102.083s |       192.0.2.1 | GET      "/api/v1/dashboard"
2026/01/24 13:19:10 Shutting down operation queue...
2026/01/24 13:19:10 Worker 1 stopped
2026/01/24 13:19:10 Worker 0 stopped
2026/01/24 13:19:10 Operation queue shut down gracefully
--- PASS: TestEmptyDashboardSizeFormat (0.01s)
=== RUN   TestGetMetadataFields
2026/01/24 13:19:10 Worker 0 started
2026/01/24 13:19:10 Worker 1 started
[GIN] 2026/01/24 - 13:19:10 | 200 |      17.417s |       192.0.2.1 | GET      "/api/v1/metadata/fields"
[GIN] 2026/01/24 - 13:19:10 | 200 |      24.833s |       192.0.2.1 | GET      "/api/v1/metadata/fields"
2026/01/24 13:19:10 Shutting down operation queue...
2026/01/24 13:19:10 Worker 1 stopped
2026/01/24 13:19:10 Worker 0 stopped
2026/01/24 13:19:10 Operation queue shut down gracefully
--- PASS: TestGetMetadataFields (0.01s)
=== RUN   TestMetadataFieldValidation
2026/01/24 13:19:10 Worker 0 started
2026/01/24 13:19:10 Worker 1 started
=== RUN   TestMetadataFieldValidation/valid_title
[GIN] 2026/01/24 - 13:19:10 | 200 |      29.292s |       192.0.2.1 | POST     "/api/v1/metadata/validate"
[GIN] 2026/01/24 - 13:19:10 | 200 |      36.333s |       192.0.2.1 | POST     "/api/v1/metadata/validate"
=== RUN   TestMetadataFieldValidation/empty_title
[GIN] 2026/01/24 - 13:19:10 | 400 |      10.833s |       192.0.2.1 | POST     "/api/v1/metadata/validate"
[GIN] 2026/01/24 - 13:19:10 | 400 |       14.25s |       192.0.2.1 | POST     "/api/v1/metadata/validate"
=== RUN   TestMetadataFieldValidation/valid_publish_date
[GIN] 2026/01/24 - 13:19:10 | 200 |       9.875s |       192.0.2.1 | POST     "/api/v1/metadata/validate"
[GIN] 2026/01/24 - 13:19:10 | 200 |      12.917s |       192.0.2.1 | POST     "/api/v1/metadata/validate"
=== RUN   TestMetadataFieldValidation/invalid_publish_date
[GIN] 2026/01/24 - 13:19:10 | 400 |       8.875s |       192.0.2.1 | POST     "/api/v1/metadata/validate"
[GIN] 2026/01/24 - 13:19:10 | 400 |      12.583s |       192.0.2.1 | POST     "/api/v1/metadata/validate"
2026/01/24 13:19:10 Shutting down operation queue...
2026/01/24 13:19:10 Worker 0 stopped
2026/01/24 13:19:10 Worker 1 stopped
2026/01/24 13:19:10 Operation queue shut down gracefully
--- PASS: TestMetadataFieldValidation (0.01s)
    --- PASS: TestMetadataFieldValidation/valid_title (0.00s)
    --- PASS: TestMetadataFieldValidation/empty_title (0.00s)
    --- PASS: TestMetadataFieldValidation/valid_publish_date (0.00s)
    --- PASS: TestMetadataFieldValidation/invalid_publish_date (0.00s)
=== RUN   TestGetWork
2026/01/24 13:19:10 Worker 0 started
2026/01/24 13:19:10 Worker 1 started
[GIN] 2026/01/24 - 13:19:10 | 200 |      26.625s |       192.0.2.1 | GET      "/api/v1/work"
[GIN] 2026/01/24 - 13:19:10 | 200 |      33.625s |       192.0.2.1 | GET      "/api/v1/work"
2026/01/24 13:19:10 Shutting down operation queue...
2026/01/24 13:19:10 Worker 1 stopped
2026/01/24 13:19:10 Worker 0 stopped
2026/01/24 13:19:10 Operation queue shut down gracefully
--- PASS: TestGetWork (0.01s)
=== RUN   TestWorkQueueOperations
2026/01/24 13:19:10 Worker 0 started
2026/01/24 13:19:10 Worker 1 started
=== RUN   TestWorkQueueOperations/list_work_items
[GIN] 2026/01/24 - 13:19:10 | 200 |      28.667s |       192.0.2.1 | GET      "/api/v1/work"
[GIN] 2026/01/24 - 13:19:10 | 200 |      34.166s |       192.0.2.1 | GET      "/api/v1/work"
=== RUN   TestWorkQueueOperations/get_work_statistics
[GIN] 2026/01/24 - 13:19:10 | 200 |      21.375s |       192.0.2.1 | GET      "/api/v1/work/stats"
[GIN] 2026/01/24 - 13:19:10 | 200 |      25.083s |       192.0.2.1 | GET      "/api/v1/work/stats"
2026/01/24 13:19:10 Shutting down operation queue...
2026/01/24 13:19:10 Worker 1 stopped
2026/01/24 13:19:10 Worker 0 stopped
2026/01/24 13:19:10 Operation queue shut down gracefully
--- PASS: TestWorkQueueOperations (0.01s)
    --- PASS: TestWorkQueueOperations/list_work_items (0.00s)
    --- PASS: TestWorkQueueOperations/get_work_statistics (0.00s)
=== RUN   TestWorkQueuePriority
2026/01/24 13:19:10 Worker 0 started
2026/01/24 13:19:10 Worker 1 started
[GIN] 2026/01/24 - 13:19:10 | 200 |      27.083s |       192.0.2.1 | GET      "/api/v1/work"
[GIN] 2026/01/24 - 13:19:10 | 200 |      36.958s |       192.0.2.1 | GET      "/api/v1/work"
2026/01/24 13:19:10 Shutting down operation queue...
2026/01/24 13:19:10 Worker 1 stopped
2026/01/24 13:19:10 Worker 0 stopped
2026/01/24 13:19:10 Operation queue shut down gracefully
--- PASS: TestWorkQueuePriority (0.01s)
=== RUN   TestGetAudiobookTagsReportsEffectiveSource
2026/01/24 13:19:10 Worker 0 started
2026/01/24 13:19:10 Worker 1 started
2026/01/24 13:19:10 [DEBUG] metadata: extracting tags for /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestGetAudiobookTagsReportsEffectiveSource528964687/001/book.m4b
2026/01/24 13:19:10 [WARN] metadata: failed to read tags for /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestGetAudiobookTagsReportsEffectiveSource528964687/001/book.m4b: seek /var/folders/xk/cqhbw4j94dz4h68mb1zm_x9c0000gn/T/TestGetAudiobookTagsReportsEffectiveSource528964687/001/book.m4b: invalid argument; falling back to filename parsing
[GIN] 2026/01/24 - 13:19:10 | 200 |     209.334s |       192.0.2.1 | GET      "/api/v1/audiobooks/01KFRKPG71ZS7919G7JXWR5EGX/tags"
[GIN] 2026/01/24 - 13:19:10 | 200 |     217.167s |       192.0.2.1 | GET      "/api/v1/audiobooks/01KFRKPG71ZS7919G7JXWR5EGX/tags"
2026/01/24 13:19:10 Shutting down operation queue...
2026/01/24 13:19:10 Worker 1 stopped
2026/01/24 13:19:10 Worker 0 stopped
2026/01/24 13:19:10 Operation queue shut down gracefully
--- PASS: TestGetAudiobookTagsReportsEffectiveSource (0.01s)
=== RUN   TestUpdateAudiobookPersistsOverrides
2026/01/24 13:19:10 Worker 0 started
2026/01/24 13:19:10 Worker 1 started
[GIN] 2026/01/24 - 13:19:10 | 200 |    1.680333ms |       192.0.2.1 | PUT      "/api/v1/audiobooks/01KFRKPG7CZ90801MVZDK8THHY"
[GIN] 2026/01/24 - 13:19:10 | 200 |    1.692416ms |       192.0.2.1 | PUT      "/api/v1/audiobooks/01KFRKPG7CZ90801MVZDK8THHY"
2026/01/24 13:19:10 Shutting down operation queue...
2026/01/24 13:19:10 Worker 1 stopped
2026/01/24 13:19:10 Worker 0 stopped
2026/01/24 13:19:10 Operation queue shut down gracefully
--- PASS: TestUpdateAudiobookPersistsOverrides (0.01s)
=== RUN   TestUpdateAudiobook_EmptyBody_Returns400
2026/01/24 13:19:10 Worker 0 started
2026/01/24 13:19:10 Worker 1 started
[GIN] 2026/01/24 - 13:19:10 | 400 |          60s |       192.0.2.1 | PUT      "/api/v1/audiobooks/01KFRKPG7S3X4HD1P5GMCTXZ15"
[GIN] 2026/01/24 - 13:19:10 | 400 |      69.459s |       192.0.2.1 | PUT      "/api/v1/audiobooks/01KFRKPG7S3X4HD1P5GMCTXZ15"
2026/01/24 13:19:10 Shutting down operation queue...
2026/01/24 13:19:10 Worker 1 stopped
2026/01/24 13:19:10 Worker 0 stopped
2026/01/24 13:19:10 Operation queue shut down gracefully
--- PASS: TestUpdateAudiobook_EmptyBody_Returns400 (0.01s)
=== RUN   TestUpdateAudiobook_InvalidJSON_Returns400
2026/01/24 13:19:10 Worker 0 started
2026/01/24 13:19:10 Worker 1 started
[GIN] 2026/01/24 - 13:19:10 | 400 |      57.167s |       192.0.2.1 | PUT      "/api/v1/audiobooks/01KFRKPG84P353Q97H1SQJFPT0"
[GIN] 2026/01/24 - 13:19:10 | 400 |      67.209s |       192.0.2.1 | PUT      "/api/v1/audiobooks/01KFRKPG84P353Q97H1SQJFPT0"
2026/01/24 13:19:10 Shutting down operation queue...
2026/01/24 13:19:10 Worker 1 stopped
2026/01/24 13:19:10 Worker 0 stopped
2026/01/24 13:19:10 Operation queue shut down gracefully
--- PASS: TestUpdateAudiobook_InvalidJSON_Returns400 (0.01s)
=== RUN   TestUpdateAudiobook_CreatesAuthorSeries_AndUpdatesOverrideState
2026/01/24 13:19:10 Worker 0 started
2026/01/24 13:19:10 Worker 1 started
[GIN] 2026/01/24 - 13:19:10 | 200 |    3.934291ms |       192.0.2.1 | PUT      "/api/v1/audiobooks/01KFRKPG8G559WK6PC1C4WXRZG"
[GIN] 2026/01/24 - 13:19:10 | 200 |    3.951333ms |       192.0.2.1 | PUT      "/api/v1/audiobooks/01KFRKPG8G559WK6PC1C4WXRZG"
[GIN] 2026/01/24 - 13:19:10 | 200 |     969.209s |       192.0.2.1 | PUT      "/api/v1/audiobooks/01KFRKPG8G559WK6PC1C4WXRZG"
[GIN] 2026/01/24 - 13:19:10 | 200 |     976.916s |       192.0.2.1 | PUT      "/api/v1/audiobooks/01KFRKPG8G559WK6PC1C4WXRZG"
2026/01/24 13:19:10 Shutting down operation queue...
2026/01/24 13:19:10 Worker 0 stopped
2026/01/24 13:19:10 Worker 1 stopped
2026/01/24 13:19:10 Operation queue shut down gracefully
--- PASS: TestUpdateAudiobook_CreatesAuthorSeries_AndUpdatesOverrideState (0.02s)
=== RUN   TestVersionEndpoints_HappyPaths
2026/01/24 13:19:11 Worker 1 started
2026/01/24 13:19:11 Worker 0 started
[GIN] 2026/01/24 - 13:19:11 | 200 |      68.042s |       192.0.2.1 | GET      "/api/v1/audiobooks/01KFRKPG9145B07T90QG54WN2V/versions"
[GIN] 2026/01/24 - 13:19:11 | 200 |          82s |       192.0.2.1 | GET      "/api/v1/audiobooks/01KFRKPG9145B07T90QG54WN2V/versions"
[GIN] 2026/01/24 - 13:19:11 | 200 |    1.037709ms |       192.0.2.1 | POST     "/api/v1/audiobooks/01KFRKPG9145B07T90QG54WN2V/versions"
[GIN] 2026/01/24 - 13:19:11 | 200 |     1.05175ms |       192.0.2.1 | POST     "/api/v1/audiobooks/01KFRKPG9145B07T90QG54WN2V/versions"
[GIN] 2026/01/24 - 13:19:11 | 200 |      89.166s |       192.0.2.1 | GET      "/api/v1/version-groups/01KFRKPG92Z0ENRTWDG96NER1J"
[GIN] 2026/01/24 - 13:19:11 | 200 |          94s |       192.0.2.1 | GET      "/api/v1/version-groups/01KFRKPG92Z0ENRTWDG96NER1J"
[GIN] 2026/01/24 - 13:19:11 | 200 |     996.084s |       192.0.2.1 | PUT      "/api/v1/audiobooks/01KFRKPG9145B07T90QG54WN2V/set-primary"
[GIN] 2026/01/24 - 13:19:11 | 200 |    1.003792ms |       192.0.2.1 | PUT      "/api/v1/audiobooks/01KFRKPG9145B07T90QG54WN2V/set-primary"
2026/01/24 13:19:11 Shutting down operation queue...
2026/01/24 13:19:11 Worker 1 stopped
2026/01/24 13:19:11 Worker 0 stopped
2026/01/24 13:19:11 Operation queue shut down gracefully
--- PASS: TestVersionEndpoints_HappyPaths (0.01s)
=== RUN   TestWorkEndpoints_WithMockStore
2026/01/24 13:19:11 Worker 0 started
2026/01/24 13:19:11 Worker 1 started
[GIN] 2026/01/24 - 13:19:11 | 200 |     113.958s |       192.0.2.1 | GET      "/api/v1/work"
[GIN] 2026/01/24 - 13:19:11 | 200 |     124.125s |       192.0.2.1 | GET      "/api/v1/work"
[GIN] 2026/01/24 - 13:19:11 | 200 |       66.25s |       192.0.2.1 | GET      "/api/v1/work/stats"
[GIN] 2026/01/24 - 13:19:11 | 200 |      69.625s |       192.0.2.1 | GET      "/api/v1/work/stats"
2026/01/24 13:19:11 Shutting down operation queue...
2026/01/24 13:19:11 Worker 1 stopped
2026/01/24 13:19:11 Worker 0 stopped
2026/01/24 13:19:11 Operation queue shut down gracefully
--- PASS: TestWorkEndpoints_WithMockStore (0.01s)
PASS
coverage: 70.1% of statements
ok  	github.com/jdfalk/audiobook-organizer/internal/server	8.439s	coverage: 70.1% of statements
=== RUN   TestGetTotalMemory
    memory_test.go:20: Total memory: 34359738368 bytes (32768.00 MB)
--- PASS: TestGetTotalMemory (0.00s)
=== RUN   TestGetTotalMemoryOverride
--- PASS: TestGetTotalMemoryOverride (0.00s)
=== RUN   TestGetMemoryStats
    memory_test.go:69: Memory Stats:
    memory_test.go:70:   Total: 34359738368 bytes (32.00 GB)
    memory_test.go:71:   Used: 6871947674 bytes (6.40 GB)
    memory_test.go:72:   Available: 27487790694 bytes (25.60 GB)
    memory_test.go:73:   Used Percent: 20.00%
--- PASS: TestGetMemoryStats (0.00s)
=== RUN   TestGetMemoryStatsFallback
--- PASS: TestGetMemoryStatsFallback (0.00s)
=== RUN   TestMemoryStats_Structure
--- PASS: TestMemoryStats_Structure (0.00s)
=== RUN   TestGetMemoryStats_Consistency
--- PASS: TestGetMemoryStats_Consistency (0.00s)
=== RUN   TestMemoryStats_EdgeCases
--- PASS: TestMemoryStats_EdgeCases (0.00s)
=== RUN   TestGetMemoryStatsRepeated
--- PASS: TestGetMemoryStatsRepeated (0.00s)
=== RUN   TestGetMemoryStatsConsistency
--- PASS: TestGetMemoryStatsConsistency (0.00s)
=== RUN   TestMemoryStatsValues
--- PASS: TestMemoryStatsValues (0.00s)
PASS
coverage: 91.3% of statements
ok  	github.com/jdfalk/audiobook-organizer/internal/sysinfo	(cached)	coverage: 91.3% of statements
=== RUN   TestUpdateM4BTags
Would update M4B tags for /test/path/book.m4b with series: Test Series, Book 1
    tagger_test.go:43: updateM4BTags executed successfully (placeholder)
--- PASS: TestUpdateM4BTags (0.00s)
=== RUN   TestUpdateMP3Tags
Would update MP3 tags for /test/path/book.mp3 with series: Test Series, Book 1
    tagger_test.go:56: updateMP3Tags executed successfully (placeholder)
--- PASS: TestUpdateMP3Tags (0.00s)
=== RUN   TestUpdateFLACTags
Would update FLAC tags for /test/path/book.flac with series: Test Series, Book 1
    tagger_test.go:69: updateFLACTags executed successfully (placeholder)
--- PASS: TestUpdateFLACTags (0.00s)
=== RUN   TestUpdateFileTags_M4B
Would update M4B tags for /test/path/book.m4b with series: Test Series, Book 1
--- PASS: TestUpdateFileTags_M4B (0.00s)
=== RUN   TestUpdateFileTags_MP3
Would update MP3 tags for /test/path/book.mp3 with series: Test Series, Book 1
--- PASS: TestUpdateFileTags_MP3 (0.00s)
=== RUN   TestUpdateFileTags_FLAC
Would update FLAC tags for /test/path/book.flac with series: Test Series, Book 1
--- PASS: TestUpdateFileTags_FLAC (0.00s)
=== RUN   TestUpdateFileTags_M4A
Would update M4B tags for /test/path/book.m4a with series: Test Series, Book 1
--- PASS: TestUpdateFileTags_M4A (0.00s)
=== RUN   TestUpdateFileTags_AAC
Would update M4B tags for /test/path/book.aac with series: Test Series, Book 1
--- PASS: TestUpdateFileTags_AAC (0.00s)
=== RUN   TestUpdateFileTags_UnsupportedFormat
--- PASS: TestUpdateFileTags_UnsupportedFormat (0.00s)
=== RUN   TestUpdateFileTags_CaseInsensitive
=== RUN   TestUpdateFileTags_CaseInsensitive/.M4B
Would update M4B tags for /test/book.M4B with series: Series
=== RUN   TestUpdateFileTags_CaseInsensitive/.Mp3
Would update MP3 tags for /test/book.Mp3 with series: Series
=== RUN   TestUpdateFileTags_CaseInsensitive/.FLAC
Would update FLAC tags for /test/book.FLAC with series: Series
=== RUN   TestUpdateFileTags_CaseInsensitive/.M4A
Would update M4B tags for /test/book.M4A with series: Series
--- PASS: TestUpdateFileTags_CaseInsensitive (0.00s)
    --- PASS: TestUpdateFileTags_CaseInsensitive/.M4B (0.00s)
    --- PASS: TestUpdateFileTags_CaseInsensitive/.Mp3 (0.00s)
    --- PASS: TestUpdateFileTags_CaseInsensitive/.FLAC (0.00s)
    --- PASS: TestUpdateFileTags_CaseInsensitive/.M4A (0.00s)
=== RUN   TestUpdateSeriesTags
Updating audio file tags with series information...
Would update M4B tags for /tmp/book-one.m4b with series: Test Series, Book 1
Warning: Could not update tags for /tmp/book-two.wav: unsupported file format: .wav
Updated tags for 1 files
--- PASS: TestUpdateSeriesTags (0.07s)
PASS
coverage: 93.8% of statements
ok  	github.com/jdfalk/audiobook-organizer/internal/tagger	(cached)	coverage: 93.8% of statements
