# file: .github/workflows/test-action-integration.yml
# version: 1.3.0
# guid: test-action-integration-001

name: Test Frontend Config Action Integration

on:
  push:
    branches: [main, develop]
    paths:
      - '.github/repository-config.yml'
      - '.github/workflows/test-action-integration.yml'
      - 'go.mod'
      - 'web/package.json'
  pull_request:
    branches: [main, develop]
    paths:
      - '.github/repository-config.yml'
      - '.github/workflows/test-action-integration.yml'
      - 'go.mod'
      - 'web/package.json'
  workflow_dispatch:

permissions:
  contents: read
  checks: write
  issues: write

jobs:
  test-action:
    name: Test Frontend Configuration Action
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Get frontend configuration
        id: frontend-config
        uses: jdfalk/get-frontend-config-action@3d728dd5c1f057dfdc97fc6eb3ca1e8fe8ba3a1b # v1.1.3
        with:
          repository-config: ''
          config-file: '.github/repository-config.yml'

      - name: Log actual output values
        if: always()
        env:
          OUT_DIR: ${{ steps.frontend-config.outputs.dir }}
          OUT_NODE: ${{ steps.frontend-config.outputs.node-version }}
          OUT_HAS: ${{ steps.frontend-config.outputs.has-frontend }}
        run: |
          echo "::group::Action Outputs (for drift diagnosis)"
          echo "dir=$OUT_DIR"
          echo "node-version=$OUT_NODE"
          echo "has-frontend=$OUT_HAS"
          echo "::endgroup::"

      - name: Verify action outputs
        id: verify-outputs
        env:
          OUT_DIR: ${{ steps.frontend-config.outputs.dir }}
          OUT_NODE: ${{ steps.frontend-config.outputs.node-version }}
          OUT_HAS: ${{ steps.frontend-config.outputs.has-frontend }}
        run: |
          FAIL=0

          echo "--- Checking dir ---"
          echo "  actual:   '$OUT_DIR'"
          echo "  expected: 'web'"
          if [ "$OUT_DIR" != "web" ]; then
            echo "::error::Expected dir='web', got '$OUT_DIR'"
            FAIL=1
          fi

          echo "--- Checking node-version ---"
          echo "  actual:   '$OUT_NODE'"
          echo "  expected: '22'"
          if [ "$OUT_NODE" != "22" ]; then
            echo "::error::Expected node-version='22', got '$OUT_NODE'"
            FAIL=1
          fi

          echo "--- Checking has-frontend ---"
          echo "  actual:   '$OUT_HAS'"
          echo "  expected: 'true'"
          if [ "$OUT_HAS" != "true" ]; then
            echo "::error::Expected has-frontend='true', got '$OUT_HAS'"
            FAIL=1
          fi

          if [ "$FAIL" -eq 0 ]; then
            echo "All output validations passed"
          fi
          exit $FAIL

      - name: Check version consistency
        id: version-check
        env:
          OUT_NODE: ${{ steps.frontend-config.outputs.node-version }}
        run: |
          # Go version: go.mod vs ci.yml
          GO_MOD_VER=$(grep '^go ' go.mod | awk '{print $2}' | sed 's/\.[0-9]*$//')
          CI_GO_VER=$(grep "go-version:" .github/workflows/ci.yml | head -1 | grep -oE "'[^']+'" | tr -d "'")
          REPO_CFG_GO_VER=$(grep -A1 'versions:' .github/repository-config.yml | grep 'go:' | head -1 | grep -oE "'[^']+'" | tr -d "'")

          echo "--- Go version check ---"
          echo "  go.mod:              $GO_MOD_VER"
          echo "  ci.yml:              $CI_GO_VER"
          echo "  repository-config:   $REPO_CFG_GO_VER"

          if [ -n "$CI_GO_VER" ] && [ "$GO_MOD_VER" != "$CI_GO_VER" ]; then
            echo "::warning::Go version mismatch: go.mod=$GO_MOD_VER vs ci.yml=$CI_GO_VER"
          fi

          # Node version: repository-config.yml vs ci.yml
          CI_NODE_VER=$(grep "node-version:" .github/workflows/ci.yml | head -1 | grep -oE "'[^']+'" | tr -d "'")

          echo "--- Node version check ---"
          echo "  ci.yml:              $CI_NODE_VER"
          echo "  action output:       $OUT_NODE"

          if [ -n "$CI_NODE_VER" ] && [ "$CI_NODE_VER" != "$OUT_NODE" ]; then
            echo "::warning::Node version mismatch: ci.yml=$CI_NODE_VER vs action=$OUT_NODE"
          fi

          echo "Version consistency checks complete"

      - name: Create issue on drift
        if: failure() && github.event_name != 'pull_request'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OUT_DIR: ${{ steps.frontend-config.outputs.dir }}
          OUT_NODE: ${{ steps.frontend-config.outputs.node-version }}
          OUT_HAS: ${{ steps.frontend-config.outputs.has-frontend }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          # Check for existing open ci-drift issue to avoid duplicates
          EXISTING=$(gh issue list --label "ci-drift" --state open --limit 1 --json number -q '.[0].number' || echo "")
          if [ -n "$EXISTING" ]; then
            echo "Open ci-drift issue already exists: #$EXISTING -- adding comment"
            gh issue comment "$EXISTING" --body "Drift detected again in run: $RUN_URL"
            exit 0
          fi

          gh issue create \
            --title "[CI DRIFT] Action output or version mismatch detected" \
            --label "ci-drift" \
            --body "## CI/CD Configuration Drift Detected

          The \`test-action-integration.yml\` workflow detected unexpected outputs
          from \`get-frontend-config-action\` or version inconsistencies across config files.

          **Expected action outputs:**
          - \`dir\` = \`web\`
          - \`node-version\` = \`22\`
          - \`has-frontend\` = \`true\`

          **Actual action outputs:**
          - \`dir\` = \`$OUT_DIR\`
          - \`node-version\` = \`$OUT_NODE\`
          - \`has-frontend\` = \`$OUT_HAS\`

          **Workflow run:** $RUN_URL

          Please investigate and update \`.github/repository-config.yml\`, \`ci.yml\`,
          or pin the action to a known-good version."
