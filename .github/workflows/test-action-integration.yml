# file: .github/workflows/test-action-integration.yml
# version: 1.2.0
# guid: test-action-integration-001

name: Test Frontend Config Action Integration

on:
  push:
    branches: [main, develop]
    paths:
      - '.github/repository-config.yml'
      - '.github/workflows/test-action-integration.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - '.github/repository-config.yml'
      - '.github/workflows/test-action-integration.yml'
  workflow_dispatch:

permissions:
  contents: read
  checks: write
  issues: write

jobs:
  test-action:
    name: Test Frontend Configuration Action
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Get frontend configuration
        id: frontend-config
        uses: jdfalk/get-frontend-config-action@3d728dd5c1f057dfdc97fc6eb3ca1e8fe8ba3a1b # v1.1.3
        with:
          repository-config: ''
          config-file: '.github/repository-config.yml'

      - name: Verify action outputs
        run: |
          echo "✅ Action executed successfully"
          echo "Frontend directory: ${{ steps.frontend-config.outputs.dir }}"
          echo "Node.js version: ${{ steps.frontend-config.outputs.node-version }}"
          echo "Has frontend: ${{ steps.frontend-config.outputs.has-frontend }}"

          # Validate outputs
          if [ "${{ steps.frontend-config.outputs.dir }}" != "web" ]; then
            echo "❌ Expected dir='web', got '${{ steps.frontend-config.outputs.dir }}'"
            exit 1
          fi

          if [ "${{ steps.frontend-config.outputs.node-version }}" != "22" ]; then
            echo "❌ Expected node-version='22', got '${{ steps.frontend-config.outputs.node-version }}'"
            exit 1
          fi

          if [ "${{ steps.frontend-config.outputs.has-frontend }}" != "true" ]; then
            echo "❌ Expected has-frontend='true', got '${{ steps.frontend-config.outputs.has-frontend }}'"
            exit 1
          fi

          echo "✅ All output validations passed"

      - name: Report results
        if: always()
        run: |
          echo "Test Results:"
          echo "  Frontend Dir: ${{ steps.frontend-config.outputs.dir }}"
          echo "  Node Version: ${{ steps.frontend-config.outputs.node-version }}"
          echo "  Has Frontend: ${{ steps.frontend-config.outputs.has-frontend }}"

      - name: Alert on output drift
        if: failure()
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { context } = require('@actions/github');
            const octokit = github.getOctokit(process.env.GITHUB_TOKEN);

            const body = [
              '## CI/CD Configuration Drift Detected',
              '',
              'The `test-action-integration.yml` workflow detected unexpected outputs',
              'from `get-frontend-config-action`. This may indicate a breaking change',
              'in the upstream action or a configuration regression.',
              '',
              '**Expected values:**',
              '- `dir` = `web`',
              '- `node-version` = `22`',
              '- `has-frontend` = `true`',
              '',
              '**Workflow run:** ' + context.payload.repository.html_url +
                '/actions/runs/' + context.runId,
              '',
              'Please investigate and update `.github/repository-config.yml` or',
              'pin the action to a known-good version.',
            ].join('\n');

            await octokit.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: '[CI DRIFT] get-frontend-config-action outputs changed',
              body: body,
              labels: ['ci', 'priority:high'],
            });
